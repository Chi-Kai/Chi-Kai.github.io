<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>æ‚‰è¾¾å¤š</title><link>https://chi-kai.github.io/</link><description>Recent content on æ‚‰è¾¾å¤š</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Thu, 19 Sep 2024 00:00:00 +0000</lastBuildDate><atom:link href="https://chi-kai.github.io/index.xml" rel="self" type="application/rss+xml"/><item><title/><link>https://chi-kai.github.io/post/%E6%A8%A1%E5%9E%8B%E5%90%8E%E9%97%A8%E6%94%BB%E5%87%BB%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/</link><pubDate>Thu, 19 Sep 2024 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/%E6%A8%A1%E5%9E%8B%E5%90%8E%E9%97%A8%E6%94%BB%E5%87%BB%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/</guid><description>&lt;h1 id="ccs24-badmerging-backdoor-attacks-against-model-merging">CCS'24 BadMerging: Backdoor Attacks Against Model Merging&lt;/h1>
&lt;h2 id="æ‘˜è¦">æ‘˜è¦&lt;/h2>
&lt;p>éšç€é¢„è®­ç»ƒæ¨¡åž‹åœ¨ä¸‹æ¸¸ä»»åŠ¡ä¸­çš„å¹¿æ³›åº”ç”¨ï¼Œ&lt;strong>æ¨¡åž‹èžåˆ&lt;/strong>ï¼ˆModel Merging, MMï¼‰ä½œä¸ºä¸€ç§æœ‰æ•ˆçš„çŸ¥è¯†è½¬ç§»æ–¹æ³•åº”è¿è€Œç”Ÿã€‚MMé€šè¿‡åˆå¹¶å¤šä¸ªç‹¬ç«‹å¾®è°ƒçš„ä»»åŠ¡ç‰¹å®šæ¨¡åž‹æ¥æž„å»ºä¸€ä¸ªèƒ½å¤Ÿå¤„ç†å¤šç§ä»»åŠ¡çš„å¢žå¼ºåž‹æ¨¡åž‹ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•å¯èƒ½å¼•å…¥å®‰å…¨é£Žé™©ï¼Œå°¤å…¶æ˜¯åŽé—¨æ”»å‡»ã€‚åŽé—¨æ”»å‡»å…è®¸æ”»å‡»è€…é€šè¿‡åœ¨è®­ç»ƒæ•°æ®ä¸­æ³¨å…¥æ¶æ„è§¦å‘å™¨æ¥ç ´åæœºå™¨å­¦ä¹ æ¨¡åž‹ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬é¦–æ¬¡æå‡ºäº†BadMergingï¼Œè¿™æ˜¯ä¸€ç§ä¸“é—¨é’ˆå¯¹æ¨¡åž‹èžåˆçš„åŽé—¨æ”»å‡»æ–¹æ³•ã€‚&lt;strong>BadMergingé€šè¿‡ä¸¤é˜¶æ®µæ”»å‡»æœºåˆ¶å’Œä¸€ç§æ–°é¢–çš„ç‰¹å¾æ’å€¼æŸå¤±å‡½æ•°ï¼Œå³ä½¿åœ¨åˆå¹¶å‚æ•°å˜åŒ–æ—¶ï¼Œä¹Ÿèƒ½å¢žå¼ºåµŒå…¥åŽé—¨çš„é²æ£’æ€§&lt;/strong>ã€‚æˆ‘ä»¬çš„æ–¹æ³•ä¸ä»…èƒ½å¤Ÿå¯¹æ”»å‡»è€…æä¾›çš„ä»»åŠ¡ï¼ˆon-task attackï¼‰è¿›è¡Œæ”»å‡»ï¼Œè¿˜èƒ½å¯¹å…¶ä»–è´¡çŒ®è€…æä¾›çš„ä»»åŠ¡ï¼ˆoff-task attackï¼‰è¿›è¡Œæ”»å‡»ã€‚å¹¿æ³›çš„å®žéªŒè¡¨æ˜Žï¼ŒBadMergingå¯¹å„ç§æ¨¡åž‹èžåˆç®—æ³•éƒ½å…·æœ‰æ˜¾è‘—çš„æ”»å‡»æ•ˆæžœï¼Œå¹¶ä¸”çŽ°æœ‰çš„é˜²å¾¡æœºåˆ¶æ— æ³•æœ‰æ•ˆé˜²å¾¡æˆ‘ä»¬çš„æ”»å‡»ï¼Œè¿™çªæ˜¾äº†éœ€è¦æ›´é«˜çº§é˜²å¾¡æœºåˆ¶çš„å¿…è¦æ€§ã€‚&lt;/p>
&lt;h2 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h2>
&lt;p>æ¨¡åž‹èžåˆï¼ˆMMï¼‰æ˜¯ä¸€ç§æ–°å…´çš„æŠ€æœ¯ï¼Œå®ƒé€šè¿‡åˆå¹¶å¤šä¸ªå¾®è°ƒåŽçš„ä»»åŠ¡ç‰¹å®šæ¨¡åž‹æ¥æé«˜æ¨¡åž‹åœ¨å¤šä¸ªä»»åŠ¡ä¸Šçš„æ€§èƒ½ã€‚è¿™ç§æ–¹æ³•çš„ä¼˜åŠ¿åœ¨äºŽèƒ½å¤Ÿåˆ©ç”¨å·²æœ‰çš„æ¨¡åž‹å’ŒçŸ¥è¯†ï¼Œå‡å°‘å­˜å‚¨æˆæœ¬å’Œè®¡ç®—èµ„æºï¼ŒåŒæ—¶æé«˜æ¨¡åž‹çš„é€šç”¨æ€§å’Œæ€§èƒ½ã€‚ MM ä¸éœ€è¦æ¥è‡ªå¤šä¸ªä»»åŠ¡çš„è®­ç»ƒæ•°æ®ï¼Œè€Œæ˜¯é€šè¿‡&lt;strong>åˆå¹¶æƒé‡&lt;/strong>æ¥ç»„åˆå¤šä¸ªç»è¿‡å¾®è°ƒçš„ç‰¹å®šäºŽä»»åŠ¡çš„æ¨¡åž‹ï¼Œè¿™äº›æ¨¡åž‹å…±äº«ç›¸åŒçš„æ¨¡åž‹æž¶æž„ã€‚
![[Pasted image 20241020172630.png]]
ç„¶è€Œï¼Œè¿™ç§åˆå¹¶è¿‡ç¨‹ä¹Ÿå¸¦æ¥äº†å®‰å…¨éšæ‚£ã€‚å¦‚æžœåˆå¹¶çš„æ¨¡åž‹ä¸­åŒ…å«äº†è¢«æ¶æ„ä¿®æ”¹çš„æ¨¡åž‹ï¼Œé‚£ä¹ˆæ•´ä¸ªåˆå¹¶åŽçš„æ¨¡åž‹å¯èƒ½ä¼šç»§æ‰¿è¿™äº›å®‰å…¨æ¼æ´žï¼Œä»Žè€Œå—åˆ°æ”»å‡»è€…çš„æŽ§åˆ¶ã€‚&lt;strong>å°½ç®¡æ¨¡åž‹èžåˆçš„å®žç”¨æ€§å·²ç»å¾—åˆ°äº†å¹¿æ³›è®¤å¯ï¼Œä½†å…¶å®‰å…¨æ€§é—®é¢˜å´é²œæœ‰ç ”ç©¶ã€‚&lt;/strong>&lt;/p>
&lt;p>ä¸Žç»å…¸åŽé—¨æ”»å‡»ä¸åŒï¼ŒMMä¸­å¯¹æ‰‹åªèƒ½è´¡çŒ®åˆå¹¶æ¨¡åž‹çš„ä¸€éƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªç‰¹å®šäºŽä»»åŠ¡çš„æ¨¡åž‹ï¼‰ï¼Œè€Œä¸”==ä¸èƒ½å®Œå…¨è®¿é—®åˆå¹¶è¿‡ç¨‹==ã€‚çŽ°æœ‰çš„åŽé—¨æ”»å‡»å°½ç®¡èƒ½å¤Ÿæœ‰æ•ˆåœ°å¯¹å•ä¸ªç‰¹å®šä»»åŠ¡æ¨¡åž‹è¿›è¡ŒåŽé—¨å¤„ç†ï¼Œä½†éƒ½æ— æ³•å¯¹åˆå¹¶æ¨¡åž‹è¿›è¡ŒåŽé—¨å¤„ç†ï¼ˆæ”»å‡»æˆåŠŸçŽ‡&amp;lt;20%ï¼‰ã€‚æˆ‘ä»¬å‘çŽ°è¿™æ˜¯&lt;strong>å› ä¸ºæ¯ä¸ªæ¨¡åž‹åœ¨åˆå¹¶è¿‡ç¨‹ä¸­éƒ½ä¼šé€šè¿‡å…¶åˆå¹¶ç³»æ•°é‡æ–°ç¼©æ”¾ï¼Œå¹¶ä¸”==å½“ç³»æ•°å°æ—¶åŽé—¨ä¼šæ¶ˆå¤±&lt;/strong>==&lt;/p>
&lt;p>BadMergingçš„å…³é”®æ€æƒ³æ˜¯&lt;strong>è®¾è®¡ä¸€ç§ä¸Žåˆå¹¶ç³»æ•°å˜åŒ–æ— å…³çš„åŽé—¨æœºåˆ¶&lt;/strong>ã€‚&lt;/p>
&lt;p>BadMerging è¿›ä¸€æ­¥å¼•å…¥äº†&lt;strong>on-taskå’Œoff-task&lt;/strong>åŽé—¨æ”»å‡»çš„æ¦‚å¿µã€‚on-taskæ”»å‡»ä¼šç»™æ”»å‡»è€…æä¾›çš„ä»»åŠ¡åŠ å…¥åŽé—¨ï¼Œè€Œoff-taskæ”»å‡»åˆ™ä¼šç»™ç”±å…¶ä»–ï¼ˆè‰¯æ€§ï¼‰æ¨¡åž‹æä¾›è€…æä¾›çš„ä»»åŠ¡åŠ å…¥åŽé—¨ã€‚è¿™äº›æ”»å‡»æ¶µç›–äº†MMçš„æ‰€æœ‰åº”ç”¨åœºæ™¯ã€‚åœ¨off-taskæ”»å‡»ä¸­ï¼Œç”±äºŽå¯¹æ‰‹å¯èƒ½ä¸çŸ¥é“å°†åˆå¹¶å“ªäº›ä»»åŠ¡ï¼ŒBadMerging æ—¨åœ¨å°†è§¦å‘å›¾åƒåˆ†ç±»ä¸ºå¯¹æ‰‹ä¸ºåŒ…å«æ­¤ç±»çš„ä»»ä½•ä»»åŠ¡é€‰æ‹©çš„ç±»ã€‚&lt;/p>
&lt;h2 id="ç›¸å…³å·¥ä½œ">ç›¸å…³å·¥ä½œ&lt;/h2>
&lt;h3 id="é¢„è®­ç»ƒæ¨¡åž‹">é¢„è®­ç»ƒæ¨¡åž‹&lt;/h3>
&lt;p>æ‰€æœ‰çŽ°æœ‰çš„æ¨¡åž‹åˆå¹¶å·¥ä½œéƒ½æ˜¯åœ¨ç±»ä¼¼ &lt;strong>CLIP&lt;/strong> çš„é¢„è®­ç»ƒæ¨¡åž‹ä¸Šè¿›è¡Œçš„
&lt;strong>CLIP&lt;/strong> æ˜¯ä¸€ä¸ªè”åˆçš„å›¾åƒå’Œæ–‡æœ¬åµŒå…¥æ¨¡åž‹ï¼Œé€šè¿‡ 4 äº¿ä¸ªå›¾åƒå’Œæ–‡æœ¬å¯¹ä»¥è‡ªç›‘ç£çš„æ–¹å¼è¿›è¡Œè®­ç»ƒã€‚è¿™æ„å‘³ç€å®ƒå°†æ–‡æœ¬å’Œå›¾åƒæ˜ å°„åˆ°åŒä¸€ä¸ªåµŒå…¥ç©ºé—´ä¸­ã€‚ä¾‹å¦‚ï¼Œä¸€å¼ ç‹—çš„å›¾ç‰‡å’Œå¥å­â€œä¸€å¼ ç‹—çš„å›¾ç‰‡â€å°†å…·æœ‰éžå¸¸ç›¸ä¼¼çš„åµŒå…¥ï¼Œå¹¶åœ¨å‘é‡ç©ºé—´ä¸­å½¼æ­¤æŽ¥è¿‘ã€‚
&lt;strong>CLIP&lt;/strong>æ¨¡åž‹é€šè¿‡è®¡ç®—æ–‡æœ¬å’Œå›¾åƒå‘é‡ä¹‹é—´çš„ä½™å¼¦ç›¸ä¼¼åº¦æ¥ç”Ÿæˆé¢„æµ‹ã€‚è¿™ç§æ¨¡åž‹ç‰¹åˆ«é€‚ç”¨äºŽé›¶æ ·æœ¬å­¦ä¹ ä»»åŠ¡ï¼Œå³æ¨¡åž‹ä¸éœ€è¦çœ‹åˆ°æ–°çš„å›¾åƒæˆ–æ–‡æœ¬çš„è®­ç»ƒç¤ºä¾‹å°±èƒ½è¿›è¡Œé¢„æµ‹
CLIP $\mathcal{M}$åŒ…æ‹¬è§†è§‰ç¼–ç å™¨$\mathcal{V}$ å’Œæ–‡æœ¬ç¼–ç å™¨$T$,å½“è®¡ç®—ä¸€ä¸ªè¾“å…¥$x$åœ¨ç›®æ ‡ç±»åž‹ç©ºé—´$C$ä¸­çš„å¾—åˆ†:
$$\mathcal{M}(x, C)=\left[\left\langle\mathcal{V}(x), \mathcal{T}\left(c_{1}\right)\right\rangle, \cdots,\left\langle\mathcal{V}(x), \mathcal{T}\left(c_{k}\right)\right\rangle\right]^{\top}$$
å¾®è°ƒCLIPæ—¶ï¼Œä½¿ç”¨äº¤å‰ç†µå‡½æ•°æ¥ä¼˜åŒ–æ¨¡åž‹æƒé‡ï¼Œå…¶ä¸­$y$æ˜¯çœŸå®žæ ‡ç­¾:
$$Loss(\mathcal{M}(x,C),y)$$&lt;/p>
&lt;h3 id="æ¨¡åž‹åˆå¹¶">æ¨¡åž‹åˆå¹¶&lt;/h3>
&lt;p>$$\theta = \theta &lt;em>{pre} + \lambda {\textstyle \sum&lt;/em>{i=1}^{n}} \theta _{i}$$&lt;/p>
&lt;h2 id="æ–¹æ¡ˆè®¾è®¡">æ–¹æ¡ˆè®¾è®¡&lt;/h2>
&lt;p>![[Pasted image 20241018105016.png]]
å‡è®¾ä¸€ä¸ªåˆå¹¶æ¨¡åž‹çš„ç»“æž„å¦‚ä¸‹:
$$\begin{aligned}\theta_{\text {merged }} &amp;amp; =\theta_{\text {pre }}+\sum_{i \neq \text { adv }} \lambda_{i} \cdot \Delta \theta_{i}+\lambda_{\mathrm{adv}} \cdot \Delta \theta_{\mathrm{adv}} \&amp;amp; =\theta_{\text {pre }}+\Delta \theta_{\mathrm{benign}}+\lambda_{\mathrm{adv}} \cdot \Delta \theta_{\mathrm{adv}}\end{aligned}$$
BadMergingæ”»å‡»æ¡†æž¶åŒ…å«ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼šæ”»å‡»æœºåˆ¶è®¾è®¡å’Œç‰¹å¾æ’å€¼æŸå¤±å‡½æ•°ã€‚&lt;/p>
&lt;ol>
&lt;li>&lt;strong>ä¸¤é˜¶æ®µæ”»å‡»æœºåˆ¶&lt;/strong>ï¼šBadMergingé¦–å…ˆåœ¨ç¬¬ä¸€é˜¶æ®µç”Ÿæˆä¸€ä¸ªé€šç”¨è§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨èƒ½å¤Ÿåœ¨åˆå¹¶å‚æ•°ä¸º0æ—¶æ¿€æ´»åŽé—¨ã€‚ç„¶åŽåœ¨ç¬¬äºŒé˜¶æ®µï¼Œæ”»å‡»è€…ä½¿ç”¨è¿™ä¸ªè§¦å‘å™¨æ¥å¾®è°ƒå…¶ä»»åŠ¡ç‰¹å®šæ¨¡åž‹ï¼Œç¡®ä¿åœ¨åˆå¹¶å‚æ•°ä¸º1æ—¶æ”»å‡»æœ‰æ•ˆã€‚è¿™æ ·ï¼Œæ”»å‡»åœ¨åˆå¹¶å‚æ•°ä»Ž0åˆ°1çš„ä»»ä½•å€¼ä¸‹éƒ½èƒ½ä¿æŒæœ‰æ•ˆã€‚&lt;/li>
&lt;li>&lt;strong>ç‰¹å¾æ’å€¼æŸå¤±å‡½æ•°&lt;/strong>ï¼šä¸ºäº†å¢žå¼ºè§¦å‘å™¨åœ¨ä¸åŒåˆå¹¶å‚æ•°ä¸‹çš„é²æ£’æ€§ï¼Œæå‡ºäº†ä¸€ç§æ–°é¢–çš„ç‰¹å¾æ’å€¼æŸå¤±å‡½æ•°ã€‚è¯¥æŸå¤±å‡½æ•°é€šè¿‡æ’å€¼è§¦å‘å™¨å›¾åƒçš„ç‰¹å¾ï¼Œå¼ºåˆ¶æ¨¡åž‹åœ¨ä¸åŒåˆå¹¶å‚æ•°ä¸‹éƒ½å°†è§¦å‘å™¨å›¾åƒåˆ†ç±»ä¸ºç›®æ ‡ç±»åˆ«ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="on-task">on-task&lt;/h3>
&lt;p>ç›®æ ‡ä»»åŠ¡ä¸Žæ”»å‡»è€…ä»»åŠ¡ç›¸åŒã€‚æ¯”å¦‚è¯´æ”»å‡»è€…çš„æ¨¡åž‹ä»»åŠ¡æ˜¯çŒ«ç‹—è¯†åˆ«ï¼ŒåŽé—¨å°±æ˜¯å°†çŒ«è¯†åˆ«ä¸ºðŸ–ã€‚BadMerging-On ç›®çš„æ˜¯&lt;strong>è¿«ä½¿æœ€ç»ˆçš„åˆå¹¶æ¨¡åž‹åœ¨æ‰§è¡Œæ”»å‡»è€…ä»»åŠ¡æ—¶æŒ‰ç…§æ”»å‡»è€…çš„æ„æ„¿è¡Œäº‹&lt;/strong>
è¿™é‡Œå‡è®¾ä¸¤ä¸ªåœºæ™¯:ï¼ˆ1ï¼‰ å¤šä»»åŠ¡å­¦ä¹ åœºæ™¯æ„å‘³ç€åˆå¹¶æ¥è‡ªä¸åŒé¢†åŸŸçš„ä»»åŠ¡å‘é‡ä»¥è¿›è¡Œå¤šä»»åŠ¡å­¦ä¹ ï¼ˆ2ï¼‰å•ä»»åŠ¡å­¦ä¹ åœºæ™¯æ„å‘³ç€åˆå¹¶æ¥è‡ªåŒä¸€é¢†åŸŸçš„ä»»åŠ¡å‘é‡ä»¥æé«˜æ•ˆç”¨&lt;/p>
&lt;ul>
&lt;li>Step1: ä¼˜åŒ–é€šç”¨è§¦å‘å™¨ï¼Œè¯¥è§¦å‘å™¨èƒ½å¤Ÿåœ¨åˆå¹¶å‚æ•°ä¸º0æ—¶æ¿€æ´»åŽé—¨ã€‚$\lambda_{adv}=0$ æ—¶æŸå¤±å‡½æ•°å¦‚ä¸‹:
$$\underset{t}{\arg \min } \sum_{x \in \mathcal{D}&lt;em>{\mathrm{tgt}}} \mathcal{L}&lt;/em>{C E}\left[\mathcal{M}&lt;em>{\left(\theta&lt;/em>{\mathrm{pre}}+\Delta \theta_{\text {benign }}\right)}\left(x \oplus t, C_{\mathrm{tgt}}\right),c\right]$$
ä½œè€…è§‚å¯Ÿåˆ°ä¸åŒä»»åŠ¡çš„ä»»åŠ¡å‘é‡æ˜¯æ­£äº¤çš„ã€‚ç”±äºŽæ”»å‡»è€…ä¸çŸ¥é“$\Delta \theta_{benign }$ ï¼Œå¯ä»¥ä½¿ç”¨$\theta_{pre}$ æ¥ä»£æ›¿ã€‚
$$\underset{t}{\arg \min } \sum_{x \in \mathcal{D}&lt;em>{\mathrm{tgt}}} \mathcal{L}&lt;/em>{C E}\left[\mathcal{M}&lt;em>{\theta&lt;/em>{\mathrm{pre}}}\left(x \oplus t, C_{\mathrm{tgt}}\right), c\right]$$&lt;/li>
&lt;li>Step2: å¾®è°ƒå…¶ä»»åŠ¡ç‰¹å®šæ¨¡åž‹ï¼Œç¡®ä¿åœ¨åˆå¹¶å‚æ•°ä¸º1æ—¶æ”»å‡»æœ‰æ•ˆã€‚$\lambda_{adv}=1$ æ—¶æŸå¤±å‡½æ•°å¦‚ä¸‹ï¼š
$$\frac{1}{\left|\mathcal{D}&lt;em>{\mathrm{adv}}\right|} \sum&lt;/em>{(x, y) \in \mathcal{D}&lt;em>{\mathrm{adv}}}\left[\mathcal{L}&lt;/em>{C E}\left(\mathcal{M}&lt;em>{\theta&lt;/em>{\mathrm{adv}}}\left(x, C_{\mathrm{adv}}\right), y\right)+\alpha \cdot \mathcal{L}&lt;em>{B D}(x, c, t)\right]$$
çŽ°åœ¨æ¨¡åž‹åœ¨ç³»æ•°ä¸º0å’Œ1æ—¶å¯ä»¥è§¦å‘åŽé—¨ï¼Œä½†æ˜¯æœ‰çš„ä¸­é—´å€¼ä¸èƒ½è§¦å‘åŽé—¨ã€‚æ‰€ä»¥å¼•å…¥æ’å€¼æŸå¤±å‡½æ•°:
$$\begin{array}{l}F=p \cdot \mathcal{V}&lt;/em>{\theta_{\text {adv }}}(x \oplus t)+(1-p) \cdot \mathcal{V}&lt;em>{\theta&lt;/em>{\mathrm{pre}}}(x \oplus t), \\mathcal{L}&lt;em>{B D}(x, c, t)=\mathcal{L}&lt;/em>{C E}\left(\left[\left\langle F, \mathcal{T}\left(c_{1}\right)\right\rangle, \cdots,\left\langle F, \mathcal{T}\left(c_{k}\right)\right\rangle\right]^{\top}, c\right) .\end{array}$$
å¯¹äºŽ Î»adv = 1ï¼Œæˆ‘ä»¬ä½¿ç”¨ MÎ¸adv çš„è§†è§‰ç¼–ç å™¨æå–çš„ç‰¹å¾æ¥è¿‘ä¼¼åˆå¹¶æ¨¡åž‹çš„ç‰¹å¾ã€‚å¯¹äºŽ Î»adv = 0ï¼Œç”±äºŽå¯¹æ‰‹ä¸çŸ¥é“ Î”Î¸benignï¼Œæˆ‘ä»¬ä½¿ç”¨ MÎ¸pre çš„è§†è§‰ç¼–ç å™¨æå–çš„ç‰¹å¾æ¥è¿‘ä¼¼åˆå¹¶æ¨¡åž‹çš„ç‰¹å¾ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="off-task">off-task&lt;/h3>
&lt;p>ç›®æ ‡ä»»åŠ¡ä¸Žæ”»å‡»è€…ä»»åŠ¡ä¸åŒã€‚å‡è®¾æ”»å‡»è€…ä»»åŠ¡æ˜¯CIFAR100ï¼Œç›®æ ‡ä»»åŠ¡æ˜¯Cars196ï¼Œå…¶ä¸­åŒ…å«ä¸€ä¸ªç›®æ ‡ç±»â€œAcura RLâ€ã€‚ç”±äºŽæ”»å‡»è€…ä¸çŸ¥é“ç›®æ ‡ä»»åŠ¡ï¼Œå› æ­¤ä»–ä»¬ä¸çŸ¥é“å…¶ä¸­çš„å…¶ä»–ç±»åˆ«ï¼Œä¾‹å¦‚â€œBMW X3â€ã€‚ä»–ä»¬åªçŸ¥é“ç›®æ ‡ç±»åˆ«å¹¶æ‹¥æœ‰è¯¥ç±»åˆ«çš„ä¸€äº›å‚è€ƒå›¾åƒï¼ˆä¾‹å¦‚â€œAcura RLâ€çš„ä¸€äº›å›¾åƒï¼‰ã€‚&lt;/p>
&lt;ul>
&lt;li>å½±å­ç±»åž‹ã€‚åœ¨æ— æ³•è®¿é—®ç›®æ ‡ä»»åŠ¡ Ctgt çš„ç±»çš„æƒ…å†µä¸‹ï¼Œåœ¨å¼€æ”¾ä¸–ç•Œä¸­éšæœºé‡‡æ ·å¯èƒ½ä¸Žç›®æ ‡ä»»åŠ¡æ— å…³çš„ç±»ã€‚&lt;/li>
&lt;li>æ•°æ®å¢žå¼ºå¤„ç†ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="å®žéªŒç»“æžœ">å®žéªŒç»“æžœ&lt;/h2>
&lt;p>æˆ‘ä»¬çš„å®žéªŒè®¾è®¡åŒ…æ‹¬äº†å¤šç§æ¨¡åž‹èžåˆç®—æ³•ï¼Œä»¥åŠä¸ŽçŽ°æœ‰åŽé—¨æ”»å‡»æ–¹æ³•çš„æ¯”è¾ƒã€‚å®žéªŒç»“æžœè¡¨æ˜Žï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>æ”»å‡»æ•ˆæžœ&lt;/strong>ï¼šBadMergingåœ¨å¤šç§æ¨¡åž‹èžåˆç®—æ³•ä¸‹éƒ½èƒ½å®žçŽ°é«˜è¾¾90%ä»¥ä¸Šçš„æ”»å‡»æˆåŠŸçŽ‡ï¼Œæ˜¾è‘—ä¼˜äºŽçŽ°æœ‰æ–¹æ³•ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>é˜²å¾¡æœºåˆ¶è¯„ä¼°&lt;/strong>ï¼šæˆ‘ä»¬è¯„ä¼°äº†çŽ°æœ‰çš„æ£€æµ‹å’Œé˜²å¾¡æœºåˆ¶ï¼ŒåŒ…æ‹¬Neural Cleanseå’ŒFine-pruningï¼Œç»“æžœè¡¨æ˜Žè¿™äº›æœºåˆ¶æ— æ³•æœ‰æ•ˆé˜²å¾¡BadMergingæ”»å‡»ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="è‡ªå·±æ€è€ƒ">è‡ªå·±æ€è€ƒ&lt;/h2>
&lt;p>&lt;strong>ä¼˜ç‚¹&lt;/strong>ï¼š&lt;/p>
&lt;ul>
&lt;li>BadMergingæ˜¯é¦–ä¸ªé’ˆå¯¹æ¨¡åž‹èžåˆçš„åŽé—¨æ”»å‡»æ¡†æž¶ï¼Œå¡«è¡¥äº†è¯¥é¢†åŸŸçš„ç ”ç©¶ç©ºç™½ã€‚&lt;/li>
&lt;li>é€šè¿‡ä¸¤é˜¶æ®µæ”»å‡»æœºåˆ¶å’Œç‰¹å¾æ’å€¼æŸå¤±å‡½æ•°ï¼ŒBadMergingå±•ç¤ºäº†å¯¹ä¸åŒåˆå¹¶å‚æ•°çš„é²æ£’æ€§ã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>ç¼ºç‚¹&lt;/strong>ï¼š&lt;/p>
&lt;ul>
&lt;li>BadMergingéœ€è¦å¯¹æ”»å‡»è€…çš„ä»»åŠ¡ç‰¹å®šæ¨¡åž‹è¿›è¡Œå¾®è°ƒï¼Œè¿™å¯èƒ½éœ€è¦è¾ƒå¤§çš„è®¡ç®—èµ„æºã€‚&lt;/li>
&lt;li>è®ºæ–‡ä¸­æ²¡æœ‰è¯¦ç»†è®¨è®ºæ”»å‡»åœ¨ä¸åŒè§„æ¨¡å’Œå¤æ‚åº¦çš„æ¨¡åž‹ä¸Šçš„æ•ˆæžœã€‚&lt;/li>
&lt;/ul>
&lt;p>&lt;strong>æœªæ¥æ”¹è¿›çš„æ–¹å‘&lt;/strong>ï¼š&lt;/p>
&lt;ul>
&lt;li>æŽ¢ç´¢åœ¨æ›´å¤§è§„æ¨¡çš„æ•°æ®é›†å’Œæ¨¡åž‹ä¸Šçš„æ”»å‡»æ•ˆæžœï¼Œä»¥åŠå¦‚ä½•ä¼˜åŒ–æ”»å‡»ç­–ç•¥ä»¥å‡å°‘èµ„æºæ¶ˆè€—ã€‚&lt;/li>
&lt;li>ç ”ç©¶å¦‚ä½•ç»“åˆå¤šç§é˜²å¾¡æœºåˆ¶æ¥æé«˜æ¨¡åž‹èžåˆçš„å®‰å…¨æ€§ã€‚&lt;/li>
&lt;li>è€ƒè™‘å®žé™…éƒ¨ç½²åœºæ™¯ï¼Œç ”ç©¶å¦‚ä½•åœ¨ä¸ç‰ºç‰²å¤ªå¤šæ€§èƒ½çš„æƒ…å†µä¸‹æé«˜æ¨¡åž‹çš„é²æ£’æ€§ã€‚&lt;/li>
&lt;/ul>
&lt;h2 id="idea-å¤šæºæ¨¡åž‹ç‰ˆæƒä¿æŠ¤">idea: å¤šæºæ¨¡åž‹ç‰ˆæƒä¿æŠ¤ã€‚&lt;/h2>
&lt;p>åœ¨æ¨¡åž‹èžåˆè¿‡ç¨‹ä¸­ï¼Œå…³æ³¨æ¯ä¸ªèžåˆæ¨¡åž‹çš„ç‰ˆæƒã€‚æ¯”å¦‚a + b + cã€‚æ¯ä¸ªæ¨¡åž‹æ‰€æœ‰è€…çš„ç‰ˆæƒéƒ½èƒ½æŸ¥åˆ°ã€‚
&lt;strong>å¯èƒ½çš„æŒ‘æˆ˜&lt;/strong>ï¼š 1. ç‰ˆæƒå†²çª a / b / c åŽé—¨æ°´å°å†²çª
2. æ°´å°å®¹é‡
3.&lt;/p>
&lt;h1 id="ccs24-neural-dehydration-effective-erasure-of-black-box-watermarks-from-dnns-with-limited-data">CCS'24 Neural Dehydration: Effective Erasure of Black-box Watermarks from DNNs with Limited Data&lt;/h1>
&lt;h2 id="æ‘˜è¦-1">æ‘˜è¦&lt;/h2>
&lt;p>æœ¬æ–‡æå‡ºäº†ä¸€ç§åä¸ºâ€œNeural Dehydrationâ€ï¼ˆç®€ç§°Dehydraï¼‰çš„æ–°åž‹æ”»å‡»æ¡†æž¶ï¼Œæ—¨åœ¨æœ‰æ•ˆç§»é™¤æ·±åº¦ç¥žç»ç½‘ç»œï¼ˆDNNï¼‰ä¸­çš„é»‘ç›’æ°´å°ã€‚é»‘ç›’æ°´å°æ˜¯ä¸€ç§ä¿æŠ¤DNNçŸ¥è¯†äº§æƒçš„æŠ€æœ¯ï¼Œé€šè¿‡åœ¨ç‰¹å®šæ ·æœ¬é›†ä¸ŠåµŒå…¥æ°´å°ä¿¡æ¯ï¼Œå¹¶åœ¨ç–‘ä¼¼æ¨¡åž‹ä¸­æå–æ°´å°ä»¥éªŒè¯æ‰€æœ‰æƒã€‚çŽ°æœ‰çš„æ°´å°ç§»é™¤æ”»å‡»é€šå¸¸éœ€è¦å¤§é‡æ•°æ®æˆ–å¯¹æ°´å°ç»“æž„æœ‰å…ˆéªŒçŸ¥è¯†ï¼Œä½†è¿™äº›æ”»å‡»å¾€å¾€åªèƒ½ç ´è§£ä¸€å°éƒ¨åˆ†ä¸»æµé»‘ç›’æ°´å°ï¼Œä¸”å¯èƒ½æŸå®³æ¨¡åž‹æ•ˆç”¨æˆ–ä¾èµ–äºŽå¤§é‡æ•°æ®ã€‚Dehydraé€šè¿‡åˆ©ç”¨DNNçš„å†…éƒ¨ç»“æž„æ¥æ¢å¤å’Œå¿˜å´æ°´å°ä¿¡æ¯ï¼Œæœ‰æ•ˆç§»é™¤äº†æ‰€æœ‰åç§ä¸»æµé»‘ç›’æ°´å°ï¼Œä¸”åªéœ€æœ‰é™æˆ–ç”šè‡³ä¸éœ€è¦æ•°æ®ã€‚å…·ä½“æ¥è¯´ï¼ŒDehydraé¦–å…ˆä½¿ç”¨æ¨¡åž‹åæ¼”æŠ€æœ¯æ¢å¤æŽ¥è¿‘çœŸå®žæ°´å°æ•°æ®çš„æ ·æœ¬ï¼Œç„¶åŽåœ¨å¾®è°ƒè¿‡ç¨‹ä¸­æ•…æ„å¿˜å´è¿™äº›æ ·æœ¬ã€‚æ­¤å¤–ï¼ŒDehydraè¿˜å¼•å…¥äº†ç›®æ ‡ç±»åˆ«æ£€æµ‹å’Œæ¢å¤æ ·æœ¬åˆ†å‰²ç®—æ³•ï¼Œä»¥å‡å°‘æ•ˆç”¨æŸå¤±å¹¶å®žçŽ°æ— æ•°æ®æ°´å°ç§»é™¤ã€‚åœ¨ä¸‰ä¸ªåŸºå‡†æ•°æ®é›†å’ŒDNNæž¶æž„ä¸Šçš„å¹¿æ³›è¯„ä¼°è¡¨æ˜Žï¼ŒDehydraåœ¨æ•°æ®æœ‰é™çš„è®¾ç½®ä¸‹ï¼Œè‡³å°‘ä¿ç•™äº†90%çš„æ¨¡åž‹æ•ˆç”¨ï¼ŒåŒæ—¶å®žçŽ°äº†å¯¹æ‰€æœ‰è¦†ç›–æ°´å°çš„å¼ºæ•ˆç§»é™¤æ•ˆæžœã€‚&lt;/p>
&lt;h2 id="èƒŒæ™¯-1">èƒŒæ™¯&lt;/h2>
&lt;p>éšç€æ·±åº¦å­¦ä¹ æŠ€æœ¯çš„å¿«é€Ÿå‘å±•ï¼Œè®­ç»ƒä¸€ä¸ªé«˜æ€§èƒ½çš„DNNæ¨¡åž‹å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚ç„¶è€Œï¼Œæ¨¡åž‹è®­ç»ƒéœ€è¦å¤§é‡çš„æ•°æ®æ”¶é›†å’Œè®¡ç®—èµ„æºã€‚ä¸ºäº†ä¿æŠ¤è¿™äº›è®­ç»ƒå¥½çš„æ¨¡åž‹ä¸è¢«éžæ³•å¤åˆ¶æˆ–æ»¥ç”¨ï¼Œæ¨¡åž‹æ°´å°æŠ€æœ¯åº”è¿è€Œç”Ÿã€‚æ°´å°æŠ€æœ¯é€šè¿‡åœ¨æ¨¡åž‹è®­ç»ƒè¿‡ç¨‹ä¸­åµŒå…¥ç‰¹å®šçš„ä¿¡æ¯ï¼Œä½¿å¾—åœ¨æ¨¡åž‹è¢«éžæ³•ä½¿ç”¨æ—¶èƒ½å¤Ÿè¿½è¸ªåˆ°åŽŸå§‹æ‰€æœ‰è€…ã€‚é»‘ç›’æ°´å°å› å…¶éªŒè¯è¿‡ç¨‹åªéœ€APIè®¿é—®è€Œå—åˆ°å¹¿æ³›å…³æ³¨ã€‚ç„¶è€Œï¼ŒçŽ°æœ‰çš„æ°´å°æŠ€æœ¯é¢ä¸´ç€è¢«æ”»å‡»è€…ç§»é™¤çš„é£Žé™©ï¼Œæ”»å‡»è€…å¯èƒ½ä¼šé€šè¿‡ä¿®æ”¹æ¨¡åž‹å‚æ•°æ¥ä½¿æ°´å°å¤±æ•ˆã€‚å°½ç®¡å·²æœ‰ç ”ç©¶æå‡ºäº†å¤šç§æ°´å°ç§»é™¤æ”»å‡»ï¼Œä½†è¿™äº›æ”»å‡»å¾€å¾€éœ€è¦å¤§é‡æ•°æ®æˆ–å¯¹æ°´å°ç»“æž„æœ‰æ·±å…¥äº†è§£ï¼Œè¿™åœ¨å®žé™…åœºæ™¯ä¸­æ˜¯ä¸çŽ°å®žçš„ã€‚å› æ­¤ï¼Œæœ¬æ–‡æå‡ºäº†ä¸€ç§æ— éœ€æ•°æ®æˆ–åªéœ€æœ‰é™æ•°æ®çš„æ°´å°ç§»é™¤æ”»å‡»æ–¹æ³•ï¼Œæ—¨åœ¨æé«˜æ”»å‡»çš„å®žç”¨æ€§å’Œæœ‰æ•ˆæ€§ã€‚&lt;/p>
&lt;h2 id="ç›¸å…³å·¥ä½œ-1">ç›¸å…³å·¥ä½œ&lt;/h2>
&lt;p>åœ¨DNNæ¨¡åž‹æ°´å°é¢†åŸŸï¼Œå·²æœ‰å¤šç§æ°´å°åµŒå…¥å’Œæå–æŠ€æœ¯è¢«æå‡ºã€‚è¿™äº›æŠ€æœ¯ä¸»è¦åˆ†ä¸ºç™½ç›’æ°´å°å’Œé»‘ç›’æ°´å°ä¸¤å¤§ç±»ã€‚ç™½ç›’æ°´å°éœ€è¦å¯¹æ¨¡åž‹å†…éƒ¨å‚æ•°è¿›è¡Œè®¿é—®ï¼Œè€Œé»‘ç›’æ°´å°åˆ™åªéœ€é€šè¿‡æ¨¡åž‹çš„é¢„æµ‹è¡Œä¸ºè¿›è¡ŒéªŒè¯ã€‚æ­¤å¤–ï¼Œé’ˆå¯¹æ°´å°çš„å®‰å…¨æ€§ï¼Œç ”ç©¶è€…ä»¬è¿˜æå‡ºäº†å¤šç§æ”»å‡»æ–¹æ³•ï¼ŒåŒ…æ‹¬åŸºäºŽå‰ªæžã€å¾®è°ƒå’Œåå­¦ä¹ çš„æ”»å‡»ã€‚è¿™äº›æ”»å‡»æ–¹æ³•è¯•å›¾é€šè¿‡ä¿®æ”¹æ¨¡åž‹å‚æ•°æˆ–è®­ç»ƒæ•°æ®æ¥ç§»é™¤æ°´å°ï¼Œä½†å®ƒä»¬é€šå¸¸éœ€è¦å¤§é‡æ•°æ®æˆ–å¯¹æ°´å°ç®—æ³•æœ‰å…ˆéªŒçŸ¥è¯†ã€‚æœ€è¿‘ï¼Œä¸€äº›ç ”ç©¶å¼€å§‹å…³æ³¨åœ¨æ•°æ®å—é™æ¡ä»¶ä¸‹çš„æ°´å°ç§»é™¤é—®é¢˜ï¼Œæå‡ºäº†ä¸€äº›æ–°çš„æ”»å‡»ç­–ç•¥ã€‚ç„¶è€Œï¼Œè¿™äº›æ–¹æ³•åœ¨å®žé™…åº”ç”¨ä¸­ä»å­˜åœ¨å±€é™æ€§ï¼Œå¦‚æ”»å‡»æ•ˆæžœä¸ä½³æˆ–å¯¹æ•°æ®çš„ä¾èµ–æ€§ä»ç„¶è¾ƒé«˜ã€‚æœ¬æ–‡æå‡ºçš„Dehydraæ–¹æ³•æ­£æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œé€šè¿‡åˆ©ç”¨æ¨¡åž‹å†…éƒ¨ä¿¡æ¯æ¥å®žçŽ°æœ‰æ•ˆçš„æ°´å°ç§»é™¤ï¼ŒåŒæ—¶å‡å°‘å¯¹å¤–éƒ¨æ•°æ®çš„ä¾èµ–ã€‚&lt;/p>
&lt;h2 id="æ–¹æ¡ˆè®¾è®¡-1">æ–¹æ¡ˆè®¾è®¡&lt;/h2>
&lt;p>![[Pasted image 20241018115506.png]]
Dehydraæ”»å‡»æ¡†æž¶ä¸»è¦åŒ…å«ä¸¤ä¸ªé˜¶æ®µï¼š&lt;strong>æ°´å°æ¢å¤å’Œæ°´å°å¿˜å´&lt;/strong>ã€‚åœ¨æ°´å°æ¢å¤é˜¶æ®µï¼ŒDehydraä½¿ç”¨æ¨¡åž‹åæ¼”æŠ€æœ¯ä»Žç›®æ ‡æ°´å°æ¨¡åž‹ä¸­æ¢å¤å‡ºæŽ¥è¿‘çœŸå®žæ°´å°æ•°æ®çš„æ ·æœ¬ã€‚è¿™ä¸€é˜¶æ®µåˆ©ç”¨äº†DNNçš„è¿‡å‚æ•°åŒ–ç‰¹æ€§ï¼Œé€šè¿‡ä¼˜åŒ–æŠ€æœ¯é‡å»ºä¸Žç›®æ ‡ç±»åˆ«ç›¸å…³è”çš„æ°´å°ä¿¡æ¯ã€‚åœ¨æ°´å°å¿˜å´é˜¶æ®µï¼ŒDehydraåœ¨å¾®è°ƒè¿‡ç¨‹ä¸­æ•…æ„å¿˜å´è¿™äº›æ¢å¤å‡ºçš„æ ·æœ¬ï¼Œä»¥æ­¤æ¥ç§»é™¤æ°´å°ã€‚ä¸ºäº†æé«˜æ”»å‡»çš„æœ‰æ•ˆæ€§å’Œå‡å°‘å¯¹æ•°æ®çš„ä¾èµ–ï¼ŒDehydraè¿›ä¸€æ­¥å¼•å…¥äº†ç›®æ ‡ç±»åˆ«æ£€æµ‹å’Œæ¢å¤æ ·æœ¬åˆ†å‰²ç®—æ³•ã€‚ç›®æ ‡ç±»åˆ«æ£€æµ‹ç®—æ³•é€šè¿‡åˆ†æžæ¨¡åž‹çš„æŸå¤±æ™¯è§‚æ¥è¯†åˆ«å›ºå®šç±»åˆ«çš„æ°´å°ï¼Œå¹¶æ£€æµ‹å…¶ç›®æ ‡ç±»åˆ«ã€‚æ¢å¤æ ·æœ¬åˆ†å‰²ç®—æ³•åˆ™åŸºäºŽæ­£å¸¸æ•°æ®ä¼˜åŠ¿çŽ°è±¡ï¼Œå°†æ¢å¤æ ·æœ¬åˆ†å‰²ä¸ºä»£ç†æ°´å°æ•°æ®å’Œä»£ç†æ­£å¸¸æ•°æ®ï¼Œä»¥ç¡®ä¿åœ¨ç§»é™¤æ°´å°çš„åŒæ—¶ä¿æŒæ¨¡åž‹çš„åŽŸå§‹æ•ˆç”¨ã€‚Dehydraçš„è¿™äº›è®¾è®¡ä½¿å…¶èƒ½å¤Ÿåœ¨æ•°æ®å—é™çš„æ¡ä»¶ä¸‹å®žçŽ°æœ‰æ•ˆçš„æ°´å°ç§»é™¤ã€‚&lt;/p>
&lt;h2 id="å®žéªŒç»“æžœ-1">å®žéªŒç»“æžœ&lt;/h2>
&lt;p>å®žéªŒéƒ¨åˆ†é¦–å…ˆä»‹ç»äº†å®žéªŒçš„è®¾è®¡ï¼ŒåŒ…æ‹¬ä½¿ç”¨çš„æ•°æ®é›†ã€DNNæž¶æž„ã€æ°´å°ç®—æ³•å’Œæ”»å‡»æ–¹æ³•ã€‚ä½œä¸ºåŸºçº¿çš„æ”»å‡»æ–¹æ³•åŒ…æ‹¬å‰ªæžã€å¾®è°ƒå’Œåå­¦ä¹ ç­‰ã€‚å®žéªŒç»“æžœè¡¨æ˜Žï¼ŒDehydraåœ¨æ•°æ®æœ‰é™çš„è®¾ç½®ä¸‹ï¼Œèƒ½å¤Ÿå®žçŽ°å¯¹æ‰€æœ‰åç§ä¸»æµé»‘ç›’æ°´å°çš„å¼ºæ•ˆç§»é™¤ï¼ŒåŒæ—¶è‡³å°‘ä¿ç•™äº†90%çš„æ¨¡åž‹æ•ˆç”¨ã€‚ä¸ŽçŽ°æœ‰æ”»å‡»æ–¹æ³•ç›¸æ¯”ï¼ŒDehydraåœ¨ç§»é™¤æ°´å°æ–¹é¢è¡¨çŽ°å‡ºæ›´é«˜çš„æœ‰æ•ˆæ€§ï¼Œä¸”å¯¹æ¨¡åž‹æ•ˆç”¨çš„å½±å“æ›´å°ã€‚&lt;/p>
&lt;h2 id="è‡ªå·±æ€è€ƒ-1">è‡ªå·±æ€è€ƒ&lt;/h2>
&lt;p>æœ¬æ–‡æå‡ºçš„Dehydraæ–¹æ³•åœ¨æ°´å°ç§»é™¤é¢†åŸŸå…·æœ‰åˆ›æ–°æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨å‡å°‘å¯¹æ•°æ®ä¾èµ–å’Œæé«˜æ”»å‡»æœ‰æ•ˆæ€§æ–¹é¢ã€‚ç„¶è€Œï¼Œè¯¥æ–¹æ³•ä¹Ÿæœ‰ä¸€äº›å±€é™æ€§ã€‚é¦–å…ˆï¼ŒDehydraä¸»è¦é’ˆå¯¹å›¾åƒåˆ†ç±»ä»»åŠ¡ï¼Œå¯¹äºŽå…¶ä»–ç±»åž‹çš„DNNæ¨¡åž‹ï¼Œå¦‚è‡ªç„¶è¯­è¨€å¤„ç†æ¨¡åž‹ï¼Œå…¶æœ‰æ•ˆæ€§å°šæœªå¾—åˆ°éªŒè¯ã€‚å…¶æ¬¡ï¼ŒDehydraçš„æ”»å‡»æ•ˆæžœå¯èƒ½å—åˆ°æ¨¡åž‹ç»“æž„å’Œæ°´å°ç®—æ³•è®¾è®¡çš„å½±å“ï¼Œå¯¹äºŽæŸäº›ç‰¹å®šçš„æ°´å°ç®—æ³•ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´æ”»å‡»ç­–ç•¥ã€‚æœªæ¥çš„å·¥ä½œå¯ä»¥æŽ¢ç´¢Dehydraåœ¨å…¶ä»–ä»»åŠ¡å’Œæ¨¡åž‹ä¸Šçš„åº”ç”¨ï¼Œå¹¶ç ”ç©¶å¦‚ä½•æé«˜å…¶å¯¹ä¸åŒæ°´å°ç®—æ³•çš„é€‚åº”æ€§ã€‚æ­¤å¤–ï¼Œç ”ç©¶è€…ä»¬è¿˜å¯ä»¥æŽ¢ç´¢å¦‚ä½•ç»“åˆDehydraä¸Žå…¶ä»–æ”»å‡»æ–¹æ³•ï¼Œä»¥å®žçŽ°æ›´å…¨é¢çš„æ°´å°é˜²å¾¡ç­–ç•¥ã€‚&lt;/p>
&lt;h2 id="eccv24-revocable-backdoor-for-deep-model-trading">ECCV'24 Revocable Backdoor for Deep Model Trading&lt;/h2>
&lt;h2 id="æ‘˜è¦-2">æ‘˜è¦&lt;/h2>
&lt;p>æœ¬æ–‡æå‡ºäº†ä¸€ç§æ–°åž‹çš„å¯æ’¤é”€åŽé—¨ï¼ˆrevocable backdoorï¼‰æ¦‚å¿µï¼Œå¹¶å°†å…¶åº”ç”¨äºŽæ·±åº¦æ¨¡åž‹äº¤æ˜“åœºæ™¯ä¸­ã€‚åœ¨æ·±åº¦æ¨¡åž‹äº¤æ˜“ä¸­ï¼Œå–å®¶å¸Œæœ›åœ¨ä¸æ³„éœ²æ¨¡åž‹æ ¸å¿ƒä»·å€¼çš„æƒ…å†µä¸‹ï¼Œè®©ä¹°å®¶è¯„ä¼°æ¨¡åž‹æ€§èƒ½ï¼›è€Œä¹°å®¶åˆ™å¸Œæœ›åœ¨ä¸æ»¡æ„æ—¶èƒ½å¤Ÿé€€å›žæ¨¡åž‹å¹¶èŽ·å¾—é€€æ¬¾ã€‚ä¸ºäº†è§£å†³è¿™ä¸€çŸ›ç›¾ï¼Œä½œè€…è®¾è®¡äº†ä¸€ç§ç‰¹æ®Šçš„åŽé—¨ï¼Œè¯¥åŽé—¨åœ¨æ¤å…¥æ—¶ä¸ä¼šé™ä½Žæ¨¡åž‹æ€§èƒ½ï¼Œä¸”å–å®¶å¯ä»¥åœ¨ä»»ä½•æ—¶å€™é€šè¿‡ç‰¹å®šçš„æŽ©ç çŸ©é˜µï¼ˆmask matricesï¼‰è½»æ¾æ’¤é”€åŽé—¨ï¼Œè€Œæ— éœ€é‡æ–°è®­ç»ƒæ¨¡åž‹ã€‚è¿™ç§å¯æ’¤é”€åŽé—¨ä¸ä»…èƒ½å¤Ÿä¿æŠ¤å–å®¶çš„åˆ©ç›Šï¼Œé˜²æ­¢ä¹°å®¶åœ¨æœªå®Œæˆæœ€ç»ˆæ”¯ä»˜æ—¶æ»¥ç”¨æ¨¡åž‹ï¼ŒåŒæ—¶ä¹Ÿèƒ½ä¿è¯ä¹°å®¶åœ¨æ”¯ä»˜æœ€ç»ˆæ¬¾é¡¹åŽèŽ·å¾—ä¸€ä¸ªå¹²å‡€çš„æ¨¡åž‹ã€‚é€šè¿‡åœ¨å¤šä¸ªæ•°æ®é›†å’Œç½‘ç»œæž¶æž„ä¸Šçš„å®žéªŒï¼Œä½œè€…è¯æ˜Žäº†è¯¥å¯æ’¤é”€åŽé—¨çš„å¯è¡Œæ€§å’Œé²æ£’æ€§ã€‚&lt;/p>
&lt;h2 id="èƒŒæ™¯-2">èƒŒæ™¯&lt;/h2>
&lt;p>æ·±åº¦å­¦ä¹ æ¨¡åž‹åœ¨å¤šä¸ªé¢†åŸŸå–å¾—äº†æ˜¾è‘—çš„æˆå°±ï¼Œæˆä¸ºé‡è¦çš„æ•°å­—äº§å“ã€‚ç„¶è€Œï¼Œè¿™äº›æ¨¡åž‹å®¹æ˜“å—åˆ°åŽé—¨æ”»å‡»çš„å¨èƒï¼Œæ”»å‡»è€…é€šè¿‡åœ¨è®­ç»ƒé˜¶æ®µæ¤å…¥åŽé—¨ï¼Œä½¿å¾—æ¨¡åž‹åœ¨ç‰¹å®šè§¦å‘å™¨å‡ºçŽ°æ—¶è¿”å›žæ”»å‡»è€…æœŸæœ›çš„ç»“æžœã€‚è¿™ç§æ”»å‡»ä¸¥é‡ç ´åäº†æ·±åº¦æ¨¡åž‹çš„å¯ä¿¡åº¦ã€‚å°½ç®¡åŽé—¨æ”»å‡»é€šå¸¸è¢«è§†ä¸ºå®‰å…¨å¨èƒï¼Œä½†ä¹Ÿæœ‰ç ”ç©¶è€…åˆ©ç”¨åŽé—¨æ”»å‡»è¿›è¡Œæ­£å‘ç›®çš„ï¼Œå¦‚æ¨¡åž‹ç‰ˆæƒä¿æŠ¤ã€äººå·¥æ™ºèƒ½å¯è§£é‡Šæ€§å’Œå¯¹æŠ—æ€§ç¤ºä¾‹é˜²å¾¡ç­‰ã€‚æœ¬æ–‡é¦–æ¬¡æå‡ºå¯æ’¤é”€åŽé—¨çš„æ¦‚å¿µï¼Œå°†å…¶åº”ç”¨äºŽæ·±åº¦æ¨¡åž‹äº¤æ˜“ï¼Œæ—¨åœ¨åœ¨ä¸é™ä½Žæ¨¡åž‹æ€§èƒ½çš„å‰æä¸‹ï¼Œå®žçŽ°å¯¹åŽé—¨çš„æŽ§åˆ¶ï¼ŒåŒæ—¶ä¿æŠ¤ä¹°å–åŒæ–¹çš„åˆ©ç›Šã€‚&lt;/p>
&lt;h2 id="ç›¸å…³å·¥ä½œ-2">ç›¸å…³å·¥ä½œ&lt;/h2>
&lt;p>åœ¨æœºå™¨å­¦ä¹ å®‰å…¨é¢†åŸŸï¼ŒåŽé—¨æ”»å‡»å’Œé˜²å¾¡æ˜¯ä¸¤ä¸ªé‡è¦çš„ç ”ç©¶æ–¹å‘ã€‚åŽé—¨æ”»å‡»çš„ç›®æ ‡æ˜¯è®©æ·±åº¦æ¨¡åž‹åœ¨è§¦å‘å™¨å‡ºçŽ°æ—¶è¿”å›žæ”»å‡»è€…æœŸæœ›çš„ç»“æžœã€‚æ—©æœŸçš„åŽé—¨æ”»å‡»å¦‚BadNetsé€šè¿‡åœ¨è®­ç»ƒé˜¶æ®µçš„æ•°æ®æŠ•æ¯’å®žçŽ°æ”»å‡»ï¼Œè€ŒåŽç»­çš„ç ”ç©¶åˆ™æŽ¢ç´¢äº†æ›´éšè”½çš„è§¦å‘å™¨æ¨¡å¼ã€‚é™¤äº†åŸºäºŽæ•°æ®æŠ•æ¯’çš„åŽé—¨æ”»å‡»ï¼Œè¿˜æœ‰é€šè¿‡æŽ§åˆ¶è®­ç»ƒè¿‡ç¨‹å®žçŽ°çš„åŽé—¨æ”»å‡»ã€‚è¿™äº›æ”»å‡»æ–¹æ³•åœ¨éšè”½æ€§å’Œæ”»å‡»æ•ˆæžœä¸Šæœ‰æ‰€ä¸åŒï¼Œä½†éƒ½éœ€è¦åœ¨æ¨¡åž‹ä¸­ç•™ä¸‹ç—•è¿¹ã€‚&lt;/p>
&lt;p>é’ˆå¯¹åŽé—¨æ”»å‡»çš„å¨èƒï¼ŒåŽé—¨é˜²å¾¡æŠ€æœ¯ä¹Ÿè¿…é€Ÿå‘å±•ã€‚åŽé—¨æ£€æµ‹æŠ€æœ¯æ—¨åœ¨ç¡®å®šæ¨¡åž‹æ˜¯å¦åŒ…å«åŽé—¨ï¼Œè€ŒåŽé—¨å‡€åŒ–æŠ€æœ¯åˆ™æ—¨åœ¨åœ¨ä¸æ˜¾è‘—é™ä½Žæ¨¡åž‹æ€§èƒ½çš„å‰æä¸‹æ¶ˆé™¤åŽé—¨ã€‚ä¾‹å¦‚ï¼ŒNeural Cleanseé€šè¿‡åˆ†æžæ¨¡åž‹çš„å¼‚å¸¸è¡Œä¸ºæ¥æ£€æµ‹åŽé—¨ï¼Œè€ŒFine-Pruningåˆ™é€šè¿‡ç½‘ç»œå‰ªæžæ¥æ¶ˆé™¤åŽé—¨ã€‚è¿™äº›é˜²å¾¡æŠ€æœ¯åœ¨æ£€æµ‹å’Œæ¸…é™¤åŽé—¨æ–¹é¢å–å¾—äº†ä¸€å®šçš„æ•ˆæžœï¼Œä½†ä¹Ÿå­˜åœ¨å±€é™æ€§ã€‚&lt;/p>
&lt;h2 id="æ–¹æ¡ˆè®¾è®¡-2">æ–¹æ¡ˆè®¾è®¡&lt;/h2>
&lt;p>æœ¬æ–‡æå‡ºçš„å¯æ’¤é”€åŽé—¨æ–¹æ¡ˆä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ¨¡å—ï¼š&lt;/p>
&lt;ol>
&lt;li>
&lt;p>&lt;strong>æ¨¡åž‹è®­ç»ƒä¸ŽåŽé—¨æ¤å…¥&lt;/strong>ï¼šåœ¨æ¨¡åž‹è®­ç»ƒé˜¶æ®µï¼Œé€šè¿‡åœ¨éƒ¨åˆ†å¹²å‡€å›¾åƒä¸Šæ·»åŠ è§¦å‘å™¨æ¨¡å¼å¹¶å°†å…¶æ ‡è®°ä¸ºç›®æ ‡æ ‡ç­¾ï¼Œç”Ÿæˆæœ‰æ¯’æ•°æ®é›†ã€‚ç„¶åŽï¼Œä½¿ç”¨è¿™äº›æœ‰æ¯’æ•°æ®è®­ç»ƒæ¨¡åž‹ï¼ŒåŒæ—¶æ›´æ–°è§¦å‘å™¨æ¨¡å¼ï¼Œä»¥ç¡®ä¿æ¨¡åž‹åœ¨è§¦å‘å™¨å‡ºçŽ°æ—¶è¿”å›žé”™è¯¯çš„ç»“æžœã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>æŽ©ç çŸ©é˜µè®¾è®¡&lt;/strong>ï¼šä¸ºäº†å®žçŽ°åŽé—¨çš„å¯æ’¤é”€æ€§ï¼Œä½œè€…è®¾è®¡äº†æŽ©ç çŸ©é˜µæ¥æŽ§åˆ¶æ¨¡åž‹çš„å†…éƒ¨ç‰¹å¾å›¾ã€‚è¿™äº›æŽ©ç çŸ©é˜µå¯ä»¥åœ¨ä¸é‡æ–°è®­ç»ƒæ¨¡åž‹çš„æƒ…å†µä¸‹ï¼Œé€šè¿‡æ”¹å˜æ¨¡åž‹çš„å†…éƒ¨ç‰¹å¾å›¾æ¥æ’¤é”€åŽé—¨ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>è§¦å‘å™¨æ¨¡å¼ä¼˜åŒ–&lt;/strong>ï¼šä¸ºäº†å¹³è¡¡è§¦å‘å™¨æ¨¡å¼çš„éšè”½æ€§å’Œæ”»å‡»é²æ£’æ€§ï¼Œä½œè€…æå‡ºäº†ä¸€ç§è§¦å‘å™¨æ¨¡å¼çš„å¾®è°ƒæ–¹æ³•ã€‚é€šè¿‡è°ƒæ•´è§¦å‘å™¨æ¨¡å¼çš„å‚æ•°ï¼Œå¯ä»¥åœ¨ä¿æŒè§¦å‘å™¨æ¨¡å¼éšè”½æ€§çš„åŒæ—¶ï¼Œæé«˜æ”»å‡»çš„æœ‰æ•ˆæ€§ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>çŽ°æœ‰åŽé—¨æ”»å‡»çš„æ’¤é”€æ–¹æ³•&lt;/strong>ï¼šå¯¹äºŽå·²ç»å­˜åœ¨çš„åŽé—¨æ”»å‡»ï¼Œä½œè€…æå‡ºäº†ä¸€ç§åŽé—¨æ“¦é™¤æ–¹æ³•ï¼Œé€šè¿‡æœ€å°åŒ–å¹²å‡€å’Œæœ‰æ¯’å›¾åƒä¹‹é—´çš„äº¤å‰ç†µæŸå¤±æ¥æ’¤é”€åŽé—¨ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="å®žéªŒç»“æžœ-2">å®žéªŒç»“æžœ&lt;/h2>
&lt;p>å®žéªŒè®¾è®¡åŒ…æ‹¬ä¸‰ä¸ªæ•°æ®é›†ï¼šCIFAR-10ã€GTSRBå’ŒSub-ImageNetï¼Œä»¥åŠä¸¤ç§ç½‘ç»œæž¶æž„ï¼šResNet-18å’ŒVGGã€‚å®žéªŒä¸­ï¼Œä½œè€…å°†æå‡ºçš„å¯æ’¤é”€åŽé—¨æ–¹æ³•ä¸Žå¤šç§çŽ°æœ‰çš„åŽé—¨æ”»å‡»æ–¹æ³•è¿›è¡Œäº†æ¯”è¾ƒï¼ŒåŒ…æ‹¬BadNetsã€Blendã€SIGã€LSBã€WaNetå’ŒBppAttackã€‚å®žéªŒç»“æžœè¡¨æ˜Žï¼Œæå‡ºçš„å¯æ’¤é”€åŽé—¨æ–¹æ³•åœ¨æ”»å‡»æœ‰æ•ˆæ€§ã€æ¨¡åž‹ä¿çœŸåº¦å’ŒåŽé—¨å¯æ’¤é”€æ€§æ–¹é¢å‡ä¼˜äºŽçŽ°æœ‰æ–¹æ³•ã€‚åœ¨æ²¡æœ‰é˜²å¾¡æŽªæ–½çš„æƒ…å†µä¸‹ï¼Œå¯æ’¤é”€åŽé—¨èƒ½å¤Ÿæ˜¾è‘—é™ä½Žæ¨¡åž‹åœ¨æœ‰æ¯’è¾“å…¥ä¸‹çš„å‡†ç¡®æ€§ï¼ŒåŒæ—¶ä¿æŒåœ¨å¹²å‡€è¾“å…¥ä¸‹çš„å‡†ç¡®æ€§ä¸å˜ã€‚æ­¤å¤–ï¼Œé€šè¿‡å¼•å…¥æŽ©ç çŸ©é˜µï¼Œæ¨¡åž‹èƒ½å¤Ÿæ¢å¤åˆ°å¹²å‡€æ¨¡åž‹çš„æ€§èƒ½æ°´å¹³ã€‚&lt;/p>
&lt;h2 id="è‡ªå·±æ€è€ƒ-2">è‡ªå·±æ€è€ƒ&lt;/h2>
&lt;p>æœ¬æ–‡çš„ä¼˜ç‚¹åœ¨äºŽæå‡ºäº†ä¸€ç§åˆ›æ–°çš„å¯æ’¤é”€åŽé—¨æ¦‚å¿µï¼Œå¹¶å°†å…¶æˆåŠŸåº”ç”¨äºŽæ·±åº¦æ¨¡åž‹äº¤æ˜“åœºæ™¯ã€‚è¿™ç§æ–¹æ³•ä¸ä»…èƒ½å¤Ÿä¿æŠ¤å–å®¶çš„åˆ©ç›Šï¼Œé˜²æ­¢æœªæŽˆæƒä½¿ç”¨ï¼ŒåŒæ—¶ä¹Ÿèƒ½ä¿è¯ä¹°å®¶åœ¨æ”¯ä»˜æœ€ç»ˆæ¬¾é¡¹åŽèŽ·å¾—ä¸€ä¸ªå¹²å‡€çš„æ¨¡åž‹ã€‚æ­¤å¤–ï¼Œå®žéªŒç»“æžœè¡¨æ˜Žï¼Œè¯¥æ–¹æ³•åœ¨å¤šä¸ªæ•°æ®é›†å’Œç½‘ç»œæž¶æž„ä¸Šéƒ½å…·æœ‰å¾ˆå¥½çš„å¯è¡Œæ€§å’Œé²æ£’æ€§ã€‚&lt;/p>
&lt;p>ç„¶è€Œï¼Œè¯¥æ–¹æ³•ä¹Ÿå­˜åœ¨ä¸€äº›å±€é™æ€§ã€‚ä¾‹å¦‚ï¼Œå¯æ’¤é”€åŽé—¨çš„å®žçŽ°ä¾èµ–äºŽæŽ©ç çŸ©é˜µçš„è®¾è®¡ï¼Œè¿™å¯èƒ½éœ€è¦å¯¹æ¨¡åž‹çš„å†…éƒ¨ç»“æž„æœ‰æ·±å…¥çš„äº†è§£ã€‚æ­¤å¤–ï¼Œè¯¥æ–¹æ³•åœ¨é¢å¯¹æ›´å¤æ‚çš„é˜²å¾¡ç­–ç•¥æ—¶ï¼Œå…¶æœ‰æ•ˆæ€§å¯èƒ½ä¼šå—åˆ°å½±å“ã€‚&lt;/p>
&lt;p>æœªæ¥çš„æ”¹è¿›æ–¹å‘å¯ä»¥åŒ…æ‹¬ï¼š1) æŽ¢ç´¢æ›´åŠ éšè”½çš„è§¦å‘å™¨æ¨¡å¼ï¼Œä»¥æé«˜åŽé—¨çš„éšè”½æ€§ï¼›2) ç ”ç©¶æ›´åŠ é«˜æ•ˆçš„åŽé—¨æ’¤é”€æ–¹æ³•ï¼Œä»¥å‡å°‘å¯¹æ¨¡åž‹æ€§èƒ½çš„å½±å“ï¼›3) è€ƒè™‘åœ¨æ›´å¹¿æ³›çš„æ”»å‡»å’Œé˜²å¾¡åœºæ™¯ä¸‹ï¼Œè¯„ä¼°å¯æ’¤é”€åŽé—¨çš„é€‚ç”¨æ€§å’Œæœ‰æ•ˆæ€§ã€‚&lt;/p></description></item><item><title>æ‰‹å†™Redis</title><link>https://chi-kai.github.io/post/%E6%89%8B%E5%86%99redis/</link><pubDate>Sat, 20 Jul 2024 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/%E6%89%8B%E5%86%99redis/</guid><description>&lt;h1 id="redis-æž¶æž„è§£æž-redis-10">Redis æž¶æž„è§£æž (Redis 1.0)&lt;/h1>
&lt;p>ç¨‹åºå…¥å£åœ¨redis.cä¸­ï¼Œä»Žmainå‡½æ•°å¯ä»¥çœ‹å‡º,ä¸»è¦çš„æ“ä½œåœ¨aeMainä¸­ï¼Œè¿™å°±æ˜¯redisä¸­è‘—åçš„aeåº“ã€‚ä¸‹é¢æˆ‘ä»¬å…ˆä»‹ç»ä¸€ä¸‹aeåº“:
![[Pasted image 20240920194849.png]]&lt;/p>
&lt;h3 id="aeåº“">aeåº“&lt;/h3>
&lt;p>aeMainä½œç”¨æ˜¯æŒç»­å¤„ç†aeloopä¸­çš„äº‹åŠ¡:
![[Pasted image 20240920195230.png]]
aeåº“ä¸»è¦å…³æ³¨çš„æ˜¯ä¸‰ä¸ªç»“æž„ä½“ï¼Œå®šä¹‰äº†FileEventå’ŒTimeEventï¼Œä»¥åŠäº‹ä»¶å¾ªçŽ¯&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* File event structure */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">typedef&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">aeFileEvent&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">fd&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">mask&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* one of AE_(READABLE|WRITABLE|EXCEPTION) */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">aeFileProc&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">fileProc&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// å›žè°ƒå‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">aeEventFinalizerProc&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">finalizerProc&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// äº‹ä»¶å®Œæˆæ—¶å›žè°ƒ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">clientData&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">aeFileEvent&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">next&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#111">aeFileEvent&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Time event structure */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">typedef&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">aeTimeEvent&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">id&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* time event identifier. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">when_sec&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* seconds */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">when_ms&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* milliseconds */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">aeTimeProc&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">timeProc&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">aeEventFinalizerProc&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">finalizerProc&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">clientData&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">aeTimeEvent&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">next&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#111">aeTimeEvent&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* State of an event based program */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">typedef&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">aeEventLoop&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">timeEventNextId&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">aeFileEvent&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">fileEventHead&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">aeTimeEvent&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">timeEventHead&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">stop&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#111">aeEventLoop&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>aeåº“æœ€ä¸»è¦çš„å‡½æ•°å°±æ˜¯&lt;code>aeProcessEvents&lt;/code>Â , å®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯å¤„ç†æ–‡ä»¶äº‹ä»¶ï¼ˆå¦‚ç½‘ç»œå¥—æŽ¥å­—è¯»å†™äº‹ä»¶ï¼‰å’Œæ—¶é—´äº‹ä»¶ï¼ˆå¦‚å®šæ—¶å™¨äº‹ä»¶ï¼‰ã€‚å®ƒä¼šæ ¹æ®ä¼ å…¥çš„æ ‡å¿—ä½ï¼ˆ&lt;code>flags&lt;/code>ï¼‰å†³å®šæ˜¯å¦å¤„ç†è¿™ä¸¤ç§äº‹ä»¶ï¼Œå¹¶è¿”å›žå¤„ç†çš„äº‹ä»¶æ•°é‡ã€‚
ä¸‹é¢è®²ä¸€ä¸‹å¤§æ¦‚çš„æµç¨‹:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#75715e">/* Check file events */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">flags&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#111">AE_FILE_EVENTS&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#00a8c8">while&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">fe&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">fe&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">mask&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#111">AE_READABLE&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#75af00">FD_SET&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">fe&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">fd&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#111">rfds&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">fe&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">mask&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#111">AE_WRITABLE&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#75af00">FD_SET&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">fe&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">fd&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#111">wfds&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">fe&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">mask&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#111">AE_EXCEPTION&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#75af00">FD_SET&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">fe&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">fd&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#111">efds&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">maxfd&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">fe&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">fd&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">maxfd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">fe&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">fd&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â  Â  &lt;span style="color:#111">numfd&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â  Â  &lt;span style="color:#111">fe&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">fe&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">next&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¦‚æžœÂ &lt;code>flags&lt;/code>Â ä¸­è®¾ç½®äº†Â &lt;code>AE_FILE_EVENTS&lt;/code>ï¼Œåˆ™éåŽ†æ–‡ä»¶äº‹ä»¶é“¾è¡¨ï¼Œå°†éœ€è¦ç›‘å¬çš„æ–‡ä»¶æè¿°ç¬¦æ·»åŠ åˆ°Â &lt;code>rfds&lt;/code>,Â &lt;code>wfds&lt;/code>,Â &lt;code>efds&lt;/code>Â ä¸­ï¼Œå¹¶æ›´æ–°Â &lt;code>maxfd&lt;/code>Â å’ŒÂ &lt;code>numfd&lt;/code>ã€‚
&lt;code>rfds wfds efds&lt;/code> æ˜¯ç±»åž‹ä¸º&lt;code>fd_set&lt;/code>çš„æè¿°ç¬¦é›†åˆã€‚
ç„¶åŽå®ƒåšäº†å“ªäº›äº‹æƒ…å‘¢:&lt;/p>
&lt;ol>
&lt;li>èŽ·å–å½“å‰åˆ°æœ€æ–°æ—¶é—´äº‹ä»¶çš„å·®ï¼Œä½œä¸ºselectçš„è¶…æ—¶æ—¶é—´ã€‚&lt;/li>
&lt;li>å¤„ç†Â &lt;code>select&lt;/code>Â è¿”å›žçš„äº‹ä»¶ã€‚
&lt;ul>
&lt;li>å¦‚æžœÂ &lt;code>select&lt;/code>Â è¿”å›žå€¼å¤§äºŽ0ï¼Œè¡¨ç¤ºæœ‰äº‹ä»¶å‘ç”Ÿï¼ŒéåŽ†æ–‡ä»¶äº‹ä»¶é“¾è¡¨ï¼Œæ£€æŸ¥å“ªäº›æ–‡ä»¶æè¿°ç¬¦ä¸Šæœ‰äº‹ä»¶å‘ç”Ÿï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•°Â &lt;code>fileProc&lt;/code>ã€‚&lt;/li>
&lt;li>å¤„ç†å®Œäº‹ä»¶åŽï¼Œé‡æ–°ä»Žé“¾è¡¨å¤´å¼€å§‹éåŽ†ï¼Œå› ä¸ºäº‹ä»¶å¤„ç†å¯èƒ½ä¼šä¿®æ”¹é“¾è¡¨ç»“æž„ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>å¤„ç†æ—¶é—´äº‹ä»¶ï¼š
&lt;ul>
&lt;li>å¦‚æžœ flags ä¸­è®¾ç½®äº† AE_TIME_EVENTSï¼Œåˆ™éåŽ†æ—¶é—´äº‹ä»¶é“¾è¡¨ï¼Œæ£€æŸ¥å“ªäº›æ—¶é—´äº‹ä»¶å·²ç»åˆ°æœŸï¼Œå¹¶è°ƒç”¨ç›¸åº”çš„å¤„ç†å‡½æ•° timeProcã€‚&lt;/li>
&lt;li>å¦‚æžœæ—¶é—´äº‹ä»¶éœ€è¦é‡å¤è§¦å‘ï¼Œåˆ™æ›´æ–°å…¶è§¦å‘æ—¶é—´ï¼›å¦åˆ™ï¼Œåˆ é™¤è¯¥æ—¶é—´äº‹ä»¶ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>è¿”å›žå¤„ç†çš„äº‹ä»¶æ•°é‡ã€‚
æˆ‘ä»¬æŽ¥ç€çœ‹å›žmainå‡½æ•°,åœ¨äº‹ä»¶å¾ªçŽ¯ä¸­æ³¨å†Œäº†ä¸€ä¸ªserverçš„acceptHandlerå‡½æ•°ï¼Œä¸€æ—¦æœ‰å®¢æˆ·ç«¯é“¾æŽ¥å¯è¯»ï¼Œå°±è§¦å‘ã€‚
![[Pasted image 20240922161721.png]]
![[Pasted image 20240922164350.png]]
å…¶ä¸­è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªæ“ä½œ acceptå®¢æˆ·ç«¯è¯·æ±‚å’Œåˆ›å»ºä¸€ä¸ªæ–°çš„å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬çœ‹è¿™ä¸ªcreateClientå‡½æ•°,é™¤äº†è®¾ç½®ä¸€äº›å®¢æˆ·ç«¯çŠ¶æ€å¤–ï¼Œè¿˜ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯æ³¨å†Œäº†ä¸€ä¸ªå¤„ç†è¯·æ±‚çš„å‡½æ•°readQueryFromClientã€‚å½“å®¢æˆ·ç«¯fdå¯è¯»å°±è§¦å‘
![[Pasted image 20240922164641.png]]&lt;/li>
&lt;/ol>
&lt;h3 id="ä¸€æ¡å‘½ä»¤çš„æ‰§è¡Œæµç¨‹">ä¸€æ¡å‘½ä»¤çš„æ‰§è¡Œæµç¨‹&lt;/h3>
&lt;p>&lt;code>readQueryFromClient&lt;/code>Â å‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯ä»Žå®¢æˆ·ç«¯è¯»å–æ•°æ®ï¼Œè§£æžæŸ¥è¯¢è¯·æ±‚ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ Redis æœåŠ¡å™¨è¿›è¡Œå¤„ç†ã€‚&lt;/p>
&lt;ol>
&lt;li>è¯»æ•°æ®ï¼Œå°†è¯»åˆ°çš„æ•°æ®å†™å…¥ç¼“å†²åŒºã€‚è¿™é‡Œå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªæ“ä½œæ˜¯æŒç»­è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯å®¢æˆ·ç«¯å¯ä»¥ä¿æŒè¿™ä¸ªé“¾æŽ¥ï¼Œä¸€æ—¦å®¢æˆ·ç«¯fdå¯è¯»ï¼Œå°±å†™å…¥bufferã€‚å¯ä»¥è¿žç»­æ“ä½œ
![[Pasted image 20240923094649.png]]&lt;/li>
&lt;li>å¤„ç†æ•°æ®ã€‚é¦–å…ˆå°†æ”¶åˆ°çš„å­—ç¬¦ä¸²åˆ†ç¦»å¤„ç†ï¼ŒæŠŠå‘½ä»¤å’Œå‚æ•°åˆ†å¼€ã€‚è¿™é‡Œå°±ä¸ç»†çœ‹äº†ã€‚å¤„ç†å®Œä¹‹åŽï¼Œå‘½ä»¤è¢«æ”¾åˆ°argvä¸­ï¼Œå‚æ•°æ”¾åˆ°argcä¸­ã€‚å¯ä»¥çœ‹åˆ°è¿™é‡Œæœ‰ä¸€ä¸ªè·³è½¬è¯­å¥gotoã€‚å½“bufferè¿˜æœ‰å‘½ä»¤æ—¶ä¼šé‡å¤æ‰§è¡Œã€‚è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªbulklenå‚æ•°ï¼Œæ˜¯åˆ¤æ–­å¤„ç†æ‰¹é‡è¯»å–æ“ä½œã€‚&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">again&lt;/span>&lt;span style="color:#111">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">bulklen&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">p&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">strchr&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">querybuf&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#39;\n&amp;#39;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// è§£æžå‘½ä»¤å’Œå‚æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">sdslen&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">querybuf&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;gt;=&lt;/span> &lt;span style="color:#111">REDIS_REQUEST_MAX_SIZE&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">redisLog&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">REDIS_DEBUG&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#d88200">&amp;#34;Client protocol error&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">freeClient&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// æ‰§è¡Œè¯­å¥
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">argc&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#75af00">processCommand&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#75af00">sdslen&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">querybuf&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#00a8c8">goto&lt;/span> &lt;span style="color:#111">again&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸‹é¢çœ‹ä¸€æ¡å‘½ä»¤æ˜¯æ€Žä¹ˆæ‰§è¡Œçš„ã€‚
&lt;code>processCommand&lt;/code> å‡½æ•°æ˜¯ Redis æœåŠ¡å™¨ä¸­ç”¨äºŽå¤„ç†å®¢æˆ·ç«¯å‘½ä»¤çš„æ ¸å¿ƒå‡½æ•°ã€‚å®ƒè´Ÿè´£è§£æžã€éªŒè¯å’Œæ‰§è¡Œå®¢æˆ·ç«¯å‘é€çš„å‘½ä»¤ï¼Œå¹¶æ ¹æ®å‘½ä»¤çš„æ‰§è¡Œç»“æžœè¿›è¡Œç›¸åº”çš„å¤„ç†ã€‚&lt;/p>
&lt;ol>
&lt;li>æŸ¥æ‰¾å‘½ä»¤&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">cmd&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">lookupCommand&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">argv&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ptr&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// éåŽ†cmdTableã€‚è¿™ä¸ªè¡¨å¾ˆå°éåŽ†ä¹Ÿæ— æ‰€è°“
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">redisCommand&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">lookupCommand&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">j&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">while&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">cmdTable&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">name&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">strcasecmp&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">cmdTable&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#111">cmdTable&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#111">j&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// cmdTable
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">redisCommand&lt;/span> &lt;span style="color:#111">cmdTable&lt;/span>&lt;span style="color:#111">[]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">{&lt;/span>&lt;span style="color:#d88200">&amp;#34;get&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">getCommand&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">REDIS_CMD_INLINE&lt;/span>&lt;span style="color:#111">},&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">{&lt;/span>&lt;span style="color:#d88200">&amp;#34;set&amp;#34;&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">setCommand&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">3&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">REDIS_CMD_BULK&lt;/span>&lt;span style="color:#f92672">|&lt;/span>&lt;span style="color:#111">REDIS_CMD_DENYOOM&lt;/span>&lt;span style="color:#111">},&lt;/span>\
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#75715e">//...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>Â  Â  &lt;span style="color:#111">{&lt;/span>&lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">};&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// redisComand
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">typedef&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">redisCommandProc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">redisClient&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">redisCommand&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">name&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">redisCommandProc&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">proc&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// æ‰§è¡Œçš„å‘½ä»¤å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>Â  Â  &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">arity&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// å¯¹åº”å‚æ•°æ•°é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>Â  Â  &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">flags&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// æ ‡å¿—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#111">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="2">
&lt;li>é”™è¯¯å¤„ç†å’Œå†…å­˜ç®¡ç†ã€‚å¯ä»¥çœ‹å‡ºå¯¹ä¸€ä¸ªå‘½ä»¤æœ‰å¾ˆå¤šæ£€æŸ¥ï¼Œå¯¹åº”çš„å‚æ•°æ•°é‡ï¼Œå†…å­˜ç­‰ç­‰
![[Pasted image 20240923111602.png]]&lt;/li>
&lt;li>æ‰§è¡Œå‘½ä»¤å¹¶æ›´æ–°æœåŠ¡å™¨çŠ¶æ€ã€‚å¦‚æžœå‘½ä»¤ä¿®æ”¹äº†æ•°æ®ï¼ˆ&lt;code>server.dirty&lt;/code>Â å‘ç”Ÿå˜åŒ–ï¼‰ï¼Œå¹¶ä¸”æœ‰ä»ŽæœåŠ¡å™¨è¿žæŽ¥ï¼Œåˆ™å°†å‘½ä»¤ä¼ æ’­ç»™ä»ŽæœåŠ¡å™¨ã€‚å¦‚æžœæœ‰ç›‘æŽ§å™¨è¿žæŽ¥ï¼Œåˆ™ä¹Ÿå°†å‘½ä»¤ä¼ æ’­ç»™ç›‘æŽ§å™¨ã€‚æœ€åŽï¼Œå¢žåŠ æœåŠ¡å™¨æ‰§è¡Œçš„å‘½ä»¤è®¡æ•°ã€‚&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">dirty&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">server&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">dirty&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">cmd&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#75af00">proc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">server&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">dirty&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#111">dirty&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#75af00">listLength&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">server&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">slaves&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">replicationFeedSlaves&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">server&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">slaves&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">cmd&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">db&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">id&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">argv&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">argc&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">listLength&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">server&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">monitors&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">replicationFeedSlaves&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">server&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">monitors&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">cmd&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">db&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">id&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">argv&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">argc&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">server&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">stat_numcommands&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol start="4">
&lt;li>å¯¹å®¢æˆ·ç«¯çŠ¶æ€é‡ç½®ã€‚&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">flags&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#111">REDIS_CLOSE&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">freeClient&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">resetClient&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="è§£æžgetå‘½ä»¤æ‰§è¡Œ">è§£æžgetå‘½ä»¤æ‰§è¡Œ&lt;/h3>
&lt;p>å¯ä»¥çœ‹åˆ°comtableä¸­ getå‘½ä»¤å¯¹åº”çš„æ˜¯ getCommandå‡½æ•°:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">getCommand&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">redisClient&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">robj&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">o&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">lookupKeyRead&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">db&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">argv&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">o&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#75af00">addReply&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">shared&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">nullbulk&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">o&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">type&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#111">REDIS_STRING&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â  Â  &lt;span style="color:#75af00">addReply&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">shared&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">wrongtypeerr&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#111">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â  Â  &lt;span style="color:#75af00">addReplySds&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#75af00">sdscatprintf&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">sdsempty&lt;/span>&lt;span style="color:#111">(),&lt;/span>&lt;span style="color:#d88200">&amp;#34;$%d&lt;/span>&lt;span style="color:#8045ff">\r\n&lt;/span>&lt;span style="color:#d88200">&amp;#34;&lt;/span>&lt;span style="color:#111">,(&lt;/span>&lt;span style="color:#00a8c8">int&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#75af00">sdslen&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">o&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ptr&lt;/span>&lt;span style="color:#111">)));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â  Â  &lt;span style="color:#75af00">addReply&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">o&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â  Â  &lt;span style="color:#75af00">addReply&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">shared&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">crlf&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä½¿ç”¨&lt;code>lookupKeyRead&lt;/code> æ¥åœ¨dbä¸­æŸ¥æ‰¾å¯¹åº”çš„å€¼ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#111">robj&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">lookupKeyRead&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">redisDb&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">db&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">robj&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#75af00">expireIfNeeded&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">db&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#75af00">lookupKey&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">db&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>expireIfNeeded å‡½æ•°é€šè¿‡æ£€æŸ¥é”®çš„è¿‡æœŸæ—¶é—´ï¼Œå†³å®šæ˜¯å¦åˆ é™¤è¿‡æœŸçš„é”®ã€‚å½“æŸ¥è¯¢çš„keyè¿‡æœŸä¼šè¢«åˆ é™¤ã€‚è€ŒlookupKeyåˆ™æ˜¯è°ƒç”¨dictFindæ¥æŸ¥è¯¢dictä¸­å¯¹åº”çš„keyã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">dictFind&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">ht&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">he&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">h&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">ht&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">size&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">h&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">dictHashKey&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">ht&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#111">ht&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">sizemask&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">he&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">ht&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">h&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">while&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">he&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">dictCompareHashKeys&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">ht&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">he&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â  Â  &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">he&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#111">he&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">he&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">next&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>dictä½¿ç”¨é“¾è¡¨æ³•å¤„ç†å“ˆå¸Œå†²çªã€‚æ‰€ä»¥é¦–å…ˆè¦å°†keyè½¬ä¸ºhashåŽçš„h,ç„¶åŽæŸ¥æ‰¾ã€‚å¯¹äºŽdictä¸­ç»“æž„çš„åˆ†æžå¯ä»¥æŸ¥çœ‹[[Redisæºç å‰–æž-ä¸€]]ã€‚
å¾—åˆ°æ•°æ®åŽï¼Œä½¿ç”¨addReplyæ¥å†™å…¥ã€‚å®ƒæ³¨å†Œäº†ä¸€ä¸ªsendReplyToClientäº‹ä»¶ï¼ˆè¿™ä¸ªå°±ä¸å†™äº†ï¼‰ï¼Œå°†æ•°æ®å†™å…¥ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">addReply&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">redisClient&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">robj&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">listLength&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">reply&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">replstate&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">REDIS_REPL_NONE&lt;/span> &lt;span style="color:#f92672">||&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  Â &lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">replstate&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">REDIS_REPL_ONLINE&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#75af00">aeCreateFileEvent&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">server&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">el&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">fd&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">AE_WRITABLE&lt;/span>&lt;span style="color:#111">,&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  Â  Â  &lt;span style="color:#111">sendReplyToClient&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">c&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">AE_ERR&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">listAddNodeTail&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">c&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">reply&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#75af00">oom&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#d88200">&amp;#34;listAddNodeTail&amp;#34;&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>Â  Â  &lt;span style="color:#75af00">incrRefCount&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">obj&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item><item><title>K8så®žè·µ</title><link>https://chi-kai.github.io/post/k8s%E5%AE%9E%E8%B7%B5/</link><pubDate>Mon, 20 May 2024 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/k8s%E5%AE%9E%E8%B7%B5/</guid><description>&lt;ol>
&lt;li>æ‰€æœ‰å‘½ä»¤è¦ä¸»è¦å¯¹åº”çš„namespace&lt;/li>
&lt;li>&amp;quot;PENDING&amp;quot; çŠ¶æ€è¡¨ç¤ºæœåŠ¡æ­£åœ¨ç­‰å¾…åº•å±‚ç½‘ç»œèµ„æºçš„åˆ†é…ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå½“ä½ åœ¨æœ¬åœ°æµ‹è¯•é›†ç¾¤æ—¶ï¼ŒLoadBalancer ç±»åž‹çš„æœåŠ¡ä¼šå¤„äºŽ Pending çŠ¶æ€ï¼Œå› ä¸ºæœ¬åœ°é›†ç¾¤é€šå¸¸æ²¡æœ‰å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å¯ä¾›åˆ†é…ã€‚&lt;/li>
&lt;li>ä»£ç†ä¼šå½±å“æœ¬åœ°kindé›†ç¾¤çš„è¯·æ±‚&lt;/li>
&lt;/ol></description></item><item><title/><link>https://chi-kai.github.io/post/%E6%B0%B4%E5%8D%B0%E9%AA%8C%E8%AF%81/</link><pubDate>Wed, 15 May 2024 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/%E6%B0%B4%E5%8D%B0%E9%AA%8C%E8%AF%81/</guid><description>&lt;h2 id="åŽé—¨æ°´å°">åŽé—¨æ°´å°&lt;/h2>
&lt;ol>
&lt;li>æœåŠ¡å™¨åµŒå…¥ 2 å®¢æˆ·ç«¯éªŒè¯ï¼ˆå®¢æˆ·ç«¯èƒ½åŠ›å¼±ï¼Œä¸èƒ½åµŒå…¥ï¼‰&lt;/li>
&lt;li>å¦‚ä½•å®¢æˆ·ç«¯ä¿è¯æ”¶åˆ°çš„æœåŠ¡å™¨æ¨¡åž‹è¢«æ­£ç¡®åµŒå…¥æ°´å°ï¼Ÿ&lt;/li>
&lt;li>åµŒå…¥æœåŠ¡å™¨è°ƒåº¦?&lt;/li>
&lt;li>&lt;/li>
&lt;/ol>
&lt;h2 id="é¢‘åŸŸå¹²æ‰°æ£€æµ‹ä¸å‡ºæ¥">é¢‘åŸŸå¹²æ‰°ï¼Œæ£€æµ‹ä¸å‡ºæ¥&lt;/h2>
&lt;h2 id="å¤šè‡‚è€è™Žæœºå®¢æˆ·ç«¯é€‰æ‹©">å¤šè‡‚è€è™Žæœºå®¢æˆ·ç«¯é€‰æ‹©&lt;/h2></description></item><item><title>åŒºå—é“¾æ•°æ®ç®¡ç†ä¼šè®®çºªè¦</title><link>https://chi-kai.github.io/post/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E4%BC%9A%E8%AE%AE%E7%BA%AA%E8%A6%81/</link><pubDate>Tue, 20 Dec 2022 10:01:54 +0800</pubDate><guid>https://chi-kai.github.io/post/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86%E4%BC%9A%E8%AE%AE%E7%BA%AA%E8%A6%81/</guid><description>&lt;h2 id="åŒºå—é“¾æŠ€æœ¯æ•™å­¦ä¸Žè™šæ‹Ÿä»¿çœŸå¹³å°">åŒºå—é“¾æŠ€æœ¯æ•™å­¦ä¸Žè™šæ‹Ÿä»¿çœŸå¹³å°&lt;/h2>
&lt;p>æ¥è‡ªå¤æ—¦å¤§å­¦çš„é˜šæµ·æ–Œæ•™æŽˆåˆ†äº«äº†ä»–ä»¬å…³äºŽåŒºå—é“¾æŠ€æœ¯æ•™å­¦çš„ä¸€äº›å†…å®¹å’Œå¼€å‘ä½¿ç”¨çš„ä»¿çœŸå¹³å°&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/20/pj94y3WEfNkogGU.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/20/5sGWNMnKtfqhIZR.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/20/XVGLWc35nKJdEye.png" alt="">&lt;/p>
&lt;p>&lt;a href="https://ilab.fudan.edu.cn/blockchain/login">ä»¿çœŸå¹³å°&lt;/a>&lt;/p>
&lt;h2 id="heading">&lt;/h2>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/20/Y6zRNikCP2QwxoK.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/20/hqMT8e7nKrAIUjy.png" alt="">&lt;/p>
&lt;h2 id="åŒºå—é“¾å­˜å‚¨æœºåˆ¶">åŒºå—é“¾å­˜å‚¨æœºåˆ¶&lt;/h2>
&lt;h3 id="åŒºå—é“¾å­˜å‚¨æ¦‚è¿°">åŒºå—é“¾å­˜å‚¨æ¦‚è¿°&lt;/h3>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/23/prbUAXVulfgKa9C.png" alt="">&lt;/p>
&lt;p>é€»è¾‘å½¢å¼----åŒºå—æ•°æ®ï¼Œç›¸å½“äºŽæ•°æ®åº“æ—¥å¿—&lt;/p>
&lt;p>ç‰©ç†æ–¹å¼----çŠ¶æ€æ•°æ®ï¼Œç›¸å½“äºŽæ•°æ®åº“å­˜å‚¨å†…å®¹&lt;/p>
&lt;p>åŒºå—é“¾åœºæ™¯ä¸‹è¿˜è¦éªŒè¯æ•°æ®ã€‚&lt;/p>
&lt;h3 id="åŒºå—æ•°æ®å­˜å‚¨">åŒºå—æ•°æ®å­˜å‚¨&lt;/h3>
&lt;p>æ€»ä½“æž„æž¶: é€»è¾‘ç»“æž„---è½¬åŒ–å±‚---ç‰©ç†å­˜å‚¨&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/23/Uo4fzSKBiqONulH.png" alt="">&lt;/p>
&lt;p>é€»è¾‘ç»“æž„:&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/23/UEc4XyIjozLYlC6.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/23/7xMEeqmjU5LQPsV.png" alt="">&lt;/p>
&lt;p>è½¬åŒ–å±‚:&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/pyrXDcUw5gYSvTd.png" alt="">&lt;/p>
&lt;p>ç‰©ç†å­˜å‚¨:&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/2dc78XQrC4pDnSx.png" alt="">&lt;/p>
&lt;h3 id="çŠ¶æ€æ•°æ®å­˜å‚¨">çŠ¶æ€æ•°æ®å­˜å‚¨&lt;/h3>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/tcwLOETspI73Nyq.png" alt="">&lt;/p>
&lt;p>UTXOæ¨¡åž‹:&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/q9vDWzmKA7u1OZ4.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/zd61EhSgYjlKfep.png" alt="">&lt;/p>
&lt;p>è´¦æˆ·æ¨¡åž‹(K-Væ¨¡åž‹):&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/OVTQe1PsCNZlGqd.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/RiHLGIz6t74hSxa.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/W63Q8Vm7iXDbjaC.png" alt="">&lt;/p>
&lt;h3 id="ä»¥å¤ªåŠmpt">ä»¥å¤ªåŠMPT&lt;/h3>
&lt;p>æ—¢èƒ½åšéªŒè¯è¿˜èƒ½åšç´¢å¼•:&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/vQNknEtsIoe4cyG.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/zJpFD8Ct2USLZgH.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/Y3DQcqMN1zUef8S.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/hIDpOsMAGnfZljo.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/TRpfPlEnQj3WZkm.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/EfkNZJPcLDp4UqW.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/tKNbhBHjZpzJrS1.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/3sBx7FaJnprcIXj.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/24/CHaFZmb5GWncEvt.png" alt="">&lt;/p>
&lt;h3 id="æ•°æ®éªŒè¯">æ•°æ®éªŒè¯&lt;/h3>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/oMPXNDTgwHleUSC.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/tseHOYJk2K3DEaU.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/oDvBjQ5F9Km38pM.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/ILk4rJbWxu7aiE8.png" alt="">&lt;/p>
&lt;h3 id="ä»¥å¤ªåŠåŒºå—ç»“æž„">ä»¥å¤ªåŠåŒºå—ç»“æž„&lt;/h3>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/MCxXWrObBYLUGRI.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/uUaH5cxzSpo7VeZ.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/qK2FuyUIQ68eZjb.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/pwgQcJ4RfZNX9YI.png" alt="">&lt;/p>
&lt;h3 id="fabric-å­˜å‚¨">Fabric å­˜å‚¨&lt;/h3>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/EgC1D3c6JSHz2bm.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/wtiS4RNlzZdQpfa.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/yia9kr2PONSYJEW.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/Zr3ta5MUbe2xNyV.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/oiUQIt3jM1YaDAg.png" alt="">&lt;/p>
&lt;h3 id="å­˜å‚¨ä¼˜åŒ–">å­˜å‚¨ä¼˜åŒ–&lt;/h3>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/rx7UifsLXaz8FQl.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/Fm9JrtSa1MWwfoj.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/DwC1IOuXRl3ht5Z.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/oEHcpg7z1vljL5N.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/NyCpb52fgUGX8Ij.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/a4oTO8kYwvzmbsx.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/kRCAdB9s7XMbuti.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/sLFXzHbPClG1TDA.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/MuSOyoEBkAs6TeJ.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/dkFGCgfcyuoSz4q.png" alt="">&lt;/p>
&lt;h2 id="åŒºå—é“¾å­˜å‚¨å¯æ‰©å±•æ€§">åŒºå—é“¾å­˜å‚¨å¯æ‰©å±•æ€§&lt;/h2>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/jNzC213eBThQnVH.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/UMvQYrK4wyAlNFT.png" alt="">&lt;/p>
&lt;p>æŒ‘æˆ˜:&lt;/p>
&lt;ol>
&lt;li>å­˜ä¸ä¸‹-å…¨é‡å­˜å‚¨æ— æ³•é€‚åº”æµ·é‡æ•°æ®&lt;/li>
&lt;li>å­˜çš„æ…¢-é“¾å¼å­˜å‚¨åžåé‡ä½Ž/å›¾å¼å†²çªäº‹åŠ¡å¤šã€‚&lt;/li>
&lt;li>æŸ¥æ‰¾å›°éš¾-æŸ¥ä¸å‡†&lt;/li>
&lt;li>åŠŸèƒ½å•ä¸€-ä¸æ”¯æŒåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œä¸°å¯ŒåŒºå—é“¾æŸ¥è¯¢åŠŸèƒ½&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/21/iBauZKHLTbAsGlc.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/25/erHm38sAfVFabNO.png" alt="">&lt;/p></description></item><item><title>åŒºå—é“¾å­¦ä¹ ---BTC</title><link>https://chi-kai.github.io/post/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0/</link><pubDate>Mon, 28 Nov 2022 11:08:17 +0800</pubDate><guid>https://chi-kai.github.io/post/%E5%8C%BA%E5%9D%97%E9%93%BE%E5%AD%A6%E4%B9%A0/</guid><description>&lt;h1 id="btc">BTC&lt;/h1>
&lt;p>bitcoin çš„è®ºæ–‡æ ‡é¢˜ä¸º ä¸€ç§ç‚¹å¯¹ç‚¹çš„ç”µå­çŽ°é‡‘ç³»ç»Ÿï¼Œå¯è§å®ƒæœ€åˆçš„è®¾è®¡ç›®æ ‡æ˜¯ä¸ºäº†æ‘†è„±ç¬¬ä¸‰æ–¹ä¸­ä»‹ï¼Œå»ºç«‹ä¸€ä¸ªæ–°åž‹çš„ä¿¡ä»»æ¨¡åž‹ã€‚æ˜¯åŒºå—é“¾æŠ€æœ¯ç¬¬ä¸€æ¬¡å®žé™…è¿ç”¨ã€‚&lt;/p>
&lt;h2 id="å¯†ç å­¦åŽŸç†">å¯†ç å­¦åŽŸç†&lt;/h2>
&lt;h3 id="å“ˆå¸Œ">å“ˆå¸Œ&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>collision resistance&lt;/strong> (è¿™é‡ŒæŒ‡å“ˆå¸Œç¢°æ’ž) :&lt;/p>
&lt;p>ä¾‹å¦‚ xâ‰ y H(x)=H(y) ä¸¤ä¸ªä¸åŒçš„è¾“å…¥ï¼Œè¾“å‡ºå´æ˜¯ç›¸ç­‰çš„ï¼Œè¿™å°±ç§°å“ˆå¸Œç¢°æ’žã€‚å®ƒæ˜¯ä¸å¯é¿å…çš„ï¼Œå› ä¸ºè¾“å…¥ç©ºé—´æ€»å¤§äºŽè¾“å‡ºç©ºé—´ã€‚&lt;/p>
&lt;p>ç»™å‡ºxï¼Œå¾ˆéš¾æ‰¾åˆ°yï¼Œé™¤éžè›®åŠ›æ±‚è§£(brute-force)ã€‚&lt;/p>
&lt;p>è¯¥æ€§è´¨çš„ä½œç”¨:å¯¹ä¸€ä¸ªmessageæ±‚digest&lt;/p>
&lt;p>æ¯”å¦‚messageå–m mçš„å“ˆå¸Œå€¼æ˜¯H(m)=digest å¦‚æžœæœ‰äººæƒ³ç¯¡æ”¹må€¼è€ŒH(m)ä¸å˜ï¼Œåˆ™æ— æ³•åšåˆ°ã€‚&lt;/p>
&lt;p>collision resistanceæ— æ³•éªŒè¯ï¼Œæ˜¯æ ¹æ®å®žè·µç»éªŒå¾—æ¥çš„ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>hiding&lt;/strong> :&lt;/p>
&lt;p>å“ˆå¸Œå‡½æ•°çš„è®¡ç®—è¿‡ç¨‹æ˜¯å•å‘çš„ï¼Œä¸å¯é€†çš„ã€‚æ— æ³•ä»Žå“ˆå¸Œå€¼æŽ¨å‡ºè¾“å…¥å†…å®¹ã€‚&lt;/p>
&lt;p>å‰ææ˜¯&lt;strong>è¾“å…¥ç©ºé—´è¶³å¤Ÿå¤§ï¼Œåˆ†å¸ƒå‡åŒ€&lt;/strong>ã€‚å¦åˆ™å¯èƒ½è¢«è›®åŠ›ç ´è§£ã€‚å¯ä»¥åœ¨è¾“å…¥åŽé¢æ‹¼æŽ¥ä¸€ä¸ªéšæœºæ•°æ¥å–hash,ä¿è¯è¾“å…¥è¶³å¤Ÿå¤§ã€‚&lt;/p>
&lt;p>è¯¥æ€§è´¨çš„ä½œç”¨:å’Œcollision resistance ç»“åˆåœ¨ä¸€èµ·ï¼Œç”¨æ¥å®žçŽ°&lt;strong>digital commitment&lt;/strong>(åˆç§°ä¸ºdigital equivalent of a sealed envelope)ã€‚æŠŠé¢„æµ‹ç»“æžœä½œä¸ºè¾“å…¥xï¼Œç®—å‡ºä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œå°†å“ˆå¸Œå€¼å…¬å¸ƒï¼Œhidingè®©äººä»¬çŸ¥é“å“ˆå¸Œå€¼è€Œä¸çŸ¥é“é¢„æµ‹å€¼ï¼Œæœ€åŽå†å°†xå…¬å¸ƒï¼Œå› ä¸ºæœ‰collision resistanceçš„æ€§è´¨ï¼Œé¢„æµ‹ç»“æžœæ˜¯ä¸å¯ç¯¡æ”¹çš„ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>puzzle friendly&lt;/strong> :&lt;/p>
&lt;p>å“ˆå¸Œå€¼äº‹å…ˆä¸å¯é¢„æµ‹ï¼Œä»…ä»…æ ¹æ®è¾“å…¥å¾ˆéš¾é¢„æµ‹è¾“å‡ºã€‚åœ¨æ¯”ç‰¹å¸ä¸­é‡‡ç”¨SHA-256å“ˆå¸Œå‡½æ•°ï¼Œéœ€è¦ä¸€ä¸ªå“ˆå¸Œå€¼ï¼Œå­˜åœ¨äºŽæŸä¸€ä¸ªèŒƒå›´å†…ï¼Œåªèƒ½é€šè¿‡ä¸åœè¿ç®—æŸ¥æ‰¾å‡ºæ¥ã€‚è¯¥æ€§è´¨ä¿è¯äº†æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ï¼Œåªèƒ½é€šè¿‡â€œæŒ–çŸ¿â€èŽ·å¾—æ¯”ç‰¹å¸ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥æ€§è´¨ä¿è¯äº†å·¥ä½œé‡è¯æ˜Ž(POW)æœºåˆ¶å¯ä»¥è¿è¡Œä¸‹åŽ»ã€â€œæŒ–çŸ¿éš¾ï¼Œä½†éªŒè¯æ˜“â€ã€‘ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="ç­¾å">ç­¾å&lt;/h3>
&lt;p>æ¯”ç‰¹å¸ä¸­è´¦æˆ·ç®¡ç† åœ¨ç¬¬ä¸‰æ–¹ä¸­å¿ƒåŒ–ç³»ç»Ÿä¸­ï¼Œè´¦æˆ·å¼€é€šä¾èµ–äºŽç¬¬ä¸‰æ–¹ã€‚ä½†åŽ»ä¸­å¿ƒåŒ–çš„æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ï¼Œå¾ˆæ˜Žæ˜¾ä¸èƒ½
è¿›è¡Œâ€œç”³è¯·è´¦æˆ·â€ã€‚åœ¨æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ï¼Œç”³è¯·è´¦æˆ·æ˜¯ç”¨æˆ·è‡ªå·±æ¥å¤„ç†çš„ï¼Œå³è‡ªå·±åˆ›å»ºä¸€ä¸ªå…¬é’¥-ç§é’¥å¯¹ã€‚ï¼ˆå…³äºŽå…¬ç§
é’¥è¯·è‡ªè¡Œäº†è§£éžå¯¹ç§°åŠ å¯†ä½“ç³»å’Œå¯¹ç§°åŠ å¯†ä½“ç³»ï¼‰ å…¬é’¥å’Œç§é’¥çš„åº”ç”¨ä¿è¯äº†â€œç­¾åâ€çš„åº”ç”¨ã€‚å½“åœ¨æ¯”ç‰¹å¸ç½‘ç»œä¸­è¿›
è¡Œè½¬è´¦æ—¶ï¼Œé€šè¿‡â€œç­¾åâ€å¯ä»¥æ˜Žç¡®æ˜¯ç”±å“ªä¸ªè´¦æˆ·è½¬å‡ºçš„ï¼Œä»Žè€Œé˜²æ­¢ä¸è‰¯åˆ†å­å¯¹å…¶ä»–è´¦æˆ·æ¯”ç‰¹å¸çš„ç›—å–ã€‚ åœ¨å‘å¸ƒäº¤
æ˜“æ—¶ï¼Œé€šè¿‡è‡ªå·±ç§é’¥ç­¾åï¼Œå…¶ä»–äººå¯ä»¥æ ¹æ®å…¬é’¥è¿›è¡ŒéªŒè¯ï¼Œä»Žè€Œä¿è¯è¯¥äº¤æ˜“ç”±è‡ªå·±å‘èµ·ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰æ‹¥æœ‰
ç§é’¥ï¼Œæ‰èƒ½å°†è¯¥è´¦æˆ·ä¸­çš„æ¯”ç‰¹å¸è½¬èµ°ã€‚ ã€æ³¨æ„ï¼šæ¯”ç‰¹å¸ç³»ç»Ÿä¸­ï¼Œå¾ˆéš¾é€šè¿‡ç”Ÿæˆå¤§é‡å…¬ç§é’¥å¯¹æ¥èŽ·å–ä»–äººç§é’¥ã€‘&lt;/p>
&lt;h2 id="æ•°æ®ç»“æž„">æ•°æ®ç»“æž„&lt;/h2>
&lt;h3 id="hash-pointer-å“ˆå¸ŒæŒ‡é’ˆ">hash pointer (å“ˆå¸ŒæŒ‡é’ˆ)&lt;/h3>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/28/8ReVK2i7LQqWsld.png" alt="">&lt;/p>
&lt;p>ä»Žä¸Šå›¾å¯ä»¥çœ‹å‡ºæ¯ä¸ªåŒºå—åŒ…å«&lt;strong>ä¸€ä¸ªæ—¶é—´æˆ³ã€ä¸€ä¸ªéšæœºæ•°ã€ä¸€ä¸ªå¯¹ä¸Šä¸€ä¸ªåŒºå—çš„å¼•ç”¨ï¼ˆå³å“ˆå¸Œï¼‰å’Œä¸Šä¸€åŒºå—ç”Ÿæˆä»¥æ¥å‘ç”Ÿçš„æ‰€æœ‰äº¤æ˜“åˆ—è¡¨&lt;/strong>ã€‚ éšç€æ—¶é—´æŽ¨ç§»å°±åˆ›å»ºå‡ºäº†ä¸€ä¸ªæŒç»­å¢žé•¿çš„åŒºå—é“¾ï¼Œå®ƒä¸æ–­åœ°æ›´æ–°ï¼Œä»Žè€Œèƒ½å¤Ÿä»£è¡¨æ¯”ç‰¹å¸è´¦æœ¬çš„æœ€æ–°çŠ¶æ€ã€‚&lt;/p>
&lt;p>åŒºå—é“¾ä¸Šçš„åŒºå—ï¼ˆé™¤äº†åˆ›ä¸–åŒºå—ï¼‰éƒ½æœ‰ä¸€ä¸ªhash pointeræŒ‡å‘å‰ä¸€ä¸ªåŒºå—ï¼Œé€šè¿‡å‰ä¸€ä¸ªåŒºå—æ•´ä½“æ¥èŽ·å–ä¸€ä¸ªhashã€‚å¦‚æžœä¸€ä¸ªåŒºå—è¢«æ¶æ„ä¿®æ”¹ï¼Œåˆ™åŽé¢çš„åŒºå—hashéƒ½ä¼šæ— æ³•åŒ¹é…ã€‚&lt;/p>
&lt;p>åŒºå—é“¾ç³»ç»Ÿä¸­æœ‰çš„èŠ‚ç‚¹åªéœ€ä¿å­˜éƒ¨åˆ†åŒºå—ï¼Œç­‰åˆ°éœ€è¦å…¶ä»–åŒºå—æ—¶ï¼Œå†å‘å…¶ä»–èŠ‚ç‚¹èŽ·å–ï¼Œå¯ä»¥é€šè¿‡hashæ¥éªŒè¯æ­£ç¡®æ€§ã€‚&lt;/p>
&lt;h3 id="merkle-tree">Merkle tree&lt;/h3>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/28/fKRoqOe94NlCHLj.png" alt="">&lt;/p>
&lt;p>æ¯”ç‰¹å¸ä¸€ä¸ªé‡è¦çš„å¯æ‰©å±•ç‰¹æ€§æ˜¯ï¼šå®ƒçš„åŒºå—å­˜å‚¨åœ¨å¤šå±‚æ¬¡æ•°æ®ç»“æž„ä¸­ã€‚ ä¸€ä¸ªåŒºå—çš„å“ˆå¸Œå®žé™…ä¸Šåªæ˜¯åŒºå—å¤´çš„å“ˆå¸Œï¼ŒåŒºå—å¤´æ˜¯ä¸€æ®µçº¦ 200 å­—èŠ‚çš„æ•°æ®ï¼ŒåŒ…å«æ—¶é—´æˆ³ã€éšæœºæ•°ã€ä¸Šä¸ªåŒºå—çš„å“ˆå¸Œå’Œé»˜å…‹å°”æ ‘æ ¹çš„å“ˆå¸Œï¼Œè€Œé»˜å…‹å°”æ ‘æ˜¯ä¸€ä¸ªå­˜å‚¨äº†è¯¥åŒºå—æ‰€æœ‰äº¤æ˜“çš„æ•°æ®ç»“æž„ã€‚&lt;/p>
&lt;p>é»˜å…‹å°”æ ‘æ˜¯ä¸€ç§äºŒå‰æ ‘ï¼Œç”±ä¸€ç»„å¶èŠ‚ç‚¹ã€ä¸€ç»„ä¸­é—´èŠ‚ç‚¹å’Œä¸€ä¸ªæ ¹èŠ‚ç‚¹æž„æˆã€‚æœ€ä¸‹é¢æ˜¯å¤§é‡åŒ…å«åŸºç¡€æ•°æ®çš„å¶èŠ‚ç‚¹ï¼Œ&lt;strong>æ¯ä¸ªä¸­é—´èŠ‚ç‚¹æ˜¯å…¶ä¸¤ä¸ªå­èŠ‚ç‚¹çš„å“ˆå¸Œ&lt;/strong>ï¼Œé¡¶éƒ¨çš„æ ¹èŠ‚ç‚¹ä¹Ÿæ˜¯å…¶ä¸¤ä¸ªå­èŠ‚ç‚¹çš„å“ˆå¸Œã€‚ é»˜å…‹å°”æ ‘çš„ç›®çš„æ˜¯å…è®¸åŒºå—æ•°æ®å¯ä»¥é›¶æ•£åœ°ä¼ é€ï¼š&lt;strong>èŠ‚ç‚¹å¯ä»¥ä»Žä¸€ä¸ªæºä¸‹è½½åŒºå—å¤´ï¼Œä»Žå…¶å®ƒæºä¸‹è½½ç›¸å…³æ ‘çš„ä¸€å°éƒ¨åˆ†ï¼Œè€Œä¾ç„¶èƒ½å¤Ÿç¡®è®¤æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯æ­£ç¡®çš„&lt;/strong>ã€‚&lt;/p>
&lt;p>ç®€åŒ–æ”¯ä»˜ç¡®è®¤åè®®ï¼ˆSPVï¼‰å…è®¸å¦ä¸€ç§èŠ‚ç‚¹å­˜åœ¨ï¼Œè¿™æ ·çš„èŠ‚ç‚¹è¢«ç§°ä¸ºâ€œè½»èŠ‚ç‚¹â€ï¼Œå®ƒä¸‹è½½åŒºå—å¤´ï¼Œä½¿ç”¨åŒºå—å¤´ç¡®è®¤å·¥ä½œé‡è¯æ˜Žï¼Œ&lt;strong>ç„¶åŽåªä¸‹è½½ä¸Žå…¶äº¤æ˜“ç›¸å…³çš„é»˜å…‹å°”æ ‘åˆ†æ”¯&lt;/strong>ã€‚ è¿™ä½¿å¾—è½»èŠ‚ç‚¹åªè¦ä¸‹è½½æ•´ä¸ªåŒºå—é“¾çš„ä¸€å°éƒ¨åˆ†ï¼Œå°±å¯ä»¥å®‰å…¨åœ°ç¡®å®šä»»ä½•ä¸€ç¬”æ¯”ç‰¹å¸äº¤æ˜“çš„çŠ¶æ€å’Œå¸æˆ·çš„å½“å‰ä½™é¢ã€‚&lt;/p>
&lt;h2 id="åè®®">åè®®&lt;/h2>
&lt;h3 id="double-spending-attack">double spending attack&lt;/h3>
&lt;p>æ•°å­—è´§å¸æœ¬èº«ä¸ºå¸¦æœ‰ç­¾åçš„æ•°æ®æ–‡ä»¶ï¼Œå¯ä»¥è¿›è¡Œå¤åˆ¶ã€‚å³ï¼šå¯¹ç”¨æˆ·æ¥è¯´ï¼Œå¯ä»¥å°†åŒä¸€è´§å¸èŠ±è´¹ä¸¤æ¬¡ã€‚&lt;/p>
&lt;p>å¯¹è´§å¸æ·»åŠ å”¯ä¸€ç¼–å·ï¼ˆä¸å¯ç¯¡æ”¹ï¼‰ï¼Œæ¯æ¬¡æ”¯ä»˜å‘è´§å¸å‘è¡Œå•ä½æŸ¥è¯¢çœŸä¼ªã€‚ è¯¥æ–¹æ³•æ¯æ¬¡äº¤æ˜“éƒ½éœ€è¦ä¾èµ–äºŽç¬¬ä¸‰æ–¹æœºæž„æ¥åˆ¤æ–­è´§å¸çœŸä¼ªä¸”é˜²æ­¢åŒèŠ±æ”»å‡»ã€‚æ˜¯ä¸€ä¸ªå…¸åž‹çš„ç¬¬ä¸‰æ–¹ä¸­å¿ƒåŒ–æ–¹æ¡ˆã€‚&lt;/p>
&lt;p>è€Œæ¯”ç‰¹å¸ç³»ç»Ÿä¸­æ˜¯é€šè¿‡æŒ–çŸ¿æ¥å†³å®šè´§å¸çš„å‘è¡Œæƒå’Œå‘è¡Œé‡ï¼Œé€šè¿‡ç³»ç»Ÿç»´æŠ¤çš„åŒºå—é“¾ç»“æž„æ¥è§£å†³åŒèŠ±é—®é¢˜&lt;/p>
&lt;h3 id="åˆ†å¸ƒå¼å…±è¯†">åˆ†å¸ƒå¼å…±è¯†&lt;/h3>
&lt;p>ä¸ºäº†ä¿è¯åŒºå—é“¾å†…å®¹åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šçš„ä¸€è‡´æ€§ï¼Œéœ€è¦å–å¾—åˆ†å¸ƒå¼å…±è¯†ã€‚&lt;/p>
&lt;p>FLPä¸å¯èƒ½ç»“è®º: åœ¨ä¸€ä¸ªå¼‚æ­¥ç³»ç»Ÿä¸­ï¼Œç½‘ç»œæ—¶å»¶æ— ä¸Šé™ï¼Œå³ä½¿åªæœ‰ä¸€ä¸ªæˆå‘˜æ˜¯æœ‰é—®é¢˜çš„ï¼Œä¹Ÿä¸å¯èƒ½è¾¾æˆå…±è¯†ã€‚&lt;/p>
&lt;p>CAPï¼ˆConsistencyä¸€è‡´æ€§ã€Availabilityå¯é æ€§ã€Partition toleranceå®¹é”™æ€§ï¼‰ Theorem: ä»»ä½•ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæœ€å¤šåªèƒ½æ»¡è¶³å…¶ä¸­ä¸¤ä¸ªæ€§è´¨ã€‚åˆ†å¸ƒå¼å…±è¯†ä¸­åè®®Paxos å¯ä»¥ä¿è¯Consistencyï¼ˆè‹¥è¾¾æˆå…±è¯†å¿…ç„¶ä¸€è‡´ï¼‰ï¼Œä½†åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šä¸€ç›´æ— æ³•è¾¾æˆå…±è¯†ã€‚&lt;/p>
&lt;p>å‡è®¾ç³»ç»Ÿä¸­å­˜åœ¨éƒ¨åˆ†èŠ‚ç‚¹æœ‰æ¶æ„ï¼Œä½†å­˜åœ¨æ¯”ä¾‹è¾ƒå°ã€‚å¤§å¤šæ•°èŠ‚ç‚¹ä¸ºâ€œå¥½â€çš„èŠ‚ç‚¹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹è¿›è¡Œå…±è¯†åè®®è®¾ç½®ã€‚&lt;/p>
&lt;p>æƒ³æ³•1ï¼šç›´æŽ¥æŠ•ç¥¨æŸä¸ªèŠ‚ç‚¹æ‰“åŒ…äº¤æ˜“åˆ°åŒºå—ï¼Œå°†å…¶å‘ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œå…¶ä»–èŠ‚ç‚¹æ£€æŸ¥è¯¥å€™é€‰åŒºå—ï¼Œæ£€æŸ¥è‹¥æ­£ç¡®æŠ•èµžæˆç¥¨ï¼Œè‹¥ç¥¨æ•°è¿‡åŠæ•°ï¼ŒåŠ å…¥åŒºå—é“¾ã€‚&lt;/p>
&lt;ul>
&lt;li>å­˜åœ¨çš„é—®é¢˜1â€”â€”æ¶æ„èŠ‚ç‚¹ä¸æ–­æ‰“åŒ…ä¸åˆæ³•åŒºå—ï¼Œå¯¼è‡´ä¸€ç›´æ— æ³•è¾¾æˆå…±è¯†ï¼Œæ—¶é—´å…¨èŠ±è´¹åœ¨æŠ•ç¥¨ä¸Šã€‚&lt;/li>
&lt;li>å­˜åœ¨çš„é—®é¢˜2â€”â€”æ— å¼ºè¿«æŠ•ç¥¨æ‰‹æ®µï¼ŒæŸäº›èŠ‚ç‚¹ä¸æŠ•ç¥¨ï¼ˆè¡Œæ”¿ä¸ä½œä¸ºï¼‰ã€‚&lt;/li>
&lt;li>å­˜åœ¨çš„é—®é¢˜3â€”â€”ç½‘ç»œå»¶è¿Ÿäº‹å…ˆæœªçŸ¥ï¼ŒæŠ•ç¥¨éœ€è¦ç­‰å¤šä¹…ï¼Ÿæ•ˆçŽ‡ä¸Šä¼šäº§ç”Ÿé—®é¢˜ã€‚&lt;/li>
&lt;li>æ›´å¤§çš„ä¸€ä¸ªé—®é¢˜â€”â€”membershipã€‚å¦‚æžœæ˜¯è”ç›Ÿé“¾ï¼Œå¯¹åŠ å…¥æˆå‘˜æœ‰è¦æ±‚ï¼Œå¯ä»¥åŸºäºŽæŠ•ç¥¨ã€‚ä½†æ¯”ç‰¹å¸ç³»ç»Ÿï¼Œä»»ä½•äººéƒ½å¯ä»¥åŠ å…¥ï¼Œä¸”åˆ›å»ºè´¦æˆ·åŠå…¶ç®€å•ï¼Œåªéœ€è¦æœ¬åœ°äº§ç”Ÿå…¬ç§é’¥å¯¹å³å¯ã€‚åªæœ‰è½¬è´¦ï¼ˆäº¤æ˜“ï¼‰æ—¶å€™,æ¯”ç‰¹å¸ç³»ç»Ÿæ‰èƒ½çŸ¥é“è¯¥è´¦æˆ·çš„å­˜åœ¨ã€‚è¿™æ ·ï¼Œé»‘å®¢å¯ä»¥ä½¿ç”¨è®¡ç®—æœºä¸“é—¨ç”Ÿæˆå¤§é‡å…¬ç§é’¥å¯¹ï¼Œå½“å…¶äº§ç”Ÿå¤§é‡å…¬ç§é’¥å¯¹è¶…è¿‡ç³»ç»Ÿä¸­ä¸€åŠæ•°ç›®ï¼Œå°±å¯ä»¥èŽ·å¾—æ”¯é…åœ°ä½ï¼ˆ&lt;strong>å¥³å·«æ”»å‡»&lt;/strong>ï¼‰ã€‚&lt;/li>
&lt;/ul>
&lt;p>æ‰€ä»¥ï¼Œè¿™ç§ç®€å•çš„æŠ•ç¥¨æ–¹æ¡ˆä¹Ÿæ˜¯ä¸å¯è¡Œçš„ã€‚&lt;/p>
&lt;p>æ¯”ç‰¹å¸ç³»ç»Ÿä¸­é‡‡ç”¨äº†å¾ˆå·§å¦™çš„æ–¹æ¡ˆè§£å†³è¿™ä¸ªé—®é¢˜ã€‚è™½ç„¶ä»ç„¶æ˜¯æŠ•ç¥¨ï¼Œä½†å¹¶éžç®€å•çš„æ ¹æ®è´¦æˆ·æ•°ç›®ï¼Œè€Œæ˜¯ä¾æ®è®¡ç®—åŠ›è¿›è¡ŒæŠ•ç¥¨ã€‚ åœ¨æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯ä»¥è‡ªè¡Œç»„è£…ä¸€ä¸ªå€™é€‰åŒºå—ï¼Œè€ŒåŽï¼Œå°è¯•å„ç§nonceå€¼ï¼Œè¿™å°±æ˜¯æŒ–çŸ¿ã€‚[H(block header)&amp;lt;=target] å½“æŸä¸ªèŠ‚ç‚¹æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„nonceï¼Œä¾¿èŽ·å¾—äº†è®°è´¦æƒï¼Œä»Žè€Œå¯ä»¥å°†åŒºå—å‘å¸ƒåˆ°ç³»ç»Ÿä¸­ã€‚å…¶ä»–èŠ‚ç‚¹å—åˆ°åŒºå—åŽï¼ŒéªŒè¯åŒºå—åˆæ³•æ€§ï¼Œå¦‚æžœç³»ç»Ÿä¸­ç»å¤§å¤šæ•°èŠ‚ç‚¹éªŒè¯é€šè¿‡ï¼Œåˆ™æŽ¥æ”¶è¯¥åŒºå—ä¸ºæœ€æ–°çš„åŒºå—å¹¶åŠ å…¥åˆ°åŒºå—é“¾ä¸­ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>å¯èƒ½å‡ºçŽ°åˆ†å‰æƒ…å†µã€‚å½“ä¸¤ä¸ªèŠ‚ç‚¹åŒæ—¶èŽ·å¾—è®°è´¦æƒï¼Œè¿™æ—¶å°±ä¼šå‡ºçŽ°åˆ†å‰ï¼Œä½†åŒºå—é“¾åªæ‰¿è®¤æœ€é•¿åˆæ³•é“¾ï¼Œéšç€æ—¶é—´æŽ¨ç§»ï¼Œå¿…ç„¶å­˜åœ¨æŸä¸€æ¡é“¾å˜æˆæœ€é•¿åˆæ³•é“¾ã€‚è¿™æ ·ï¼Œä¹Ÿå°±ä¼šå¯¼è‡´åˆæ³•åŒºå—è¢«æ‹’ç»&lt;/p>
&lt;/li>
&lt;li>
&lt;p>åˆ†å‰æ”»å‡»ã€‚Aç”¨æˆ·å¯¹ä¸Šé¢çš„Aè½¬è´¦ç»™Bçš„è®°å½•å›žæ»šï¼Œä»Žè€Œéžæ³•èŽ·å–åˆ©ç›Šã€‚åœ¨ä¸¤æ¡é“¾ä¸Šï¼Œå‘çŽ°äº¤æ˜“éƒ½åˆæ³•ã€‚è¿™æ˜¯ä¸€ä¸ªå…¸åž‹çš„åŒèŠ±æ”»å‡»ã€‚Aç»™Bè½¬è´¦åŽï¼Œç”¨åˆ†å‰æ”»å‡»å°†é’±åˆè½¬å›žæ¥ï¼Œè¦†ç›–æŽ‰åŽŸæ¥çš„è®°å½•ã€‚ åœ¨æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ï¼Œè¿™ç§æƒ…å†µå®žé™…ä¸Šå¾ˆéš¾å‘ç”Ÿã€‚å› ä¸ºå¤§å¤šæ•°çŸ¿å·¥è®¤å¯çš„æ˜¯æœ€é•¿çš„åˆæ³•é“¾ï¼Œä¼šæ²¿ç€ä¸Šé¢çš„é“¾ç»§ç»­æŒ–ä¸‹åŽ»ã€‚è€ŒAè¿™ä¸ªæ”»å‡»è€…è¦æƒ³å›žé€€è®°å½•ï¼Œå°±å¿…é¡»ä½¿å¾—ä¸‹é¢çš„é“¾å˜å¾—æ¯”ä¸Šé¢çš„é“¾è¿˜é•¿ã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œæ”»å‡»è€…éœ€è¦è¾¾åˆ°æ•´ä¸ªç³»ç»Ÿä¸­51%çš„è®¡ç®—åŠ›ï¼Œæ‰èƒ½ä½¿å¾—è¿™ç§æ”»å‡»æˆåŠŸ&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="æ¿€åŠ±æœºåˆ¶">æ¿€åŠ±æœºåˆ¶&lt;/h3>
&lt;p>èŠ‚ç‚¹ç«žäº‰è®°è´¦æƒéœ€è¦æ¶ˆè€—ç®—åŠ›å’Œç”µåŠ›æˆæœ¬ï¼Œä¸ºäº†è®©æ¿€åŠ±èŠ‚ç‚¹å‚ä¸Žï¼Œç³»ç»Ÿä¼šç»™å‡ºå—èŠ‚ç‚¹ &lt;strong>å‡ºå—å¥–åŠ±&lt;/strong>ï¼Œä¸€ä¸ªèŽ·å¾—åˆæ³•åŒºå—çš„èŠ‚ç‚¹ï¼Œå¯ä»¥åœ¨åŒºå—ä¸­åŠ å…¥ä¸€ä¸ªç‰¹æ®Šäº¤æ˜“ï¼ˆé“¸å¸äº¤æ˜“ï¼‰ã€‚äº‹å®žä¸Šï¼Œè¿™ç§æ–¹å¼ä¹Ÿæ˜¯å”¯ä¸€ä¸€ä¸ªäº§ç”Ÿæ–°æ¯”ç‰¹å¸çš„é€”å¾„ã€‚&lt;/p>
&lt;p>æ¯”ç‰¹å¸ç³»ç»Ÿè®¾è®¡è§„å®šï¼Œèµ·åˆæ¯ä¸ªåŒºå—å¯ä»¥èŽ·å¾—50ä¸ªæ¯”ç‰¹å¸ï¼Œä½†ä¹‹åŽ&lt;strong>æ¯éš”21ä¸‡ä¸ªåŒºå—&lt;/strong>ï¼Œå¥–åŠ±å‡åŠã€‚å› ä¸ºå¹³å‡å‡ºå—æ—¶é—´ä¸º&lt;strong>10åˆ†é’Ÿ&lt;/strong>ï¼Œå¯ä»¥ç®—å‡ºå¤§çº¦&lt;strong>å››å¹´&lt;/strong>å‡åŠã€‚&lt;/p>
&lt;p>åŒºå—ä¸­ä¿å­˜äº¤æ˜“è®°å½•ï¼Œå¦‚æžœä»…ä»…è®¾ç½®å‡ºå—å¥–åŠ±ï¼Œé‚£ä¹ˆï¼Œä¼šä¸ä¼šå­˜åœ¨èŠ‚ç‚¹åªæƒ³å‘å¸ƒåŒºå—èŽ·å¾—å‡ºå—å¥–åŠ±è€Œä¸æƒ³æ‰“åŒ…äº¤æ˜“ï¼Ÿ&lt;/p>
&lt;p>BTCç³»ç»Ÿè®¾è®¡äº†&lt;strong>Tranction feeï¼ˆäº¤æ˜“è´¹ï¼‰&lt;/strong>ï¼Œæ¯ä¸ªäº¤æ˜“å¯ä»¥æœ‰å¤šä¸ªè¾“å…¥ï¼Œä¹Ÿå¯ä»¥æœ‰å¤šä¸ªè¾“å‡ºï¼Œä½†è¾“å…¥ä¹‹å’Œè¦ç­‰äºŽè¾“å‡ºä¹‹å’Œï¼ˆtotal inputs = total outputsï¼‰ã€‚ å­˜åœ¨ä¸€äº›äº¤æ˜“çš„total inputs ç•¥å¤§äºŽ total outputsï¼Œè¿™éƒ¨åˆ†å·®é¢ä¾¿ä½œä¸ºäº¤æ˜“è´¹ï¼Œç»™äº†èŽ·å¾—è®°è´¦æƒçš„èŠ‚ç‚¹ã€‚å¯¹äºŽèŽ·å¾—è®°è´¦æƒèŠ‚ç‚¹æ¥è¯´ï¼Œé™¤äº†å‡ºå—å¥–åŠ±ä¹‹å¤–ï¼Œè¿˜å¯ä»¥å¾—åˆ°æ‰“åŒ…äº¤æ˜“çš„äº¤æ˜“è´¹ã€‚ä½†ç›®å‰æ¥è¯´ï¼Œäº¤æ˜“è´¹è¿œè¿œå°äºŽå‡ºå—å¥–åŠ±ã€‚ç­‰åˆ°æœªæ¥å‡ºå—å¥–åŠ±å˜å°‘ï¼Œå¯èƒ½åŒºå—é“¾çš„ç»´æŠ¤ä¾¿ä¸»è¦ä¾èµ–äºŽäº¤æ˜“è´¹äº†ã€‚&lt;/p>
&lt;h2 id="å®žçŽ°">å®žçŽ°&lt;/h2>
&lt;h3 id="utxo">UTXO&lt;/h3>
&lt;p>æ¯”ç‰¹å¸é‡‡ç”¨äº† &lt;strong>åŸºäºŽäº¤æ˜“çš„è´¦æœ¬æ¨¡å¼&lt;/strong> ã€‚ç„¶è€Œï¼Œç³»ç»Ÿä¸­å¹¶æ— æ˜¾ç¤ºè®°å½•è´¦æˆ·åŒ…å«æ¯”ç‰¹å¸æ•°ï¼Œå®žé™…ä¸Šå…¶éœ€è¦é€šè¿‡äº¤æ˜“è®°å½•è¿›è¡ŒæŽ¨ç®—ã€‚åœ¨æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ï¼Œå…¨èŠ‚ç‚¹éœ€è¦ç»´æŠ¤ä¸€ä¸ªåä¸º &lt;strong>UTXO&lt;/strong>(Unspent Transaction Outputå°šæœªè¢«èŠ±æŽ‰çš„äº¤æ˜“è¾“å‡º) çš„æ•°æ®ç»“æž„ã€‚&lt;/p>
&lt;p>Aè½¬ç»™Bäº”ä¸ªBTCï¼Œè½¬ç»™Cä¸‰ä¸ªBTCï¼ŒBå°†äº”ä¸ªBTCèŠ±æŽ‰ï¼Œåˆ™è¯¥äº¤æ˜“è®°å½•ä¸ä¿å­˜åœ¨UTXOä¸­ï¼ŒCæ²¡æœ‰èŠ±æŽ‰ï¼Œåˆ™è¯¥äº¤æ˜“è®°å½•ä¿å­˜åœ¨UTXOä¸­&lt;/p>
&lt;p>UTXOé›†åˆä¸­æ¯ä¸ªå…ƒç´ è¦ç»™å‡ºäº§ç”Ÿè¿™ä¸ªè¾“å‡ºçš„äº¤æ˜“çš„å“ˆå¸Œå€¼ï¼Œä»¥åŠå…¶åœ¨äº¤æ˜“ä¸­æ˜¯ç¬¬å‡ ä¸ªè¾“å‡ºã€‚é€šè¿‡è¿™ä¸¤ä¸ªä¿¡æ¯ï¼Œä¾¿å¯ä»¥å®šä½åˆ°UTXOä¸­çš„è¾“å‡ºã€‚&lt;/p>
&lt;blockquote>
&lt;p>åˆ¤æ–­ä¸€ä¸ªäº¤æ˜“æ˜¯å¦åˆæ³•ï¼Œè¦æŸ¥ä¸€ä¸‹æƒ³è¦èŠ±æŽ‰çš„BTCæ˜¯å¦åœ¨è¯¥é›†åˆä¸­ï¼Œåªæœ‰åœ¨é›†åˆä¸­æ‰æ˜¯åˆæ³•çš„ã€‚å¦‚æžœæƒ³è¦èŠ±æŽ‰çš„BTCä¸åœ¨UTXOä¸­ï¼Œé‚£ä¹ˆè¯´æ˜Žè¿™ä¸ªBTCè¦ä¹ˆæ ¹æœ¬ä¸å­˜åœ¨ï¼Œè¦ä¹ˆå·²ç»è¢«èŠ±è¿‡ã€‚æ‰€ä»¥ï¼Œå…¨èŠ‚ç‚¹éœ€è¦åœ¨å†…å­˜ä¸­ç»´æŠ¤ä¸€ä¸ªUTXOï¼Œä»Žè€Œä¾¿äºŽå¿«é€Ÿæ£€æµ‹double spendingï¼ˆåŒèŠ±æ”»å‡»ï¼‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="ç½‘ç»œ">ç½‘ç»œ&lt;/h2>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/01/gzeoK1dSaJf4VRL.png" alt="">&lt;/p>
&lt;p>bitcoin ç½‘ç»œå±‚ä½¿ç”¨çš„æ˜¯p2pç½‘ç»œï¼ŒåŒºå—é“¾è¿è¡Œåœ¨åº”ç”¨å±‚ã€‚&lt;/p>
&lt;p>èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡é‡‡ç”¨äº†TCPåè®®ï¼Œä¾¿äºŽç©¿é€é˜²ç«å¢™ã€‚&lt;/p>
&lt;p>å½“ä¸€ä¸ªèŠ‚ç‚¹è¦åŠ å…¥ç½‘ç»œæ—¶ï¼Œè¦å…ˆæ‰¾åˆ°ä¸€ä¸ªseed node (ç§å­èŠ‚ç‚¹)ï¼Œé€šè¿‡è¿™ä¸ªç§å­èŠ‚ç‚¹æ¥èŽ·å¾—å…¶ä»–èŠ‚ç‚¹ã€‚é€€å‡ºæ—¶è‡ªè¡Œé€€å‡ºï¼Œè¿‡æ®µæ—¶é—´å…¶ä»–èŠ‚ç‚¹å°±ä¼šæŠŠå®ƒä»Žç½‘ç»œä¸­åˆ é™¤ã€‚&lt;/p>
&lt;p>ç½‘ç»œè®¾è®¡åŽŸåˆ™: &lt;strong>simple,robust,but not efficient&lt;/strong>&lt;/p>
&lt;p>èŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªæ”¶åˆ°çš„å¾…ä¸Šé“¾çš„äº¤æ˜“é›†åˆï¼Œå½“ç¬¬ä¸€æ¬¡æ”¶åˆ°ä¸€ä¸ªäº¤æ˜“æ—¶ï¼Œä¼šè½¬å‘ç»™é‚»å±…èŠ‚ç‚¹å¹¶åŠ å…¥é›†åˆï¼Œä¸‹æ¬¡æ”¶åˆ°æ—¶å°±ä¸ä¼šè½¬å‘ã€‚å½“äº¤æ˜“ä¸Šé“¾å°±æŠŠå®ƒåˆ æŽ‰ã€‚&lt;/p>
&lt;p>å‡å¦‚ç½‘ç»œä¸­å­˜åœ¨ä¸¤ä¸ªå†²çªäº¤æ˜“ï¼Œå¦‚äº¤æ˜“1ï¼šA-&amp;gt;B,äº¤æ˜“2ï¼šA-&amp;gt;Cï¼ˆå‡è®¾èŠ±è´¹çš„åŒä¸€ç¬”é’±ï¼‰ã€‚å…·ä½“æŽ¥æ”¶å“ªä¸ªå–å†³äºŽèŠ‚ç‚¹å…ˆæŽ¥æ”¶åˆ°å“ªä¸ªäº¤æ˜“ï¼Œä¹‹åŽæ”¶åˆ°å¦ä¸€ä¸ªäº¤æ˜“ä¼šå°†å…¶æ”¾å¼ƒã€‚&lt;/p>
&lt;p>æ–°å‘å¸ƒåŒºå—åœ¨ç½‘ç»œä¸­ä¼ æ’­æ–¹å¼ä¸Žæ–°å‘å¸ƒäº¤æ˜“ä¼ æ’­æ–¹å¼ç±»ä¼¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹é™¤æ£€æŸ¥è¯¥åŒºå—å†…å®¹æ˜¯å¦åˆæ³•ï¼Œè¿˜è¦æ£€æŸ¥æ˜¯å¦ä½äºŽæœ€é•¿åˆæ³•é“¾ä¸Šã€‚åŒºå—è¶Šå¤§ï¼Œåˆ™ç½‘ç»œä¸Šä¼ è¾“è¶Šæ…¢ã€‚BTCåè®®å¯¹äºŽåŒºå—å¤§å°é™åˆ¶ä¸ºä¸å¤§äºŽ1Må¤§å°.&lt;/p>
&lt;p>æ­¤å¤–ï¼Œæ¯”ç‰¹å¸ç½‘ç»œä¼ æ’­å±žäºŽ Best effortï¼ˆå°½åŠ›è€Œä¸ºï¼‰ ï¼Œä¸èƒ½ä¿è¯ä¸€å®šä¼ è¾“æˆåŠŸã€‚ä»¥ä¸€ä¸ªäº¤æ˜“å‘å¸ƒåˆ°ç½‘ç»œä¸Šï¼Œæœªå¿…æ‰€æœ‰èŠ‚ç‚¹éƒ½èƒ½æ”¶åˆ°ï¼Œä¹Ÿæœªå¿…æ‰€æœ‰èŠ‚ç‚¹æ”¶åˆ°äº¤æ˜“é¡ºåºéƒ½ä¸€è‡´ã€‚&lt;/p>
&lt;h2 id="æŒ–çŸ¿">æŒ–çŸ¿&lt;/h2>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/02/84z1iTa5Qk3CgLd.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/02/9EWYarsVecQ7ij3.png" alt="">&lt;/p>
&lt;p>ä»Ž blockchain.com ç½‘ç«™ æˆªå–ä¸€ä¸ªæœ€è¿‘çš„block:&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/03/t1FDuAzh3HmIQLq.png" alt="">&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°ï¼ŒåŒºå—å“ˆå¸Œä¸Žå‰ä¸€åŒºå—å“ˆå¸Œéƒ½æ˜¯ä»¥ä¸€é•¿ä¸²0å¼€å¤´çš„ï¼ŒæŒ–çŸ¿æœ¬èº«å°±æ˜¯å°è¯•å„ç§nonceï¼Œä½¿å¾—äº§ç”Ÿçš„åŒºå—å“ˆå¸Œå€¼å°äºŽç­‰äºŽç›®æ ‡é˜ˆå€¼ã€‚&lt;/p>
&lt;p>çœ‹ä¸€ä¸‹ block header çš„ä»£ç æè¿°: &lt;a href="https://github.com/bitcoin/bitcoin/blob/master/src/primitives/block.h">bitcoin&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/03/sC3A8qNUnXYLa9D.png" alt="">&lt;/p>
&lt;p>nonceæ˜¯ä¸€ä¸ª32ä½çš„æ— ç¬¦å·æ•´åž‹æ•°æ®ï¼Œåœ¨æŒ–çŸ¿æ—¶å€™æ˜¯é€šè¿‡ä¸æ–­è°ƒæ•´nonceè¿›è¡Œçš„ï¼Œä½†å¯ä»¥çœ‹åˆ°ï¼Œnonceçš„å–å€¼æœ€å¤šä¸º$2^{32}$ç§ã€‚ä½†å¹¶éžå°†è¿™äº›nonceå…¨éƒ¨éåŽ†ä¸€éï¼Œå°±ä¸€å®šèƒ½æ‰¾åˆ°ç¬¦åˆè¦æ±‚çš„nonceã€‚ç”±äºŽè¿‘å¹´æ¥ï¼ŒæŒ–çŸ¿äººå‘˜è¶Šæ¥è¶Šå¤šï¼ŒæŒ–çŸ¿éš¾åº¦å·²ç»è°ƒæ•´çš„æ¯”è¾ƒå¤§äº†ï¼Œè€Œè¿™ä¸€æœç´¢ç©ºé—´å¤ªå°ï¼Œæ‰€ä»¥ä»…è°ƒæ•´nonceå¾ˆå¤§å¯èƒ½æ‰¾ä¸åˆ°æ­£ç¡®çš„ç»“æžœã€‚&lt;/p>
&lt;p>å¯ä»¥çœ‹åˆ°é™¤äº†nonceå…¶ä»–çš„å…ƒç´ åªæœ‰ntimeå’ŒhashMerkleRootå¯ä»¥è¿›è¡Œè°ƒæ•´ã€‚æˆ‘ä»¬ä¸»è¦æ˜¯è°ƒæ•´MerkleRootã€‚&lt;/p>
&lt;p>æ¯ä¸ªå‘å¸ƒåŒºå—è€…å¯ä»¥å¾—åˆ°å‡ºå—å¥–åŠ±ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥åœ¨åŒºå—ä¸­å‘å¸ƒä¸€ä¸ª é“¸å¸äº¤æ˜“(coinbaseäº¤æ˜“),è¿™ä¹Ÿæ˜¯BTCç³»ç»Ÿä¸­äº§ç”Ÿæ–°æ¯”ç‰¹å¸çš„å”¯ä¸€æ–¹å¼ã€‚ä¸­å¯ä»¥å†™å…¥ä»»ä½•å†…å®¹ï¼Œåœ¨è¿™é‡Œå†™ä»€ä¹ˆéƒ½æ²¡æœ‰å½±å“ã€‚æ‰€ä»¥å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€äº›ä»»æ„ä¿¡æ¯ï¼Œä¾¿å¯ä»¥å®žçŽ°æ— æ³•ç¯¡æ”¹ï¼ˆä¹Ÿæ— æ³•åˆ é™¤ï¼‰ã€‚æ‰€ä»¥ï¼Œåªè¦æˆ‘ä»¬æ”¹å˜äº†å†™å…¥å†…å®¹ï¼Œä¾¿å¯ä»¥æ”¹å˜Merkle Tree çš„æ ¹å“ˆå¸Œå€¼ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œåœ¨å®žé™…çš„æŒ–çŸ¿ä¸­ï¼ŒåŒ…å«ä¸¤å±‚å¾ªçŽ¯ã€‚å¤–å±‚å¾ªçŽ¯è°ƒæ•´coinbaseåŸŸï¼ˆå¯ä»¥è§„å®šåªå°†å…¶ä¸­å‰xä¸ªå­—èŠ‚ä½œä¸ºå¦ä¸€ä¸ªnonceï¼‰ï¼Œç®—å‡ºblock headerä¸­æ ¹å“ˆå¸Œå€¼åŽï¼Œå†…å±‚å¾ªçŽ¯å†è°ƒæ•´nonceã€‚&lt;/p>
&lt;h3 id="æ¦‚çŽ‡åˆ†æž">æ¦‚çŽ‡åˆ†æž&lt;/h3>
&lt;p>æŒ–çŸ¿æœ¬è´¨ä¸Šæ˜¯ä¸æ–­å°è¯•å„ç§nonceï¼Œæ¥æ±‚è§£è¿™æ ·ä¸€ä¸ªpuzzleã€‚æ¯æ¬¡å°è¯•nonceï¼Œå¯ä»¥è§†ä¸ºä¸€æ¬¡ä¼¯åŠªåˆ©è¯•éªŒã€‚æœ€å…¸åž‹çš„ä¼¯åŠªåˆ©è¯•éªŒå°±æ˜¯æŠ•æŽ·ç¡¬å¸ï¼Œæ­£é¢å’Œåé¢æœä¸Šæ¦‚çŽ‡ä¸ºpå’Œ1-pã€‚åœ¨æŒ–çŸ¿è¿‡ç¨‹ä¸­ï¼Œä¸€æ¬¡ä¼¯åŠªåˆ©è¯•éªŒï¼ŒæˆåŠŸçš„æ¦‚çŽ‡æžå°ï¼Œå¤±è´¥çš„æ¦‚çŽ‡æžå¤§ã€‚æŒ–çŸ¿ä¾¿æ˜¯å¤šæ¬¡è¿›è¡Œä¼¯åŠªåˆ©è¯•éªŒï¼Œä¸”æ¯æ¬¡éšæœºã€‚è¿™äº›ä¼¯åŠªåˆ©è¯•éªŒä¾¿æž„æˆäº†a sequence of independent Bernoulli trials(ä¸€ç³»åˆ—ç‹¬ç«‹çš„ä¼¯åŠªåˆ©è¯•éªŒ)ã€‚æ ¹æ®æ¦‚çŽ‡è®ºç›¸å…³çŸ¥è¯†çŸ¥é“ï¼Œä¼¯åŠªåˆ©è¯•éªŒæœ¬èº«å…·æœ‰æ— è®°å¿†æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ— è®ºä¹‹å‰åšå¤šå°‘å¤§é‡è¯•éªŒï¼Œå¯¹åŽç»­ç»§ç»­è¯•éªŒæ²¡æœ‰ä»»ä½•å½±å“ã€‚ å¯¹äºŽæŒ–çŸ¿æ¥è¯´ï¼Œä¾¿æ˜¯å¤šæ¬¡ä¼¯åŠªåˆ©è¯•éªŒå°è¯•nonceï¼Œæœ€ç»ˆæ‰¾åˆ°ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„nonceã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥é‡‡ç”¨æ³Šæ¾åˆ†å¸ƒè¿›è¡Œè¿‘ä¼¼ï¼Œç”±æ­¤é€šè¿‡æ¦‚çŽ‡è®ºå¯ä»¥æŽ¨æ–­å‡ºï¼Œç³»ç»Ÿå‡ºå—æ—¶é—´æœä»ŽæŒ‡æ•°åˆ†å¸ƒã€‚(éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‡ºå—æ—¶é—´æŒ‡çš„æ˜¯æ•´ä¸ªç³»ç»Ÿå‡ºå—æ—¶é—´ï¼Œå¹¶éžæŒ–çŸ¿çš„ä¸ªäºº)&lt;/p>
&lt;p>ç³»ç»Ÿå¹³å‡å‡ºå—æ—¶é—´ä¸º10minï¼Œè¯¥æ—¶é—´ä¸ºç³»ç»Ÿæœ¬èº«è®¾è®¡ï¼Œé€šè¿‡éš¾åº¦è°ƒæ•´ç»´æŠ¤å…¶å¹³å‡å‡ºå—æ—¶é—´ã€‚ æŒ‡æ•°åˆ†å¸ƒæœ¬èº«ä¹Ÿå…·æœ‰æ— è®°å¿†æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹æ•´ä¸ªç³»ç»Ÿè€Œè¨€ï¼Œå·²ç»è¿‡åŽ»10minï¼Œä»ç„¶æ²¡æœ‰äººæŒ–åˆ°åŒºå—ï¼Œé‚£ä¹ˆå¹³å‡ä»ç„¶è¿˜éœ€è¦ç­‰10minï¼ˆå¾ˆä¸ç¬¦åˆäººçš„ç›´è§‰ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå°†æ¥è¦æŒ–å¤šä¹…å’Œå·²ç»æŒ–å¤šä¹…æ— å…³ã€‚&lt;/p>
&lt;h3 id="å·¥å…·æ¼”åŒ–">å·¥å…·æ¼”åŒ–&lt;/h3>
&lt;p>CPU-&amp;gt;GPU-&amp;gt;ASICä¸“ç”¨çŸ¿æœº&lt;/p>
&lt;h3 id="çŸ¿æ± ">çŸ¿æ± &lt;/h3>
&lt;p>çŸ¿æ± é€šå¸¸æ˜¯ä¸€ä¸ªå…¨èŠ‚ç‚¹é©±åŠ¨å¤šå°çŸ¿æœºã€‚çŸ¿å·¥åªéœ€è¦ä¸åœè®¡ç®—å“ˆå¸Œå€¼ï¼Œè€Œå…¨èŠ‚ç‚¹å…¶ä»–èŒè´£ç”±çŸ¿ä¸»æ¥æ‰¿æ‹…ã€‚ASICèŠ¯ç‰‡åªèƒ½è®¡ç®—å“ˆå¸Œå€¼ï¼Œä¸èƒ½å®žçŽ°å…¨èŠ‚ç‚¹å…¶ä»–åŠŸèƒ½ã€‚æ­¤å¤–ï¼ŒçŸ¿æ± å‡ºçŽ°è§£å†³äº†å•ä¸ªçŸ¿å·¥æ”¶ç›Šä¸ç¨³å®šçš„é—®é¢˜ã€‚å½“èŽ·å¾—æ”¶ç›ŠåŽï¼Œæ‰€æœ‰çŸ¿å·¥å¯¹æ”¶ç›Šè¿›è¡Œåˆ†é…ï¼Œä»Žè€Œä¿è¯äº†æ”¶ç›Šçš„ç¨³å®šæ€§ã€‚&lt;/p>
&lt;p>çŸ¿æ± ä¸€èˆ¬å…·æœ‰ä¸¤ç§ç»„ç»‡å½¢å¼ã€‚&lt;/p>
&lt;p>1.ç±»ä¼¼å¤§åž‹æ•°æ®ä¸­å¿ƒï¼ˆåŒä¸€æœºæž„ï¼‰ï¼Œé›†ä¸­æˆåƒä¸Šä¸‡çŸ¿æœºè¿›è¡Œå“ˆå¸Œè®¡ç®—ã€‚&lt;/p>
&lt;p>2.åˆ†å¸ƒå¼ã€‚çŸ¿å·¥ä¸ŽçŸ¿ä¸»ä¸è®¤è¯†(ä¸åŒæœºæž„)ï¼ŒçŸ¿å·¥ä¸ŽçŸ¿ä¸»è”ç³»ï¼Œè‡ªæ„¿åŠ å…¥å…¶çŸ¿æ± ï¼ŒçŸ¿ä¸»åˆ†é…ä»»åŠ¡ï¼ŒçŸ¿å·¥è¿›è¡Œè®¡ç®—ï¼ŒèŽ·å¾—æ”¶ç›ŠåŽæ•´ä¸ªçŸ¿æ± ä¸­æ‰€æœ‰çŸ¿å·¥è¿›è¡Œåˆ©ç›Šåˆ†é…ã€‚&lt;/p>
&lt;h3 id="éš¾åº¦è°ƒæ•´">éš¾åº¦è°ƒæ•´&lt;/h3>
&lt;p>åœ¨æ¯”ç‰¹å¸ç³»ç»Ÿä¸­ï¼ŒåŒºå—é“¾çš„å‡ºå—æ—¶é—´ä¿æŒåœ¨å¹³å‡10minå·¦å³ã€‚æ¯«æ— ç–‘é—®çš„æ˜¯ï¼Œä¼´éšç€å‚ä¸ŽæŒ–çŸ¿çš„äººå¢žå¤šï¼Œç³»ç»Ÿæ€»ç®—åŠ›ä¸æ–­å¢žå¼ºï¼Œå‡ºå—æ—¶é—´è¶Šæ¥è¶ŠçŸ­ï¼Œè™½ç„¶æé«˜äº†ç³»ç»Ÿæ•ˆçŽ‡ä½†æ˜¯å¢žåŠ äº†ä¸ç¨³å®šæ€§ï¼Œä¸åˆ©äºŽè¾¾æˆå…±è¯†ï¼Œæ‰€ä»¥æŒ–çŸ¿çš„éš¾åº¦ç»å¯¹ä¸èƒ½ä¸€æˆä¸å˜ã€‚&lt;/p>
&lt;p>&lt;strong>è¿™é‡Œçš„éš¾åº¦ç³»æ•°å°±æ˜¯ä¸Šé¢blockä¿¡æ¯ä¸­çš„difficulty&lt;/strong>ã€‚&lt;/p>
&lt;p>H(block header)&amp;lt;=target.ï¼ˆtargetä¾¿æ˜¯ç›®æ ‡é˜ˆå€¼ï¼Œtargetè¶Šå°ï¼Œç›®æ ‡éš¾åº¦å°±è¶Šå¤§ï¼‰å¯¹äºŽæŒ–çŸ¿éš¾åº¦çš„è°ƒæ•´ï¼Œå¯ä»¥è§†ä¸ºè°ƒæ•´ç›®æ ‡ç©ºé—´åœ¨æ•´ä¸ªè¾“å‡ºç©ºé—´ä¸­æ‰€å æ¯”ä¾‹å¤§å°ã€‚&lt;/p>
&lt;p>ä¹‹å‰æœ‰æåŠï¼Œæ¯”ç‰¹å¸ç³»ç»Ÿé‡‡ç”¨çš„å“ˆå¸Œç®—æ³•ä¸ºSHA-256ï¼Œæ‰€ä»¥æ•´ä¸ªè¾“å‡ºç©ºé—´å¤§å°ä¸º$2^{256}$ï¼Œè°ƒæ•´ç›®æ ‡ç©ºé—´æ‰€å æ¯”ä¾‹ï¼Œç®€å•çš„è¯´éœ€è¦ç›®æ ‡å€¼å‰éœ€è¦å¤šå°‘ä¸ª0ã€‚ å½“ç„¶ï¼ŒæŒ–çŸ¿éš¾åº¦å’Œç›®æ ‡é˜ˆå€¼æˆåæ¯”ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå…¶ä¸­difficulty-1-targetä¸ºæ˜¯æŒ–çŸ¿éš¾åº¦ä¸º1æ—¶å€™çš„targetï¼Œå³æœ€å°æŒ–çŸ¿éš¾åº¦:&lt;/p>
&lt;p>$$difficulty = \frac{difficulty-1-target}{target} $$&lt;/p>
&lt;p>åœ¨BTCåè®®ä¸­è§„å®šï¼Œæ¯éš”2016ä¸ªåŒºå—éœ€è¦è°ƒæ•´ä¸€æ¬¡éš¾åº¦ï¼Œæ ¹æ®10minäº§ç”Ÿä¸€ä¸ªæ–°åŒºå—å¯ä»¥å¾—åˆ°ï¼Œå¤§æ¦‚éœ€è¦14å¤©çš„æ—¶é—´ã€‚å…·ä½“è°ƒæ•´å…¬å¼å¦‚ä¸‹ï¼š&lt;/p>
&lt;p>$$\text { target }=\text { target } * \frac{\text { actual time }}{\text { expected time }}$$&lt;/p>
&lt;blockquote>
&lt;p>å¯è§ï¼Œå¦‚æžœå®žé™…æ—¶é—´æ¯”è¾ƒé•¿ï¼Œtargetä¼šæ¯”è¾ƒå¤§ï¼Œç›¸åº”çš„æŒ–çŸ¿éš¾åº¦ä¼šé™ä½Žï¼›å¦‚æžœå®žé™…æ—¶é—´æ¯”è¾ƒçŸ­ï¼Œtargetä¼šæ¯”è¾ƒå°ï¼Œç›¸åº”çš„æŒ–çŸ¿éš¾åº¦ä¼šå¢žå¤§ã€‚&lt;/p>
&lt;/blockquote>
&lt;p>å¦‚ä½•è®©æ‰€æœ‰çŸ¿å·¥éƒ½æ„¿æ„è°ƒæ•´è¿™ä¸ªæŒ–çŸ¿éš¾åº¦å‘¢ï¼Ÿ è¿™ä¸€è°ƒæ•´ç®—æ³•åœ¨ä»£ç ä¸­å·²ç»å†™å…¥ï¼Œå¦‚æžœæœ‰æ¶æ„èŠ‚ç‚¹æ•…æ„ä¸è°ƒï¼Œå…¶æ‰€äº§ç”Ÿçš„åŒºå—ä¸ä¼šè¢«å¤§å¤šæ•°è¯šå®žçš„èŠ‚ç‚¹æ‰¿è®¤ã€‚åœ¨block headerä¸­æœ‰ä¸€ä¸ªnbitsçš„åŸŸï¼Œå®ƒæ˜¯å¯¹targetçš„ç¼–ç å­˜å‚¨ï¼ˆtargetä¸º256ä½ï¼Œnbitsä¸º32ä½ï¼Œä¹Ÿå°±æ˜¯è¯´block headerå¹¶æœªç›´æŽ¥å­˜å‚¨targetï¼‰ï¼Œå…¶ä»–èŠ‚ç‚¹åœ¨è¿›è¡Œåˆæ³•æ€§éªŒè¯æ—¶å€™ä¼šéªŒè¯nbitsåŸŸæ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•åˆ™å¯¹è¯¥åŒºå—ä¸äºˆä»¥æ‰¿è®¤ã€‚&lt;/p>
&lt;p>æŒ–çŸ¿éš¾åº¦å˜ä½Žæ˜¯å¥½äº‹å—ï¼Ÿ å¯¹äºŽçŸ¿å·¥æ¥è¯´ï¼ŒæŒ–çŸ¿éš¾åº¦å˜ä½Žï¼ŒæŒ–çŸ¿å˜å¾—æ›´å®¹æ˜“ï¼Œè¿™ä¹Ÿè¯´æ˜Žå¤§å¤šæ•°äººå¯¹è¯¥å¸ç§ä¸å†çœ‹å¥½ï¼Œè¿™ä¸ªå¸ç§çš„ä»·å€¼ä¹Ÿä¼šå¤§è·³æ°´ï¼Œè¿™å¯¹çŸ¿å·¥æ¥è¯´å¯æ˜¯ä¸€ä¸ªåæ¶ˆæ¯ã€‚&lt;/p>
&lt;h3 id="å®‰å…¨æ€§åˆ†æž">å®‰å…¨æ€§åˆ†æž&lt;/h3>
&lt;p>å› ä¸ºçŸ¿æ± çš„å‡ºçŽ°ï¼Œå¼•å‘äº†å¯¹51%ç®—åŠ›æ”»å‡»çš„æ‹…å¿§ï¼ŒçŸ¿å·¥åªè´Ÿè´£è®¡ç®—ï¼Œå¹¶ä¸çŸ¥é“çŸ¿æ± çš„è¡Œä¸º(&lt;strong>ä¹Œåˆä¹‹ä¼—&lt;/strong>)ã€‚ï¼Œ51%æ”»å‡»åªæ˜¯ä¸€ä¸ªæ¦‚çŽ‡é—®é¢˜ï¼Œå¹¶éžè¾¾åˆ°51%ç®—åŠ›å°±èƒ½å‘åŠ¨æ”»å‡»ï¼Œä¸èƒ½è¾¾åˆ°å°±æ— æ³•å‘åŠ¨æ”»å‡»ã€‚æ­¤å¤–ï¼ŒçŸ¿æ± æœ¬èº«ç®—åŠ›ä¹Ÿæ˜¯åœ¨ä¸æ–­å˜åŒ–çš„ã€‚&lt;/p>
&lt;ol>
&lt;li>åˆ†å‰æ”»å‡»: æ¯”ç‰¹å¸åè®®ä¸­ï¼Œç¼ºçœéœ€è¦ç­‰6ä¸ªç¡®è®¤åŒºå—ï¼Œæ­¤æ—¶æ‰è®¤ä¸ºè¯¥è®°å½•æ˜¯ä¸å¯ç¯¡æ”¹çš„ã€‚å¹³å‡å‡ºå—æ—¶é—´10minï¼Œå…­ä¸ªç¡®è®¤åŒºå—ä¾¿éœ€è¦1å°æ—¶ï¼Œå¯è§ç­‰å¾…æ—¶é—´è¿˜æ˜¯ç›¸å¯¹è¾ƒé•¿çš„ã€‚&lt;/li>
&lt;li>å°é”äº¤æ˜“ï¼ˆBoycottï¼‰ å‡å¦‚æ”»å‡»è€…ä¸å–œæ¬¢æŸä¸ªè´¦æˆ·Aï¼Œä¸æƒ³è®©Açš„äº¤æ˜“ä¸ŠåŒºå—é“¾ï¼Œåœ¨ç›‘å¬åˆ°æœ‰å…¶ä»–äººå°†Açš„äº¤æ˜“å‘å¸ƒåˆ°åŒºå—é“¾ä¸Šæ—¶ï¼Œç«‹åˆ»å‘åŠ¨åˆ†å‰æ”»å‡»ï¼Œä½¿Aæ‰€åœ¨é“¾æ— æ³•æˆä¸ºâ€æœ€é•¿åˆæ³•é“¾â€œã€‚è¿™æ ·ï¼Œä¾¿å®žçŽ°äº†å¯¹Aè´¦æˆ·çš„å°é”ã€‚&lt;/li>
&lt;li>ç›—å¸ï¼ˆå°†ä»–äººè´¦æˆ·BTCè½¬èµ°ï¼‰ è¿™ä¸ªæ˜¯ä¸å¯èƒ½çš„ï¼Œå› ä¸ºå…¶å¹¶æ²¡æœ‰ä»–äººè´¦æˆ·ç§é’¥ã€‚å¦‚æžœä¾ä»—ç®—åŠ›å¼ºï¼Œå¼ºè¡Œå°†æ²¡æœ‰ç­¾
åçš„è½¬è´¦å‘å¸ƒåˆ°åŒºå—é“¾ï¼Œæ­£å¸¸èŠ‚ç‚¹ä¸ä¼šè®¤ä¸ºå…¶åˆæ³•ï¼Œè¿™æ ·ï¼Œå³ä½¿è¿™æ¡é“¾å†é•¿ï¼Œå…¶ä»–äººä¹Ÿä¸ä¼šè®¤ä¸ºå…¶æ˜¯æœ€é•¿åˆæ³•é“¾ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="åˆ†å‰">åˆ†å‰&lt;/h2>
&lt;p>åˆ†å‰æŒ‡çš„æ˜¯ï¼ŒåŽŸæ¥çš„ç³»ç»Ÿä¸­ä¸ºä¸€æ¡é“¾ï¼Œä½†åˆ†æˆäº†ä¸¤æ¡é“¾ã€‚åˆ†å‰å½¢æˆçš„åŽŸå› å¯èƒ½æœ‰å¤šç§ï¼Œä¾‹å¦‚ï¼šæŒ–çŸ¿æ—¶ä¸¤ä¸ªèŠ‚ç‚¹å·®ä¸å¤šåŒæ—¶æŒ–å‡ºçŸ¿ï¼Œéƒ½ä¼šå‘å¸ƒåŒºå—(å¯¹æ¯”ç‰¹å¸ç³»ç»Ÿå½“å‰çŠ¶æ€äº§ç”Ÿåˆ†æ­§å¯¼è‡´çš„åˆ†å‰â€”â€”state fork)ï¼›åˆ†å‰æ”»å‡»ï¼ŒåŒæ ·ä¹Ÿä¼šå¯¼è‡´åˆ†å‰(forking attackï¼Œäººä¸ºæ•…æ„é€ æˆ)ï¼›æ¯”ç‰¹å¸åè®®æ”¹å˜ï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸èƒ½ä¿è¯æ‰€æœ‰èŠ‚ç‚¹åŒæ—¶å‡çº§è½¯ä»¶ï¼Œå‡è®¾å­˜åœ¨å°‘æ•°èŠ‚ç‚¹æœªå‡çº§ï¼Œå¯¼è‡´å‡ºçŽ°åˆ†å‰(protocal fork)ï¼›&lt;/p>
&lt;h3 id="ç¡¬åˆ†å‰">ç¡¬åˆ†å‰&lt;/h3>
&lt;p>å¯¹æ¯”ç‰¹å¸åè®®å¢žåŠ æ–°åè®®ï¼Œæ‰©å±•æ–°åŠŸèƒ½ï¼Œæœªå‡çº§è½¯ä»¶çš„æ—§èŠ‚ç‚¹ä¼šä¸è®¤å¯è¿™äº›ä¿®æ”¹ï¼Œä¼šè®¤ä¸ºè¿™äº›ç‰¹æ€§æ˜¯éžæ³•çš„ã€‚è¿™ä¹Ÿå°±æ˜¯å¯¹æ¯”ç‰¹å¸åè®®å†…å®¹äº§ç”Ÿåˆ†æ­§ï¼Œä»Žè€Œå¯¼è‡´åˆ†å‰ã€‚ç¡¬åˆ†å‰çš„ä¸€ä¸ªå…¸åž‹ä¾‹å­ï¼Œå°±æ˜¯å¯¹æ¯”ç‰¹å¸åŒºå—å¤§å°çš„ä¿®æ”¹&lt;/p>
&lt;p>å¦‚æžœæˆ‘ä»¬å°†åŒºå—æœ€å¤§é™åˆ¶å¢žå¤§ä¸º4MB,å¯¹äºŽæ–°èŠ‚ç‚¹æ¥è¯´ï¼Œä¸Šé¢çš„ä¸ºæœ€é•¿åˆæ³•é“¾ï¼Œæ–°èŠ‚ç‚¹ä¾¿éƒ½ä¼šæ²¿ç€ä¸Šé¢çš„é“¾ç»§ç»­æŒ–ï¼›å¯¹äºŽæ—§èŠ‚ç‚¹æ¥è¯´ï¼Œä¸Šé¢çš„é“¾æ— è®ºå¤šä¹ˆé•¿ï¼Œéƒ½æ˜¯ä¸€æ¡éžæ³•é“¾ï¼Œä¸ä¼šè®¤å¯è¯¥é“¾ï¼Œæ‰€ä»¥æ—§èŠ‚ç‚¹å°±ä¼šæ²¿ç€ä¸‹é¢çš„é“¾ç»§ç»­æŒ–çŸ¿ã€‚æ­¤æ—¶ï¼Œå°±å‡ºçŽ°äº†æ–°èŠ‚ç‚¹æ°¸è¿œæ²¿ç€ä¸Šé¢çš„é“¾æŒ–çŸ¿ï¼Œæ—§èŠ‚ç‚¹æ°¸è¿œæ²¿ç€ä¸‹é¢çš„é“¾æŒ–çŸ¿ï¼Œç”±äºŽæ–°èŠ‚ç‚¹ç®—åŠ›è¶³å¤Ÿå¼ºï¼Œæ‰€ä»¥å½¢æˆä¸¤æ¡æ°¸è¿œéƒ½åœ¨å»¶ä¼¸ä¸”å¹³è¡Œçš„é“¾ã€‚å‡ºçŽ°hard forkåŽï¼Œä¾¿å˜æˆäº†ä¸¤æ¡å¹³è¡Œçš„é“¾ï¼Œä¹Ÿå°±é€ æˆäº†ç¤¾åŒºåˆ†è£‚ã€‚&lt;/p>
&lt;h3 id="è½¯åˆ†å‰">è½¯åˆ†å‰&lt;/h3>
&lt;p>å¦‚æžœå¯¹BTCåè®®æ·»åŠ é™åˆ¶ï¼Œä½¿å¾—åŽŸæœ¬åˆæ³•äº¤æ˜“åœ¨æ–°äº¤æ˜“ä¸­ä¸åˆæ³•ï¼Œä¾¿ä¼šå½¢æˆè½¯åˆ†å‰ã€‚&lt;/p>
&lt;p>å‡è®¾ç³»ç»Ÿä¸­å¤§å¤šæ•°èŠ‚ç‚¹æ›´æ–°äº†è½¯ä»¶ï¼Œå°‘æ•°èŠ‚ç‚¹ä»ç„¶éµä»Ž1MBé™åˆ¶çš„åè®®(æ³¨æ„ï¼Œè¿™é‡Œå¤§å¤šæ•°å’Œå°‘æ•°æ˜¯æŒ‰ç…§ç®—åŠ›æ¥åŒºåˆ†çš„ï¼Œå’Œè´¦æˆ·æ•°é‡æ— å…³)ã€‚å³ï¼šæ–°èŠ‚ç‚¹è®¤ä¸ºåŒºå—å¤§å°æœ€å¤§0.5MBï¼Œæ—§èŠ‚ç‚¹è®¤ä¸ºåŒºå—å¤§å°æœ€å¤§1MBï¼Œä¸”æ–°èŠ‚ç‚¹å æ®å¤§å¤šæ•°&lt;/p>
&lt;p>æ–°èŠ‚ç‚¹åªè®¤å¯æ–°èŠ‚ç‚¹æŒ–å‡ºçš„å—(è€Œä¸”å å¤§å¤šæ•°)ï¼Œæ—§èŠ‚ç‚¹æŒ–å‡ºçš„åŒºå—ä¸€ç›´è¢«æŠ›å¼ƒï¼Œæ— æ³•å¾—åˆ°å‡ºå—å¥–åŠ±(ä¸åœ¨æœ€é•¿åˆæ³•é“¾ä¸Š)ã€‚è¿™å°±å€’é€¼æ—§èŠ‚ç‚¹å‡çº§è½¯ä»¶ï¼Œæœ€ç»ˆä¼šå®žçŽ°åŒºå—é“¾ä¸Šçš„æ‰€æœ‰çŸ¿å·¥å…±åŒè®¤å¯æ–°åè®®ï¼Œå®žçŽ°è½¯ä»¶åè®®çš„å‡çº§ã€‚&lt;/p>
&lt;p>&lt;strong>soft fork&lt;/strong> ç‰¹ç‚¹ï¼šåªè¦ç³»ç»Ÿä¸­æ‹¥æœ‰åŠæ•°ä»¥ä¸Šç®—åŠ›èŠ‚ç‚¹æ›´æ–°è½¯ä»¶ï¼Œç³»ç»Ÿå°±ä¸ä¼šäº§ç”Ÿæ°¸ä¹…æ€§åˆ†å‰
&lt;strong>hard fork&lt;/strong> ç‰¹ç‚¹ï¼šå¿…é¡»ç³»ç»Ÿä¸­æ‰€æœ‰èŠ‚ç‚¹æ›´æ–°è½¯ä»¶ï¼Œç³»ç»Ÿæ‰ä¸ä¼šäº§ç”Ÿæ°¸ä¹…æ€§åˆ†å‰&lt;/p>
&lt;h2 id="åŒ¿åæ€§">åŒ¿åæ€§&lt;/h2>
&lt;p>æ¯”ç‰¹å¸ä¸­çš„åŒ¿åå¹¶éžçœŸæ­£çš„åŒ¿åï¼Œè€Œæ˜¯å‡çš„åŒ¿åã€‚çº¸å¸çš„åŒ¿åæ€§æ›´å¥½ï¼Œå› ä¸ºå…¶å¹¶æ²¡æœ‰å¯¹ä¸ªäººä¿¡æ¯çš„æ ‡è®°ã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºå…¶åŒ¿åæ€§ï¼Œå¾ˆå¤šéžæ³•äº¤æ˜“é‡‡ç”¨çŽ°é‡‘ã€‚&lt;/p>
&lt;p>æ¯”ç‰¹å¸ä¸­çš„æ•°æ®æ˜¯å®Œå…¨å…¬å¼€çš„ï¼Œè€Œç½‘ä¸Šçš„äº¤æ˜“æ˜¯è¦ä¸Žå®žä½“ä¸–ç•Œè¿›è¡Œäº¤æ˜“çš„ï¼Œæ‰€ä»¥å¤§å¤§ç ´åäº†å…¶åŒ¿åæ€§ã€‚å‡å¦‚é“¶è¡Œå…è®¸ç”¨å‡å(ä»¥å‰çš„å­˜æŠ˜æ—¶ä»£)ï¼Œç”±äºŽé“¶è¡Œæ•°æ®å¹¶éžå…¬å¼€ï¼Œæ‰€ä»¥é“¶è¡Œç³»ç»Ÿçš„åŒ¿åæ€§æ˜¯è¦æ¯”æ¯”ç‰¹å¸æ›´å¥½çš„ã€‚&lt;/p>
&lt;p>ä»Žåº”ç”¨å±‚çœ‹ï¼Œå¯ä»¥å°†å„ä¸ªä¸åŒç”¨æˆ·çš„BTCæ··åˆåœ¨ä¸€èµ·ï¼Œä½¿å¾—è¿½æŸ¥å˜å¾—æ··ä¹±(Coin mixing)ï¼›ä»Žç½‘ç»œå±‚çœ‹ï¼Œå¯ä»¥é‡‡ç”¨å¤šè·¯å¾„è½¬å‘çš„æ–¹æ³•ï¼Œæ•°æ®ä¸ç›´æŽ¥å‘é€å‡ºåŽ»ï¼Œè€Œæ˜¯ç»è¿‡å¾ˆå¤šè·³(æ´‹è‘±è·¯ç”±çš„åŸºæœ¬æ€æƒ³)ã€‚&lt;/p>
&lt;p>å®žé™…ä¸Šï¼Œæš´éœ²ç”¨æˆ·éšç§æ­£æ˜¯ç”±äºŽåŒºå—é“¾çš„å…¬å¼€æ€§å’Œä¸å¯ç¯¡æ”¹æ€§ã€‚ä¸å¯ç¯¡æ”¹æ€§å¯¹äºŽéšç§ä¿æŠ¤ï¼Œå®žé™…ä¸Šæ˜¯ç¾éš¾æ€§çš„ã€‚&lt;/p>
&lt;h3 id="é›¶çŸ¥è¯†è¯æ˜Ž">é›¶çŸ¥è¯†è¯æ˜Ž&lt;/h3>
&lt;p>é›¶çŸ¥è¯†è¯æ˜Žï¼šä¸€æ–¹ï¼ˆè¯æ˜Žè€…ï¼‰å‘å¦ä¸€æ–¹ï¼ˆéªŒè¯è€…ï¼‰è¯æ˜ŽæŸä¸€ä¸ªé™ˆè¿°æ˜¯æ­£ç¡®çš„ï¼Œä½†ä¸éœ€è¦é€éœ²é™¤è¯¥é™ˆè¿°æ˜¯æ­£ç¡®çš„ä¹‹å¤–çš„
ä»»ä½•ä¿¡æ¯ã€‚ ä¾‹å¦‚ï¼šAæƒ³è¦å‘Bè¯æ˜ŽæŸä¸€è´¦æˆ·å±žäºŽAï¼Œè¿™è¯´æ˜ŽAçŸ¥é“è¯¥è´¦æˆ·çš„ç§é’¥ã€‚ä½†ä¸å¯èƒ½é€šè¿‡Aå…¬å¸ƒç§é’¥çš„æ–¹æ³•æ¥è¯
æ˜Žï¼Œè¯¥è´¦æˆ·ç¡®å®žå±žäºŽAã€‚å› æ­¤ï¼ŒAå¯ä»¥äº§ç”Ÿä¸€ä¸ªè´¦æˆ·ç­¾åï¼ŒBé€šè¿‡å…¬é’¥å¯¹ç­¾åè¿›è¡ŒéªŒè¯ã€‚(å®žé™…ä¸Šè¯¥è¯æ˜Žæ˜¯å¦å±žäºŽé›¶çŸ¥
è¯†è¯æ˜Žå­˜åœ¨äº‰è®®ï¼Œå› ä¸ºæ³„éœ²äº†ç”¨ç§é’¥äº§ç”Ÿçš„ç­¾å)&lt;/p>
&lt;p>é›¶çŸ¥è¯†è¯æ˜Žçš„æ•°å­¦åŸºç¡€ä¾¿æ˜¯åŒæ€éšè—ã€‚&lt;/p>
&lt;p>ä¸€äº›å…¶ä»–ç›¸å…³çš„: ç›²ç­¾ï¼Œé›¶å¸é›¶é’ž&lt;/p>
&lt;h3 id="å“ˆå¸ŒæŒ‡é’ˆ">å“ˆå¸ŒæŒ‡é’ˆ&lt;/h3>
&lt;p>åœ¨block headerä¸­åªæœ‰hashå€¼ï¼Œæ²¡æœ‰æŒ‡é’ˆã€‚é‚£ä¹ˆå¦‚ä½•æŸ¥æ‰¾åˆ°å‰ä¸€ä¸ªåŒºå—çš„å†…å®¹ï¼Ÿ å…¨èŠ‚ç‚¹ä¸€èˆ¬å°†åŒºå—å­˜å‚¨
äºŽä¸€ä¸ªkey-valueæ•°æ®åº“ä¸­ï¼Œkeyä¸ºå“ˆå¸Œï¼Œvalueä¸ºåŒºå—å†…å®¹ã€‚å¸¸ç”¨çš„key-valueæ•°æ®åº“ä¸ºlevelDBï¼Œåªè¦æŽŒæ¡åˆ°æœ€åŽä¸€
ä¸ªåŒºå—çš„å“ˆå¸Œå€¼å³å¯ä¾æ®å“ˆå¸Œå€¼ä¸€ç›´å¾€å‰æ‰¾åˆ°åŒºå—é“¾æ‰€æœ‰å†…å®¹ã€‚ æœ‰äº›èŠ‚ç‚¹åªä¿å­˜åŒºå—é“¾éƒ¨åˆ†ä¿¡æ¯ï¼Œå¦‚æžœéœ€è¦ç”¨åˆ°å‰
é¢çš„åŒºå—ï¼Œå¯ä»¥é—®å…¶ä»–èŠ‚ç‚¹è¦ã€‚å“ˆå¸ŒæŒ‡é’ˆæ€§è´¨ä¿è¯äº†æ•´ä¸ªåŒºå—é“¾å†…å®¹æ˜¯ä¸å¯ç¯¡æ”¹çš„&lt;/p>
&lt;h3 id="é‡å­è®¡ç®—">é‡å­è®¡ç®—&lt;/h3>
&lt;p>ä¼šä¸ä¼šBTCè¿™ç§å»ºç«‹åœ¨å¯†ç å­¦ä¸Šçš„åŠ å¯†è´§å¸ï¼Œåœ¨é‡å­è®¡ç®—å‡ºæ¥åŽä¼šä¸ä¼šå˜å¾—ä¸å®‰å…¨ã€‚ ä¸€. é‡å­è®¡ç®—è·ç¦»ä½¿ç”¨ä»ç„¶æœ‰å¾ˆ
é•¿è·ç¦»ï¼ˆäººå·¥æ™ºèƒ½ä¹Ÿæ˜¯ï¼Œç›®å‰ä»ç„¶å¤„äºŽå¼±äººå·¥æ™ºèƒ½é˜¶æ®µã€‚å…¶å®žå¾ˆå¤šæŠ€æœ¯éƒ½æ˜¯å¦‚æ­¤ï¼Œç‚’çš„æƒ…å†µå¾ˆä¸¥é‡ï¼Œä½†è·ç¦»å®žç”¨å¾ˆ
è¿œã€‚ä½†æ˜¯ä¸ç‚’ä¾¿ä¸ä¼šæœ‰èµ„æœ¬æµå…¥è¿›è¡Œç ”ç©¶ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªéžå¸¸ç›¸æ‚–çš„åœ°æ–¹ï¼‰ã€‚ äºŒ. é‡å­è®¡ç®—è‹¥çœŸæ­£ä½¿ç”¨åˆ°ç ´åçŽ°æœ‰åŠ å¯†
ç®—æ³•ï¼Œå¯¹ä¼ ç»Ÿé‡‘èžä¸šçš„ç ´åä»ç„¶æ˜¯æœ€å¤§çš„ã€‚ ä¸‰. å®žé™…ä¸­ä½¿ç”¨çš„å¹¶éžå…¬é’¥ï¼Œè€Œæ˜¯é‡‡ç”¨å…¬é’¥å“ˆå¸Œã€‚è€Œå“ˆå¸Œå‡½æ•°ä¸€èˆ¬éƒ½æ˜¯ä¸
å¯é€†çš„ï¼Œæ‰€ä»¥å³ä½¿é‡å­è®¡ç®—ä¹Ÿæ— æ³•åæŽ¨ç§é’¥ã€‚ BTCä¸­ç”¨çš„SHA-256ï¼Œæ— è®ºè¾“å…¥å¤šå¤§ï¼Œæœ€ç»ˆç»“æžœéƒ½ä¸º256ä½ï¼Œå¿…ç„¶ä¼šå¯¼
è‡´ä¿¡æ¯ä¸¢å¤±ï¼Œæ— æ³•åæŽ¨åŽŸæœ¬æ•°æ®ã€‚ æ€»ç»“ï¼šåŠ å¯†å¯é€†ã€å“ˆå¸Œä¸å¯é€†ï¼›åŠ å¯†ä¸æŸå¤±ä¿¡æ¯ã€å“ˆå¸Œç ´åä¿¡æ¯ï¼ˆåŠ å¯†å’Œå“ˆå¸Œçš„åŒºåˆ«ï¼‰&lt;/p></description></item><item><title>åŒºå—é“¾ç™½çš®ä¹¦è§£è¯»</title><link>https://chi-kai.github.io/post/%E5%8C%BA%E5%9D%97%E9%93%BE%E7%99%BD%E7%9A%AE%E4%B9%A6%E8%A7%A3%E8%AF%BB/</link><pubDate>Fri, 25 Nov 2022 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/%E5%8C%BA%E5%9D%97%E9%93%BE%E7%99%BD%E7%9A%AE%E4%B9%A6%E8%A7%A3%E8%AF%BB/</guid><description>&lt;h2 id="æ¯”ç‰¹å¸ç™½çš®ä¹¦">æ¯”ç‰¹å¸ç™½çš®ä¹¦&lt;/h2>
&lt;h2 id="ä»¥å¤ªåŠç™½çš®ä¹¦">ä»¥å¤ªåŠç™½çš®ä¹¦&lt;/h2>
&lt;h2 id="tangle-ç™½çš®ä¹¦">Tangle ç™½çš®ä¹¦&lt;/h2>
&lt;p>è¯¦ç»†çš„å†…å®¹è§ &lt;a href="https://lzphi.cn/2020/12/20/2020-12-17-Tangle-%E7%99%BD%E7%9A%AE%E4%B9%A6/">Tangleç™½çš®ä¹¦ä¸­æ–‡ç‰ˆ&lt;/a>&lt;/p>
&lt;p>&lt;strong>tangle&lt;/strong> æ˜¯ &lt;strong>IOTA&lt;/strong> æ‰€ç”¨çš„æŠ€æœ¯ï¼Œä¸ºç‰©è”ç½‘å’Œå°é¢æ”¯ä»˜æä¾›æ”¯æŒã€‚ä¸åŒäºŽå¸¸è§çš„åŒºå—é“¾ï¼Œå®ƒä½¿ç”¨ä¸€ä¸ªDAGï¼ˆæœ‰å‘æ— çŽ¯å›¾ï¼‰ä½œä¸ºç»“æž„ï¼Œè¿™é‡Œç§°ä¸ºTangleã€‚&lt;/p>
&lt;p>ä¼ ç»ŸåŒºå—é“¾ç³»ç»Ÿçš„å•é“¾ç»“æž„åœ¨äº¤æ˜“è®¤è¯ï¼Œåžåé‡ï¼Œèµ„æºæ¶ˆè€—ç­‰æ–¹é¢å­˜åœ¨ç¼ºé™·ï¼ŒDAGç»“æž„çš„åŒºå—é“¾æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚&lt;/p>
&lt;h2 id="fabric-ç™½çš®ä¹¦">Fabric ç™½çš®ä¹¦&lt;/h2>
&lt;p>&lt;strong>Hyperledger Fabric&lt;/strong> æ˜¯ Linux åŸºé‡‘ä¼š çš„ ä¸€ä¸ªé¡¹ç›®ï¼Œæ˜¯Hyperledgerä¸‹é¢çš„ä¸€ä¸ªå­é¡¹ç›®ã€‚ä½œä¸ºä¸€ä¸ªå¼€æºè”ç›Ÿé“¾ï¼Œè¢«å¾ˆå¤šé¡¹ç›®åº”ç”¨ã€‚&lt;/p>
&lt;p>å®ƒçš„ä¸»è¦ç‰¹ç‚¹æ˜¯æ¨¡å—åŒ–çš„å…±è¯†æœºåˆ¶ï¼Œç›¸å¯¹é«˜æ€§èƒ½ï¼Œå’Œå¯ä»¥ä½¿ç”¨å¸¸è§„è¯­è¨€ç¼–å†™æ™ºèƒ½åˆçº¦(golang)ã€‚&lt;/p>
&lt;h3 id="æ¦‚å¿µ">æ¦‚å¿µ&lt;/h3>
&lt;h4 id="è”ç›Ÿé“¾">è”ç›Ÿé“¾&lt;/h4>
&lt;p>æ–‡ä¸­åˆ’åˆ†è”ç›Ÿé“¾å’Œå…¬é“¾çš„æ ‡å‡†æ˜¯: &lt;strong>æ˜¯å¦å‘å¸å’ŒèŠ‚ç‚¹èº«ä»½æ˜¯å¦å¯çŸ¥&lt;/strong>&lt;/p>
&lt;p>çŠ¶æ€æœºå¤åˆ¶(SMR)æ˜¯å»ºè®¾å¼¹æ€§åº”ç”¨ä¼—æ‰€å‘¨çŸ¥çš„æ–¹å¼ï¼Œä½†æ˜¯å¦‚æžœæˆ‘ä»¬æŠŠè¿è¡Œåœ¨åŒºå—é“¾ä¸Šçš„æ™ºèƒ½åˆçº¦çœ‹ä½œä¸€ç§åˆ†å¸ƒå¼åº”ç”¨ï¼Œä¸Žä¼ ç»Ÿçš„SMRåŒºåˆ«åœ¨äºŽ:&lt;/p>
&lt;ul>
&lt;li>è®¸å¤šåº”ç”¨å¹¶å‘è¿è¡Œ&lt;/li>
&lt;li>è¿™äº›åº”ç”¨å¯ä»¥è¢«ä»»ä½•äººåŠ¨æ€åœ°éƒ¨ç½²&lt;/li>
&lt;li>è¿™äº›åº”ç”¨çš„ä»£ç æ˜¯ä¸è¢«ä¿¡ä»»çš„ï¼Œå¯èƒ½æœ‰æ¶æ„&lt;/li>
&lt;/ul>
&lt;h4 id="order-execute">order-execute&lt;/h4>
&lt;p>çŽ°æœ‰çš„å¤§éƒ¨åˆ†å¯ä»¥è¿è¡Œæ™ºèƒ½åˆçº¦çš„åŒºå—é“¾éµå¾ªSMRå®žçŽ°ä¸€ç§order-executeçš„æž¶æž„: èŠ‚ç‚¹å…ˆå°†äº¤æ˜“æŽ’åºå†å°†å®ƒä»¬å¹¿æ’­ç»™å…¶ä»–èŠ‚ç‚¹ï¼Œç„¶åŽæ¯ä¸ªèŠ‚ç‚¹é¡ºåºæ‰§è¡Œã€‚&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/06/B4Ns3GZAKl8dIXT.png" alt="">&lt;/p>
&lt;p>è¿™ä¸ªæž¶æž„å­˜åœ¨çš„ä¸€äº›é—®é¢˜:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>æ‰€æœ‰èŠ‚ç‚¹æŒ‰ç…§é¡ºåºæ‰§è¡Œäº¤æ˜“ä¼šé™åˆ¶æ€§èƒ½ï¼ˆä¾‹å¦‚TPSï¼‰ï¼Œé€šå¸¸å°†ä¸ç›¸å…³çš„æ“ä½œå¹¶å‘æ‰§è¡Œå¯ä»¥æå‡æ€§èƒ½ï¼Œä½†æ˜¯å¯¹æ™ºèƒ½åˆçº¦å¾ˆéš¾åšåˆ°å¹¶å‘ï¼Œå› ä¸ºä»£ç ä¹‹é—´çš„ä¾èµ–å…³ç³»å¾ˆéš¾ç¡®å®š&lt;/p>
&lt;/li>
&lt;li>
&lt;p>order-executeæœ€å¤§çš„é™åˆ¶æ˜¯ï¼Œæ‰€æœ‰èŠ‚ç‚¹æ‰€æ‰§è¡Œçš„äº¤æ˜“å¿…é¡»æ»¡è¶³ç¡®å®šæ€§.ç±»ä¼¼ä»¥å¤ªåŠè¿™æ ·é‡‡ç”¨Solidityè¿™æ ·çš„ç¼–ç¨‹è¯­è¨€å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šä¿è¯ä»£ç ç¡®å®šæ€§ï¼Œä½†å¯¹äºŽæ›´æµè¡Œçš„è¯­è¨€ï¼ˆä¾‹å¦‚Goï¼ŒJavaï¼ŒC/C++ï¼‰ï¼Œåˆ™å¾ˆéš¾ä¿è¯ç¡®å®šæ€§ï¼ˆæ¯”å¦‚Goä¸­çš„map iteratorå°±æ— æ³•ä¿è¯ç¡®å®šæ€§ï¼‰ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="execute-order-validate">execute-order-validate&lt;/h4>
&lt;p>&lt;img src="https://s2.loli.net/2022/12/07/jDBxcLmYrfXSnbl.png" alt="">&lt;/p></description></item><item><title>DAGåŒºå—é“¾è®ºæ–‡é˜…è¯»</title><link>https://chi-kai.github.io/post/dag%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/</link><pubDate>Thu, 10 Nov 2022 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/dag%E5%8C%BA%E5%9D%97%E9%93%BE%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/</guid><description>&lt;h2 id="direct-acyclic-graph-based-ledger-for-internet-of-things-performance-and-security-analysis">ã€ŠDirect Acyclic Graph-Based Ledger for Internet of Things: Performance and Security Analysisã€‹&lt;/h2>
&lt;h3 id="é—®é¢˜èƒŒæ™¯">é—®é¢˜èƒŒæ™¯&lt;/h3>
&lt;p>ç”±äºŽåŒºå—é“¾çš„å®‰å…¨æ€§ï¼ŒåŽ»ä¸­å¿ƒåŒ–ï¼Œå¯ä¿¡æ€§ï¼Œåœ¨IoTç³»ç»Ÿä¸Šæœ‰å¯è§‚çš„åº”ç”¨å‰æ™¯ï¼ˆå¦‚æ™ºèƒ½è½¦ï¼Œèƒ½æºäº¤æ˜“ï¼‰ã€‚IoTç³»ç»Ÿå…·æœ‰è§„æ¨¡å¤§ï¼Œèµ„æºå—é™çš„ç‰¹æ€§ã€‚æ‰€ä»¥å…¶ä¸Šçš„å…±è¯†ç®—æ³•å¿…é¡»æ»¡è¶³èµ„æºéœ€æ±‚å°,ä½Žæ¶ˆè€—ï¼Œå’Œé«˜çš„äº¤æ˜“åžåé‡ã€‚&lt;/p>
&lt;p>çŽ°åœ¨ä¸»è¦çš„ä¸¤ç§å…±è¯†ç®—æ³•:PoWéœ€è¦é«˜çš„èµ„æºæ¶ˆè€—ï¼ŒPoSçš„å¸é¾„è¯æ˜Žå¯èƒ½é€ æˆåž„æ–­å’Œä¸­å¿ƒåŒ–ã€‚&lt;/p>
&lt;p>å…¸åž‹çš„åŒºå—é“¾æ˜¯ä¸€ç§å•é“¾ç»“æž„ï¼Œä¸ºäº†é¿å…éžæ³•çš„forkï¼Œåº”ç”¨çš„å…±è¯†ç®—æ³•å¿…é¡»é™ä½Žæ–°çš„blockç”Ÿæˆé€ŸçŽ‡ã€‚è¿™å¯¼è‡´äº†åžåé‡ç“¶é¢ˆå’ŒåŒºå—è®¤è¯å»¶è¿Ÿçš„é—®é¢˜ï¼Œåœ¨IoTç³»ç»Ÿä¸Šåˆæœ‰äº¤æ˜“èŠ±è´¹é«˜å’Œèµ„æºæ¶ˆè€—å¤§çš„é—®é¢˜ã€‚&lt;/p>
&lt;p>DAGå…±è¯†ç®—æ³•å¯ä»¥å…è®¸ä»»ä½•èŠ‚ç‚¹å¯ä»¥ç«‹å³å‘ledgeræ’å…¥ä¸€ä¸ªæ–°çš„blockï¼Œå‰ææ˜¯å®ƒèƒ½å…ˆå¤„ç†æ›´æ—©çš„äº¤æ˜“ã€‚è¿™ç§æ–¹å¼ä¼šé€ æˆå¾ˆå¤šforkï¼ŒDAGæœ‰å¾ˆå¤šç®—æ³•æ¥é¿å…åœ¨ä¼ ç»ŸåŒºå—é“¾ä¸Šé¢ä¸´çš„double-spendingé—®é¢˜(Markov Chain Monte Carlo algorithm and virtual voting algorithm)ã€‚DAGå…±è¯†ç®—æ³•çš„äº¤æ˜“åžåæ˜¯ä¸å—é™åˆ¶çš„ï¼Œè€Œä¸”èµ„æºæ¶ˆè€—å¾ˆä½Žï¼Œè¿™ç¬¦åˆIoTçš„åº”ç”¨åœºæ™¯ã€‚&lt;/p>
&lt;h3 id="dagæ¦‚è¿°">DAGæ¦‚è¿°&lt;/h3>
&lt;h4 id="åè¯å®šä¹‰">åè¯å®šä¹‰&lt;/h4>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/19/auRt2FzeCjwgsGM.png" alt="">&lt;/p>
&lt;p>è¿™é‡Œä½¿ç”¨å…¸åž‹çš„Tangleç®—æ³•æ¥è¿›è¡Œè§£é‡Šã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>Block: æ‰€æœ‰å—æ˜¯è®°å½•ä¿¡æ¯çš„å­˜å‚¨å•å…ƒ(åŒ…æ‹¬äº¤æ˜“ï¼Œæ•°å­—ç­¾åï¼Œå“ˆå¸Œå€¼)ï¼Œåœ¨Tangleé‡Œä¸€ä¸ªå—è®°å½•ä¸€ä¸ªäº¤æ˜“&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Tip: è¿˜æ²¡æœ‰è¢«éªŒè¯çš„å—(äº¤æ˜“)&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Direct approvalï¼šç›´æŽ¥éªŒè¯ï¼Œä¸¤ä¸ªå—ç›´æŽ¥ç”±ä¸€æ¡è¾¹æ¥é“¾æŽ¥ï¼Œç§°ä¸ºç›´æŽ¥éªŒè¯ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>indirect approvalï¼šé—´æŽ¥éªŒè¯ï¼Œä¸¤ä¸ªå—æœ‰é€šè¿‡ä¸€ä¸ªå—å’Œ&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Own weight: ä¸Žå®ƒçš„æå‡ºè€…çš„å·¥ä½œé‡æœ‰å…³&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Cumulative weight: ä»£è¡¨ä¸€ä¸ªäº¤æ˜“çš„è®¤è¯çº§åˆ«ã€‚æ˜¯ä¸€ä¸ªäº¤æ˜“è‡ªèº«own weightä»¥åŠå®ƒç›´æŽ¥è¯æ˜Žå’Œé—´æŽ¥è¯æ˜Žçš„äº¤æ˜“çš„äº¤æ˜“own weightæ€»å’Œã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h4 id="å…±è¯†è¿‡ç¨‹">å…±è¯†è¿‡ç¨‹&lt;/h4>
&lt;ol>
&lt;li>èŠ‚ç‚¹åˆ›é€ ä¸€ä¸ªå—æ¥å‚¨å­˜äº¤æ˜“&lt;/li>
&lt;li>èŠ‚ç‚¹é€šè¿‡MCMC tips é€‰æ‹©ç®—æ³•æ¥é€‰æ‹©ä¸¤ä¸ªæ²¡æœ‰å†²çªçš„tipsï¼Œç„¶åŽæ·»åŠ å®ƒä»¬çš„hashåˆ°å—ä¸­&lt;/li>
&lt;li>èŠ‚ç‚¹è§£å†³ä¸€ä¸ªä½Žéš¾åº¦çš„powé—®é¢˜ï¼Œæ¥é¿å…åžƒåœ¾ä¿¡æ¯&lt;/li>
&lt;li>ä½¿ç”¨ç§é’¥ç»™äº¤æ˜“ç­¾åå¹¶å¹¿æ’­ï¼Œå½“å…¶ä»–èŠ‚ç‚¹æ”¶åˆ°æ—¶ä¼šæ£€æŸ¥æ˜¯å¦åˆæ³•&lt;/li>
&lt;li>æˆåŠŸæ·»åŠ çš„äº¤æ˜“æˆä¸ºtip,ç­‰å¾…è¢«éªŒè¯ã€‚ç›´åˆ°å®ƒçš„cumulative weight è¾¾åˆ°å®šä¹‰çš„æ ‡å‡†ã€‚&lt;/li>
&lt;/ol>
&lt;h4 id="åˆ†å‰é—®é¢˜">åˆ†å‰é—®é¢˜&lt;/h4>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/19/VnrEiPCoslHG9KY.png" alt="">&lt;/p>
&lt;p>åœ¨åˆ†å¸ƒå¼è´¦æœ¬ä¸­ï¼Œæž„å»ºåˆ†å‰ä»¥é‡åšå·¥ä½œæ˜¯ç¯¡æ”¹å­˜å‚¨æ•°æ®çš„å”¯ä¸€æ–¹æ³•ã€‚åŸºäºŽæ­¤ï¼Œdouble-spendingçš„ä¸»è¦æ€æƒ³æ˜¯å°†ä¸¤ç¬”ç›¸äº’å†²çªçš„äº¤æ˜“å¹¶è¡Œæ”¾ç½®åœ¨ä¸¤æ¡é“¾ä¸Šã€‚åœ¨ç¬¬ä¸€ç¬”äº¤æ˜“èŠ±è´¹åœ¨æœåŠ¡ä¸Šä¹‹åŽï¼Œæ”»å‡»è€…æ‰©å±•åŒ…å«å†²çªäº¤æ˜“çš„é“¾å¹¶è®©å®ƒè¶…è¿‡ç¬¬ä¸€æ¡é“¾ã€‚å½“æ­¤æ“ä½œæˆåŠŸæ—¶ï¼Œç¬¬ä¸€ç¬”äº¤æ˜“å°†è¢«å­¤ç«‹ï¼Œæ”»å‡»è€…å¯ä»¥å¤šæ¬¡ä½¿ç”¨tokenã€‚&lt;/p>
&lt;ul>
&lt;li>å•é“¾æ¨¡åž‹: ä»¥æœ€é•¿çš„ä¸€ä¸ªé“¾ä¸ºæ ‡å‡†ï¼Œæ­£å¸¸çš„çŸ¿å·¥ä¼šåœ¨æœ€é•¿çš„é“¾ä¸Šå·¥ä½œ&lt;/li>
&lt;li>DAGæ¨¡åž‹: ä»¥ç´¯è®¡æƒé‡æœ€å¤§çš„å­å›¾ä¸ºæ ‡å‡†ï¼Œæ­£å¸¸çš„èŠ‚ç‚¹ä¼šé€šè¿‡MCMC tips é€‰æ‹©ç®—æ³•æ‰©å±•æƒé‡æœ€å¤§çš„é“¾ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="heading">&lt;/h3>
&lt;h2 id="tips-transaction-inclusion-protocol-with-signaling-in-dag-based-blockchain">ã€ŠTIPS: Transaction Inclusion Protocol with Signaling in DAG-based Blockchainã€‹&lt;/h2>
&lt;h3 id="é—®é¢˜èƒŒæ™¯-1">é—®é¢˜èƒŒæ™¯&lt;/h3>
&lt;p>ç”±äºŽDAGåŒºå—é“¾çš„é«˜å¹¶å‘åœºæ™¯å’Œç½‘ç»œå»¶è¿Ÿï¼ŒçŸ¿å·¥é€šå¸¸ä¸èƒ½åŠæ—¶èŽ·å–æ•´ä¸ªç½‘ç»œçš„æ›´æ–°ä¿¡æ¯ï¼Œå¯¼è‡´é‡å¤åœ¨ä¸€ä¸ªå¹¶è¡ŒåŒºå—åŒ…æ‹¬ç›¸åŒçš„äº¤æ˜“ï¼Œåœ¨åŒºå—é“¾ä¸­ç”Ÿæˆå†—ä½™çš„è®°å½•ã€‚è¿™ä¸ªäº¤æ˜“åŒ…å«å†²çªä¼šæµªè´¹åŒºå—å®¹é‡å’Œé™ä½Žç³»ç»Ÿæ€§èƒ½ã€‚å°½ç®¡DAGåŒºå—é“¾å·²ç»é™åˆ¶äº¤æ˜“çš„é«˜å¹¶å‘ï¼Œä½†æ˜¯äº¤æ˜“å†²çªçš„é£Žé™©å®žé™…è¿˜ä¼šè¯±å‘&lt;strong>çŸ¿å·¥æ”¶ç›Š&lt;/strong>å’Œ&lt;strong>ç³»ç»Ÿåžå&lt;/strong>çš„å›°å¢ƒã€‚&lt;/p>
&lt;h4 id="é—®é¢˜åˆ†æž">é—®é¢˜åˆ†æž&lt;/h4>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h804wzs4nsj30rk0jtgqa.jpg" alt="ç¬¦å·.png">&lt;/p>
&lt;p>ä¸‰ç§äº¤æ˜“åŒ…å«ç­–ç•¥:&lt;/p>
&lt;ol>
&lt;li>éšæœºåŒ…å«($P^{rand}$): $p_{1}=p_{2}=\cdots=p_{m}=\frac{n}{m}$&lt;/li>
&lt;li>æœ‰ä¼˜å…ˆçº§çš„éšæœºåŒ…å«($P^{priority}$): $p_{1} \geq p_{2} \geq \cdots \geq p_{m} \text { and } \frac{p_{1}}{f_{1}}=\frac{p_{2}}{f_{2}}=\cdots=\frac{p_{m}}{f_{m}}$&lt;/li>
&lt;li>Top n ($P^{top}$): $p_{1}=p_{2}=\cdots=p_{n}=1 \text { and } p_{n+1}=p_{n+2}=\cdots=p_{m}=0$&lt;/li>
&lt;/ol>
&lt;p>è¿™é‡Œä»…è€ƒè™‘çŸ¿å·¥æ”¶ç›Šä¸­çš„äº¤æ˜“è´¹ç”¨å¥–åŠ±ã€‚&lt;/p>
&lt;h5 id="æ”¶å…¥å›°å¢ƒ">æ”¶å…¥å›°å¢ƒ&lt;/h5>
&lt;h3 id="ç®—æ³•è®¾è®¡">ç®—æ³•è®¾è®¡&lt;/h3>
&lt;h2 id="silentdelivery-practical-timed-delivery-of-private-information-using-smart-contracts">ã€ŠSilentDelivery: Practical Timed-delivery of Private Information using Smart Contractsã€‹&lt;/h2></description></item><item><title>DAGåŒºå—é“¾ç»¼è¿°</title><link>https://chi-kai.github.io/post/dag%E5%8C%BA%E5%9D%97%E9%93%BE%E7%BB%BC%E8%BF%B0/</link><pubDate>Mon, 07 Nov 2022 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/dag%E5%8C%BA%E5%9D%97%E9%93%BE%E7%BB%BC%E8%BF%B0/</guid><description>&lt;h2 id="é—®é¢˜çŽ°çŠ¶">é—®é¢˜çŽ°çŠ¶&lt;/h2>
&lt;h4 id="åŒºå—é“¾é¢ä¸´çš„é—®é¢˜">åŒºå—é“¾é¢ä¸´çš„é—®é¢˜&lt;/h4>
&lt;p>åŒºå—é“¾ä½œä¸ºçŽ°åœ¨ä¸€ä¸ªçƒ­é—¨æŠ€æœ¯ï¼Œè¶Šæ¥è¶Šå¤šçš„äººæ¶Œå…¥å…¶ä¸­ã€‚ä¼ ç»Ÿçš„åŒºå—é“¾ç”±äºŽå…¶å•é“¾ç»“æž„å’Œå…±è¯†ç®—æ³•çš„é™åˆ¶ï¼Œå­˜åœ¨[!!!]ç­‰é—®é¢˜ã€‚
ä¹‹å‰æœ‰ç ”ç©¶å·¥ä½œæå‡ºï¼Œä¸€ä¸ªåŒºå—é“¾ä¸­åŒºå—é“¾çš„åŽ»ä¸­å¿ƒåŒ–ï¼Œå®‰å…¨ï¼Œå’Œè§„æ¨¡ä¸‰ä¸ªç‰¹æ–°ä¸èƒ½å…±å­˜ã€‚&lt;/p>
&lt;h4 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ&lt;/h4>
&lt;ul>
&lt;li>åˆ†ç‰‡æŠ€æœ¯: å°†ä¸€ä¸ªäº¤æ˜“åˆ†ç‰‡æ¥å¹¶è¡Œå¤„ç†ï¼Œä½†æ˜¯å¾ˆéš¾è¾¾æˆå…±è¯†ï¼Œè·¨é“¾æŠ€æœ¯é€šè¿‡åœ¨ä¸åŒåˆ†ç‰‡ä¹‹é—´å»ºç«‹é€šé“æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚&lt;/li>
&lt;li>Layer2 Protocl:å‚ä¸Žè€…èƒ½å¤Ÿé€šè¿‡ç§æœ‰é€šä¿¡è€Œä¸æ˜¯å¹¿æ’­åˆ°æ•´ä¸ªç½‘ç»œæ¥æ‰§è¡Œè„±ï¼ˆä¸»ï¼‰é“¾äº¤æ˜“æŒ‘æˆ˜æ˜¯å¦‚ä½•æ­£ç¡®æœ‰æ•ˆåœ°ä¿è¯é“¾ä¸‹å’Œé“¾ä¸Šäº¤æ˜“çš„æœ‰æ•ˆæ€§å’Œä¸€è‡´æ€§ã€‚&lt;/li>
&lt;li>è¾…åŠ©é“¾æŠ€æœ¯: é€šè¿‡å¢žåŠ è¾…åŠ©é“¾æ¥è®©æ›´å¤šçš„äº¤æ˜“å‚ä¸Žã€‚&lt;/li>
&lt;li>æ··åˆç»“æž„&lt;/li>
&lt;li>æ··åˆå…±è¯†ç®—æ³•&lt;/li>
&lt;li>ä¿®æ”¹ç¡¬è§£ç å‚æ•°&lt;/li>
&lt;/ul>
&lt;p>è¿™äº›æ–¹æ¡ˆéƒ½å—é™äºŽåŒºå—é“¾çš„çº¿æ€§ç»“æž„ï¼Œå› æ­¤ç»“æž„ä¸Šçš„æ”¹å˜æˆä¸ºä¸€ä¸ªæ–°å…´æ–¹æ¡ˆã€‚&lt;/p>
&lt;h4 id="dagåŒºå—é“¾çš„æå‡º">DAGåŒºå—é“¾çš„æå‡º&lt;/h4>
&lt;p>å•é“¾ç»“æž„ä½¿å¾—åŒä¸€æ—¶é—´å¤šä¸ªèŠ‚ç‚¹ç«žäº‰ä¸€ä¸ªå¯ç”¨ä½ç½®ï¼Œè¿™å¯¼è‡´äº†è®¤è¯ç¼“æ…¢ï¼Œäº¤æ˜“ç«žäº‰å’Œç®—åŠ›æµªè´¹ã€‚
ä¸ºäº†èƒ½åœ¨åŒä¸€æ—¶é—´æäº¤æ›´å¤šäº¤æ˜“ï¼Œæå‡ºäº†åŸºäºŽDAGçš„åŒºå—é“¾ã€‚&lt;/p>
&lt;h2 id="æ¦‚è§ˆ">æ¦‚è§ˆ&lt;/h2>
&lt;p>DAG æ˜¯æŒ‡æœ‰å‘æ— çŽ¯å›¾ï¼Œé€šå¸¸è¢«å½“ä½œä¸€ç§åŸºç¡€æ•°æ®ç»“æž„åº”ç”¨äºŽå¯¼èˆªå¯»å€ï¼Œæ•°æ®åŽ‹ç¼©ç­‰ç®—æ³•åœºæ™¯ã€‚
è¿™ä¸ªæ¦‚å¿µé¦–æ¬¡è¢«Sompolinkskyåœ¨GHOSTä¸­å¼•å…¥åŒºå—é“¾ï¼Œç”¨æ¥è§£å†³å¹¶å‘é—®é¢˜ã€‚æ”¹è¿›ç‰ˆæœ¬è¢«ä½œä¸ºæ ¸å¿ƒå…±è¯†ç®—æ³•åº”ç”¨äºŽä»¥å¤ªåŠä¸­ã€‚ä¹‹åŽï¼ŒLerneråœ¨DAGCoinä¸­å°†ç²’åº¦ä»Žå—æå‡åˆ°äº¤æ˜“ï¼ŒæŠ›å¼ƒäº†æ‰“åŒ…å’Œè®¡ç®—æ­¥éª¤å¤§å¤§æé«˜äº†æ•ˆçŽ‡ã€‚IOTAå’ŒByteBall åº”ç”¨äº†æ— å—çš„æ¦‚å¿µï¼Œå‘å¸ƒäº†å¼€æºå®žçŽ°ï¼Œè‡³ä»Šå¼•é¢†å¸‚åœºã€‚éšåŽï¼Œä¸€äº›å·¥ä½œåˆåœ¨DAGçš„åŸºç¡€ä¸Šè¿›è¡Œäº†æ”¹è¿›ã€‚å¦‚Spectre,Hashgraph,Nanoç­‰ã€‚&lt;/p>
&lt;p>åŸºäºŽDAGçš„ç³»ç»Ÿä¸»è¦æœ‰åˆ©äºŽéœ€è¦é«˜æ€§èƒ½ä½Žæ¶ˆè€—çš„åˆ†å¸ƒå¼åº”ç”¨(DAPP)ã€‚ç›´æŽ¥åº”ç”¨åº•å±‚çš„åŒºå—é“¾å¯ä»¥äº«å—åˆ°æ›´å¥½çš„ç‰¹æ€§ï¼Œä½†æ˜¯éœ€è¦ä¸“ä¸šçš„å¼€å‘æŠ€å·§å’Œæ˜‚è´µçš„ç¡¬ä»¶è®¾å¤‡ã€‚ä½¿ç”¨ä¸€äº›å®˜æ–¹çš„ç»„ä»¶æ˜¯ä¸€ç§å¯æ›¿ä»£çš„æ–¹æ¡ˆï¼Œå¦‚IOTA,MAM,Qubicã€‚ç›®å‰å¯ä»¥è€ƒè™‘åº”ç”¨çš„é¢†åŸŸæœ‰: ç‰©è”ç½‘ï¼Œæ•°æ®ç®¡ç†ï¼Œè½¦è½½åº”ç”¨ï¼Œæ™ºèƒ½å®¶å…·ç­‰ã€‚&lt;/p>
&lt;h2 id="å»ºæ¨¡">å»ºæ¨¡&lt;/h2>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h7ytqxs2xdj30td0kdq8u.jpg" alt="DAGå®šä¹‰.png">&lt;/p>
&lt;p>ä¸€ä¸ªæœ‰çŽ¯æ— å‘å›¾ç”±ç‚¹é›†å’Œè¾¹é›†ç»„æˆã€‚ç‚¹é›†çš„æ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯ä¸€ä¸ªäº¤æ˜“ï¼Œä¸€ä¸ªå—ï¼Œæˆ–è€…åè®®ä¸­çš„ä¸€ä¸ªäº‹ä»¶ã€‚è¾¹é›†çš„å…ƒç´ æ˜¯ä¸€ä¸ªå…ƒç»„ï¼Œä»£è¡¨ä¸¤ç‚¹ä¹‹é—´çš„å…³ç³»ã€‚&lt;/p>
&lt;p>&lt;strong>å…³é”®å‚æ•°&lt;/strong> å› ä¸ºçŽ°åœ¨æ¨¡åž‹ç¼ºä¹å…·ä½“çš„å®žçŽ°ï¼Œä½¿ç”¨å®šæ€§çš„å‚æ•°æ¥æè¿°ç³»ç»Ÿçš„åŸºæœ¬æŠ€æœ¯ã€‚&lt;/p>
&lt;ul>
&lt;li>&lt;strong>å‡ºåº¦å…¥åº¦&lt;/strong>: æè¿°æ¯ä¸ªå•å…ƒè¿žæŽ¥æ•°ç›®ã€‚ å‡ºåº¦æ˜¯æŒ‡ä»ŽèŠ‚ç‚¹æŒ‡å‡ºçš„è¾¹ï¼Œå³èŠ‚ç‚¹çš„å‰ä»»ã€‚å…¥åº¦æ˜¯æŒ‡æŒ‡å‘èŠ‚ç‚¹çš„è¾¹ï¼Œå³èŠ‚ç‚¹çš„ç»§æ‰¿è€…ã€‚&lt;/li>
&lt;li>&lt;strong>äº¤æ˜“æ¨¡åž‹&lt;/strong>ï¼šæè¿°å¦‚ä½•å®Œæˆä¸€ç¬”äº¤æ˜“ã€‚UXTO ä»£è¡¨ä¸€ç§æ— æŸè€—çš„è¾“å‡ºï¼Œäº¤æ˜“æ—¶åŽŸå­çš„ï¼Œä¸å¯åˆ†å‰²ã€‚æ¯ä¸ªæ“ä½œå¿…é¡»é€šè¿‡è¿™äº›äº¤æ˜“å®Œæˆã€‚Account model ç»´æŒä¸€ç§å¹³è¡¡çŠ¶æ€ã€‚&lt;/li>
&lt;li>&lt;strong>å¯ä¿¡åº¦&lt;/strong>: ä¸€ä¸ªç´¯åŠ çš„æ•°å­—å±•ç¤ºä¸€ä¸ªå•å…ƒè¢«å­å—ç›´æŽ¥æˆ–è€…é—´æŽ¥è®¤è¯çš„ç¨‹åº¦ã€‚ä¹Ÿåæ˜ ä¸‹ä¸€è½®è¢«é€‰æ‹©çš„æ¦‚çŽ‡ã€‚&lt;/li>
&lt;li>&lt;strong>è®¤è¯&lt;/strong>: ä¸€äº›ç‹¬ç‰¹çš„å‚æ•°è¢«ç”¨äºŽåœ¨ç½‘ç»œä¸­è®¤è¯å•å…ƒã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="åˆ†ç±»">åˆ†ç±»&lt;/h4>
&lt;p>&lt;strong>èŠ‚ç‚¹è¡¨çŽ°å½¢å¼&lt;/strong>&lt;/p>
&lt;p>è¿™ä¸ªé—´æŽ¥æ˜¾ç¤ºä¸€ä¸ªç³»ç»Ÿç»“æž„ï¼Œæ˜¯äº¤æ˜“ï¼Œäº‹ä»¶æˆ–è€…åŒºå—ã€‚æˆ‘ä»¬å®šä¹‰ä¸¤ç§ç±»åž‹: $1^{od}$ å’Œ $2^{od} $ã€‚ å‰è€…è¡¨ç¤ºè¯·æ±‚åˆ°è¾¾æ—¶ä¼šè¢«å³åˆ»å¤„ç†ï¼Œä¸éœ€è¦ç­‰å¾…æ¥è‡ªèŠ‚ç‚¹çš„æ›´å¤šè¯·æ±‚ã€‚è¿™ç§å½¢å¼åŒ…æ‹¬åŒºå—å’Œè§¦å‘äº‹ä»¶ã€‚ åŽè€…è¡¨ç¤ºè¯·æ±‚éœ€è¦æ›´å¤šæ“ä½œï¼Œå¤šæ•°æƒ…å†µä¸‹è¿™ä¸ªè¯·æ±‚éœ€è¦è¢«é¢„å…ˆè®¡ç®—æˆ–æ‰“åŒ…ï¼Œç„¶åŽè¢«æ•£æ’­ã€‚è¿™ç§å½¢å¼åŒ…æ‹¬åŒºå—å’Œäº‹ä»¶ã€‚&lt;/p>
&lt;p>èŠ‚ç‚¹å½¢å¼è¡¨ç¤ºç³»ç»Ÿç»“æž„ï¼ŒåŒæ—¶ä¹Ÿå†³å®šè´¦æœ¬æ¨¡åž‹ï¼Œè¡¨ç¤ºäº¤æ˜“å¦‚ä½•åœ¨DAGä¸­ç”Ÿæˆã€‚æœ‰ä¸¤ç§äº¤æ˜“æ¨¡åž‹: UXTO-based model å’Œ account-based modelã€‚ç¬¬ä¸€ä¸ªæ„å‘³ç€æ‰€æœ‰æ“ä½œéƒ½å¿…é¡»é€šè¿‡åŽŸå­äº‹åŠ¡æ¥å®žçŽ°ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡è·Ÿè¸ªä»¥å‰çš„äº¤æ˜“åŽ†å²æ¥è®¡ç®—ä½™é¢ã€‚å¯¹äºŽç¬¬äºŒä¸ªï¼Œæ¯ä¸ªç”¨æˆ·éƒ½æ‹¥æœ‰ä¸€ä¸ªå¸æˆ·ï¼Œå¹¶ä¸”äº¤æ˜“è¢«é…ç½®ä¸ºå…¶ç»“æž„ä¸­çš„å­—æ®µä¹‹ä¸€ã€‚ç”¨æˆ·ç›´æŽ¥åœ¨ä»–ä»¬çš„è´¦æˆ·ä¸­è®¡ç®—ä½™é¢ã€‚&lt;/p>
&lt;p>&lt;strong>ç½‘ç»œæŠ€æœ¯&lt;/strong>&lt;/p>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h7yywv7qowj31gt0hiq76.jpg" alt="ä¸‰ç§ç±»åž‹.png">&lt;/p>
&lt;p>åˆ†ä¸ºä¸‰ç§ &lt;strong>å‘æ•£&lt;/strong>,&lt;strong>å¹¶è¡Œ&lt;/strong>,&lt;strong>æ”¶æ•›&lt;/strong>ã€‚å‘æ•£è¡¨ç¤ºå•å…ƒåœ¨ä¸ç¡®å®šçš„æ–¹å‘ç¨€ç–çš„ä¼ æ’­ã€‚å¹¶è¡Œè¡¨ç¤ºåœ¨å¤šä¸ªé“¾çš„å•å…ƒè¢«ä¸€ç»„èŠ‚ç‚¹ç»´æŠ¤ã€‚æ”¶æ•›è¡¨ç¤ºå•å…ƒæŒ‰ç…§ä¸€ä¸ªç¡®å®šçš„è¶‹åŠ¿æ”¶æ•›åˆ°ä¸€ä¸ªç¡®å®šçš„åºåˆ—ã€‚&lt;/p>
&lt;p>æŒ‰ç…§ä¸Šè¿°æ ‡å‡†åˆ†ç±»å¦‚ä¸‹:
&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h7z2qpoyepj31kp0hywlh.jpg" alt="åˆ†ç±».png">&lt;/p>
&lt;h2 id="å…±è¯†ç®—æ³•">å…±è¯†ç®—æ³•&lt;/h2>
&lt;p>è¿™é‡Œè®¨è®ºå…±è¯†ç®—æ³•çš„å‡ ä¸ªæ–¹é¢ã€‚&lt;/p>
&lt;p>&lt;strong>å¼€æ”¾ç¨‹åº¦&lt;/strong>: è¡¨æ˜Žä¸€ä¸ªä»»æ„èŠ‚ç‚¹æ˜¯å¦æ— é™åˆ¶è¿è¡Œå…±è¯†ç®—æ³•ã€‚&lt;/p>
&lt;p>&lt;strong>æˆå‘˜é€‰æ‹©&lt;/strong>: é€‰æ‹©èŠ‚ç‚¹æˆä¸ºå‡ºå—èŠ‚ç‚¹çš„è§„åˆ™ã€‚&lt;/p>
&lt;p>&lt;strong>å•å…ƒåˆ†é…&lt;/strong>: å…±è¯†ç®—æ³•çš„å‡†å¤‡ã€‚&lt;/p>
&lt;p>&lt;strong>å•å…ƒå®šä½&lt;/strong>: ç¡®å®šä¸€ä¸ªå•å…ƒåœ¨ç½‘ç»œä¸­çš„ä½ç½®ã€‚&lt;/p>
&lt;p>&lt;strong>æ‰©å±•è§„åˆ™&lt;/strong>: å¦‚ä½•æ‰©å±•å›¾æˆ–è€…é“¾å’Œè§£é™¤è”ç³»ã€‚&lt;/p>
&lt;p>&lt;strong>å†²çªè§£å†³&lt;/strong>: è¡¨ç¤ºä¸€ç³»åˆ—å¯ä»¥ç¡®å®šå†²çªå•å…ƒä¼˜å…ˆçº§çš„å‚æ•°ã€‚&lt;/p>
&lt;p>&lt;strong>ç‰¹åˆ«æŠ€æœ¯&lt;/strong>: ä¸Žå…¶ä»–ç³»ç»Ÿä¸åŒçš„æŠ€æœ¯ã€‚&lt;/p>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h7z3ukvzmpj31u11yfnpd.jpg" alt="å…±è¯†åˆ†ç±».png">&lt;/p>
&lt;h4 id="ç¬¬ä¸€ç±»">ç¬¬ä¸€ç±»&lt;/h4>
&lt;p>&lt;strong>blockless ane natural expanding graph&lt;/strong>&lt;/p>
&lt;h5 id="iota">IOTA&lt;/h5>
&lt;p>æ— é™åˆ¶ç½‘ç»œï¼Œä½¿ç”¨UTXOæ•°æ®æ¨¡åž‹ï¼Œé€šè¿‡äº¤æ˜“å»ºç«‹ç³»ç»Ÿã€‚IOTAæŠŠèŠ‚ç‚¹çš„äº‹åŠ¡ç§°ä¸ºtangleã€‚ä¸€ä¸ªå¾…ç¡®è®¤çš„tipéœ€è¦å…ˆç¡®è®¤å‰é¢çš„ä¸¤ä¸ªtipï¼Œå‚ä¸Žè€…ä¹Ÿå…±åŒç»´æŠ¤ç³»ç»Ÿå®‰å…¨ã€‚ä½†æ˜¯å¦‚æžœæ¶æ„tipsè¢«æŒç»­ç”Ÿæˆï¼Œå¯èƒ½é€ æˆæ•´ä¸ªå›¾å‘å¤šä¸ªæ–¹å‘å‘æ•£ã€‚æ‰€ä»¥tipé€‰æ‹©ç®—æ³•æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œæœ‰ä¸‰ç§æœºåˆ¶æä¾›: &lt;strong>ä¸€è‡´éšæœºï¼ŒæœªåŠ æƒéšæœºå’ŒåŠ æƒéšæœºç§»åŠ¨&lt;/strong>ã€‚æœ€å…ˆè¿›çš„æ˜¯åŠ æƒéšæœºç§»åŠ¨ç®—æ³•ï¼Œæ˜¯é©¬å°”å¯å¤«é“¾è’™ç‰¹å¡ç½— (MCMC) ç®—æ³•çš„åº”ç”¨ã€‚æœ‰ä¸€äº›ä¿®æ”¹tipé€‰æ‹©ç®—æ³•çš„å˜ä½“ï¼Œå¦‚GIOTA,EIOTAã€‚&lt;/p>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h81275b065j30ha0amwgd.jpg" alt="IOTA.png">&lt;/p>
&lt;h5 id="graphchain">Graphchain:&lt;/h5>
&lt;p>æ— é™åˆ¶ç½‘ç»œã€‚&lt;/p>
&lt;p>IOATåŽ»é™¤äº†æ¿€åŠ±æœºåˆ¶ï¼Œè€ŒGraphchainåˆé‡æ–°å¼•å…¥ã€‚æ¯ä¸ªäº¤æ˜“å¿…é¡»è®¤è¯è¶³å¤Ÿå¤šçš„èŠ‚ç‚¹æ¥èŽ·å¾—æ¿€åŠ±ã€‚&lt;/p>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h812l3mj9tj30os0cujsm.jpg" alt="å›¾ç‰‡.png">&lt;/p>
&lt;h5 id="avalancheq">Avalancheq&lt;/h5>
&lt;p>ä¸€ä¸ªæ— é™åˆ¶,æ–°å…±è¯†æœºåˆ¶çš„ç½‘ç»œã€‚&lt;/p>
&lt;p>å…±è¯†æœºåˆ¶ä¸åŒäºŽæ‹œå åº­å’Œä¸­æœ¬èªå…±è¯†ã€‚æ˜¯ä¸€ç§å«åš&lt;strong>Slush&lt;/strong>çš„åè®®ï¼Œä»Žgossipç®—æ³•å’Œæµè¡Œç—…ç½‘ç»œä¸­èŽ·å¾—çµæ„Ÿçš„CFTå®¹å¿åè®®ã€‚&lt;/p>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h812t17em1j30rm0hw0vo.jpg" alt="å›¾ç‰‡.png">&lt;/p>
&lt;h4 id="ç¬¬äºŒç±»">ç¬¬äºŒç±»&lt;/h4>
&lt;p>&lt;strong>based on blocks,natural expanding graph&lt;/strong>&lt;/p>
&lt;h5 id="spectre">Spectre&lt;/h5>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/17/J2PbKE7sRvNtzuW.png" alt="">&lt;/p>
&lt;p>ä¸€ç§æ— é™åˆ¶ç½‘ç»œã€‚å…³é”®æŠ€æœ¯æ˜¯åŸºäºŽå—çš„ä¼˜å…ˆçº§çš„é€’å½’åŠ æƒæŠ•ç¥¨ç®—æ³•ï¼Œ&lt;/p>
&lt;h5 id="phantom">Phantom&lt;/h5>
&lt;h4 id="æ€»ç»“">æ€»ç»“&lt;/h4>
&lt;p>ä»Žä¸Šé¢æåˆ°çš„åŒºå—é“¾ç³»ç»Ÿæå–å‡ºå¸¸ç”¨çš„æŠ€æœ¯:&lt;/p>
&lt;ol>
&lt;li>Cross-referencing(äº¤å‰å¼•ç”¨)ã€‚ä¸€ä¸ªå—å¯ä»¥å¼•ç”¨å¤šä¸ªåŒºå—ï¼Œä¹Ÿå¯ä»¥è¢«å¤šä¸ªåŒºå—å¼•ç”¨ã€‚äº¤å‰å¼•ç”¨å¯ä»¥æé«˜åžåé‡ï¼Œæ‰©å¤§è§„æ¨¡ï¼Œé™ä½Žè®¤è¯æ—¶é—´ã€‚&lt;/li>
&lt;li>Trusted authorityã€‚ä¸€ä¸ªæƒå¨ä¸­å¿ƒæ¥åšæœ€åŽçš„å†³å®šï¼Œå¯ä»¥å‡å°‘ç¡®è®¤æ—¶é—´ï¼Œä½†æ˜¯ä¼šå‡å¼±åŽ»ä¸­å¿ƒåŒ–ç‰¹æ€§ã€‚&lt;/li>
&lt;li>Pairwise vote(æˆå¯¹æŠ•ç¥¨)ã€‚2 å¯¹ 1 çš„æŠ•ç¥¨é€‰æ‹©ï¼Œè€Œä¸æ˜¯æ­£å¸¸æŠ•ç¥¨ç®—æ³•ä¸­çš„ n å¯¹ 1ã€‚&lt;/li>
&lt;li>Transaction sharding(äº‹åŠ¡åˆ†ç‰‡)ã€‚å°†äº¤æ˜“åˆ†é…åˆ°ä¸åŒçš„é“¾æ¥é˜»æ­¢æŽ’åºè¿‡ç¨‹ä¸­å¯èƒ½çš„å¤åˆ¶å’Œå†²çªã€‚&lt;/li>
&lt;li>PoW æœºåˆ¶ã€‚ç”¨ä½œä¸€ä¸ªåæ¶æ„èŠ‚ç‚¹çš„å·¥å…·ï¼Œå¯¹äºŽå­åºåˆ—çš„PoWæ˜¯é¢„å…ˆè®¡ç®—çš„ï¼Œå¯ä»¥ä¿è¯äº¤æ˜“çž¬é—´å®Œæˆã€‚&lt;/li>
&lt;/ol>
&lt;p>å¯¹å¸¸ç”¨çš„å…±è¯†æœºåˆ¶åˆ†æž:&lt;/p>
&lt;ol>
&lt;li>Tip selection algorithmã€‚ä¸€ä¸ªæ–°çš„äº¤æ˜“å¦‚ä½•é€‰æ‹©ä¹‹å‰çš„äº¤æ˜“è¿›è¡Œç¡®è®¤ã€‚å¢žåŠ äº†åžåé‡å’Œè§„æ¨¡ï¼Œä¸€å®šç¨‹åº¦ä¸Šé™ä½Žäº†å®‰å…¨æ€§å’Œä¸€è‡´æ€§ã€‚&lt;/li>
&lt;li>Recursive algorithmã€‚é€’å½’è°ƒç”¨ä¸€ä¸ªå‡½æ•°ç›´åˆ°å¾—åˆ°ä¸€ä¸ªç¨³å®šå€¼ã€‚è¿™ä¸ªç®—æ³•è¢«å…±è¯†æœºåˆ¶é‡‡ç”¨æ¥ä½¿å¾—æ— åºçš„å—èšåˆæˆä¸€ä¸ªæœ‰åºçš„é“¾ï¼Œä½¿ç³»ç»Ÿå¯ä»¥åœ¨ä¸€ä¸ªç¡®å®šçš„æ–¹å‘æ‰©å±•ã€‚&lt;/li>
&lt;li>BFT-style consensusã€‚åˆ†ä¸ºä¸‰ç§
&lt;ul>
&lt;li>ä¼ ç»ŸBFTã€‚éœ€è¦æ ¹æ®èµ„æºç¡®å®š(PoWï¼ŒPoS)ä¸€ä¸ªcommitee,commiteeæˆå‘˜æ¥æ‰§è¡Œå…±è¯†æ“ä½œã€‚&lt;/li>
&lt;li>async-BA/leaderless BFT: æ¯ä¸ªé“¾éƒ½å¯ä»¥å¹¿æ’­å—å’ŒæŠ•ç¥¨ï¼Œå½“ä¸€ä¸ªå—å¾—åˆ°è¶³å¤Ÿçš„ç¥¨æ•°å°±å¯ä»¥æäº¤ï¼Œä½†æ˜¯ç”±äºŽè¿™ä¸ªæäº¤å’Œç¡®è®¤æ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥ä¸€ä¸ªå…¨å±€çš„çº¿æ€§æŽ’åºå¾ˆéš¾è¾¾åˆ°ã€‚&lt;/li>
&lt;li>å‰é¢ä¸¤ç§çš„æ•´åˆã€‚ç»å…¸çš„æ‹œå åº­å®¹é”™åè®®é¦–å…ˆåº”ç”¨äºŽå„ä¸ªç‹¬ç«‹çš„åŒºåŸŸï¼Œä¸Šå±‚åè®®é‡‡ç”¨async-BAå®žçŽ°è·¨åŒºåŸŸçš„æœ€ç»ˆå…±è¯†ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>Nakamoto consensus and its variants ï¼ˆä¸­æœ¬èªå…±è¯†å’Œå®ƒçš„å˜ä½“ï¼‰ã€‚çŽ°å­˜æœ€æµè¡Œçš„æ–¹æ³•ã€‚ä¼ ç»Ÿçš„NCé€‰æ‹©æœ€é•¿çš„é“¾ï¼Œå˜ä½“NCé€‰æ‹©æƒé‡æœ€å¤§çš„é“¾ï¼Œå¤šç”¨äºŽå½¢æˆä¸»é“¾ã€‚&lt;/li>
&lt;li>Sorting algorithmã€‚æŒ‰ç…§æ€»ä½“çš„çº¿æ€§é¡ºåºæ¥æŽ’åºï¼Œå¯¹äºŽç¡®ä¿å…¨å±€ä¸€è‡´æ€§æ˜¯å¿…ä¸å¯å°‘çš„ã€‚æ ¹æ®ä¸€äº›å‚æ•°æ¥ç¡®å®šä¼˜å…ˆçº§ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="ç‰¹æ€§åˆ†æž">ç‰¹æ€§åˆ†æž&lt;/h2>
&lt;h3 id="baå’Œncç‰¹æ€§">BAå’ŒNCç‰¹æ€§&lt;/h3>
&lt;p>æ‹œå åº­å…±è¯†å’Œä¸­æœ¬èªå…±è¯†æ˜¯æœ€æµè¡Œçš„ä¸¤ç§å…±è¯†åè®®ã€‚&lt;/p>
&lt;h4 id="æ‹œå åº­å…±è¯†">æ‹œå åº­å…±è¯†&lt;/h4>
&lt;p>åœ¨å­˜åœ¨æ¶æ„èŠ‚ç‚¹çš„æƒ…å†µä¸‹å¯ä»¥è¾¾æˆçš„å…±è¯†ã€‚æœ‰ä¸‰ä¸ªç‰¹æ€§:&lt;/p>
&lt;ul>
&lt;li>argeement:&lt;/li>
&lt;li>validity:&lt;/li>
&lt;li>termination:&lt;/li>
&lt;/ul>
&lt;h4 id="ä¸­æœ¬èªå…±è¯†">ä¸­æœ¬èªå…±è¯†&lt;/h4>
&lt;p>å…è®¸æ‰€æœ‰èŠ‚ç‚¹å¯ä»¥å‚ä¸Žå…±è¯†é€šè¿‡PoW,PoSç­‰æ–¹å¼ã€‚æœ‰ä¸¤ä¸ªå…³é”®ç‰¹æ€§:&lt;/p>
&lt;ul>
&lt;li>persistence:&lt;/li>
&lt;li>liveness:&lt;/li>
&lt;/ul>
&lt;h2 id="å®‰å…¨åˆ†æž">å®‰å…¨åˆ†æž&lt;/h2>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/17/suHCLTGvFKi1bjc.png" alt="">&lt;/p>
&lt;h3 id="parasite-chain-attack">Parasite Chain Attack&lt;/h3>
&lt;p>å°è¯•ç”¨é¢„å…ˆå‡†å¤‡å¥½çš„å­é“¾æ¥æ›¿æ¢æ­£ç¡®çš„å­é“¾ã€‚&lt;/p>
&lt;p>é¦–å…ˆæ”»å‡»è€…å‚ç…§ä¸»é“¾æ¥æž„é€ ä¸€ä¸ªæœ‰å¾ˆé«˜å¯ä¿¡åº¦çš„å­é“¾ã€‚ç„¶åŽåˆ†åˆ«å‘é€ä¸€å¯¹å†²çªçš„äº¤æ˜“åˆ°ä¸»é“¾å’Œæž„é€ çš„ç§é“¾ï¼ŒæŽ¥ä¸‹æ¥è¦ç¡®ä¿å­é“¾å¾—åˆ°æœ‰ç«žäº‰åŠ›çš„å¯ä¿¡åº¦ã€‚è¿™æ—¶ï¼Œè¿™ä¸ªå†²çªäº¤æ˜“å¯èƒ½å·²ç»åœ¨ä¸»é“¾ä¸Šç¡®è®¤ï¼Œæ”»å‡»è€…å†å‘å¸ƒä»–çš„å­é“¾ï¼Œè¿™æ ·å¾ˆå¯èƒ½ä½¿æ­£ç¡®çš„ä¸»é“¾æ— æ•ˆç„¶åŽä¸€ä¸ªcoinå¯èƒ½è¢«ä½¿ç”¨ä¸¤æ¬¡ã€‚&lt;/p>
&lt;p>è¿™ç§æ”»å‡»éœ€è¦æ”»å‡»è€…æœ‰å……è¶³çš„ç®—åŠ›æ¥ç”ŸæˆåŒºå—ï¼Œä»¥æ²¡æœ‰å¼ºåŠ›é¢†å¯¼è€…çš„åè®®ä¸ºç›®æ ‡ã€‚&lt;/p>
&lt;h3 id="balance-attack--liveness-attack">Balance attack / liveness attack&lt;/h3>
&lt;p>ä¿æŒå¤šä¸ªå­å›¾å¹³è¡¡å¢žé•¿æ¥èŽ·å–æ”¶ç›Šï¼Œæ”»å‡»è€…åœ¨ä¸€ä¸ªå­å›¾å‘å¸ƒäº¤æ˜“åŽï¼Œåˆåœ¨å¦ä¸€ä¸ªå­å›¾å‘å¸ƒäº¤æ˜“ï¼ŒåŠ¨æ€ç»´æŒå‡ ä¸ªå­å›¾çš„å¹³è¡¡æ¥èŽ·å–æ”¶ç›Šã€‚&lt;/p>
&lt;p>éœ€è¦ä¸€ä¸ªå¾ˆå¤§ç®—åŠ›ï¼Œä¸»è¦æ”»å‡»åŸºäºŽPOWçš„åè®®ã€‚&lt;/p>
&lt;h3 id="splitting-attack">Splitting attack&lt;/h3>
&lt;p>ç±»ä¼¼å¹³è¡¡æ”»å‡»ï¼Œæ”»å‡»è€…æ‰¾åˆ°ä¸¤ä¸ªç›¸è¿‘çš„åˆ†æ”¯æˆ–è€…å­å›¾æ¥å‘é€å†²çªäº¤æ˜“èŽ·å–åˆ©æ¶¦ã€‚&lt;/p>
&lt;p>æ”»å‡»è€…éœ€è¦æœ‰å¼ºå¤§çš„ç®—åŠ›ï¼Œä¸»è¦æ”»å‡»æ²¡æœ‰å¼ºåŠ›ä¸­å¿ƒçš„ç³»ç»Ÿã€‚&lt;/p>
&lt;h3 id="large--weight-attack">Large Weight Attack&lt;/h3>
&lt;h3 id="censorship-attack">Censorship Attack&lt;/h3>
&lt;h3 id="replay-attack">Replay Attack&lt;/h3>
&lt;h3 id="sybi-attack">Sybi Attack&lt;/h3>
&lt;h2 id="heading">&lt;/h2></description></item><item><title>è”é‚¦å­¦ä¹ è®ºæ–‡é˜…è¯»</title><link>https://chi-kai.github.io/post/%E8%81%94%E9%82%A6%E5%AD%A6%E4%B9%A0%E7%9B%B8%E5%85%B3%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/</link><pubDate>Sun, 06 Nov 2022 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/%E8%81%94%E9%82%A6%E5%AD%A6%E4%B9%A0%E7%9B%B8%E5%85%B3%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/</guid><description>&lt;h2 id="towards-on-device-federated-learning-a-direct-acyclic-graph-based-blockchain-approach">ã€ŠTowards On-Device Federated Learning: A Direct Acyclic Graph-based Blockchain Approachã€‹&lt;/h2>
&lt;h3 id="ç›®æ ‡">ç›®æ ‡&lt;/h3>
&lt;p>ä¸ºäº†è§£å†³è”é‚¦å­¦ä¹ ä¸­çš„è®¾å¤‡å¼‚æ­¥å’Œå¼‚å¸¸æ£€æµ‹é—®é¢˜ï¼ŒåŒæ—¶é¿å…ç”±åŒºå—é“¾å¯¼è‡´çš„èµ„æºæµªè´¹&lt;/p>
&lt;ul>
&lt;li>
&lt;p>è®¾å¤‡å¼‚æ­¥ã€‚ä¼ ç»Ÿçš„ä¸­å¿ƒåŒ–å’ŒåŒæ­¥FL(Google FL),ä¸€ä¸ªèŠ‚ç‚¹å¿…é¡»ç­‰å¾…å…¶ä»–èŠ‚ç‚¹å®Œæˆä»»åŠ¡æ‰èƒ½ä¸€èµ·è¿›å…¥ä¸‹ä¸€è½®è®­ç»ƒï¼Œä¸€ä¸ªå´©æºƒçš„èŠ‚ç‚¹å¯èƒ½é˜»å¡žæ•´ä¸ªç³»ç»Ÿã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å¼‚å¸¸æ£€æµ‹ã€‚ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®é›†å’Œæ“ä½œå¯¹å…¶ä»–èŠ‚ç‚¹æ˜¯ä¸å¯è§çš„ã€‚ä¸€äº›æ¶æ„èŠ‚ç‚¹å¯èƒ½ä¼šç ´åæ•´ä¸ªç³»ç»Ÿçš„å‡†ç¡®åº¦å’Œé™ä½Žæ•ˆçŽ‡ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="ä¸»è¦è´¡çŒ®">ä¸»è¦è´¡çŒ®&lt;/h3>
&lt;p>æå‡ºäº†ç¬¬ä¸€ä¸ªåŸºäºŽDAGçš„FLå¼‚æ­¥æ¡†æž¶æ¥è§£å†³è®¾å¤‡å¼‚æ­¥å’Œå¼‚å¸¸èŠ‚ç‚¹æ£€æµ‹é—®é¢˜ã€‚&lt;/p>
&lt;h3 id="dag-fl-æ¨¡åž‹">DAG-FL æ¨¡åž‹&lt;/h3>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h7vnbi5q76j30ru0n1tcw.jpg" alt="DAG-FLç»“æž„.png">&lt;/p>
&lt;p>â€œThis feature promises that a node in DAG-FL can immediately participate in an iteration of FL whenever it is in idle state. When the node completes an iteration of FL and gets a new trained local model, the new local model can be published on its local DAG as a transaction immediately, and latter the new published transaction would be seen by all other nodes.â€ (&lt;a href="zotero://select/library/items/MG76RNTD">Cao ç­‰ã€‚, p. 4&lt;/a>) (&lt;a href="zotero://open-pdf/library/items/BZ4CNUBL?page=4">pdf&lt;/a>) â€&lt;/p>
&lt;p>è¿˜æ˜¯ç”¨æœ¬åœ°çš„æ•°æ®æ¥è®­ç»ƒæ¨¡åž‹ï¼Œå¹¶æ²¡æœ‰å’Œå…¶ä»–èŠ‚ç‚¹åšèšåˆï¼Ÿ&lt;/p>
&lt;p>â€œinitialâ€ (&lt;a href="zotero://select/library/items/MG76RNTD">Cao ç­‰ã€‚, p. 5&lt;/a>) (&lt;a href="zotero://open-pdf/library/items/BZ4CNUBL?page=5">pdf&lt;/a>)&lt;/p>
&lt;h3 id="å¼‚æ­¥æž„æž¶">å¼‚æ­¥æž„æž¶&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>FL Layer:&lt;/p>
&lt;p>å…¨å±€æ¨¡åž‹ç”±å­˜å‚¨åœ¨DAGä¸­çš„æœ¬åœ°æ¨¡åž‹ä½¿ç”¨FedAvgç®—æ³•èšåˆäº§ç”Ÿï¼ŒèŠ‚ç‚¹ä½¿ç”¨æœ¬åœ°æ•°æ®é›†è¿›è¡Œè®­ç»ƒã€‚å¾—åˆ°çš„æ–°çš„æ¨¡åž‹è¢«å½“ä½œä¸€ä¸ªäº¤æ˜“å‘å¸ƒåˆ°DAGä¸­ã€‚ï¼ˆæ¯ç¬”äº¤æ˜“å°±æ˜¯ä¸€ä¸ªæ¨¡åž‹ï¼‰&lt;/p>
&lt;/li>
&lt;li>
&lt;p>DAG Layer:&lt;/p>
&lt;p>æ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤ä¸€ä¸ªæœ¬åœ°DAGï¼Œå…¶ä¸­æ¯ä¸ªäº¤æ˜“åŒ…å«ä¸‹ç›¸åº”çš„è®¤è¯ä¿¡æ¯ï¼Œæœ¬åœ°æ¨¡åž‹å‚æ•°ï¼Œå’Œè®¸å¯é“¾æŽ¥ã€‚æœ¬åœ°DAGé€šè¿‡å¹¿æ’­å’Œæ— çº¿ç½‘ç»œæ›´æ–°ï¼Œæœ€ç»ˆä¸€ä¸ªæ–°çš„äº¤æ˜“å¯ä»¥å¾—åˆ°ä¼ æ’­ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>Application Layer:&lt;/p>
&lt;p>ä¸€ä¸ªå¤–éƒ¨æŽ¥å£ï¼Œé€šè¿‡æ™ºèƒ½åˆçº¦å‘å¸ƒä»»åŠ¡ã€‚è¿™ä¸ªå®¢æˆ·ç«¯å¯ä»¥è§‚å¯Ÿæ•´ä¸ªFLè¿‡ç¨‹çš„è¿›å±•ï¼Œä»Žè€ŒæŽ§åˆ¶æ•´ä¸ªFLçš„è¿›è¡Œå’Œåœæ­¢ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å¼‚æ­¥æ€§åˆ†æžï¼š&lt;/p>
&lt;p>Â  Â åœ¨æ•´ä¸ªDAG-FLä¸­æ²¡æœ‰central server,æ¯ä¸ªèŠ‚ç‚¹æ˜¯é€šè¿‡æœ¬åœ°å·²æœ‰çš„æ¨¡åž‹æ¥æž„å»ºæ–°çš„å…¨å±€æ¨¡åž‹ã€‚èŠ‚ç‚¹å¯ä»¥åœ¨åˆé€‚çš„æ—¶é—´æ¥è¿›è¡ŒFLè¿­ä»£ï¼ŒèŽ·å–çš„æ–°çš„æ¨¡åž‹å‘å¸ƒåœ¨æœ¬åœ°DAG,éšåŽå¯ä»¥è¢«å…¶ä»–èŠ‚ç‚¹æ‰€è§ã€‚èŠ‚ç‚¹ä¹‹é—´çš„è¡Œä¸ºäº’ä¸å½±å“å¯ä»¥å¼‚æ­¥è¿›è¡Œã€‚&lt;/p>
&lt;h3 id="å…±è¯†ç®—æ³•">å…±è¯†ç®—æ³•&lt;/h3>
&lt;p>å½“ä¸€ä¸ªèŠ‚ç‚¹å®Œæˆä¸€è½®è¿­ä»£ï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„æ¨¡åž‹ã€‚ä»–ä¼šä»Žæœ¬åœ°DAGé€‰å–å‡ ä¸ªtips(åŠ å…¥DAGä½†æ˜¯æ²¡æœ‰è¢«éªŒè¯çš„block)æ¥è¿›è¡ŒéªŒè¯:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>éªŒè¯ä½¿ç”¨RSAç­‰ç®—æ³•åŠ å¯†çš„èº«ä»½è¯ä¹¦ã€‚å¯ä»¥é¿å…æ¶æ„èŠ‚ç‚¹çš„å¥³å·«æ”»å‡»ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>ä½¿ç”¨æœ¬åœ°çš„æµ‹è¯•é›†æ¥è®¡ç®—æ¨¡åž‹çš„ç²¾ç¡®åº¦ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>ç„¶åŽé€‰å–æ¨¡åž‹ç²¾ç¡®åº¦æœ€é«˜çš„å‡ ä¸ªæ¨¡åž‹æ¥æž„æˆæ–°çš„å…¨å±€æ¨¡åž‹ã€‚&lt;/p>
&lt;p>èŠ‚ç‚¹ä½¿ç”¨è¿™ä¸ªæ¨¡åž‹å’Œæœ¬åœ°æ•°æ®é›†è®­ç»ƒï¼Œå¾—åˆ°çš„æ–°æ¨¡åž‹é€šè¿‡ä¸€ä¸ªæ–°çš„äº¤æ˜“å‘å¸ƒåˆ°DAGä¸­ã€‚&lt;/p>
&lt;p>éšç€DAGçš„æŒç»­æ‰©å±•ï¼Œä¸€ä¸ªäº¤æ˜“çš„æ¯æ¬¡è®¤è¯éƒ½æ„å‘³ç€è¿™ä¸ªäº¤æ˜“ä»£è¡¨çš„æ¨¡åž‹è¢«é€‰æ‹©åŽ»æž„å»ºä¸€ä¸ªå…¨å±€æ¨¡åž‹ï¼Œè¿›è€Œå½±å“æœ€ç»ˆæ¨¡åž‹çš„ç”Ÿæˆã€‚å¾—åˆ°çš„è®¤è¯è¶Šå¤šï¼Œå®ƒåœ¨FLä¸­çš„å½±å“è¶Šå¤§ã€‚åä¹‹ï¼ŒèŠ‚ç‚¹å°±ä¼šè¢«å­¤ç«‹ï¼Œåœ¨FLä¸­å½±å“è¶Šå°ã€‚&lt;/p>
&lt;p>æ‰€ä»¥ï¼Œæœ€ç»ˆDAG-FLè®­ç»ƒçš„æ¨¡åž‹ä¼šå‘å¤§å¤šæ•°èŠ‚ç‚¹æœŸæœ›çš„æ–¹å‘å‘å±•ï¼Œå°‘éƒ¨åˆ†æ¶æ„èŠ‚ç‚¹ä¼šé€æ¸è¢«å­¤ç«‹ï¼Œå½±å“é™åˆ°æœ€å°åŒ–ã€‚&lt;/p>
&lt;h3 id="flç®—æ³•">FLç®—æ³•&lt;/h3>
&lt;p>ç¬¦å·å®šä¹‰:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>D = {1,2,3,â€¦,N $_D$ },ä»£è¡¨æ•´ä¸ªè®¾å¤‡é›†ç¾¤ã€‚D $_i$æ˜¯ç¬¬iä¸ªèŠ‚ç‚¹ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>S $_i$æ˜¯D $_i$çš„è®­ç»ƒé›†ï¼Œ|S $_i$| = N $_i$,è¿™é‡ŒN $_i$æ˜¯S $_i$çš„samplesæ•°é‡ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>D $_i$åœ¨æœ¬åœ°åˆ›å»ºä¸€ä¸ªä»…è‡ªå·±å¯è§çš„DAGä¸ºg $_i$ï¼Œå­˜å‚¨åœ¨å…¶ä¸­çš„äº¤æ˜“ä¸ºw&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ—¶é—´tï¼Œåœ¨D $_i$è®­ç»ƒå¾—åˆ°çš„æœ¬åœ°æ¨¡åž‹ä¸ºw $_i$ $^t$&lt;/p>
&lt;/li>
&lt;/ol>
&lt;p>ç®—æ³•æµç¨‹:&lt;/p>
&lt;ol>
&lt;li>D $_i$åœ¨t $_0$å¼€å§‹FLç®—æ³•è¿­ä»£ï¼Œé¦–å…ˆéªŒè¯æœ¬åœ°DAGçš„ä¸€äº›tips(éªŒè¯ä»–ä»¬çš„èº«ä»½å’Œç”¨æµ‹è¯•é›†éªŒè¯å‡†ç¡®åº¦)&lt;/li>
&lt;li>å°†å‡†ç¡®åº¦è¾ƒé«˜çš„çš„kä¸ªtipsä½¿ç”¨FedAvgç®—æ³•èšåˆæˆä¸€ä¸ªå…¨å±€æ¨¡åž‹:
$$
\omega^{t_{0}}=\sum_{i=1}^{k} n_{i} \omega_{d_{i}}^{t_{i}}
$$
è¿™é‡Œ n $_i$æ˜¯è¡¨ç¤ºæ¨¡åž‹é‡è¦æ€§çš„æƒé‡å› å­ï¼Œä¸ºäº†ç®€åŒ–è¿™é‡Œè®¾ç½®ä¸º1/k,è¡¨ç¤ºåŒç­‰é‡è¦ã€‚&lt;/li>
&lt;li>èŠ‚ç‚¹ä»Žæ•°æ®é›†S $_i$ä¸­æå–mä¸ªsamplesä½œä¸ºä¸€ä¸ªæœ€å°batch z$_i$ æ¥å¯¹å¾—åˆ°çš„å…¨å±€æ¨¡åž‹è®­ç»ƒ $\beta$ä¸ªepochs.&lt;/li>
&lt;li>å¾—åˆ°ä¸€ä¸ªæ–°æ¨¡åž‹ $\omega &lt;em>{i}^{ t&lt;/em>{0}}$,å°†å®ƒå‘å¸ƒåˆ°$g_{i}$ä¸Šã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="dag-fl-æ“ä½œ">DAG-FL æ“ä½œ&lt;/h3>
&lt;p>è¿™é‡Œä»‹ç»æ¡†æž¶ä¸­çš„ä¸¤ä¸ªé‡è¦ç®—æ³•ã€‚&lt;/p>
&lt;h4 id="dag-fl-controlling">DAG-FL Controlling&lt;/h4>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h7voje2iexj30tp0r90zh.jpg" alt="DAG-FL Controlling.png">&lt;/p>
&lt;p>åœ¨åº”ç”¨å±‚çš„å¤–æŽ¥å®¢æˆ·ç«¯å¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªæƒå¨ç»„ç»‡ï¼Œè´Ÿè´£ä»»åŠ¡å‘å¸ƒä»»åŠ¡ã€‚é€šè¿‡æ™ºèƒ½åˆçº¦æ‰§è¡ŒDAG-FL æŽ§åˆ¶ç®—æ³•ã€‚è¿‡ç¨‹å¦‚ä¸Šå›¾ã€‚&lt;/p>
&lt;h4 id="dag-fl-updating">DAG-FL Updating&lt;/h4>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h7vro3iz6gj30tr0qu0ze.jpg" alt="DAG-FL Updating.png">&lt;/p>
&lt;p>èŠ‚ç‚¹åœ¨ç©ºé—²æ—¶æ‰§è¡ŒDAG-FL Updating ç®—æ³•ã€‚&lt;/p>
&lt;ol>
&lt;li>èŠ‚ç‚¹éšæœºä»Žæœ¬åœ°DAGé€‰å–stalenessèŒƒå›´åœ¨å¯ä»¥æŽ¥æ”¶çš„tipã€‚&lt;/li>
&lt;li>èŠ‚ç‚¹å…ˆè®¤è¯æ‰€é€‰tipsçš„èº«ä»½ï¼Œç„¶åŽç”¨è‡ªå·±çš„testæ•°æ®é›†æ¥è®¡ç®—æ‰€é€‰tipsçš„æ¨¡åž‹ç²¾ç¡®åº¦ã€‚&lt;/li>
&lt;li>é€‰æ‹©ç²¾ç¡®åº¦é«˜çš„kä¸ªtipsï¼Œä½¿ç”¨FedAvgingç®—æ³•å¾—åˆ°ä¸€ä¸ªå…¨å±€æ¨¡åž‹ã€‚èŠ‚ç‚¹ç”¨æœ¬åœ°æ•°æ®æ¥è®­ç»ƒè¿™ä¸ªå…¨å±€æ¨¡åž‹ã€‚&lt;/li>
&lt;li>ä¸€ä¸ªæ–°çš„äº¤æ˜“è¢«ç”Ÿæˆã€‚åŒ…æ‹¬èº«ä»½ä¿¡æ¯ï¼Œä¸Šä¸€é˜¶æ®µè®­ç»ƒå¾—åˆ°çš„æ¨¡åž‹ï¼Œå’Œæœ€kä¸ªtipsçš„éªŒè¯ä¿¡æ¯ã€‚&lt;/li>
&lt;/ol>
&lt;h3 id="æœªæ¥å·¥ä½œ">æœªæ¥å·¥ä½œ&lt;/h3>
&lt;ol>
&lt;li>åœ¨æ¨¡åž‹å¯ç”¨æ€§ä¸Šï¼Œä½¿ç”¨ä¸€ä¸ªå°çš„test setå¯èƒ½å¯¹äºŽä¸€äº›ç‰¹å®šåœºæ™¯ä¸é€‚åˆï¼Œè€ƒè™‘å…¶ä»–çš„å¼‚å¸¸æ£€æµ‹æ–¹æ³•ã€‚&lt;/li>
&lt;li>ä¿¡ç”¨è¯„ä¼°&lt;/li>
&lt;li>æƒé‡èšåˆã€‚æœ¬æ–‡çš„æ¨¡åž‹ä½¿ç”¨çš„æ–¹æ³•æ˜¯åŒç­‰æƒé‡ç³»æ•°çš„FedAvg,å¯ä»¥ä½¿ç”¨æ›´å¥½çš„æ–¹æ³•æ¥ç»™é«˜è´¨é‡çš„æ¨¡åž‹æ›´é«˜çš„æƒé‡æé«˜æ¨¡åž‹ç²¾åº¦ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="implicit-model-specialization-through-dag-based-decentralized-federated-learning">ã€ŠImplicit Model Specialization through DAG-based Decentralized Federated Learningã€‹&lt;/h2>
&lt;h3 id="èƒŒæ™¯">èƒŒæ™¯&lt;/h3>
&lt;p>ç”±äºŽè”é‚¦å­¦ä¹ æ•°æ®çš„éžç‹¬ç«‹åŒåˆ†å¸ƒç‰¹æ€§ï¼Œæ‰€æœ‰èŠ‚ç‚¹è®­ç»ƒä¸€ä¸ªæ¨¡åž‹å¤ªè¿‡å®½æ³›ï¼Œæå‡ºä¸€ç§åŸºäºŽDAGåŒºå—é“¾çš„è”é‚¦å­¦ä¹ æ¡†æž¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹åˆ©ç”¨æœ¬åœ°æ•°æ®å’Œå…¶ä»–èŠ‚ç‚¹ç›¸ä¼¼çš„æ•°æ®è®­ç»ƒè‡ªå·±çš„ç‰¹ä¾‹åŒ–æ¨¡åž‹ï¼Œå’Œå…¨å±€çš„æ³›åŒ–æ¨¡åž‹ç»“åˆæ¥æé«˜ç³»ç»Ÿçš„æ€§èƒ½ã€‚&lt;/p>
&lt;p>è¿™ç¯‡è®ºæ–‡æ˜¯åœ¨è”é‚¦å­¦ä¹ ä¹‹å‰å·²ç»æœ‰çš„å¯¹æœ¬åœ°æ•°æ®ç‰¹ä¾‹åŒ–çš„ç ”ç©¶åŸºç¡€ä¸Šï¼Œå¼•å…¥DAGåŒºå—é“¾ã€‚&lt;/p>
&lt;h3 id="æ¨¡åž‹">æ¨¡åž‹&lt;/h3>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/12/EWSmpuqlzK4TMAt.png" alt="">&lt;/p>
&lt;p>æ¯ä¸ªèŠ‚ç‚¹æ‰§è¡Œå››ä¸ªæ­¥éª¤ï¼Œé€šè¿‡åŸºç¡€çš„éšæœºç§»åŠ¨ç®—æ³•é€‰æ‹©DAGä¸Šçš„ä¸¤ä¸ªtips,å°†è¿™ä¸ªä¸¤ä¸ªé€‰æ‹©çš„æ¨¡åž‹å‚æ•°å¹³å‡ï¼Œå¾—åˆ°çš„æ¨¡åž‹åœ¨æœ¬åœ°æ•°æ®é›†ä¸Šè®­ç»ƒï¼Œå¦‚æžœæœ€ç»ˆå¾—åˆ°çš„æ¨¡åž‹æœ‰æé«˜å°±å‘å¸ƒã€‚&lt;/p>
&lt;h4 id="tipsé€‰æ‹©ç®—æ³•">tipsé€‰æ‹©ç®—æ³•&lt;/h4>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/12/clpHA9C21hkRoUV.png" alt="">
ä»ŽåŒºå—é“¾æŽ¥çš„ç›¸åæ–¹å‘éšæœºéåŽ†ã€‚æ¯ä¸ªäº¤æ˜“(åŒºå—)æ ¹æ®å®ƒçš„å­å›¾å¤§å°åˆ†é…ä¸€ä¸ªæƒé‡ï¼Œé€šå¸¸ä¼šé€‰æ‹©æœ€é«˜æƒé‡çš„åŒºå—ï¼Œä½¿å¾—è¿™ä¸ªéåŽ†æ–¹å‘æ”¶æ•›ã€‚
&lt;img src="https://s2.loli.net/2022/11/12/uJkGPclTq24VEDa.png" alt="">&lt;/p>
&lt;p>åŒæ—¶ï¼Œå¯¹äºŽæ¯ä¸ªèŠ‚ç‚¹æœ‰ç‰¹å®šåŒ–çš„åå‘å¤„ç†ï¼ŒéåŽ†çš„æ¯ä¸€æ­¥ï¼Œå¯¹äºŽä¸‹ä¸€è·³å¯ä»¥åˆ°è¾¾çš„æ½œåœ¨æ¨¡åž‹åœ¨æœ¬åœ°æ•°æ®é›†ä¸Šè¿›è¡Œè¯„ä¼°ã€‚&lt;/p>
&lt;p>WEIGHTEDCHOICE å‡½æ•°ä»Žè¿™äº›æ¨¡åž‹ä¸­éšæœºé€‰æ‹©ï¼Œå¹¶æ ¹æ®å­èŠ‚ç‚¹å¯¹æœ¬åœ°æ•°æ®çš„ç²¾ç¡®åº¦è¿›è¡ŒåŠ æƒã€‚ï¼ˆåˆ°åº•æ˜¯æŒ‰ç…§æƒé‡è¿˜æ˜¯éšæœºé€‰æ‹©ï¼Ÿï¼‰&lt;/p>
&lt;p>è¿™é‡Œçš„ç²¾ç¡®åº¦è®¡å’Œæƒé‡è®¡ç®—ï¼š&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/12/NxPmWCyJBFhMAbv.png" alt="">&lt;/p>
&lt;p>éåŽ†çš„éšæœºæ€§å¯ä»¥ç”± Î± å‚æ•°ç¡®å®šï¼Œå…¶ä¸­å€¼è¶Šå¤§ï¼Œæƒé‡ä¹‹é—´çš„å·®å¼‚è¶Šå¤§ï¼Œå› æ­¤éšæœºæ€§è¶Šå°ï¼Œç¡®å®šæ€§è¶Šé«˜ã€‚å¦ä¸€æ–¹é¢ï¼Œè¾ƒå°çš„ Î± å€¼ä¼šå¯¼è‡´æƒé‡æ”¶æ•›ï¼Œä»Žè€Œå¯¼è‡´æ›´å¤šéšæœºæ€§ã€‚æ¨¡åž‹ä¹‹é—´çš„é¢„æœŸç²¾åº¦å·®å¼‚å–å†³äºŽæˆ‘ä»¬çš„æ–¹æ³•æ‰€åº”ç”¨çš„æœºå™¨å­¦ä¹ é—®é¢˜ï¼Œä»¥åŠå­¦ä¹ çŽ‡ã€æ‰¹é‡å¤§å°å’Œå±€éƒ¨æ—¶æœŸç­‰è¶…å‚æ•°ã€‚ä¸ºäº†åœ¨æ¨¡åž‹ä¹‹é—´çš„ç²¾åº¦å˜åŒ–å¾ˆå°çš„æƒ…å†µä¸‹ä¹Ÿèƒ½å®žçŽ°è‰¯å¥½çš„ç‰¹æ€§åŒ–ï¼Œå³ä½¿åœ¨å·®å¼‚å¾ˆå¤§çš„æƒ…å†µä¸‹ä¹Ÿèƒ½å®žçŽ°è‰¯å¥½çš„æ³›åŒ–ï¼Œå°†æ¯ä¸ªæ­¥éª¤ä¸­çš„ç²¾åº¦åˆ†å¸ƒ max(accuracies) - min(accuracies) ç²¾åº¦å½’ä¸€åŒ– * çš„ä¸€éƒ¨åˆ†ï¼š&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/12/cHbGaDKXUvMLl6P.png" alt="">&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/12/7bDcLwGtZp2e1Co.png" alt="">&lt;/p>
&lt;h2 id="safa-a-semi-asynchronous-protocol-for-fast-federated-learning-with-low-overhead">ã€ŠSAFA: A Semi-Asynchronous Protocol for Fast Federated Learning With Low Overheadã€‹&lt;/h2>
&lt;h3 id="èƒŒæ™¯-1">èƒŒæ™¯&lt;/h3>
&lt;p>åŽŸæœ‰çš„FedAvgç®—æ³•å­˜åœ¨ä¸€äº›é—®é¢˜:&lt;/p>
&lt;ul>
&lt;li>åŒæ­¥å¼€é”€å¤§ï¼š æ¯è½®è¿­ä»£ä¸­å¤®æœåŠ¡å™¨éœ€è¦ä¼ è¾“å…¨å±€æ¨¡åž‹ç»™æ‰€æœ‰å®¢æˆ·ç«¯ï¼Œå¸¦å®½è¾¾åˆ°ä¸€ä¸ªå³°å€¼ã€‚&lt;/li>
&lt;li>å®¢æˆ·ç«¯åˆ©ç”¨ä¸è¶³ï¼šéšæœºé€‰æ‹©çš„å®¢æˆ·ç«¯ä½¿å¾—è®¸å¤šå¯ä»¥å‚åŠ è®­ç»ƒçš„å®¢æˆ·ç«¯é—²ç½®ã€‚&lt;/li>
&lt;/ul>
&lt;blockquote>
&lt;p>è¿™ä¸ªè®ºç‚¹ä¸å……åˆ†ã€‚FedAvgæ˜¯åœ¨æ‰€æœ‰å¯ç”¨çš„å®¢æˆ·ç«¯ä¸­éšæœºé€‰æ‹©ä¸€å®šæ¯”ä¾‹ï¼Œå¹¶ä¸æ˜¯å®Œå…¨éšæœºçš„ã€‚&lt;/p>
&lt;/blockquote>
&lt;ul>
&lt;li>è¿›åº¦æµªè´¹: è¢«é€‰ä¸­çš„è®¾å¤‡å¦‚æžœåœ¨å®Œæˆæœ¬åœ°è®­ç»ƒä¹‹å‰å¤±è´¥ï¼Œåˆ™ä¹‹å‰çš„å·¥ä½œéƒ½ä¼šä½œåºŸã€‚&lt;/li>
&lt;li>æ¯å›žåˆæ•ˆçŽ‡ä½Ž: åœ¨æ¯è½®ç»“æŸè¿›è¡Œèšåˆï¼ŒFedAvgå¿…é¡»ç­‰å¾…æ‰€æœ‰å®¢æˆ·ç«¯å®Œæˆã€‚å¦‚æžœä¸€äº›å®¢æˆ·ç«¯æ•…éšœï¼Œæ•´ä¸ªè¿‡ç¨‹ä¼šç­‰åˆ°è¶…æ—¶ç»“æŸã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="æ¨¡åž‹-1">æ¨¡åž‹&lt;/h3>
&lt;p>SAFAåŒ…æ‹¬ä¸‰éƒ¨åˆ†: Lag-tolerant Model Distribution (&lt;strong>æ»žåŽå®¹å¿æ¨¡åž‹åˆ†å¸ƒ&lt;/strong>)ï¼ŒCompensatory
First-Come-First-Merge (CFCFM) client selection [&lt;strong>è¡¥å¿æ€§å…ˆåˆ°å…ˆåˆå¹¶ (CFCFM) å®¢æˆ·ç«¯é€‰æ‹©&lt;/strong>],
discriminative aggregation (&lt;strong>åˆ¤åˆ«èšåˆ&lt;/strong>)&lt;/p>
&lt;p>ä¸‹é¢SAFAçš„ä¸€ä¸ªç³»ç»Ÿå›¾:&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/13/R9dHQ6s1tjNDrWp.png" alt="">&lt;/p>
&lt;p>æ–‡ä¸­æ‰€ç”¨çš„å‚æ•°è¡¨&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/13/wXgupKY9TJLVN3Z.png" alt="">&lt;/p>
&lt;h4 id="lag-tolerant-model-distribution">Lag-tolerant Model Distribution&lt;/h4>
&lt;p>æ•´ä¸ªæ¨¡å—å…³é”®çš„æœ‰ä¸¤ç‚¹:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>æœ‰é€‰æ‹©çš„åŒæ­¥å…¨å±€æ¨¡åž‹ã€‚&lt;/p>
&lt;p>ä¸åƒFedAvgç®—æ³•ä¸€æ ·æ¯è½®æ¯ä¸ªå‚ä¸ŽèŠ‚ç‚¹éƒ½è¦åŒæ­¥æ¨¡åž‹ï¼Œè¿™æ˜¯ä¸€ä¸ªäº¤æµå¯†é›†çš„è¿‡ç¨‹ï¼Œå¼€é”€å¾ˆå¤§ã€‚SAFAæ¨¡åž‹åªè¦æ±‚ä¸¤ç§ç±»åž‹å¿…é¡»åŒæ­¥ã€‚&lt;strong>ä¸Šä¸€è½®æˆåŠŸå®Œæˆçš„èŠ‚ç‚¹(FedAvgä¸­çš„æ­£å¸¸èŠ‚ç‚¹)å’Œè¢«æ ‡è®°ä¸ºè¿‡æ—¶çš„èŠ‚ç‚¹&lt;/strong>ï¼Œè¿™ä¸ªè¿‡æ—¶èŠ‚ç‚¹æ˜¯ç”±äºŽç½‘ç»œæˆ–è€…å…¶ä»–åŽŸå› æœ¬åœ°æ¨¡åž‹è½åŽå…¨å±€å¤ªå¤šçš„å®¢æˆ·ç«¯ã€‚è¿™é‡Œæœ‰ä¸ªæ»žåŽå®¹å¿å‚æ•° $\tau$ï¼Œæ¥è°ƒèŠ‚è¿™ä¸ªæ»žåŽèŒƒå›´ã€‚&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/13/HYekTp8LqDa92Ic.png" alt="">&lt;/p>
&lt;p>è¿™é‡Œt-1è¡¨ç¤ºä¸Šä¸€è½®çš„æœ€æ–°æ¨¡åž‹, $\omega _{k}$ä»£è¡¨ç¬¬kä¸ªèŠ‚ç‚¹çš„æœ¬åœ°æ¨¡åž‹ï¼Œ$\omega$ ä»£è¡¨å…¨å±€æ¨¡åž‹ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ $t- \tau$ èŒƒå›´å†…æœ¬åœ°èŠ‚ç‚¹çš„æ»žåŽæ˜¯å¯ä»¥å®¹å¿çš„ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ²¡æœ‰è¢«é€‰ä¸­çš„èŠ‚ç‚¹ä¹Ÿå¯ä»¥å‚ä¸Žè¿­ä»£ã€‚&lt;/p>
&lt;p>æ²¡æœ‰è¢«é€‰ä¸­çš„èŠ‚ç‚¹ä¹Ÿå¯ä»¥ä¸Šä¼ æ›´æ–°ã€‚è¿™éƒ¨åˆ†ä¸ä¼šè¢«ç›´æŽ¥åˆå¹¶ï¼Œè€Œæ˜¯ä¼šé€šè¿‡ä¸€ä¸ªbypassç»“æž„å½±å“ä¸‹ä¸€è½®ã€‚
ä¸€ä¸ªcacheç”¨æ¥ä¿å­˜é‚£äº›é€‰ä¸­çš„èŠ‚ç‚¹ä¸Šä¼ çš„æ›´æ–°ï¼Œæ²¡è¢«é€‰ä¸­çš„èŠ‚ç‚¹çš„æ›´æ–°ä¿å­˜åœ¨bypassä¸­ã€‚bypassä¼šåœ¨æ±‡èšæ­¥éª¤å®ŒæˆåŽå’Œcacheåˆå¹¶,ä½¿å¾—å®žé™…çš„æœ‰å½±å“èŠ‚ç‚¹æ¯”çŽ‡æ¯”å‚æ•°Cå†³å®šçš„æ›´é«˜ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h4 id="compensatory-first-come-first-merge-cfcfm-client-selection">Compensatory First-Come-First-Merge (CFCFM) client selection&lt;/h4>
&lt;p>ä»£æ›¿å¿…é¡»ç­‰å¾…æ‰€æœ‰é€‰ä¸­èŠ‚ç‚¹ä¸Šä¼ æ›´æ–°ï¼ŒSAFAé‡‡ç”¨&lt;strong>å…ˆæ¥å…ˆåˆå¹¶&lt;/strong>æ–¹æ³•ï¼Œåªè¦ä¸Šä¼ çš„æ›´æ–°è¾¾åˆ°æ‰€éœ€è¦çš„æ¯”çŽ‡ï¼ˆæ˜¯ä¸æ˜¯æ„å‘³ç€å¯ä»¥ä¸Šä¼ çš„èŠ‚ç‚¹å¤§äºŽå®žé™…æ‰€éœ€è¦çš„èŠ‚ç‚¹ï¼‰å°±å¯ä»¥æ‰§è¡Œåˆå¹¶æ“ä½œã€‚&lt;/p>
&lt;p>ç»™äºˆé‚£äº›å‚ä¸Žè¾ƒå°‘çš„å®¢æˆ·æ›´é«˜çš„ä¼˜å…ˆçº§ã€‚åœ¨æ¯ä¸€è½®ä¸­ï¼ŒæœåŠ¡å™¨éƒ½ä¼šç»´æŠ¤ä¸€ä¸ªé”™è¿‡ä¸Šä¸€è½®è®­ç»ƒçš„å®¢æˆ·ç«¯çš„ id åˆ—è¡¨ï¼Œå®ƒä»¬ä¸Šä¼ çš„æ›´æ–°ä¼šä¼˜å…ˆé€‰æ‹©ã€‚&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/14/h6bZz4YPaOc87rf.png" alt="">&lt;/p>
&lt;h4 id="discriminative-aggregation">Discriminative Aggregation&lt;/h4>
&lt;p>èšåˆç®—æ³•å¦‚ä¸‹:&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/15/UlZErVnbgSC5KHG.png" alt="">&lt;/p>
&lt;p>å¯¹äºŽé€‰æ‹©çš„å®¢æˆ·ç«¯ï¼Œå®ƒä»¬çš„æ›´æ–°å°†åœ¨åˆå¹¶åˆ°å…¨å±€æ¨¡åž‹åŽä¿ç•™åœ¨ç¼“å­˜ä¸­ã€‚å¯¹äºŽæœªé€‰æ‹©çš„å®¢æˆ·ç«¯ï¼Œæ›´æ–°ä¸ä¼šåœ¨æœ¬è½®ç”Ÿæ•ˆï¼Œä½†ä¼šè¢«ç¼“å­˜å¸¦å…¥ä¸‹ä¸€è½®ã€‚å¯¹äºŽå´©æºƒçš„å®¢æˆ·ç«¯ï¼Œåªæœ‰åœ¨å®ƒä»¬æ²¡æœ‰è¢«å¼ƒç”¨çš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬çš„æ¨¡åž‹æ‰ä¼šä¿æŒä¸å˜ã€‚&lt;/p>
&lt;h4 id="ç®—æ³•æµç¨‹">ç®—æ³•æµç¨‹&lt;/h4>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/15/kxSZgVusbUM29hY.png" alt="">&lt;/p>
&lt;p>æ¯è½®å¼€å§‹æ—¶ï¼ŒæœåŠ¡å™¨å…ˆæ£€æŸ¥å®¢æˆ·ç«¯çš„æ¨¡åž‹ï¼Œæ ¹æ®ç»™å®šçš„è¶…å‚æ•°$\tau$å’Œæ»žåŽå®¹å¿ç®—æ³•æ¥åˆ†é…æ¨¡åž‹ã€‚æœåŠ¡å™¨æ”¶é›†ä¸Šä¼ çš„æ›´æ–°ï¼Œé”™è¿‡ä¸Šæ¬¡æ›´æ–°çš„èŠ‚ç‚¹ä¼šè¢«ä¼˜å…ˆé‡‡é›†ã€‚ç­‰é‡‡é›†åˆ°çš„æ›´æ–°æ»¡è¶³é¢„å…ˆè®¾ç½®çš„æ ‡å‡†åŽï¼Œæ‰§è¡Œä¸‰æ­¥åˆå¹¶ï¼Œç„¶åŽæ›´æ–°ç¼“å­˜çŠ¶æ€ã€‚&lt;/p>
&lt;h2 id="iot-22a-blockchain-based-model-migration-approach-for-secure-and-sustainable-federated-learning-in-iot-systems">IOT â€˜22ã€ŠA Blockchain-based Model Migration Approach for Secure and Sustainable Federated Learning in IoT Systemsã€‹&lt;/h2>
&lt;h3 id="èƒŒæ™¯-2">èƒŒæ™¯&lt;/h3></description></item><item><title>Raftè®ºæ–‡é˜…è¯»</title><link>https://chi-kai.github.io/post/raft%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/</link><pubDate>Sun, 30 Oct 2022 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/raft%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/</guid><description>&lt;h2 id="é¢†å¯¼äººé€‰ä¸¾">é¢†å¯¼äººé€‰ä¸¾&lt;/h2>
&lt;p>é¦–å…ˆæŒ‰ç…§è®ºæ–‡ä¸­æœ€å…³é”®çš„figure 2è¡¥å…¨èŠ‚ç‚¹å’ŒRPCç»“æž„ã€‚&lt;/p>
&lt;p>èŠ‚ç‚¹æœ‰ä¸‰ä¸ªçŠ¶æ€: Leader,Candidate,Follower å’Œ ä¸¤ä¸ªè®¡æ—¶å™¨: é€‰ä¸¾è®¡æ—¶å™¨ï¼Œå¿ƒè·³è®¡æ—¶å™¨ã€‚&lt;/p>
&lt;p>&lt;strong>Follower&lt;/strong>: æœ‰ä¸€ä¸ªé€‰ä¸¾è®¡æ—¶å™¨ï¼Œéšæœºé€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼Œæ¯å½“é€‰ä¸¾è¶…æ—¶ï¼Œå°±è½¬å˜ä¸ºCandidate.&lt;/p>
&lt;p>&lt;strong>Candidate&lt;/strong>: ä¸­é—´æ€ï¼Œå½“Followerä¸€ç«¯æ—¶é—´æ²¡æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œé€‰ä¸¾è®¡æ—¶å™¨åˆ°æœŸï¼Œå°±ä¼šè½¬å˜ä¸ºCandidate,termåŠ 1ï¼Œä¸ºè‡ªå·±æŠ•ç¥¨å¹¶å‘å…¶ä»–èŠ‚ç‚¹å‘é€æŠ•ç¥¨è¯·æ±‚ï¼Œ&lt;/p>
&lt;p>&lt;strong>Leader&lt;/strong>: å½“ä¸€ä¸ªCandidateèŽ·å¾—åŠæ•°ä»¥ä¸Šçš„æŠ•ç¥¨å°±ä¼šè½¬å˜ä¸ºLeader,æœ€é‡è¦çš„èŠ‚ç‚¹ï¼Œè´Ÿè´£å’Œå®¢æˆ·ç«¯äº¤äº’ã€‚éœ€è¦å®šæ—¶å‘æ¯ä¸ªFollowerå‘é€å¿ƒè·³æ¥ç»´æŒæƒå¨ã€‚&lt;/p>
&lt;ol>
&lt;li>èŠ‚ç‚¹ä¸€å¼€å§‹çŠ¶æ€éƒ½æ˜¯Follower,Termä¸º0ã€‚&lt;/li>
&lt;li>å½“ä¸€ä¸ªé€‰ä¸¾è®¡æ—¶å™¨åˆ°æœŸæ—¶ï¼ŒèŠ‚ç‚¹è½¬å˜ä¸ºCandidateï¼ŒtermåŠ 1ï¼Œå¼€å§‹å‘é€æŠ•ç¥¨è¯·æ±‚ã€‚è¿™é‡Œæœ‰ä¸‰ç§æƒ…å†µ:
&lt;ul>
&lt;li>å…¶ä»–èŠ‚ç‚¹æŒ‰ç…§å…ˆæ¥å…ˆåˆ°çš„åŽŸåˆ™æŠ•ç¥¨ï¼ŒèŽ·å¾—åŠæ•°ä»¥ä¸Šçš„æŠ•ç¥¨å¯ä»¥èƒœå‡ºæˆä¸ºLeader.&lt;/li>
&lt;li>åœ¨é€‰ä¸¾è¿‡ç¨‹ä¸­å¾—åˆ°æ›´é«˜termçš„RPCï¼ŒCandidateä¼šè½¬å˜ä¸ºFollower.&lt;/li>
&lt;li>å¦‚æžœä¸¤ä¸ªCandidateèŽ·å¾—åŒæ ·çš„ç¥¨æ•°ï¼Œç­‰é€‰ä¸¾è®¡æ—¶å™¨å†æ¬¡è¶…æ—¶ï¼Œä¼šå¼€å§‹ä¸‹ä¸€è½®æŠ•ç¥¨ã€‚&lt;/li>
&lt;/ul>
&lt;/li>
&lt;li>é€‰å‡ºLeaderåŽï¼ŒLeaderé©¬ä¸Šå¹¿æ’­å¿ƒè·³æ¥ç»´æŒæƒå¨ã€‚&lt;/li>
&lt;/ol>
&lt;p>ä»£ç é‡åˆ°çš„é—®é¢˜:&lt;/p>
&lt;ol>
&lt;li>
&lt;p>é€‰ä¸¾è¶…æ—¶è¦çœŸçš„éšæœºæ—¶é—´ï¼Œæœ‰çš„éšæœºå‡½æ•°è¿”å›žçš„æ˜¯å›ºå®šå€¼ï¼Œè¿™é‡Œç”¨æ—¶é—´åšç§å­ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-golang" data-lang="golang">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">r&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">New&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">rand&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">NewSource&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">time&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Now&lt;/span>&lt;span style="color:#111">().&lt;/span>&lt;span style="color:#75af00">UnixNano&lt;/span>&lt;span style="color:#111">()))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">t&lt;/span> &lt;span style="color:#f92672">:=&lt;/span> &lt;span style="color:#75af00">time&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Duration&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">ElectionTime&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#75af00">r&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Intn&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">ElectionTime&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#75af00">time&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Millisecond&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>ç”±äºŽç½‘ç»œåŽŸå› ï¼Œå¯èƒ½ä¸€äº›èŠ‚ç‚¹çš„å›žå¤ä¸èƒ½åŠæ—¶æ”¶åˆ°ã€‚å½“æ”¶åˆ°ä¸€ä¸ªè¶…æœŸçš„å›žå¤æ—¶ï¼Œå¤„ç†åŠžæ³•å°±æ˜¯æŠ›å¼ƒã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// å¦‚æžœå›žå¤æ™šäº†ï¼Œä¸æ˜¯åŒä¸€ä¸ªtermæˆ–è€…leaderåˆ™æŠ›å¼ƒ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// å¤„ç†å¿ƒè·³å›žå¤
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#75af00">rf&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">currentTerm&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#75af00">args&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Term&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#75af00">rf&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">state&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#75af00">StateLeader&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// åœ¨æœ¬Termå†…çš„æŠ•ç¥¨ä¸”stateä»ä¸ºCandidateï¼Œè¶…æ—¶è¿‡æœŸçš„ä¸¢å¼ƒ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// å¤„ç†æŠ•ç¥¨å›žå¤
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#75af00">rf&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">state&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#75af00">StateCandidate&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#75af00">rf&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">currentTerm&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#75af00">args&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Term&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>å½“æ”¶åˆ°ä¸€ä¸ªæ›´é«˜termçš„å›žå¤RPC,Candidateè½¬å˜ä¸ºFollowerï¼Œtermå˜ä¸ºæ›´é«˜çš„term,æŠ•ç¥¨å˜ä¸ºnullã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å½“æ”¶åˆ°ä¸€ä¸ªæ›´é«˜çš„termçš„å¿ƒè·³æ—¶ï¼ŒçŠ¶æ€è½¬å˜ä¸ºFollower,termå˜ä¸ºæ›´é«˜çš„term,æŠ•ç¥¨å˜ä¸ºnullã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>èŠ‚ç‚¹åœ¨ä¸¤ç§æƒ…å†µæ‹’ç»æŠ•ç¥¨ï¼Œä¸€æ˜¯Candidateçš„termå°äºŽè‡ªå·±ï¼ŒäºŒæ˜¯è‡ªå·±åœ¨æœ¬termä¸­å·²ç»æŠ•è¿‡ç¥¨ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-golang" data-lang="golang">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#75af00">rf&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">currentTerm&lt;/span> &lt;span style="color:#111">&amp;gt;&lt;/span> &lt;span style="color:#75af00">args&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Term&lt;/span> &lt;span style="color:#f92672">||&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">rf&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">currentTerm&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#75af00">args&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">Term&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#75af00">rf&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">votedFor&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#75af00">rf&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">votedFor&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#75af00">args&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#75af00">CandidateId&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>é”çš„ä½¿ç”¨: å½“ä¸€ä¸ªæ•°æ®æœ‰å†™æœ‰è¯»ï¼Œå†™å’Œè¯»å¿…é¡»åŠ é”ã€‚å¦‚æžœä¸€ä¸ªæ•°æ®åªè¯»ä¸å†™ï¼Œä¸ç”¨åŠ é”ã€‚&lt;/p>
&lt;/li>
&lt;/ol>
&lt;h2 id="æ—¥å¿—å¤åˆ¶">æ—¥å¿—å¤åˆ¶&lt;/h2>
&lt;p>å½“é€‰ä¸¾ç»“æŸåŽï¼Œleaderå¼€å§‹ä¸ºå®¢æˆ·ç«¯æä¾›æœåŠ¡ã€‚å®¢æˆ·ç«¯å‘å‡ºçš„æ¯ä¸€æ¡è¯·æ±‚ä¼šè¢«äº¤ç»™leaderå¤„ç†ã€‚&lt;/p>
&lt;p>leaderå°†æ¯ä¸€æ¡æŒ‡ä»¤æ‰“åŒ…æˆä¸€ä¸ªentry &amp;lt;index,term,cmd&amp;gt;,å°†è¿™ä¸ªentryé™„åŠ åˆ°æ—¥å¿—ä¸­åŽ»ï¼Œç„¶åŽå¹¶è¡Œåœ°å‘èµ· AppendEntries RPCs ç»™å…¶ä»–çš„æœåŠ¡å™¨ï¼Œè®©ä»–ä»¬å¤åˆ¶è¿™æ¡entryã€‚&lt;/p>
&lt;p>å½“å¤§éƒ¨åˆ†æœåŠ¡å™¨åŒæ„æŽ¥æ”¶è¿™ä¸ªentry,leaderå°†è¿™ä¸ªentryåº”ç”¨äºŽçŠ¶æ€æœºä¸­ï¼Œç§°ä¸ºå·²æäº¤ï¼ŒåŒæ—¶é¢†å¯¼äººçš„æ—¥å¿—ä¸­ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¹Ÿéƒ½ä¼šè¢«æäº¤ï¼ŒåŒ…æ‹¬ç”±å…¶ä»–é¢†å¯¼äººåˆ›å»ºçš„æ¡ç›®ã€‚ç„¶åŽå°†æ‰§è¡Œç»“æžœè¿”å›žç»™å®¢æˆ·ç«¯ã€‚&lt;/p>
&lt;p>ä¸ºäº†ç»´æŠ¤æ—¥å¿—çš„ä¸€è‡´æ€§ï¼Œè¦ä¿è¯æ—¥å¿—åŒ¹é…ç‰¹æ€§:&lt;/p>
&lt;ul>
&lt;li>å¦‚æžœåœ¨ä¸åŒçš„æ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ¡ç›®æ‹¥æœ‰ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå·ï¼Œé‚£ä¹ˆä»–ä»¬å­˜å‚¨äº†ç›¸åŒçš„æŒ‡ä»¤ã€‚&lt;/li>
&lt;li>å¦‚æžœåœ¨ä¸åŒçš„æ—¥å¿—ä¸­çš„ä¸¤ä¸ªæ¡ç›®æ‹¥æœ‰ç›¸åŒçš„ç´¢å¼•å’Œä»»æœŸå·ï¼Œé‚£ä¹ˆä»–ä»¬ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—æ¡ç›®ä¹Ÿå…¨éƒ¨ç›¸åŒã€‚&lt;/li>
&lt;/ul>
&lt;p>ç¬¬ä¸€ä¸ªç‰¹æ€§ç”± â€œåªæœ‰ä¸€ä¸ªleaderå¯ä»¥åˆ›å»ºentryâ€ æ¥ä¿è¯ã€‚&lt;/p>
&lt;p>ç¬¬äºŒä¸ªç‰¹æ€§ç”±é™„åŠ æ—¥å¿— RPC çš„ä¸€ä¸ªç®€å•çš„ä¸€è‡´æ€§æ£€æŸ¥æ‰€ä¿è¯ã€‚å®ƒçš„æ­¥éª¤å¦‚ä¸‹:&lt;/p>
&lt;p>**åœ¨å‘é€é™„åŠ æ—¥å¿— RPC çš„æ—¶å€™ï¼Œä¼šå¸¦ä¸Šä¸Šä¸€æ¡entryä¿¡æ¯ã€‚**å¦‚æžœè·Ÿéšè€…åœ¨å®ƒçš„æ—¥å¿—ä¸­æ‰¾ä¸åˆ°åŒ…å«ç›¸åŒindexå’Œtermçš„æ¡ç›®ï¼Œé‚£ä¹ˆä»–å°±ä¼šæ‹’ç»æŽ¥æ”¶æ–°çš„æ—¥å¿—æ¡ç›®ã€‚&lt;/p>
&lt;p>&lt;strong>æ‰¾åˆ°æœ€å¤§å…±è¯†ç‚¹ã€‚&lt;/strong> åœ¨è¢«è·Ÿéšè€…æ‹’ç»ä¹‹åŽï¼Œleaderå°±ä¼šå‡å° nextIndex å€¼å¹¶è¿›è¡Œé‡è¯•(å‘é€å†ä¸Šä¸€ä¸ªentry),ç›´åˆ°æ‰¾åˆ°æœ€å¤§å…±è¯†ç‚¹ï¼Œè¢«followeræŽ¥æ”¶ã€‚ä¹‹åŽï¼Œleaderä¼šå¼ºåˆ¶è¦†ç›–followeræœ€å¤§å…±è¯†ç‚¹åŽé¢æ‰€æœ‰æ—¥å¿—ã€‚è¿™æ ·å°±ä¿è¯followerä¸Žleaderæ—¥å¿—å§‹ç»ˆä¸€è‡´ã€‚&lt;/p>
&lt;blockquote>
&lt;p>leaderä¸ºæ‰€æœ‰followerèŠ‚ç‚¹ç»´æŒä¸€ä¸ªnextIndexï¼Œè®°å½•æ¯ä¸ªfollowerä¸‹ä¸€ä¸ªæ—¥å¿—çš„indexã€‚å½“ä¸€ä¸ªleaderåˆšåˆšå½“é€‰çš„æ—¶å€™ï¼Œåˆå§‹åŒ–æ‰€æœ‰nextIndexä¸ºè‡ªå·±æœ€åŽä¸€æ¡æ—¥å¿—çš„IndexåŠ 1ã€‚ï¼ˆå‡è®¾æ‰€æœ‰followerä¸Žleaderæ—¥å¿—ä¿æŒä¸€è‡´ï¼‰ã€‚&lt;/p>
&lt;/blockquote>
&lt;blockquote>
&lt;p>æ—¥å¿—å¤åˆ¶å¯ä»¥åšä¸€äº›ä¼˜åŒ–ã€‚æ¯”å¦‚åœ¨æ­£å¸¸å¤åˆ¶æ—¶å¯ä»¥æ‰¹é‡å¤åˆ¶æ—¥å¿—ä»¥å‡å°‘ç³»ç»Ÿè°ƒç”¨çš„å¼€é”€ï¼›åœ¨å¯»æ‰¾å…±è¯†ç‚¹æ—¶å¯ä»¥åªæºå¸¦ä¸€æ¡æ—¥å¿—ä»¥å‡å°‘ä¸å¿…è¦çš„æµé‡ä¼ è¾“ã€‚&lt;/p>
&lt;/blockquote>
&lt;h2 id="å®‰å…¨æ€§">å®‰å…¨æ€§&lt;/h2>
&lt;h3 id="é€‰ä¸¾é™åˆ¶">é€‰ä¸¾é™åˆ¶&lt;/h3>
&lt;p>leader åªèƒ½å‘é€æ—¥å¿—ç»™followerï¼Œè€Œä¸èƒ½ä»ŽfolloweræŽ¥æ”¶æ—¥å¿—ï¼Œæ‰€ä»¥é€‰å‡ºçš„leaderå¿…é¡»åŒ…å«é›†ç¾¤ä¸­æ‰€æœ‰å·²ç»æäº¤çš„æ—¥å¿—ã€‚&lt;/p>
&lt;p>åœ¨é€‰ä¸¾æŠ•ç¥¨æ—¶ï¼Œæºå¸¦æœ€æ–°çš„æ—¥å¿—ä¿¡æ¯ï¼Œå’Œfollowerç›¸æ¯”è¾ƒï¼Œçœ‹è°çš„æ—¥å¿—æœ€æ–°ã€‚å¦‚æžœå€™é€‰äººæ›´æ–°ï¼Œåˆ™èŽ·å¾—æŠ•ç¥¨ã€‚&lt;/p>
&lt;blockquote>
&lt;p>è¿™é‡Œæ›´æ–°çš„å®šä¹‰æ˜¯: é€šè¿‡æ¯”è¾ƒä¸¤ä»½æ—¥å¿—ä¸­æœ€åŽä¸€æ¡æ—¥å¿—æ¡ç›®çš„ç´¢å¼•å€¼å’Œä»»æœŸå·å®šä¹‰è°çš„æ—¥å¿—æ¯”è¾ƒæ–°ã€‚å¦‚æžœä¸¤ä»½æ—¥å¿—æœ€åŽçš„æ¡ç›®çš„ä»»æœŸå·ä¸åŒï¼Œé‚£ä¹ˆä»»æœŸå·å¤§çš„æ—¥å¿—æ›´åŠ æ–°ã€‚å¦‚æžœä¸¤ä»½æ—¥å¿—æœ€åŽçš„æ¡ç›®ä»»æœŸå·ç›¸åŒï¼Œé‚£ä¹ˆæ—¥å¿—æ¯”è¾ƒé•¿çš„é‚£ä¸ªå°±æ›´åŠ æ–°ã€‚&lt;/p>
&lt;/blockquote>
&lt;h3 id="æäº¤ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®">æäº¤ä¹‹å‰ä»»æœŸå†…çš„æ—¥å¿—æ¡ç›®&lt;/h3>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h7oklyiaigj30ue0vaww7.jpg" alt="å¹½çµå¤çŽ°">&lt;/p>
&lt;p>åœ¨ä¸Šå›¾ä¸­ï¼Œraft ä¸ºäº†é¿å…å‡ºçŽ°ä¸€è‡´æ€§é—®é¢˜ï¼Œè¦æ±‚ leader ç»ä¸ä¼šæäº¤è¿‡åŽ»çš„ term çš„ entry ï¼ˆå³ä½¿è¯¥ entry å·²ç»è¢«å¤åˆ¶åˆ°äº†å¤šæ•°èŠ‚ç‚¹ä¸Šï¼‰ã€‚leader æ°¸è¿œåªæäº¤å½“å‰ term çš„ entryï¼Œè¿‡åŽ»çš„ entry åªä¼šéšç€å½“å‰çš„ entry è¢«ä¸€å¹¶æäº¤ã€‚ï¼ˆä¸Šå›¾ä¸­çš„ cï¼Œterm2 åªä¼šè·Ÿéš term4 è¢«æäº¤ã€‚ï¼‰&lt;/p>
&lt;p>å¦‚æžœä¸€ä¸ª candidate èƒ½å–å¾—å¤šæ•°åŒæ„ï¼Œè¯´æ˜Žå®ƒçš„æ—¥å¿—å·²ç»æ˜¯å¤šæ•°èŠ‚ç‚¹ä¸­æœ€å®Œå¤‡çš„ï¼Œ é‚£ä¹ˆä¹Ÿå°±å¯ä»¥è®¤ä¸ºè¯¥ candidate å·²ç»åŒ…å«äº†æ•´ä¸ªé›†ç¾¤çš„æ‰€æœ‰ committed entriesã€‚&lt;/p>
&lt;p>å› æ­¤ leader å½“é€‰åŽï¼Œåº”å½“ç«‹åˆ»å‘èµ· AppendEntriesRPC æäº¤ä¸€ä¸ª no-op entryã€‚æ³¨æ„ï¼Œè¿™æ˜¯ä¸€ä¸ª Mustï¼Œä¸æ˜¯ä¸€ä¸ª Shouldï¼Œå¦åˆ™ä¼šæœ‰è®¸å¤š corner case å­˜åœ¨é—®é¢˜ã€‚å¦‚:&lt;/p>
&lt;ul>
&lt;li>
&lt;p>è¯»è¯·æ±‚ï¼šleader æ­¤æ—¶çš„çŠ¶æ€æœºå¯èƒ½å¹¶ä¸æ˜¯æœ€æ–°çš„ï¼Œè‹¥æœåŠ¡è¯»è¯·æ±‚å¯èƒ½ä¼šè¿åçº¿æ€§ä¸€è‡´æ€§ï¼Œå³å‡ºçŽ° safety çš„é—®é¢˜ï¼›è‹¥ä¸æœåŠ¡è¯»è¯·æ±‚åˆ™å¯èƒ½ä¼šæœ‰ liveness çš„é—®é¢˜ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é…ç½®å˜æ›´ï¼šå¯èƒ½ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å®žé™…ä¸Šï¼Œleader å½“é€‰åŽæäº¤ä¸€ä¸ª no-op entry æ—¥å¿—çš„åšæ³•å°±æ˜¯Raft ç®—æ³•è§£å†³ â€œå¹½çµå¤çŽ°â€ é—®é¢˜çš„è§£æ³•ï¼Œ&lt;a href="https://mp.weixin.qq.com/s/jzx05Q781ytMXrZ2wrm2Vg">ç›¸å…³åšå®¢&lt;/a>&lt;/p></description></item><item><title>è”é‚¦å­¦ä¹ ç»¼è¿°</title><link>https://chi-kai.github.io/post/%E8%81%94%E9%82%A6%E5%AD%A6%E4%B9%A0%E7%BB%BC%E8%BF%B0/</link><pubDate>Mon, 17 Oct 2022 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/%E8%81%94%E9%82%A6%E5%AD%A6%E4%B9%A0%E7%BB%BC%E8%BF%B0/</guid><description>&lt;h2 id="ä»€ä¹ˆæ˜¯è”é‚¦å­¦ä¹ ">ä»€ä¹ˆæ˜¯è”é‚¦å­¦ä¹ &lt;/h2>
&lt;p>æœ¬è´¨ï¼šè”é‚¦å­¦ä¹ æœ¬è´¨ä¸Šæ˜¯ä¸€ç§åˆ†å¸ƒå¼æœºå™¨å­¦ä¹ æŠ€æœ¯ï¼Œæˆ–æœºå™¨å­¦ä¹ æ¡†æž¶ã€‚&lt;/p>
&lt;p>ç›®æ ‡ï¼šè”é‚¦å­¦ä¹ çš„ç›®æ ‡æ˜¯åœ¨ä¿è¯æ•°æ®éšç§å®‰å…¨åŠåˆæ³•åˆè§„çš„åŸºç¡€ä¸Šï¼Œå®žçŽ°å…±åŒå»ºæ¨¡ï¼Œæå‡AIæ¨¡åž‹çš„æ•ˆæžœã€‚&lt;/p>
&lt;h2 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†:&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>IIDï¼š&lt;strong>ç‹¬ç«‹åŒåˆ†å¸ƒï¼Œè¡¨ç¤ºä¸€ç»„éšæœºå˜é‡çš„æ¦‚çŽ‡åˆ†å¸ƒéƒ½ç›¸åŒï¼Œè€Œä¸”ç›¸äº’ç‹¬ç«‹ã€‚ä¾‹å¦‚æŽ·è‰²å­ã€‚è”é‚¦å­¦ä¹ èƒŒæ™¯ä¸‹ï¼Œæ•°æ®é›†æ˜¯éžç‹¬ç«‹åŒåˆ†å¸ƒçš„ã€‚&lt;/strong>&lt;/p>
&lt;/li>
&lt;li>
&lt;p>SGD: æ¢¯åº¦ä¸‹é™ç®—æ³•&lt;/p>
&lt;ul>
&lt;li>
&lt;p>ç»å¤§å¤šæ•°æœºå™¨å­¦ä¹ æ¨¡åž‹éƒ½æœ‰ä¸€ä¸ªæŸå¤±å‡½æ•°ï¼Œæ¥è¡¡é‡é¢„æµ‹å€¼ä¸Žå®žé™…å€¼çš„å·®å¼‚ã€‚æŸå¤±å‡½æ•°çš„å€¼è¶Šå°ï¼Œæ¨¡åž‹çš„ç²¾ç¡®åº¦å°±è¶Šé«˜ã€‚é€šè¿‡ä½¿ç”¨æ¢¯åº¦ä¸‹é™æ¥è°ƒèŠ‚å‚æ•°ï¼Œè¿›è€Œæœ€å°åŒ–æŸå¤±å‡½æ•°ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æŸå¤±å‡½æ•°é‡Œä¸€èˆ¬æœ‰ä¸¤ç§å‚æ•°ï¼Œä¸€ç§æ˜¯æŽ§åˆ¶è¾“å…¥ä¿¡å·é‡çš„æƒé‡(Weight, ç®€ç§°Â wÂ ï¼‰ï¼Œå¦ä¸€ç§æ˜¯è°ƒæ•´å‡½æ•°ä¸ŽçœŸå®žå€¼è·ç¦»çš„åå·®ï¼ˆBiasï¼Œç®€ç§°Â bÂ ï¼‰ã€‚æˆ‘ä»¬æ‰€è¦åšçš„å·¥ä½œï¼Œå°±æ˜¯é€šè¿‡æ¢¯åº¦ä¸‹é™æ–¹æ³•ï¼Œä¸æ–­åœ°è°ƒæ•´æƒé‡Â wÂ å’Œåå·®bï¼Œä½¿å¾—æŸå¤±å‡½æ•°çš„å€¼å˜å¾—è¶Šæ¥è¶Šå°ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>é€šè¿‡è®¡ç®—æ¢¯åº¦å¯ä»¥æ‰¾åˆ°ä¸‹é™çš„æ–¹å‘ï¼Œç„¶åŽé€šè¿‡å­¦ä¹ çŽ‡aæ¥æŽ§åˆ¶ä¸‹é™çš„å¿«æ…¢ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-fallback" data-lang="fallback">&lt;span style="display:flex;">&lt;span>def train(X, y, W, B, alpha, max_iters):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â &amp;#39;â€˜â€™
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â é€‰å–æ‰€æœ‰çš„æ•°æ®ä½œä¸ºè®­ç»ƒæ ·æœ¬æ¥æ‰§è¡Œæ¢¯åº¦ä¸‹é™
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â X : è®­ç»ƒæ•°æ®é›†
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â y : è®­ç»ƒæ•°æ®é›†æ‰€å¯¹åº”çš„ç›®æ ‡å€¼
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â W : æƒé‡å‘é‡
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â B ï¼š åå·®å˜é‡
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â alpha ï¼š å­¦ä¹ é€ŸçŽ‡
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â max_iters : æ¢¯åº¦ä¸‹é™è¿‡ç¨‹æœ€å¤§çš„è¿­ä»£æ¬¡æ•°
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  &amp;#39;&amp;#39;&amp;#39;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  dW = 0 # åˆå§‹åŒ–æƒé‡å‘é‡çš„æ¢¯åº¦ç´¯åŠ å™¨
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  dB = 0 # åˆå§‹åŒ–åå·®å‘é‡çš„æ¢¯åº¦ç´¯åŠ å™¨
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  m = X.shape[0] # è®­ç»ƒæ•°æ®çš„æ•°é‡
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  # å¼€å§‹æ¢¯åº¦ä¸‹é™çš„è¿­ä»£
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  for i in range(max_iters):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â  Â  dW = 0 # é‡æ–°è®¾ç½®æƒé‡å‘é‡çš„æ¢¯åº¦ç´¯åŠ å™¨
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â  Â  dB = 0 # é‡æ–°è®¾ç½®åå·®å‘é‡çš„æ¢¯åº¦ç´¯åŠ å™¨
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â  Â 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â  Â  # å¯¹æ‰€æœ‰çš„è®­ç»ƒæ•°æ®è¿›è¡ŒéåŽ†
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â  Â  for j in range(m):
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â  Â  Â  Â  # 1. éåŽ†æ‰€æœ‰çš„è®­ç»ƒæ•°æ®
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â  Â  Â  Â  # 2. è®¡ç®—æ¯ä¸ªè®­ç»ƒæ•°æ®çš„æƒé‡å‘é‡æ¢¯åº¦w_gradå’Œåå·®å‘é‡æ¢¯åº¦b_grad
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â  Â  Â  Â  # 3. æŠŠw_gradå’Œb_gradçš„å€¼åˆ†åˆ«ç´¯åŠ åˆ°dWå’ŒdBä¸¤ä¸ªç´¯åŠ å™¨é‡Œ
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â  Â 
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â  Â  W = W - alpha * (dW / m) # æ›´æ–°æƒé‡çš„å€¼
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â  Â  B = B - alpha * (dB / m) # æ›´æ–°åå·®çš„å€¼
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Â  Â return W, B # è¿”å›žæ›´æ–°åŽçš„æƒé‡å’Œåå·®ã€‚
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ul>
&lt;h2 id="ä¼˜åŒ–è¿‡ç¨‹">ä¼˜åŒ–è¿‡ç¨‹&lt;/h2>
&lt;ul>
&lt;li>
&lt;p>å›ºå®šæ€»æ•°Â KÂ ä¸ªå®¢æˆ·ç«¯ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯éƒ½æœ‰æœ¬åœ°æ•°æ®é›†ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¯æ¬¡é€‰å–åˆ†æ•°Â CÂ ï¼ˆæ¯”ä¾‹ï¼‰ä¸ªå®¢æˆ·ç«¯&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æœåŠ¡å™¨å°†å½“å‰çš„å…¨å±€ç®—æ³•å‘é€ç»™æ¯ä¸ªå®¢æˆ·ç«¯ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>æ¯ä¸ªè¢«é€‰å®šçš„å®¢æˆ·ç«¯æ‰§è¡Œæœ¬åœ°è®¡ç®—ï¼Œå¹¶å°†æœåŠ¡å™¨æ›´æ–°ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="é€šä¿¡æˆæœ¬å ä¸»å¯¼">é€šä¿¡æˆæœ¬å ä¸»å¯¼&lt;/h2>
&lt;p>ä¸€èˆ¬æ•°æ®ä¸­å¿ƒä¸­ï¼Œé€šè®¯èŠ±è´¹å å°‘æ•°ï¼Œè®¡ç®—èŠ±è´¹å å¤§å¤´ã€‚ä½†æ˜¯åœ¨è”é‚¦ä¼˜åŒ–ä¸­ï¼Œé€šè®¯å ä¸»å¯¼åœ°ä½&lt;/p>
&lt;ul>
&lt;li>
&lt;p>é€šå¸¸ä¸Šä¼ å¸¦å®½è¢«é™åˆ¶åˆ°1MBæˆ–è€…æ›´ä½Žã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>å®¢æˆ·ç«¯åªæœ‰åœ¨&lt;strong>å……ç”µï¼Œæ’å…¥ç”µæºï¼Œå’Œæœ‰ä¸é™é‡WIFI&lt;/strong>çš„æƒ…å†µä¸‹æ‰ä¼šå‚ä¸Žåˆ°ä¼˜åŒ–è¿‡ç¨‹ä¸­æ¥ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>å¸Œæœ›æ¯ä¸ªå®¢æˆ·æ¯å¤©åªå‚åŠ å°‘é‡çš„æ›´æ–°å›žåˆ&lt;/strong>ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;p>å› ä¸ºå•ä¸ªå®¢æˆ·ç«¯çš„è®­ç»ƒæ•°æ®å¾ˆå°ï¼Œè€Œä¸”å½“å‰æ™ºèƒ½æ‰‹æœºç­‰å®¢æˆ·ç«¯çš„è®¡ç®—èƒ½åŠ›æ˜¯è¶³å¤Ÿå¼ºçš„ï¼Œæ‰€ä»¥&lt;strong>é€šè¿‡ä½¿ç”¨é¢å¤–çš„è®¡ç®—é‡æ¥å‡å°‘é€šä¿¡çš„æ¬¡æ•°&lt;/strong>&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>å¢žåŠ å¹¶è¡Œé‡&lt;/strong>ã€‚åœ¨æ¯æ¬¡é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨æ›´å¤šå®¢æˆ·ç«¯æ¥æ›´æ–°ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>&lt;strong>å¢žåŠ æ¯ä¸ªå®¢æˆ·ç«¯çš„è®¡ç®—é‡&lt;/strong>ã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h2 id="è”é‚¦å¹³å‡ç®—æ³•">è”é‚¦å¹³å‡ç®—æ³•&lt;/h2>
&lt;p>è”é‚¦èƒŒæ™¯ä¸‹ï¼Œå¯¹æ¢¯åº¦ä¸‹é™ç®—æ³•çš„æ‰©å±•ã€‚&lt;/p>
&lt;p>é€‰å–Kä¸ªClientï¼ŒServerå°†å½“å‰çš„å‚æ•°ä¼ é€’ç»™Client,Clientæ ¹æ®æœ¬åœ°æ•°æ®é›†å’Œå‚æ•°æ¥è¿›è¡Œæ¢¯åº¦ä¸‹é™ã€‚&lt;/p>
&lt;p>æœ€åŽå°†è®­ç»ƒåŽçš„å‚æ•°è¿”å›žç»™Server,Serverå°†èŽ·å¾—çš„æ‰€æœ‰å‚æ•°åŠ æƒå¤„ç†åŽå¾—åˆ°æœ€ç»ˆçš„å‚æ•°ã€‚ç„¶åŽå†è¿›è¡Œä¸‹ä¸€è½®è®¡ç®—ã€‚&lt;/p>
&lt;p>&lt;img src="http://tva1.sinaimg.cn/large/008upJWily1h7of7bwegjj30re0p00ym.jpg" alt="fedsvg.png">&lt;/p>
&lt;p>å¦‚å›¾æ‰€ç¤ºï¼Œå½“B $\rightarrow$ $\infty$ï¼ŒE $\rightarrow$ 1 Â è¡¨ç¤ºæœ¬åœ°æ•°æ®å…¨éƒ¨å‚ä¸Žè®­ç»ƒï¼Œåªè®­ç»ƒä¸€æ¬¡ï¼Œç§°ä¸ºFedSGDã€‚&lt;/p>
&lt;h2 id="åˆ†ç±»">åˆ†ç±»&lt;/h2>
&lt;p>æˆ‘ä»¬æŠŠæ¯ä¸ªå‚ä¸Žå…±åŒå»ºæ¨¡çš„ä¼ä¸šç§°ä¸ºå‚ä¸Žæ–¹ï¼Œæ ¹æ®å¤šå‚ä¸Žæ–¹ä¹‹é—´æ•°æ®åˆ†å¸ƒçš„ä¸åŒï¼ŒæŠŠè”é‚¦å­¦ä¹ åˆ†ä¸ºä¸‰ç±»ï¼šæ¨ªå‘è”é‚¦å­¦ä¹ ã€çºµå‘è”é‚¦å­¦ä¹ å’Œè”é‚¦è¿ç§»å­¦ä¹ ã€‚&lt;/p>
&lt;h3 id="æ¨ªå‘è”é‚¦å­¦ä¹ ">æ¨ªå‘è”é‚¦å­¦ä¹ &lt;/h3>
&lt;p>æ¨ªå‘è”é‚¦å­¦ä¹ çš„æœ¬è´¨æ˜¯ &lt;strong>æ ·æœ¬çš„è”åˆ&lt;/strong>ï¼Œé€‚ç”¨äºŽå‚ä¸Žè€…é—´ä¸šæ€ç›¸åŒä½†è§¦è¾¾å®¢æˆ·ä¸åŒï¼Œå³ç‰¹å¾é‡å å¤šï¼Œç”¨æˆ·é‡å å°‘æ—¶çš„åœºæ™¯ï¼Œæ¯”å¦‚ä¸åŒåœ°åŒºçš„é“¶è¡Œé—´ï¼Œä»–ä»¬çš„ä¸šåŠ¡ç›¸ä¼¼ï¼ˆç‰¹å¾ç›¸ä¼¼ï¼‰ï¼Œä½†ç”¨æˆ·ä¸åŒï¼ˆæ ·æœ¬ä¸åŒï¼‰&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/29/DbjBYyxuRgdhQrF.png" alt="">&lt;/p>
&lt;h4 id="å­¦ä¹ è¿‡ç¨‹">å­¦ä¹ è¿‡ç¨‹:&lt;/h4>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/29/Myue2zbxD9JIs1Z.png" alt="">&lt;/p>
&lt;ul>
&lt;li>å‚ä¸Žæ–¹å„è‡ªä»ŽæœåŠ¡å™¨Aä¸‹è½½æœ€æ–°æ¨¡åž‹&lt;/li>
&lt;li>æ¯ä¸ªå‚ä¸Žæ–¹åˆ©ç”¨æœ¬åœ°æ•°æ®è®­ç»ƒæ¨¡åž‹ï¼ŒåŠ å¯†æ¢¯åº¦ä¸Šä¼ ç»™æœåŠ¡å™¨Aï¼ŒæœåŠ¡å™¨Aèšåˆå„ç”¨æˆ·çš„æ¢¯åº¦æ›´æ–°æ¨¡åž‹å‚æ•°ï¼›&lt;/li>
&lt;li>æœåŠ¡å™¨Aè¿”å›žæ›´æ–°åŽçš„æ¨¡åž‹ç»™å„å‚ä¸Žæ–¹ï¼›&lt;/li>
&lt;li>å„å‚ä¸Žæ–¹æ›´æ–°å„è‡ªæ¨¡åž‹ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="çºµå‘è”é‚¦å­¦ä¹ ">çºµå‘è”é‚¦å­¦ä¹ &lt;/h3>
&lt;p>çºµå‘è”é‚¦å­¦ä¹ çš„æœ¬è´¨æ˜¯ &lt;strong>ç‰¹å¾çš„è”åˆ&lt;/strong>ï¼Œé€‚ç”¨äºŽç”¨æˆ·é‡å å¤šï¼Œç‰¹å¾é‡å å°‘çš„åœºæ™¯ï¼Œæ¯”å¦‚åŒä¸€åœ°åŒºçš„å•†è¶…å’Œé“¶è¡Œï¼Œä»–ä»¬è§¦è¾¾çš„ç”¨æˆ·éƒ½ä¸ºè¯¥åœ°åŒºçš„å±…æ°‘ï¼ˆæ ·æœ¬ç›¸åŒï¼‰ï¼Œä½†ä¸šåŠ¡ä¸åŒï¼ˆç‰¹å¾ä¸åŒï¼‰ã€‚&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/29/9RFpChvgXyAMSBY.png" alt="">&lt;/p>
&lt;h4 id="å­¦ä¹ è¿‡ç¨‹-1">å­¦ä¹ è¿‡ç¨‹&lt;/h4>
&lt;p>çºµå‘è”é‚¦å­¦ä¹ çš„æœ¬è´¨æ˜¯äº¤å‰ç”¨æˆ·åœ¨ä¸åŒä¸šæ€ä¸‹çš„ç‰¹å¾è”åˆï¼Œæ¯”å¦‚å•†è¶…Aå’Œé“¶è¡ŒBï¼Œåœ¨ä¼ ç»Ÿçš„æœºå™¨å­¦ä¹ å»ºæ¨¡è¿‡ç¨‹ä¸­ï¼Œéœ€è¦å°†ä¸¤éƒ¨åˆ†æ•°æ®é›†ä¸­åˆ°ä¸€ä¸ªæ•°æ®ä¸­å¿ƒï¼Œç„¶åŽå†å°†æ¯ä¸ªç”¨æˆ·çš„ç‰¹å¾joinæˆä¸€æ¡æ•°æ®ç”¨æ¥è®­ç»ƒæ¨¡åž‹ï¼Œæ‰€ä»¥å°±éœ€è¦åŒæ–¹æœ‰ç”¨æˆ·äº¤é›†ï¼ˆåŸºäºŽjoinç»“æžœå»ºæ¨¡ï¼‰ï¼Œå¹¶æœ‰ä¸€æ–¹å­˜åœ¨labelã€‚å…¶å­¦ä¹ æ­¥éª¤å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œåˆ†ä¸ºä¸¤å¤§æ­¥ï¼š&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/29/tOUj1Jx6MyslKL7.png" alt="">&lt;/p>
&lt;p>ç¬¬ä¸€æ­¥ï¼šåŠ å¯†æ ·æœ¬å¯¹é½ã€‚æ˜¯åœ¨ç³»ç»Ÿçº§åšè¿™ä»¶äº‹ï¼Œå› æ­¤åœ¨ä¼ä¸šæ„ŸçŸ¥å±‚é¢ä¸ä¼šæš´éœ²éžäº¤å‰ç”¨æˆ·ã€‚&lt;/p>
&lt;p>ç¬¬äºŒæ­¥ï¼šå¯¹é½æ ·æœ¬è¿›è¡Œæ¨¡åž‹åŠ å¯†è®­ç»ƒï¼š&lt;/p>
&lt;ul>
&lt;li>ç”±ç¬¬ä¸‰æ–¹Cå‘Aå’ŒBå‘é€å…¬é’¥ï¼Œç”¨æ¥åŠ å¯†éœ€è¦ä¼ è¾“çš„æ•°æ®ï¼›&lt;/li>
&lt;li>Aå’ŒBåˆ†åˆ«è®¡ç®—å’Œè‡ªå·±ç›¸å…³çš„ç‰¹å¾ä¸­é—´ç»“æžœï¼Œå¹¶åŠ å¯†äº¤äº’ï¼Œç”¨æ¥æ±‚å¾—å„è‡ªæ¢¯åº¦å’ŒæŸå¤±ï¼›&lt;/li>
&lt;li>Aå’ŒBåˆ†åˆ«è®¡ç®—å„è‡ªåŠ å¯†åŽçš„æ¢¯åº¦å¹¶æ·»åŠ æŽ©ç å‘é€ç»™Cï¼ŒåŒæ—¶Bè®¡ç®—åŠ å¯†åŽçš„æŸå¤±å‘é€ç»™Cï¼›&lt;/li>
&lt;li>Cè§£å¯†æ¢¯åº¦å’ŒæŸå¤±åŽå›žä¼ ç»™Aå’ŒBï¼ŒAã€BåŽ»é™¤æŽ©ç å¹¶æ›´æ–°æ¨¡åž‹ã€‚&lt;/li>
&lt;/ul>
&lt;h3 id="è”é‚¦è¿ç§»å­¦ä¹ ">è”é‚¦è¿ç§»å­¦ä¹ &lt;/h3>
&lt;p>å½“å‚ä¸Žè€…é—´ç‰¹å¾å’Œæ ·æœ¬é‡å éƒ½å¾ˆå°‘æ—¶å¯ä»¥è€ƒè™‘ä½¿ç”¨è”é‚¦è¿ç§»å­¦ä¹ ï¼Œå¦‚ä¸åŒåœ°åŒºçš„é“¶è¡Œå’Œå•†è¶…é—´çš„è”åˆã€‚ä¸»è¦é€‚ç”¨äºŽä»¥æ·±åº¦ç¥žç»ç½‘ç»œä¸ºåŸºæ¨¡åž‹çš„åœºæ™¯ã€‚&lt;/p>
&lt;p>è¿ç§»å­¦ä¹ ï¼Œæ˜¯æŒ‡åˆ©ç”¨æ•°æ®ã€ä»»åŠ¡ã€æˆ–æ¨¡åž‹ä¹‹é—´çš„ç›¸ä¼¼æ€§ï¼Œå°†åœ¨æºé¢†åŸŸå­¦ä¹ è¿‡çš„æ¨¡åž‹ï¼Œåº”ç”¨äºŽ ç›®æ ‡é¢†åŸŸçš„ä¸€ç§å­¦ä¹ è¿‡ç¨‹ã€‚&lt;/p></description></item><item><title>Redisæºç å‰–æž(ä¸€)</title><link>https://chi-kai.github.io/post/redis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-%E4%B8%80/</link><pubDate>Sun, 22 May 2022 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/redis%E6%BA%90%E7%A0%81%E5%89%96%E6%9E%90-%E4%B8%80/</guid><description>&lt;h1 id="åŸºç¡€æ•°æ®ç»“æž„éƒ¨åˆ†">åŸºç¡€æ•°æ®ç»“æž„éƒ¨åˆ†&lt;/h1>
&lt;h2 id="åŠ¨æ€å­—ç¬¦ä¸²-sds">åŠ¨æ€å­—ç¬¦ä¸² SDS&lt;/h2>
&lt;p>å®žçŽ°åœ¨ sds.h/sds.cã€‚&lt;/p>
&lt;h3 id="è®¾è®¡åŽŸåˆ™">è®¾è®¡åŽŸåˆ™&lt;/h3>
&lt;p>ä¸ºä»€ä¹ˆä¸ä½¿ç”¨cè¯­è¨€åŽŸç”Ÿçš„å­—ç¬¦ä¸²æ“ä½œåº“? cå­—ç¬¦ä¸²ç”¨'\0'ä½œä¸ºç»ˆæ­¢ç¬¦ï¼Œä¸èƒ½æ»¡è¶³äºŒè¿›åˆ¶å®‰å…¨ï¼Œè€Œä¸”æ±‚å­—ç¬¦ä¸²é•¿åº¦ï¼Œæ‹¼æŽ¥ç­‰æ“ä½œéƒ½è¦éåŽ†åˆ°'\0'æ¥å®žçŽ°ï¼Œéœ€è¦è‡ªå·±æŽ§åˆ¶å†…å­˜ä½¿ç”¨ï¼Œæ“ä½œå¤æ‚åº¦é«˜ã€‚&lt;/p>
&lt;h3 id="å‰ç½®çŸ¥è¯†">å‰ç½®çŸ¥è¯†&lt;/h3>
&lt;p>ç”±äºŽæˆ‘å¯¹Cè¯­è¨€æ²¡æœ‰æ·±å…¥äº†è§£ï¼Œæœ‰å¾ˆå¤šçŸ¥è¯†ç‚¹ä¼šåœ¨å‰é¢è¡¥å……ã€‚&lt;/p>
&lt;ul>
&lt;li>
&lt;p>&lt;strong>attribute&lt;/strong> ((&lt;strong>packed&lt;/strong>)): å¯¹é½ä¼˜åŒ–&lt;/p>
&lt;p>&lt;strong>attribute&lt;/strong>((args)) æ˜¯GNU Cçš„ä¸€ä¸ªæœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡ç¼–è¯‘å™¨æ¥ä¿®é¥°ç»“æž„ä½“ï¼Œå‡½æ•°ç­‰ã€‚&lt;/p>
&lt;p>çŽ°ä»£è®¡ç®—æœºä¸­å†…å­˜ç©ºé—´éƒ½æ˜¯æŒ‰ç…§å­—èŠ‚ï¼ˆbyteï¼‰åˆ’åˆ†çš„ï¼Œä»Žç†è®ºä¸Šè®²ä¼¼ä¹Žå¯¹ä»»ä½•ç±»åž‹çš„å˜é‡çš„è®¿é—®å¯ä»¥ä»Žä»»ä½•åœ°å€å¼€å§‹ï¼Œä½†å®žé™…æƒ…å†µæ˜¯åœ¨è®¿é—®ç‰¹å®šå˜é‡çš„æ—¶å€™ç»å¸¸åœ¨ç‰¹å®šçš„å†…å­˜åœ°å€è®¿é—®ï¼Œè¿™å°±éœ€è¦å„ç±»åž‹æ•°æ®æŒ‰ç…§ä¸€å®šçš„è§„åˆ™åœ¨ç©ºé—´ä¸ŠæŽ’åˆ—ï¼Œè€Œä¸æ˜¯é¡ºåºåœ°ä¸€ä¸ªæŽ¥ä¸€ä¸ªåœ°æŽ’æ”¾ï¼Œè¿™å°±æ˜¯å¯¹é½.&lt;/p>
&lt;p>ä¸ºäº†æé«˜æ•ˆçŽ‡ï¼Œè®¡ç®—æœºä»Žå†…å­˜ä¸­å–æ•°æ®æ˜¯æŒ‰ç…§ä¸€ä¸ªå›ºå®šé•¿åº¦çš„ã€‚ä»¥32ä½æœºä¸ºä¾‹ï¼Œå®ƒæ¯æ¬¡å–32ä¸ªä½ï¼Œä¹Ÿå°±æ˜¯4ä¸ªå­—èŠ‚ï¼ˆæ¯å­—èŠ‚8ä¸ªä½)ã€‚å­—èŠ‚å¯¹é½æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿä»¥intåž‹æ•°æ®ä¸ºä¾‹ï¼Œå¦‚æžœå®ƒåœ¨å†…å­˜ä¸­å­˜æ”¾çš„ä½ç½®æŒ‰4å­—èŠ‚å¯¹é½ï¼Œä¹Ÿå°±æ˜¯è¯´1ä¸ªintçš„æ•°æ®å…¨éƒ¨è½åœ¨è®¡ç®—æœºä¸€æ¬¡å–æ•°çš„åŒºé—´å†…ï¼Œé‚£ä¹ˆåªéœ€è¦å–ä¸€æ¬¡å°±å¯ä»¥äº†&lt;/p>
&lt;p>ä½¿ç”¨__packed__å‚æ•°æ˜¯è¡¨ç¤ºï¼Œä½¿ç”¨åŽŸæ¥çš„åœ°å€ç©ºé—´ï¼Œç¼–è¯‘æ—¶ä¸è¦å­—èŠ‚å¯¹é½ï¼Œè¿™æ ·ç”¨æ—¶é—´æ¢ç©ºé—´ï¼Œä½¿å¾—ç»“æž„ä½“ç´§å¯†ã€‚&lt;/p>
&lt;p>è¯¦ç»†çš„ç”¨æ³•è§ &lt;a href="https://blog.csdn.net/weaiken/article/details/88085360">æœºåˆ¶è¯¦è§£&lt;/a>ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>uint8_t uint16_t ... size_t ä½¿ç”¨&lt;/p>
&lt;p>åŽé¢åŠ _tè¡¨ç¤ºæ˜¯ä¸€ä¸ªtypedef å®šä¹‰çš„ç±»åž‹ï¼Œæœ¬è´¨æ˜¯åŽŸæœ‰ç±»åž‹ã€‚è¿™æ ·åšæ˜¯ä¸ºäº†æ›´å¥½çš„è·¨å¹³å°ç§»æ¤ï¼Œå› ä¸ºä¸åŒçš„å¹³å°ä¸­int,long è¿™äº›åŸºç¡€ç±»åž‹å¯èƒ½å ç”¨çš„å­—èŠ‚ä¸åŒï¼Œè¿™å¯¹äºŽä¸€äº›å¯¹å†…å­˜ä¸¥æ ¼è¦æ±‚çš„åº“é€ æˆä¸ä¾¿ã€‚ä½¿ç”¨uint8_t ç­‰ç±»åž‹ï¼Œåœ¨ä¸åŒå¹³å°ä¸Šéƒ½ä»£è¡¨å ä¸€ä¸ªå­—èŠ‚8ä½ï¼Œä¾¿äºŽç¨‹åºçš„å®žçŽ°ã€‚&lt;/p>
&lt;p>åŒç† size_t ä¹Ÿæ˜¯ç”¨æ¥ä¿æŒè·¨å¹³å°ç§»æ¤æ€§ã€‚å¯ä»¥æ˜¯unsigned int unsigned char unsigned longç­‰ç­‰ï¼Œå–å†³äºŽå®žçŽ°ï¼Œsize_t = typeof(sizeof(X))ã€‚&lt;/p>
&lt;/li>
&lt;li>
&lt;p>static inline&lt;/p>
&lt;p>å¤´æ–‡ä»¶ä¸­å¾ˆå¤šå‡½æ•°ä½¿ç”¨äº†static inline å…³é”®å­—ï¼Œinline å»ºè®®ç¼–è¯‘å™¨å°†å‡½æ•°ä½œä¸ºä¸€ä¸ªå®å†…è”ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å‡½æ•°è°ƒç”¨æ—¶çš„å †æ ˆæ¶ˆè€—ï¼Œæé«˜æ€§èƒ½ã€‚ä½†æ˜¯ç¼–è¯‘å™¨ä¸ä¸€å®šä¼šå†…è”å‡½æ•°ï¼Œè¿™æ—¶å€™staticå¯ä»¥ä¿è¯è¿™ä¸ªå‡½æ•°æ˜¯ä»…åœ¨æœ¬æ–‡ä»¶å¯è§ï¼Œé¿å…é‡å¤åŒ…å«å†²çªã€‚&lt;/p>
&lt;/li>
&lt;/ul>
&lt;h3 id="æ•°æ®ç»“æž„">æ•°æ®ç»“æž„&lt;/h3>
&lt;p>è¿™é‡Œä»¥sdshdr8ä¸ºä¾‹&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ä¸€ä¸ªå­—èŠ‚ 8ä½
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// __attribute__ ((__packed__)) ç”¨æ¥å‘Šè¯‰ç¼–è¯‘å™¨å–æ¶ˆç»“æž„åœ¨ç¼–è¯‘ä¸­çš„ä¼˜åŒ–å¯¹é½ï¼ŒæŒ‰ç…§å®žé™…å ç”¨ã€‚
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// å› ä¸ºå†…å­˜æ˜¯æŒ‰ç…§2çš„å€æ•°è¯»å–çš„ï¼Œå¦åˆ™å¯èƒ½è¯»ä¸¤æ¬¡,é€Ÿåº¦å˜æ…¢ã€‚è¿™é‡Œæ˜¯ç”¨æ—¶é—´æ¢ç©ºé—´
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ä¿è¯æ•´ä¸ªç»“æž„ä½“çš„ç©ºé—´ç´§å¯†
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#75af00">__attribute__&lt;/span> &lt;span style="color:#111">((&lt;/span>&lt;span style="color:#111">__packed__&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#111">sdshdr8&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// buf ä¸­å·²ç»ä½¿ç”¨çš„å­—èŠ‚æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">uint8_t&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* used */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// åŽ»æŽ‰å¤´å’Œnullç»“æŸç¬¦ï¼Œå·²ç»åˆ†é…çš„å­—èŠ‚æ•°=æœ‰æ•ˆé•¿åº¦+æ•°æ®é•¿åº¦
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">uint8_t&lt;/span> &lt;span style="color:#111">alloc&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* excluding the header and null terminator */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 8ä½ï¼Œåªç”¨å‰ä¸‰ä½
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">flags&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* 3 lsb of type, 5 unused bits */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æŸ”æ€§æ•°ç»„ï¼Œæ²¡æœ‰åˆ†é…ä¹‹å‰ä¸å å†…å­˜
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">buf&lt;/span>&lt;span style="color:#111">[];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è®°å½•äº†å·²ç»ä½¿ç”¨çš„ç©ºé—´å’Œåˆ†é…çš„ç©ºé—´ï¼Œæ¯”Cå­—ç¬¦ä¸²æ“ä½œæ•ˆçŽ‡æ›´é«˜ã€‚å’Œ C è¯­è¨€ä¸­çš„å­—ç¬¦ä¸²æ“ä½œç›¸æ¯”ï¼ŒSDS é€šè¿‡è®°å½•å­—ç¬¦æ•°ç»„çš„ä½¿ç”¨é•¿åº¦å’Œåˆ†é…ç©ºé—´å¤§å°ï¼Œé¿å…äº†å¯¹å­—ç¬¦ä¸²çš„éåŽ†æ“ä½œï¼Œé™ä½Žäº†æ“ä½œå¼€é”€ï¼Œè¿›ä¸€æ­¥å°±å¯ä»¥å¸®åŠ©è¯¸å¤šå­—ç¬¦ä¸²æ“ä½œæ›´åŠ é«˜æ•ˆåœ°å®Œæˆï¼Œæ¯”å¦‚åˆ›å»ºã€è¿½åŠ ã€å¤åˆ¶ã€æ¯”è¾ƒç­‰ã€‚&lt;/p>
&lt;h4 id="äºŒè¿›åˆ¶å®‰å…¨">äºŒè¿›åˆ¶å®‰å…¨&lt;/h4>
&lt;pre>&lt;code>ä»€ä¹ˆæ˜¯äºŒè¿›åˆ¶å®‰å…¨ï¼Ÿé€šä¿—åœ°è®²ï¼ŒCè¯­è¨€ä¸­ï¼Œç”¨â€œ\0â€è¡¨ç¤ºå­—ç¬¦ä¸²çš„ç»“æŸï¼Œå¦‚æžœå­—ç¬¦ä¸²ä¸­æœ¬èº«å°±æœ‰â€œ\0â€å­—ç¬¦ï¼Œå­—ç¬¦ä¸²å°±ä¼šè¢«æˆªæ–­ï¼Œå³éžäºŒè¿›åˆ¶å®‰å…¨ï¼›è‹¥é€šè¿‡æŸç§æœºåˆ¶ï¼Œä¿è¯è¯»å†™å­—ç¬¦ä¸²æ—¶ä¸æŸå®³å…¶å†…å®¹ï¼Œåˆ™æ˜¯äºŒè¿›åˆ¶å®‰å…¨ã€‚åœ¨ç½‘ç»œæŠ¥æ–‡ä¸­å¸¸å¸¸éœ€è¦äºŒè¿›åˆ¶å®‰å…¨ã€‚
sdsä½¿ç”¨ len æ¥æŽ§åˆ¶å­—ç¬¦ä¸²é•¿åº¦ï¼Œè€Œä¸æ˜¯ä½¿ç”¨&amp;quot;\0&amp;quot;,ä¿éšœäº†äºŒè¿›åˆ¶å®‰å…¨ã€‚
&lt;/code>&lt;/pre>
&lt;h4 id="æžè‡´çš„å†…å­˜ä½¿ç”¨">æžè‡´çš„å†…å­˜ä½¿ç”¨&lt;/h4>
&lt;ul>
&lt;li>å¯¹äºŽä¸åŒçš„é•¿åº¦çš„å­—ç¬¦ä¸²æœ‰ä¸åŒçš„ç»“æž„ï¼Œä¸Šé¢çš„sdshdr8 è¡¨ç¤ºé•¿åº¦ä¸º8ä½çš„å­—ç¬¦ä¸²ï¼Œè¿˜æœ‰sdshdr16/32/64ã€‚ä¿è¯ä¸ä¼šå› ä¸ºå­—ç¬¦ä¸²è¿‡å°è€Œé¢å¤–æµªè´¹å­—èŠ‚ï¼Œä¹Ÿä¸ä¼šå› ä¸ºå­—ç¬¦ä¸²è¿‡é•¿è€Œé¢‘ç¹æ‰©å®¹ã€‚
- ç»“æž„ä½“ç´§å¯†ï¼Œæ”¾å¼ƒå¯¹é½ä¼˜åŒ–ã€‚åœ¨å‰ç½®è¯´æ˜Žäº†ç»“æž„ä½“ä½¿ç”¨ç¼–è¯‘å™¨å‚æ•°packedæ¥æ”¾å¼ƒä¼˜åŒ–ï¼Œ&lt;strong>ç”¨æ—¶é—´æ¢ç©ºé—´&lt;/strong>ã€‚
- flagã€‚ä½¿ç”¨ä¸€ä¸ªunsigned char,8ä½çš„å°ç«¯ä¸‰ä½æ¥è¡¨ç¤ºç»“æž„ä½“çš„æ€§è´¨(5/8/16/32/64)ã€‚
- å˜é•¿æ•°ç»„ï¼ˆæŸ”æ€§æ•°ç»„ï¼‰ã€‚æŸ”æ€§æ•°ç»„æˆå‘˜ï¼ˆflexible array memberï¼‰ï¼Œä¹Ÿå«ä¼¸ç¼©æ€§æ•°ç»„æˆå‘˜ï¼Œ&lt;strong>åªèƒ½è¢«æ”¾åœ¨ç»“æž„ä½“çš„æœ«å°¾&lt;/strong>ã€‚åŒ…å«æŸ”æ€§æ•°ç»„æˆå‘˜çš„ç»“æž„ä½“ï¼Œé€šè¿‡mallocå‡½æ•°ä¸ºæŸ”æ€§æ•°ç»„åŠ¨æ€åˆ†é…å†…å­˜ã€‚ä¹‹æ‰€ä»¥ç”¨æŸ”æ€§æ•°ç»„å­˜æ”¾å­—ç¬¦ä¸²ï¼Œæ˜¯å› ä¸ºæŸ”æ€§æ•°ç»„çš„åœ°å€å’Œç»“æž„ä½“æ˜¯è¿žç»­çš„ï¼Œè¿™æ ·æŸ¥æ‰¾å†…å­˜æ›´å¿«ï¼ˆå› ä¸ºä¸éœ€è¦é¢å¤–é€šè¿‡æŒ‡é’ˆæ‰¾åˆ°å­—ç¬¦ä¸²çš„ä½ç½®ï¼‰ï¼›å¯ä»¥å¾ˆæ–¹ä¾¿åœ°é€šè¿‡æŸ”æ€§æ•°ç»„çš„é¦–åœ°å€åç§»å¾—åˆ°ç»“æž„ä½“é¦–åœ°å€ï¼Œè¿›è€Œèƒ½å¾ˆæ–¹ä¾¿åœ°èŽ·å–å…¶ä½™å˜é‡ã€‚&lt;/li>
&lt;/ul>
&lt;h4 id="ä¸Žcå­—ç¬¦ä¸²å‡½æ•°">ä¸Žcå­—ç¬¦ä¸²å‡½æ•°&lt;/h4>
&lt;pre>&lt;code>å§‹ç»ˆå°†bufæŒ‡é’ˆæš´éœ²ç»™ä¸Šå±‚ï¼Œå¯ä»¥å’Œcå­—ç¬¦ä¸²å‡½æ•°åˆ‡åˆã€‚åŒæ—¶å¯ä»¥å¾ˆå®¹æ˜“åœ°é€šè¿‡å‡åŽ»ä¸€ä¸ªsdshdrå¤§å°åç§»åˆ°ç»“æž„ä½“é¦–éƒ¨æ¥è°ƒç”¨ç»“æž„ä½“å±žæ€§ã€‚
å¦‚ä¸‹é¢çš„å®å®šä¹‰:
```c
#define SDS_HDR_VAR(T,s) struct sdshdr##T *sh = (void*)((s)-(sizeof(struct sdshdr##T)));
#define SDS_HDR(T,s) ((struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T))))
```
&lt;/code>&lt;/pre>
&lt;h3 id="åŸºæœ¬æ“ä½œ">åŸºæœ¬æ“ä½œ&lt;/h3>
&lt;h4 id="åˆ›å»º">åˆ›å»º&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">sds&lt;/span> &lt;span style="color:#75af00">_sdsnewlen&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">init&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">size_t&lt;/span> &lt;span style="color:#111">initlen&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">trymalloc&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">sh&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">sds&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">type&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">sdsReqType&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">initlen&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å› ä¸ºé€šå¸¸æ€»æ˜¯æœ‰ç©ºå­—ç¬¦ä¸²ï¼Œè€Œä½¿ç”¨type5æ¯å¢žåŠ ä¸€æ¬¡å°±éœ€è¦æ‰©å®¹ï¼Œæ‰€ä»¥ç›´æŽ¥ä½¿ç”¨type 8 ---- ä¸ºä»€ä¹ˆä¸æŠŠtype5ç›´æŽ¥åˆ äº†ï¼Ÿ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">/* Empty strings are usually created in order to append. Use type 8
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * since type 5 is not good at this. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">type&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">SDS_TYPE_5&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#111">initlen&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">type&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">SDS_TYPE_8&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">hdrlen&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">sdsHdrSize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">fp&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* flags pointer. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">size_t&lt;/span> &lt;span style="color:#111">usable&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// initlen æ˜¯bufä¸­å®žé™…è£…çš„å¤§å°ï¼Œhdrlenæ˜¯sds headerå¤§å°ï¼Œ+1 æ˜¯\0ç»ˆæ­¢ç¬¦
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">assert&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">initlen&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">hdrlen&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">initlen&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">/* Catch size_t overflow */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//malloc_usableè¿˜æ˜¯è°ƒç”¨tyymalloc_usable
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">sh&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">trymalloc&lt;/span>&lt;span style="color:#f92672">?&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">s_trymalloc_usable&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">initlen&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#111">usable&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">:&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">s_malloc_usable&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">initlen&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#111">usable&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sh&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">init&lt;/span>&lt;span style="color:#f92672">==&lt;/span>&lt;span style="color:#111">SDS_NOINIT&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">init&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#111">init&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">memset&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sh&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">initlen&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æŒ‡å‘buf
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">s&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">char&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#111">sh&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">fp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">((&lt;/span>&lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">usable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">usable&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¯èƒ½ç”³è¯·çš„è¶…è¿‡ç±»åž‹MaxSize
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">usable&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#75af00">sdsTypeMaxSize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">usable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">sdsTypeMaxSize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">switch&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">case&lt;/span> &lt;span style="color:#111">SDS_TYPE_5&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">fp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">type&lt;/span> &lt;span style="color:#f92672">|&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">initlen&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#111">SDS_TYPE_BITS&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">break&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">case&lt;/span> &lt;span style="color:#111">SDS_TYPE_8&lt;/span>&lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">SDS_HDR_VAR&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">8&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">sh&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">len&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">initlen&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">sh&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">alloc&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">usable&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">fp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">break&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">initlen&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#111">init&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">memcpy&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">init&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">initlen&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">initlen&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#d88200">&amp;#39;\0&amp;#39;&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>é¦–å…ˆæ ¹æ®ç”³è¯·çš„åˆå§‹å¤§å°æ¥ç¡®å®šç±»åž‹ï¼Œé€šè¿‡ç±»åž‹å¯ä»¥ç¡®å®šhdrå¤§å°ï¼Œç„¶åŽæ¥ç”³è¯·ç©ºé—´ã€‚&lt;/li>
&lt;li>è¿™é‡Œä½¿ç”¨çš„s_trymalloc_usableä¸Žs_malloc_usableéƒ½æ˜¯æ–‡ä»¶zmallo.cå®žçŽ°çš„å†…å­˜ç®¡ç†å‡½æ•°ï¼ŒåŽé¢ä¼šä¸“é—¨è®²è§£ã€‚è¿™é‡Œåªç”¨çŸ¥é“å®ƒä¼šç”³è¯·å‰ä¸€ä¸ªå‚æ•°å¤§å°çš„ç©ºé—´ï¼Œå¹¶ä¸”å°†ç©ºé—´å¤§å°èµ‹å€¼ç»™åŽä¸€ä¸ªå‚æ•°usableã€‚&lt;/li>
&lt;li>å¾—åˆ°ç©ºé—´çš„é¦–åœ°å€ï¼ŒåŠ ä¸Šå¤´å¤§å°å¾—åˆ°bufåœ°å€s,s[-1] å¾—åˆ°ç±»åž‹æŒ‡é’ˆfp,usableå‡åŽ»å¤´å¤§å°hdrlenå’Œç±»åž‹å¤§å°1å¾—åˆ°å®žé™…å¯ç”¨å¤§å°ã€‚&lt;/li>
&lt;li>æ ¹æ®ç±»åž‹æ¥æž„å»ºä¸€ä¸ªsdsç»“æž„ä½“ï¼Œæœ€åŽè¿”å›žæ˜¯bufçš„æŒ‡é’ˆï¼Œè¡¥ä¸Šç»ˆæ­¢ç¬¦'\0'ã€‚è¿™é‡Œä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå®ï¼Œå¯ä»¥å€Ÿé‰´è¿™ç§å†™æ³•ï¼Œä¸€ä¸ªç»å¸¸ä½¿ç”¨çš„æ“ä½œï¼Œå¦‚æžœå†™æˆå‡½æ•°ï¼Œä¼šå¢žåŠ å †æ ˆè°ƒåº¦æ¶ˆè€—ï¼Œå†™æˆå®å¯ä»¥æé«˜æ€§èƒ½ï¼Œä»£ä»·æ˜¯ç¼–è¯‘åŽçš„æ–‡ä»¶å¤§å°ä¼šå¢žåŠ ã€‚&lt;/li>
&lt;/ol>
&lt;p>è¿™æ˜¯sdsåˆ›å»ºçš„åº•å±‚å®žçŽ°ï¼Œå®žé™…ä½¿ç”¨çš„æ˜¯ä¸Šå±‚çš„å°è£…ï¼Œåªæ˜¯å¯¹è¿™ä¸ªå‡½æ•°çš„å°è£…è°ƒç”¨ã€‚&lt;/p>
&lt;h4 id="é”€æ¯">é”€æ¯&lt;/h4>
&lt;p>æœ‰ä¸¤ç§æ–¹æ³•ï¼Œä¸€ç§æ˜¯ç›´æŽ¥é”€æ¯:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">sdsfree&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sds&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">s_free&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#00a8c8">char&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#75af00">sdsHdrSize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸€ç§æ˜¯ä»…ä»…å°†sdsçš„lenæ ‡è®°ä¸º0,ä½†æ˜¯å®žé™…çš„bufå¹¶ä¸ä¼šé‡Šæ”¾ï¼Œè€Œæ˜¯ç­‰å¾…è¦†å†™ã€‚è¿™æ ·å¯ä»¥ä¼˜åŒ–æ€§èƒ½ã€‚&lt;/p>
&lt;h4 id="æ‰©å®¹">æ‰©å®¹&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">sds&lt;/span> &lt;span style="color:#75af00">_sdsMakeRoomFor&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sds&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">size_t&lt;/span> &lt;span style="color:#111">addlen&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">greedy&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">sh&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">newsh&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">size_t&lt;/span> &lt;span style="color:#111">avail&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">sdsavail&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">size_t&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">newlen&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">reqlen&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">oldtype&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#111">SDS_TYPE_MASK&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">size_t&lt;/span> &lt;span style="color:#111">usable&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Return ASAP if there is enough space left. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">avail&lt;/span> &lt;span style="color:#f92672">&amp;gt;=&lt;/span> &lt;span style="color:#111">addlen&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">len&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">sdslen&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">sh&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">char&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#75af00">sdsHdrSize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">oldtype&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">reqlen&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">newlen&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">len&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">addlen&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// è¿™é‡Œæ˜¯é˜²æ­¢æº¢å‡º
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">assert&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">newlen&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">/* Catch size_t overflow */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">greedy&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// SDS_MAX_PREALLOC æ˜¯ 1MB
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">newlen&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">SDS_MAX_PREALLOC&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">newlen&lt;/span> &lt;span style="color:#f92672">*=&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">newlen&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">SDS_MAX_PREALLOC&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">type&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">sdsReqType&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">newlen&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Don&amp;#39;t use type 5: the user is appending to the string and type 5 is
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * not able to remember empty space, so sdsMakeRoomFor() must be called
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * at every appending operation. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">type&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">SDS_TYPE_5&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">type&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">SDS_TYPE_8&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">hdrlen&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">sdsHdrSize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">assert&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hdrlen&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">newlen&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">reqlen&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">/* Catch size_t overflow */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">oldtype&lt;/span>&lt;span style="color:#f92672">==&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å’ŒåŽŸç±»åž‹ç›¸åŒï¼Œåˆ™ä¸ç”¨é‡Šæ”¾å†…å­˜ï¼Œç›´æŽ¥å°†bufæ‰©å®¹å³å¯
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">newsh&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">s_realloc_usable&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sh&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">newlen&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#111">usable&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">newsh&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">s&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">char&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#111">newsh&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Since the header size changes, need to move the string forward,
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * and can&amp;#39;t use realloc */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ç±»åž‹æ”¹å˜,éœ€è¦é‡æ–°ç”³è¯·å†…å­˜ï¼ŒåŽŸå†…å­˜é‡Šæ”¾
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">newsh&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">s_malloc_usable&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">newlen&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span>&lt;span style="color:#111">usable&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">newsh&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">memcpy&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#00a8c8">char&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#111">newsh&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">s_free&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sh&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">s&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">char&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#111">newsh&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">sdssetlen&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">usable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">usable&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#111">hdrlen&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// type æ˜¯é€šè¿‡newlenåˆ¤æ–­å¾—åˆ°çš„ï¼Œè€Œusable æ˜¯ hdrlen + newlen + 1 å¯èƒ½å‡ºçŽ°è¶…å‡ºçš„æƒ…å†µ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">usable&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#75af00">sdsTypeMaxSize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">usable&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">sdsTypeMaxSize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">sdssetalloc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">usable&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">s&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>é¦–å…ˆåˆ¤æ–­newlenåŠ ä¸Šlenæ˜¯å¦è¶…å‡ºå¯ç”¨çš„å¤§å°avail,æ²¡è¶…å°±ä¸æ‰©å®¹ã€‚&lt;/li>
&lt;li>å’Œä¹‹å‰ä¸åŒï¼Œè¿™ä¸€ç‰ˆæœ¬åŠ å…¥äº†greedyå‚æ•°ï¼Œæ¥è°ƒèŠ‚æ‰©å®¹ç­–ç•¥ï¼Œå½“greedyä¸º1æ—¶ï¼Œæ¯æ¬¡ä¼šæ‰©å¤§çš„æ¯”æ‰€éœ€è¦çš„æ›´å¤šï¼Œè¿™æ ·å¯ä»¥å‡å°‘æ‰©å®¹é¢‘çŽ‡ã€‚è€Œgreedyä¸º0æ—¶ï¼Œå°±æ˜¯èŠ‚çº¦å†…å­˜&lt;/li>
&lt;li>greedyä¸º1æ—¶å¯ç”¨æ­¤ç­–ç•¥: å¦‚æžœnewlenå°äºŽ1MB,æ¯æ¬¡æ‰©å®¹äºŒèƒŒï¼Œå¤§äºŽ1MBæ—¶æ¯æ¬¡å¢žåŠ 1MBã€‚ï¼ˆæ¯æ¬¡2å€å†…å­˜å¾ˆå¿«å°±è€—å°½äº†ï¼‰&lt;/li>
&lt;li>è¿™é‡Œæ ¹æ®æ–°çš„newlenæ¥ç¡®å®šç±»åž‹ï¼Œå¦‚æžœç±»åž‹ä¸å˜ï¼Œåªéœ€è¦æ‰©å±•bufæ•°ç»„ï¼Œè€Œç±»åž‹æ”¹å˜çš„è¯å°±éœ€è¦é‡æ–°ç”³è¯·å†…å­˜ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="è·³è¡¨zskiplist">è·³è¡¨zskiplist&lt;/h2>
&lt;p>å¯¹åº”çš„ä»£ç åœ¨ server.h å’Œ t_zset.cã€‚&lt;/p>
&lt;p>è·³è¡¨å¯ä»¥çœ‹ä½œé“¾è¡¨åŠ ä¸Šéƒ½å¤šå±‚ç´¢å¼•ï¼Œä¸€èˆ¬æ¯ä¸¤ä¸ª&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/25/87fPGrURAgdHzn3.jpg" alt="skiplist">&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* ZSETs use a specialized version of Skiplists */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">typedef&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">sds&lt;/span> &lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// å­˜å‚¨å­—ç¬¦ä¸²ç±»åž‹çš„æ•°æ®
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">double&lt;/span> &lt;span style="color:#111">score&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// å‚¨å­˜æŽ’åºçš„åˆ†å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">backward&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// åŽå‘æŒ‡é’ˆ å¤´èŠ‚ç‚¹å’Œç¬¬ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¸ºNULL
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">zskiplistLevel&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// æŒ‡å‘æœ¬å±‚ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">span&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// è·¨åº¦ æŒ‡å‘æœ¬å±‚ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸­é—´è·¨è¶Šçš„èŠ‚ç‚¹ä¸ªæ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">}&lt;/span> &lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[];&lt;/span> &lt;span style="color:#75715e">// æŸ”æ€§æ•°ç»„ï¼Œæœªåˆ†é…å†…å­˜æ—¶ä¸å ç©ºé—´ã€‚åˆå§‹åŒ–æ—¶ï¼Œlevel éšæœºåˆ†é…1~32
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#111">zskiplistNode&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">typedef&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">zskiplist&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">header&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">tail&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">length&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// é™¤äº†å¤´èŠ‚ç‚¹ä»¥å¤–èŠ‚ç‚¹æ€»æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// è·³è¡¨çš„é«˜åº¦
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#111">zskiplist&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ç”¨çš„å›¾ç‰‡æ˜¯ç½‘å›¾ &lt;a href="https://zhuanlan.zhihu.com/p/26499803">é“¾æŽ¥&lt;/a>ï¼Œå…¶ä¸­objä¸€èˆ¬ä¸ºsdsï¼Œåœ¨Redis6ä¸­å·²ç»æ”¹ä¸ºsds eleã€‚&lt;/p>
&lt;p>å¯ä»¥ä»Žå›¾å’Œä»£ç å¾ˆæ¸…æ™°åœ°çœ‹å‡ºè·³è·ƒè¡¨çš„ç»“æž„ã€‚&lt;/p>
&lt;p>è·³è·ƒè¡¨æ˜¯Redisæœ‰åºé›†åˆçš„åº•å±‚å®žçŽ°æ–¹å¼ä¹‹ä¸€ï¼Œæ‰€ä»¥æ¯ä¸ªèŠ‚ç‚¹çš„eleå­˜å‚¨æœ‰åºé›†åˆçš„æˆå‘˜memberå€¼ï¼Œscoreå­˜å‚¨æˆå‘˜scoreå€¼ã€‚æ‰€æœ‰èŠ‚ç‚¹çš„åˆ†å€¼æ˜¯æŒ‰ä»Žå°åˆ°å¤§çš„æ–¹å¼æŽ’åºçš„ï¼Œå½“æœ‰åºé›†åˆçš„æˆå‘˜åˆ†å€¼ç›¸åŒæ—¶ï¼ŒèŠ‚ç‚¹ä¼šæŒ‰memberçš„å­—å…¸åºè¿›è¡ŒæŽ’åºã€‚&lt;/p>
&lt;p>é€šè¿‡è·³è·ƒè¡¨ç»“æž„ä½“çš„å±žæ€§æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œç¨‹åºå¯ä»¥åœ¨O(1)çš„æ—¶é—´å¤æ‚åº¦ä¸‹ï¼Œå¿«é€ŸèŽ·å–åˆ°è·³è·ƒè¡¨çš„å¤´èŠ‚ç‚¹ã€å°¾èŠ‚ç‚¹ã€é•¿åº¦å’Œé«˜åº¦ã€‚&lt;/p>
&lt;h3 id="åˆ›å»º-1">åˆ›å»º&lt;/h3>
&lt;p>Redisé€šè¿‡zslRandomLevelå‡½æ•°éšæœºç”Ÿæˆä¸€ä¸ª1ï½ž32çš„å€¼ï¼Œä½œä¸ºæ–°å»ºèŠ‚ç‚¹çš„é«˜åº¦ï¼Œå€¼è¶Šå¤§å‡ºçŽ°çš„æ¦‚çŽ‡è¶Šä½Žã€‚èŠ‚ç‚¹å±‚é«˜ç¡®å®šä¹‹åŽä¾¿ä¸ä¼šå†ä¿®æ”¹ã€‚ç”Ÿæˆéšæœºå±‚é«˜çš„ä»£ç å¦‚ä¸‹ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ZSKIPLIST ä¸º 0.25
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#75af00">zslRandomLevel&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">void&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">threshold&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">ZSKIPLIST_P&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">RAND_MAX&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">level&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">while&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">random&lt;/span>&lt;span style="color:#111">()&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">threshold&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">level&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// è¿™é‡Œ ZSKIPLIST_MAXLEVEL ä¸º32
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">ZSKIPLIST_MAXLEVEL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#111">level&lt;/span> &lt;span style="color:#111">:&lt;/span> &lt;span style="color:#111">ZSKIPLIST_MAXLEVEL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å½“p=0.25æ—¶ï¼Œè·³è·ƒè¡¨èŠ‚ç‚¹çš„æœŸæœ›å±‚é«˜ä¸º1/(1-0.25)â‰ˆ1.33ã€‚&lt;/p>
&lt;p>ä¸‹é¢æ˜¯åˆ›å»ºå‡½æ•°&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Create a skiplist node with the specified number of levels.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * The SDS string &amp;#39;ele&amp;#39; is referenced by the node after the call. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">zslCreateNode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">double&lt;/span> &lt;span style="color:#111">score&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">sds&lt;/span> &lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">zn&lt;/span> &lt;span style="color:#f92672">=&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// level æŸ”æ€§æ•°ç»„åŠ ä¸Šå¤´å¤§å° æ¥ç”³è¯·å†…å­˜
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">zmalloc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">sizeof&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">zn&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#00a8c8">sizeof&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">zskiplistLevel&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zn&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">score&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zn&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ele&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">zn&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Create a new skiplist. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">zskiplist&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">zslCreate&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">void&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zskiplist&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">zmalloc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">sizeof&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">length&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¤´èŠ‚ç‚¹çš„levelæ˜¯æœ€å¤§å±‚æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">header&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">zslCreateNode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">ZSKIPLIST_MAXLEVEL&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">j&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">j&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">ZSKIPLIST_MAXLEVEL&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">j&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">header&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">header&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">span&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">header&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">backward&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">tail&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¤´èŠ‚ç‚¹æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„èŠ‚ç‚¹ï¼Œä¸å­˜å‚¨æœ‰åºé›†åˆçš„memberä¿¡æ¯ã€‚å¤´èŠ‚ç‚¹æ˜¯è·³è·ƒè¡¨ä¸­ç¬¬ä¸€ä¸ªæ’å…¥çš„èŠ‚ç‚¹ï¼Œå…¶levelæ•°ç»„çš„æ¯é¡¹forwardéƒ½ä¸ºNULL, spanå€¼éƒ½ä¸º0&lt;/p>
&lt;h3 id="æ’å…¥">æ’å…¥&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Insert a new node in the skiplist. Assumes the element does not already
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * exist (up to the caller to enforce that). The skiplist takes ownership
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * of the passed SDS string &amp;#39;ele&amp;#39;. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">zslInsert&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">zskiplist&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">double&lt;/span> &lt;span style="color:#111">score&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">sds&lt;/span> &lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// è®°å½•æ¯å±‚æ‰€èƒ½åˆ°è¾¾çš„æœ€å³è¾¹èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">ZSKIPLIST_MAXLEVEL&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// è®°å½•æ¯å±‚ä»Žheaderåˆ°update[i}æ‰€éœ€çš„æ­¥é•¿
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">rank&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">ZSKIPLIST_MAXLEVEL&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// åˆ¤æ–­score æ˜¯ä¸æ˜¯NAN
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">serverAssert&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">isnan&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">score&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">x&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">header&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ä»Žæœ€é«˜å±‚ç´¢å¼•å¼€å§‹éåŽ†
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">&amp;gt;=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">--&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* store rank that is crossed to reach the insert position */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å½“åœ¨æœ€é«˜å±‚æ—¶ï¼Œå…ˆå°†rankèµ‹å€¼ä¸º0ï¼Œå…ˆå‡è®¾
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">rank&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">rank&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// åœ¨ç¬¬iå±‚ä¸€ç›´å‘å‰ç§»åŠ¨æ¯”è¾ƒ,å› ä¸ºæ˜¯æŒ‰ç…§score ä»Žå°åˆ°å¤§æŽ’åˆ—çš„
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// æ‰¾åˆ°è¿™å±‚å¤§äºŽæ’å…¥score çš„ä½ç½®ç„¶åŽä¸‹ç§»
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">while&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">||&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">sdscmp&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ›´æ–°æ€»çš„span
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">rank&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">span&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">x&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// è®°å½•è¿™å±‚çš„ç»ˆç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* we assume the element is not already inside, since we allow duplicated
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * scores, reinserting the same element should never happen since the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * caller of zslInsert() should test in the hash table if the element is
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * already inside or not. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// zslInsertä¸èƒ½åº”ç”¨åœ¨æ’å…¥èŠ‚ç‚¹å·²ç»å­˜åœ¨çš„æƒ…å†µä¸‹ã€‚
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// æ‰€ä»¥ä¸ç”¨æ£€æŸ¥å­˜åœ¨
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//ä¸ºæ’å…¥èŠ‚ç‚¹è®¡ç®—éšæœºå±‚æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">level&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">zslRandomLevel&lt;/span>&lt;span style="color:#111">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//å¤§äºŽåŽŸæ¥å±‚é«˜çš„éƒ¨åˆ†ï¼Œåªéœ€è¦è°ƒæ•´headerå°±è¡Œã€‚
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">level&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">rank&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">header&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ä¸ºå•¥æ˜¯è¿™ä¸ªï¼Ÿå¯èƒ½æ˜¯ç”¨æ¥å ä½
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">span&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">length&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">x&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">zslCreateNode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">score&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ’å…¥åˆ°æ¯å±‚æœ€å³ä¾§èƒ½åˆ°è¾¾çš„èŠ‚ç‚¹ä¹‹åŽ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* update span covered by update[i] as x is inserted here */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ’å…¥èŠ‚ç‚¹æ¯å±‚çš„spanæ›´æ–°,è¿™ä¸ªçœ‹ä¸‹å›¾
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">span&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">span&lt;/span> &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">rank&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#111">rank&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">span&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">rank&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#111">rank&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">])&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* increment span for untouched levels */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">span&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">backward&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">header&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#111">NULL&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">backward&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">tail&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">length&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>ä¸‹å›¾æ¥æºäºŽ &lt;a href="https://zhuanlan.zhihu.com/p/56941754">é“¾æŽ¥&lt;/a>&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/26/FHEMRScINYyX72U.png" alt="">&lt;/p>
&lt;p>ä»¥èŠ‚ç‚¹19æ’å…¥ä¸ºä¾‹ï¼Œå…¶ä¸­
é»‘è‰²ç®­å¤´çš„è¡¨ç¤ºçš„è·¨åº¦ä¸ºupdate[i]-&amp;gt;level[i].span
è“è‰²ç®­å¤´è¡¨ç¤ºçš„è·¨åº¦ä¸ºrank[0] - rank[i]å³èŠ‚ç‚¹19åœ¨level_0çš„update[0]ä¸º11ï¼Œ
åœ¨level_1çš„update[1]ä¸º7ï¼Œrank[0] - rank[i]ä¸ºèŠ‚ç‚¹7ä¸ŽèŠ‚ç‚¹11ä¹‹é—´çš„è·¨åº¦
ç»¿è‰²ç®­å¤´è¡¨ç¤ºçš„è·¨åº¦ä¸ºèŠ‚ç‚¹19åˆ°èŠ‚ç‚¹37çš„span&lt;/p>
&lt;h3 id="åˆ é™¤">åˆ é™¤&lt;/h3>
&lt;p>é¦–å…ˆæŸ¥æ‰¾åˆ°å¯¹åº”çš„èŠ‚ç‚¹ï¼Œå°†æ¯å±‚æœ€å³è¾¹åˆ°è¾¾çš„èŠ‚ç‚¹è®°å½•ä¸‹æ¥ï¼Œå¯¹åº”çš„updateã€‚
è¾…åŠ©å‡½æ•°:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">zslDeleteNode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">zskiplist&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#f92672">**&lt;/span>&lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// è°ƒæ•´å¯¹åº”çš„spanå’Œforward
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">span&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">span&lt;/span> &lt;span style="color:#f92672">-&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">span&lt;/span> &lt;span style="color:#f92672">-=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">backward&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">backward&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">tail&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">backward&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// è°ƒæ•´level
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">while&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">header&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#f92672">--&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">length&lt;/span>&lt;span style="color:#f92672">--&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>åˆ é™¤å‡½æ•°:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#75af00">zslDelete&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">zskiplist&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">double&lt;/span> &lt;span style="color:#111">score&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">sds&lt;/span> &lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#f92672">**&lt;/span>&lt;span style="color:#111">node&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zskiplistNode&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">ZSKIPLIST_MAXLEVEL&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">//æŸ¥æ‰¾ä½ç½®
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">x&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">header&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span> &lt;span style="color:#f92672">&amp;gt;=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">i&lt;/span>&lt;span style="color:#f92672">--&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">while&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">||&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">sdscmp&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">x&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// ä¿å­˜æ¯å±‚æœ€å³è¾¹çš„èŠ‚ç‚¹
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">i&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* We may have multiple elements with the same score, what we need
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * is to find the element with both the right score and object. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¯èƒ½åŒä¸€ä¸ªscoreæœ‰å¤šä¸ªele
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">x&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">level&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">forward&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#75af00">sdscmp&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">ele&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">zslDeleteNode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">zsl&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">update&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#111">node&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">zslFreeNode&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">node&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">x&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* not found */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="åŽ‹ç¼©åˆ—è¡¨">åŽ‹ç¼©åˆ—è¡¨&lt;/h2>
&lt;p>å…·ä½“çš„å®žçŽ°åœ¨ziplist.hå’Œziplist.c&lt;/p>
&lt;p>åŽ‹ç¼©åˆ—è¡¨æ˜¯Redisä¸­ä¸€ç§é«˜æ•ˆåˆ©ç”¨å†…å­˜çš„æ•°æ®ç»“æž„ï¼Œç”¨æ¥å‚¨å­˜å­—ç¬¦ä¸²å’Œæ•°å­—ï¼Œå®ƒçš„pushå’Œpopæ“ä½œéƒ½æ˜¯ &lt;strong>O(1)&lt;/strong> ã€‚Redisçš„æœ‰åºé›†åˆã€æ•£åˆ—å’Œåˆ—è¡¨éƒ½ç›´æŽ¥æˆ–è€…é—´æŽ¥ä½¿ç”¨äº†åŽ‹ç¼©åˆ—è¡¨ã€‚å½“æœ‰åºé›†åˆæˆ–æ•£åˆ—è¡¨çš„å…ƒç´ ä¸ªæ•°æ¯”è¾ƒå°‘ï¼Œä¸”å…ƒç´ éƒ½æ˜¯çŸ­å­—ç¬¦ä¸²æ—¶ï¼ŒRedisä¾¿ä½¿ç”¨åŽ‹ç¼©åˆ—è¡¨ä½œä¸ºå…¶åº•å±‚æ•°æ®å­˜å‚¨ç»“æž„ã€‚åˆ—è¡¨ä½¿ç”¨å¿«é€Ÿé“¾è¡¨ï¼ˆquicklistï¼‰æ•°æ®ç»“æž„å­˜å‚¨ï¼Œè€Œå¿«é€Ÿé“¾è¡¨å°±æ˜¯åŒå‘é“¾è¡¨ä¸ŽåŽ‹ç¼©åˆ—è¡¨çš„ç»„åˆã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ziplist ç»“æž„
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">zlbytes&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">zltail&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">zllen&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">...&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">zlend&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œçš„æ‰€æœ‰ç»“æž„éƒ½æ˜¯æŒ‰ç…§å°ç«¯å­˜å‚¨ã€‚&lt;/p>
&lt;ul>
&lt;li>zlbytes: åŽ‹ç¼©åˆ—è¡¨çš„å­—èŠ‚é•¿åº¦ï¼Œå 4ä¸ªå­—èŠ‚ï¼Œå› æ­¤åŽ‹ç¼©åˆ—è¡¨æœ€å¤šæœ‰$2^{32}-1$ä¸ªå­—èŠ‚ã€‚è¿™ä¸ªè®¾è®¡æ˜¯ä¸ºäº†resizeæ—¶ä¸å¿…éåŽ†æ•´ä¸ªåˆ—è¡¨&lt;/li>
&lt;li>zltail: åŽ‹ç¼©åˆ—è¡¨å°¾å…ƒç´ ç›¸å¯¹äºŽåŽ‹ç¼©åˆ—è¡¨èµ·å§‹åœ°å€çš„åç§»é‡ï¼Œå 4ä¸ªå­—èŠ‚ï¼Œè¿™ä¸ªè®¾è®¡å¯ä»¥ä½¿popæ“ä½œä¸å¿…è¦éåŽ†å…¨éƒ¨ã€‚&lt;/li>
&lt;li>zllen: åŽ‹ç¼©åˆ—è¡¨çš„å…ƒç´ ä¸ªæ•°ï¼Œå 2ä¸ªå­—èŠ‚ã€‚zllenæ— æ³•å­˜å‚¨å…ƒç´ ä¸ªæ•°è¶…è¿‡65535ï¼ˆ$2^{16}-1$ï¼‰çš„åŽ‹ç¼©åˆ—è¡¨ï¼Œå¿…é¡»éåŽ†æ•´ä¸ªåŽ‹ç¼©åˆ—è¡¨æ‰èƒ½èŽ·å–åˆ°å…ƒç´ ä¸ªæ•°ã€‚&lt;/li>
&lt;li>zlend: åŽ‹ç¼©åˆ—è¡¨çš„ç»“å°¾ï¼Œå 1ä¸ªå­—èŠ‚ï¼Œæ’ä¸º0xFFã€‚&lt;/li>
&lt;/ul>
&lt;p>è¿™é‡Œå¯ä»¥æ¸…æ¥šåœ°æ„Ÿå—åˆ°Cè¯­è¨€å¯¹å†…å­˜çš„æŽŒæŽ§ï¼Œé€šè¿‡æŒ‡é’ˆä½ç§»æ¥èŽ·å–ç»“æž„ä¿¡æ¯ã€‚è¿™é‡Œä½¿ç”¨å®åˆæ˜¯Cè¯­è¨€çš„ä¸€ä¸ªç‰¹è‰²ï¼Œæ¯”èµ·inlineåªæ˜¯å»ºè®®ç¼–è¯‘å™¨å†…è”ï¼Œå®çœŸæ­£æ˜¯å†…è”ï¼Œå¯¹äºŽä¸€äº›ç»†å°è€Œé¢‘ç¹çš„æ“ä½œæé«˜äº†æ€§èƒ½ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Return total bytes a ziplist is composed of. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIPLIST_BYTES(zl) (*((uint32_t*)(zl)))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Return the offset of the last item inside the ziplist. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIPLIST_TAIL_OFFSET(zl) (*((uint32_t*)((zl)+sizeof(uint32_t))))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Return the length of a ziplist, or UINT16_MAX if the length cannot be
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * determined without scanning the whole ziplist. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIPLIST_LENGTH(zl) (*((uint16_t*)((zl)+sizeof(uint32_t)*2)))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* The size of a ziplist header: two 32 bit integers for the total
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * bytes count and last item offset. One 16 bit integer for the number
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * of items field. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIPLIST_HEADER_SIZE (sizeof(uint32_t)*2+sizeof(uint16_t))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Size of the &amp;#34;end of ziplist&amp;#34; entry. Just one byte. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIPLIST_END_SIZE (sizeof(uint8_t))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Return the pointer to the first entry of a ziplist. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIPLIST_ENTRY_HEAD(zl) ((zl)+ZIPLIST_HEADER_SIZE)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Return the pointer to the last entry of a ziplist, using the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * last entry offset inside the ziplist header. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIPLIST_ENTRY_TAIL(zl) ((zl)+intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl)))
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Return the pointer to the last byte of a ziplist, which is, the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * end of ziplist FF entry. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIPLIST_ENTRY_END(zl) ((zl)+intrev32ifbe(ZIPLIST_BYTES(zl))-ZIPLIST_END_SIZE)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºŽ &lt;entry> ç»“æž„å¦‚ä¸‹:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">prevlen&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span>&lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#111">data&lt;/span>&lt;span style="color:#f92672">&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>previous_entry_lengthå­—æ®µè¡¨ç¤ºå‰ä¸€ä¸ªå…ƒç´ çš„å­—èŠ‚é•¿åº¦ï¼Œå 1ä¸ªæˆ–è€…5ä¸ªå­—èŠ‚ï¼Œå½“å‰ä¸€ä¸ªå…ƒç´ çš„é•¿åº¦å°äºŽ254å­—èŠ‚æ—¶ï¼Œç”¨1ä¸ªå­—èŠ‚è¡¨ç¤ºï¼›å½“å‰ä¸€ä¸ªå…ƒç´ çš„é•¿åº¦å¤§äºŽæˆ–ç­‰äºŽ254å­—èŠ‚æ—¶ï¼Œç”¨5ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚è€Œæ­¤æ—¶previous_entry_lengthå­—æ®µçš„ç¬¬1ä¸ªå­—èŠ‚æ˜¯å›ºå®šçš„0xFEï¼ŒåŽé¢4ä¸ªå­—èŠ‚æ‰çœŸæ­£è¡¨ç¤ºå‰ä¸€ä¸ªå…ƒç´ çš„é•¿åº¦ã€‚å‡è®¾å·²çŸ¥å½“å‰å…ƒç´ çš„é¦–åœ°å€ä¸ºpï¼Œé‚£ä¹ˆp-previous_entry_lengthå°±æ˜¯å‰ä¸€ä¸ªå…ƒç´ çš„é¦–åœ°å€ï¼Œä»Žè€Œå®žçŽ°åŽ‹ç¼©åˆ—è¡¨ä»Žå°¾åˆ°å¤´çš„éåŽ†ã€‚&lt;/p>
&lt;p>encodingå­—æ®µè¡¨ç¤ºå½“å‰å…ƒç´ çš„ç¼–ç ï¼Œå³contentå­—æ®µå­˜å‚¨çš„æ•°æ®ç±»åž‹ï¼ˆæ•´æ•°æˆ–è€…å­—èŠ‚æ•°ç»„ï¼‰ï¼Œæ•°æ®å†…å®¹å­˜å‚¨åœ¨contentå­—æ®µã€‚ä¸ºäº†èŠ‚çº¦å†…å­˜ï¼Œencodingå­—æ®µåŒæ ·é•¿åº¦å¯å˜ã€‚&lt;/p>
&lt;p>&lt;img src="https://s2.loli.net/2022/11/26/6gMtVLmx9udXpS3.png" alt="">&lt;/p>
&lt;p>Redisä½¿ç”¨å®æ¥è¡¨ç¤º&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIP_STR_MASK 0xc0
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIP_INT_MASK 0x30
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIP_STR_06B (0 &amp;lt;&amp;lt; 6)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIP_STR_14B (1 &amp;lt;&amp;lt; 6)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIP_STR_32B (2 &amp;lt;&amp;lt; 6)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIP_INT_16B (0xc0 | 0&amp;lt;&amp;lt;4)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIP_INT_32B (0xc0 | 1&amp;lt;&amp;lt;4)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIP_INT_64B (0xc0 | 2&amp;lt;&amp;lt;4)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIP_INT_24B (0xc0 | 3&amp;lt;&amp;lt;4)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define ZIP_INT_8B 0xfe
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>&lt;strong>è¿™é‡Œä½¿ç”¨ä½è¿ç®—æ¥ä»£è¡¨ç±»åž‹&lt;/strong>ï¼Œæ—¢èŠ‚çœäº†å†…å­˜åˆæé«˜äº†æ€§èƒ½ã€‚&lt;/p>
&lt;h3 id="ç»“æž„">ç»“æž„&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">typedef&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">zlentry&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">prevrawlensize&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* Bytes used to encode the previous entry len*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">prevrawlen&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* Previous entry len. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">lensize&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* Bytes used to encode this entry type/len.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> For example strings have a 1, 2 or 5 bytes
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> header. Integers always use a single byte.*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* Bytes used to represent the actual entry.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> For strings this is just the string length
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> while for integers it is 1, 2, 3, 4, 8 or
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> 0 (for 4 bit immediate) depending on the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> number range. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">headersize&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* prevrawlensize + lensize. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* Set to ZIP_STR_* or ZIP_INT_* depending on
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> the entry encoding. However for 4 bits
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> immediate integers this can assume a range
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> of values and must be range-checked. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* Pointer to the very start of the entry, that
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> is, this points to prev-entry-len field. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#111">zlentry&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯¹äºŽåŽ‹ç¼©åˆ—è¡¨çš„ä»»æ„å…ƒç´ ï¼ŒèŽ·å–å‰ä¸€ä¸ªå…ƒç´ çš„é•¿åº¦ã€åˆ¤æ–­å­˜å‚¨çš„æ•°æ®ç±»åž‹ã€èŽ·å–æ•°æ®å†…å®¹éƒ½éœ€è¦ç»è¿‡å¤æ‚çš„è§£ç è¿ç®—ã€‚è§£ç åŽçš„ç»“æžœåº”è¯¥è¢«ç¼“å­˜èµ·æ¥ï¼Œä¸ºæ­¤å®šä¹‰äº†ç»“æž„ä½“zlentryï¼Œç”¨äºŽè¡¨ç¤ºè§£ç åŽçš„åŽ‹ç¼©åˆ—è¡¨å…ƒç´ ã€‚&lt;/p>
&lt;p>è§£ç æ“ä½œï¼Œä¸»è¦ç”¨å®å®žçŽ°:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">inline&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">zipEntry&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">zlentry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">e&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">ZIP_DECODE_PREVLEN&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">prevrawlensize&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">prevrawlen&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">ZIP_ENTRY_ENCODING&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">p&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">prevrawlensize&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">ZIP_DECODE_LENGTH&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">p&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">prevrawlensize&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">encoding&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">lensize&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">len&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">assert&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">lensize&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">/* check that encoding was valid. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">headersize&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">prevrawlensize&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">lensize&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">p&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">p&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œä¸»è¦å°±æ˜¯å¯¹å­—èŠ‚çš„è¯»å–ï¼Œå¯ä»¥åŽ»çœ‹æºä»£ç ã€‚&lt;/p>
&lt;h3 id="æ“ä½œ">æ“ä½œ&lt;/h3>
&lt;h4 id="åˆ›å»º-2">åˆ›å»º&lt;/h4>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Create a new empty ziplist. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// å…ˆç”³è¯·åˆå§‹çš„ç©ºé—´(4+4+2+1),å†å¯¹zlbytes,zltail,zllen,zlendé€ä¸ªåˆå§‹åŒ–
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">ziplistNew&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">void&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">bytes&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">ZIPLIST_HEADER_SIZE&lt;/span>&lt;span style="color:#f92672">+&lt;/span>&lt;span style="color:#111">ZIPLIST_END_SIZE&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">zl&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">zmalloc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">bytes&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">ZIPLIST_BYTES&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">zl&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">intrev32ifbe&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">bytes&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">ZIPLIST_TAIL_OFFSET&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">zl&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">intrev32ifbe&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">ZIPLIST_HEADER_SIZE&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">ZIPLIST_LENGTH&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">zl&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">zl&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">bytes&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">ZIP_END&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">zl&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h4 id="æ’å…¥å…ƒç´ ">æ’å…¥å…ƒç´ &lt;/h4>
&lt;ol>
&lt;li>ç¼–ç ã€‚è®¡ç®—previous_entry_lengthå­—æ®µã€encodingå­—æ®µå’Œcontentå­—æ®µçš„å†…å®¹ã€‚&lt;/li>
&lt;/ol>
&lt;h2 id="å­—å…¸">å­—å…¸&lt;/h2>
&lt;h3 id="ç»“æž„-1">ç»“æž„&lt;/h3>
&lt;p>èŠ‚ç‚¹:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">typedef&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// èŠ‚çœå†…å­˜ ä¸åŒåœºæ™¯ä¸‹ä½¿ç”¨ä¸åŒå­—æ®µ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">union&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">val&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// db.dict å‚¨å­˜å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">uint64_t&lt;/span> &lt;span style="color:#111">u64&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int64_t&lt;/span> &lt;span style="color:#111">s64&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// db.expires å‚¨å­˜è¿‡æœŸæ—¶é—´
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">double&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span> &lt;span style="color:#111">v&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å•é“¾è¡¨æ³• è§£å†³å“ˆå¸Œå†²çªã€‚
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">next&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* Next entry in the same hash bucket. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">metadata&lt;/span>&lt;span style="color:#111">[];&lt;/span> &lt;span style="color:#75715e">/* An arbitrary number of bytes (starting at a
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * pointer-aligned address) of size as returned
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * by dictType&amp;#39;s dictEntryMetadataBytes(). */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#111">dictEntry&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹å‡ºæ˜¯ä½¿ç”¨é“¾è¡¨æ³•æ¥è§£å†³hashå†²çªçš„ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dictType&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// å¯¹åº”ç‰¹å®šç±»åž‹æ“ä½œå‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">**&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">];&lt;/span> &lt;span style="color:#75715e">// å“ˆå¸Œè¡¨ã€‚æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ­£å¸¸ä½¿ç”¨ï¼Œå¦å¤–ä¸€ä¸ªåœ¨rehashæ—¶ä½¿ç”¨
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">];&lt;/span> &lt;span style="color:#75715e">// è®°å½•æ¯ä¸ªå“ˆå¸Œè¡¨è¢«ä½¿ç”¨çš„æ•°ç›®ã€‚
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">rehashidx&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* rehashing not in progress if rehashidx == -1 */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Keep small vars at end for optimal (minimal) struct padding */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int16_t&lt;/span> &lt;span style="color:#111">pauserehash&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* If &amp;gt;0 rehashing is paused (&amp;lt;0 indicates coding error) */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// size çš„ ç³»æ•°ï¼Œsize æ˜¯2 çš„Næ¬¡å¹‚
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">signed&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">];&lt;/span> &lt;span style="color:#75715e">/* exponent of size. (size = 1&amp;lt;&amp;lt;exp) */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">};&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªdictType ç”¨æ¥å¯¹åº”ç‰¹å®šç±»åž‹çš„æ“ä½œå‡½æ•°,è¿™äº›å‡½æ•°ä½“çŽ°äº†é¢å‘å¯¹è±¡ç¼–ç¨‹çš„æ€æƒ³ï¼Œä¼šåœ¨åŽé¢åˆé€‚çš„æ—¶æœºç”¨åˆ°ã€‚&lt;/p>
&lt;p>æ¯”å¦‚æ‰¾ä¸ªhashFunction ç”¨æ¥æŽ§åˆ¶dictä½¿ç”¨çš„hashå‡½æ•°ï¼Œé»˜è®¤ä¸ºsiphashã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-go" data-lang="go">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75af00">typedef&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#75af00">dictType&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">uint64_t&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">hashFunction&lt;/span>&lt;span style="color:#111">)(&lt;/span>&lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">key&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">// hashå‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">keyDup&lt;/span>&lt;span style="color:#111">)(&lt;/span>&lt;span style="color:#75af00">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">key&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">// keyçš„ å¤åˆ¶å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">valDup&lt;/span>&lt;span style="color:#111">)(&lt;/span>&lt;span style="color:#75af00">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">obj&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">// val çš„å¤åˆ¶å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">keyCompare&lt;/span>&lt;span style="color:#111">)(&lt;/span>&lt;span style="color:#75af00">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">key1&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#75af00">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">key2&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">// key å¯¹æ¯”å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">void&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">keyDestructor&lt;/span>&lt;span style="color:#111">)(&lt;/span>&lt;span style="color:#75af00">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">key&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">// key é”€æ¯å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75af00">void&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">valDestructor&lt;/span>&lt;span style="color:#111">)(&lt;/span>&lt;span style="color:#75af00">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">obj&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">// val é”€æ¯å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">expandAllowed&lt;/span>&lt;span style="color:#111">)(&lt;/span>&lt;span style="color:#75af00">size_t&lt;/span> &lt;span style="color:#75af00">moreMem&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">double&lt;/span> &lt;span style="color:#75af00">usedRatio&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">//æ‰©å±•å‡½æ•°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">/* Allow a dictEntry to carry extra caller-defined metadata. The
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * extra memory is initialized to 0 when a dictEntry is allocated. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">size_t&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">dictEntryMetadataBytes&lt;/span>&lt;span style="color:#111">)(&lt;/span>&lt;span style="color:#75af00">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">d&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">// å…ƒæ•°æ®
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#75af00">dictType&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ›å»º-3">åˆ›å»º&lt;/h3>
&lt;p>å…ˆç”³è¯·ç©ºé—´ï¼Œå†åˆå§‹åŒ–å‚æ•°&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Reset hash table parameters already initialized with _dictInit()*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">_dictReset&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">htidx&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">htidx&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">htidx&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">htidx&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Create a new hash table */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">dictCreate&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dictType&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">zmalloc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">sizeof&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">_dictInit&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Initialize the hash table */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#75af00">_dictInit&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">dictType&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">_dictReset&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">_dictReset&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">type&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">type&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">rehashidx&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">pauserehash&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">DICT_OK&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// ä½¿ç”¨ä¸€äº›å®æ¥åé¦ˆç»“æžœ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="å¢žåŠ ä¸Žæ‰©å®¹">å¢žåŠ ä¸Žæ‰©å®¹&lt;/h3>
&lt;p>è¿™é‡Œå…ˆæå‰è®²ä¸€ä¸‹Rehashçš„æ¦‚å¿µï¼Œä¾¿äºŽç†è§£å¢žåŠ æ‰©å®¹ä¸­çš„ä¸€äº›æ“ä½œ:&lt;/p>
&lt;p>æ‰©å®¹åŽï¼Œå­—å…¸å®¹é‡åŠæŽ©ç å€¼ä¼šå‘ç”Ÿæ”¹å˜ï¼ŒåŒä¸€ä¸ªé”®ä¸ŽæŽ©ç ç»ä½è¿ç®—åŽå¾—åˆ°çš„ç´¢å¼•å€¼å°±ä¼šå‘ç”Ÿæ”¹å˜ï¼Œä»Žè€Œå¯¼è‡´æ ¹æ®é”®æŸ¥æ‰¾ä¸åˆ°å€¼çš„æƒ…å†µã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯ï¼Œ&lt;strong>æ–°æ‰©å®¹çš„å†…å­˜æ”¾åˆ°ä¸€ä¸ªå…¨æ–°çš„Hashè¡¨ä¸­ï¼ˆht[1]ï¼‰ï¼Œå¹¶ç»™å­—å…¸æ‰“ä¸Šåœ¨è¿›è¡Œrehashæ“ä½œä¸­çš„æ ‡è¯†ï¼ˆå³rehashidx! =-1ï¼‰&lt;/strong>ã€‚æ­¤åŽï¼Œæ–°æ·»åŠ çš„é”®å€¼å¯¹éƒ½å¾€æ–°çš„Hashè¡¨ä¸­å­˜å‚¨ï¼›è€Œä¿®æ”¹ã€åˆ é™¤ã€æŸ¥æ‰¾æ“ä½œéœ€è¦åœ¨ht[0]ã€ht[1]ä¸­è¿›è¡Œæ£€æŸ¥ï¼Œç„¶åŽå†å†³å®šåŽ»å¯¹å“ªä¸ªHashè¡¨æ“ä½œã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦æŠŠè€Hashè¡¨ï¼ˆht[0]ï¼‰ä¸­çš„æ•°æ®é‡æ–°è®¡ç®—ç´¢å¼•å€¼åŽå…¨éƒ¨è¿ç§»æ’å…¥åˆ°æ–°çš„Hashè¡¨(ht[1])ä¸­ï¼Œæ­¤è¿ç§»è¿‡ç¨‹ç§°ä½œrehashã€‚&lt;/p>
&lt;p>å…ˆçœ‹å¢žåŠ å•ä¸ªentryçš„æ“ä½œ:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* Add an element to the target hash table */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#75af00">dictAdd&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">val&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">entry&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">dictAddRaw&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">DICT_ERR&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">dictSetVal&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">val&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">DICT_OK&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">dictAddRaw&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">**&lt;/span>&lt;span style="color:#111">existing&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">index&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">htidx&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// å¦‚æžœæ­£åœ¨rehash,åœ¨addæ—¶è¿›è¡Œä¸€æ­¥rehashï¼Œè¿™é‡Œæ˜¯å°†å¤§èŒƒå›´çš„rehashåˆ†æ•£æ¥å‡å°èµ„æºé›†ä¸­æ¶ˆè€—
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">dictIsRehashing&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#75af00">_dictRehashStep&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Get the index of the new element, or -1 if
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * the element already exists. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">((&lt;/span>&lt;span style="color:#111">index&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">_dictKeyIndex&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#75af00">dictHashKey&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">),&lt;/span> &lt;span style="color:#111">existing&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Allocate the memory and store the new entry.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * Insert the element in top, with the assumption that in a database
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * system it is more likely that recently added entries are accessed
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * more frequently. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">htidx&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">dictIsRehashing&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">?&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span> &lt;span style="color:#f92672">:&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">size_t&lt;/span> &lt;span style="color:#111">metasize&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">dictMetadataSize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">entry&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">zmalloc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">sizeof&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">metasize&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">metasize&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">memset&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">dictMetadata&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#111">),&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">metasize&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ’å…¥åœ¨é¡¶éƒ¨:æ ¹æ®æ—¶ç©ºå±€é™æ€§
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">next&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">htidx&lt;/span>&lt;span style="color:#111">][&lt;/span>&lt;span style="color:#111">index&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">htidx&lt;/span>&lt;span style="color:#111">][&lt;/span>&lt;span style="color:#111">index&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">htidx&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Set the hash entry fields. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">dictSetKey&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹å‡ºï¼Œaddè°ƒç”¨äº†ä¸€ä¸ªåº•å±‚çš„addrawå‡½æ•°ã€‚addrawé¦–å…ˆä½¿ç”¨dictkeyindexæ¥æŸ¥æ‰¾ä¸€ä¸ªåˆé€‚çš„æ’å…¥ä½ç½®ï¼Œå¦‚æžœè¿™ä¸ªkeyå·²ç»å­˜åœ¨å°±é€€å‡ºaddæ“ä½œã€‚ç„¶åŽç¡®å®šæ˜¯å¦åœ¨rehash,ä¸Šé¢æˆ‘ä»¬è®²è¿‡å¦‚æžœåœ¨rehashé‚£ä¹ˆ &lt;strong>æ–°æ·»åŠ çš„é”®å€¼å¯¹éƒ½å¾€æ–°çš„Hashè¡¨ä¸­å­˜å‚¨&lt;/strong>ã€‚åŽé¢å°±ç”³è¯·ç©ºé—´åœ¨ç›¸åº”ä½ç½®é¡¶éƒ¨æ’å…¥ï¼Œè¿™æ˜¯æ•°æ®åº“æ—¶ç©ºå±€é™æ€§çš„ä½“çŽ°ã€‚&lt;/p>
&lt;p>è¿™é‡Œçœ‹ä¸€ä¸‹dictSetKeyå’ŒdictSetVal:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define dictSetKey(d, entry, _key_) do { \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> if ((d)-&amp;gt;type-&amp;gt;keyDup) \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> (entry)-&amp;gt;key = (d)-&amp;gt;type-&amp;gt;keyDup((d), _key_); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> else \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> (entry)-&amp;gt;key = (_key_); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">} while(0)
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">#define dictSetVal(d, entry, _val_) do { \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> if ((d)-&amp;gt;type-&amp;gt;valDup) \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> (entry)-&amp;gt;v.val = (d)-&amp;gt;type-&amp;gt;valDup((d), _val_); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> else \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> (entry)-&amp;gt;v.val = (_val_); \
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">} while(0)
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>å¯ä»¥çœ‹å‡ºæ˜¯ç”¨å®çš„å½¢å¼è°ƒç”¨dictçš„dicttypeå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™äº›æ“ä½œæ˜¯å¯ä»¥è°ƒæ•´çš„ã€‚&lt;/p>
&lt;p>æ‰©å®¹æ“ä½œ:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// å°†dæ‰©å®¹åˆ°2^sizeçš„å¤§å°
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#75af00">_dictExpand&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">size&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span>&lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#111">malloc_failed&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">malloc_failed&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">malloc_failed&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* the size is invalid if it is smaller than the number of
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * elements already inside the hash table */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">dictIsRehashing&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">size&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">DICT_ERR&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* the new hash table */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">**&lt;/span>&lt;span style="color:#111">new_ht_table&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">new_ht_used&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">signed&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">new_ht_size_exp&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">_dictNextExp&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">size&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Detect overflows */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">size_t&lt;/span> &lt;span style="color:#111">newsize&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">1ul&lt;/span>&lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span>&lt;span style="color:#111">new_ht_size_exp&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// åŽè€…åˆ¤æ–­åœ¨ä»€ä¹ˆæ—¶å€™æˆç«‹?
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">newsize&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">size&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#111">newsize&lt;/span> &lt;span style="color:#f92672">*&lt;/span> &lt;span style="color:#00a8c8">sizeof&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dictEntry&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#111">newsize&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">DICT_ERR&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Rehashing to the same table size is not useful. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">new_ht_size_exp&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">])&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">DICT_ERR&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Allocate the new hash table and initialize all pointers to NULL */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">malloc_failed&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">new_ht_table&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">ztrycalloc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">newsize&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#00a8c8">sizeof&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dictEntry&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">malloc_failed&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">new_ht_table&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">malloc_failed&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">DICT_ERR&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span> &lt;span style="color:#00a8c8">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">new_ht_table&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">zcalloc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">newsize&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#00a8c8">sizeof&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dictEntry&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æ–°çš„hashè¡¨è¢«ä½¿ç”¨çš„æ•°é‡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">new_ht_used&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Is this the first initialization? If so it&amp;#39;s not really a rehashing
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * we just set the first hash table so that it can accept keys. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">new_ht_size_exp&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">new_ht_used&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">new_ht_table&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">DICT_OK&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Prepare a second hash table for incremental rehashing */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">new_ht_size_exp&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">new_ht_used&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">new_ht_table&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">rehashidx&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">DICT_OK&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>é¦–å…ˆåˆ¤æ–­æ˜¯å¦åœ¨rehashï¼Œåœ¨rehashä¸­ä¸èƒ½æ‰©å®¹ã€‚ç„¶åŽåˆ›å»ºä¸€ä¸ªæ–°çš„hash tableï¼Œè¿™ä¸ªnewsizeæ˜¯2çš„næ¬¡å¹‚ã€‚expandæ“ä½œåœ¨åˆšå¼€å§‹åˆå§‹åŒ–æ—¶ä¼šä½¿ç”¨ï¼Œä¹Ÿä¼šåœ¨è¿™é‡Œåšä¸€ä¸ªåˆ¤æ–­ã€‚æ›´å¸¸ç”¨çš„æ˜¯åœ¨æ‰©å®¹åŽè¿›è¡Œrehashæ“ä½œã€‚&lt;/p>
&lt;p>èŽ·å¾—sizeçš„å‡½æ•°:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">// ç¡®ä¿hash cap ä¸º2çš„Næ¬¡å¹‚
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">signed&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#75af00">_dictNextExp&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">size&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">char&lt;/span> &lt;span style="color:#111">e&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">DICT_HT_INITIAL_EXP&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">size&lt;/span> &lt;span style="color:#f92672">&amp;gt;=&lt;/span> &lt;span style="color:#111">LONG_MAX&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">8&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#00a8c8">sizeof&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">long&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// 1 &amp;lt;&amp;lt; e == 1 * 2^e
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// æ‰¾åˆ°ä¸€ä¸ªå¤§äºŽsize çš„2^e
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">while&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(((&lt;/span>&lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span>&lt;span style="color:#111">e&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;gt;=&lt;/span> &lt;span style="color:#111">size&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">e&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="æ¸è¿›å¼rehash">æ¸è¿›å¼Rehash&lt;/h3>
&lt;p>ç›´æŽ¥çœ‹å‡½æ•°:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#75af00">dictRehash&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">n&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">empty_visits&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">n&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#ae81ff">10&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* Max number of empty buckets to visit. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">dictIsRehashing&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">while&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">n&lt;/span>&lt;span style="color:#f92672">--&lt;/span> &lt;span style="color:#f92672">&amp;amp;&amp;amp;&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">de&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">nextde&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Note that rehashidx can&amp;#39;t overflow as we are sure there are more
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * elements because ht[0].used != 0 */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">assert&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">DICTHT_SIZE&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">])&lt;/span> &lt;span style="color:#f92672">&amp;gt;&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">rehashidx&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">while&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">][&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">rehashidx&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">rehashidx&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">--&lt;/span>&lt;span style="color:#111">empty_visits&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">de&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">][&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">rehashidx&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Move all the keys in this bucket from the old to the new hash HT */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">while&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">de&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">uint64_t&lt;/span> &lt;span style="color:#111">h&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">nextde&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">de&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">next&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Get the index in the new hash table */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">h&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">dictHashKey&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">de&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#75af00">DICTHT_SIZE_MASK&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">de&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">next&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">][&lt;/span>&lt;span style="color:#111">h&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">][&lt;/span>&lt;span style="color:#111">h&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">de&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">--&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">de&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">nextde&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">][&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">rehashidx&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">rehashidx&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Check if we already rehashed the whole table... */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">zfree&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Copy the new ht onto the old one */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">_dictReset&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">rehashidx&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* More to rehash... */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>rehashé™¤äº†æ‰©å®¹æ—¶ä¼šè§¦å‘ï¼Œç¼©å®¹æ—¶ä¹Ÿä¼šè§¦å‘ã€‚Redisæ•´ä¸ªrehashçš„å®žçŽ°ï¼Œä¸»è¦åˆ†ä¸ºå¦‚ä¸‹å‡ æ­¥å®Œæˆã€‚&lt;/p>
&lt;ol>
&lt;li>ç»™Hashè¡¨ht[1]ç”³è¯·è¶³å¤Ÿçš„ç©ºé—´ï¼›æ‰©å®¹æ—¶ç©ºé—´å¤§å°ä¸ºå½“å‰å®¹é‡&lt;em>2ï¼Œå³d-&amp;gt;ht[0]. used&lt;/em>2ï¼›å½“ä½¿ç”¨é‡ä¸åˆ°æ€»ç©ºé—´10%æ—¶ï¼Œåˆ™è¿›è¡Œç¼©å®¹ã€‚ç¼©å®¹æ—¶ç©ºé—´å¤§å°åˆ™ä¸ºèƒ½æ°å¥½åŒ…å«d-&amp;gt;ht[0].usedä¸ªèŠ‚ç‚¹çš„2^Næ¬¡æ–¹å¹‚æ•´æ•°ï¼Œå¹¶æŠŠå­—å…¸ä¸­å­—æ®µrehashidxæ ‡è¯†ä¸º0&lt;/li>
&lt;li>è¿›è¡Œrehashæ“ä½œè°ƒç”¨çš„æ˜¯dictRehashå‡½æ•°ï¼Œé‡æ–°è®¡ç®—ht[0]ä¸­æ¯ä¸ªé”®çš„Hashå€¼ä¸Žç´¢å¼•å€¼ï¼ˆé‡æ–°è®¡ç®—å°±å«rehashï¼‰ï¼Œä¾æ¬¡æ·»åŠ åˆ°æ–°çš„Hashè¡¨ht[1]ï¼Œå¹¶æŠŠè€Hashè¡¨ä¸­è¯¥é”®å€¼å¯¹åˆ é™¤ã€‚æŠŠå­—å…¸ä¸­å­—æ®µrehashidxå­—æ®µä¿®æ”¹ä¸ºHashè¡¨ht[0]ä¸­æ­£åœ¨è¿›è¡Œrehashæ“ä½œèŠ‚ç‚¹çš„ç´¢å¼•å€¼.&lt;/li>
&lt;li>rehashæ“ä½œåŽï¼Œæ¸…ç©ºht[0]ï¼Œç„¶åŽå¯¹è°ƒä¸€ä¸‹ht[1]ä¸Žht[0]çš„å€¼ï¼Œå¹¶æŠŠå­—å…¸ä¸­rehashidxå­—æ®µæ ‡è¯†ä¸º-1ã€‚&lt;/li>
&lt;/ol>
&lt;p>æˆ‘ä»¬çŸ¥é“ï¼ŒRediså¯ä»¥æä¾›é«˜æ€§èƒ½çš„çº¿ä¸ŠæœåŠ¡ï¼Œè€Œä¸”æ˜¯å•è¿›ç¨‹æ¨¡å¼ï¼Œå½“æ•°æ®åº“ä¸­é”®å€¼å¯¹æ•°é‡è¾¾åˆ°äº†ç™¾ä¸‡ã€åƒä¸‡ã€äº¿çº§åˆ«æ—¶ï¼Œæ•´ä¸ªrehashè¿‡ç¨‹å°†éžå¸¸ç¼“æ…¢ï¼Œå¦‚æžœä¸ä¼˜åŒ–rehashè¿‡ç¨‹ï¼Œå¯èƒ½ä¼šé€ æˆå¾ˆä¸¥é‡çš„æœåŠ¡ä¸å¯ç”¨çŽ°è±¡ã€‚Redisä¼˜åŒ–çš„æ€æƒ³å¾ˆå·§å¦™ï¼Œåˆ©ç”¨åˆ†è€Œæ²»ä¹‹çš„æ€æƒ³äº†è¿›è¡Œrehashæ“ä½œï¼Œå¤§è‡´çš„æ­¥éª¤å¦‚ä¸‹ã€‚&lt;/p>
&lt;p>æ‰§è¡Œæ’å…¥ã€åˆ é™¤ã€æŸ¥æ‰¾ã€ä¿®æ”¹ç­‰æ“ä½œå‰ï¼Œéƒ½å…ˆåˆ¤æ–­å½“å‰å­—å…¸rehashæ“ä½œæ˜¯å¦åœ¨è¿›è¡Œä¸­ï¼Œè¿›è¡Œä¸­åˆ™è°ƒç”¨dictRehashStepå‡½æ•°è¿›è¡Œrehashæ“ä½œï¼ˆæ¯æ¬¡åªå¯¹1ä¸ªèŠ‚ç‚¹è¿›è¡Œrehashæ“ä½œï¼Œå…±æ‰§è¡Œ1æ¬¡ï¼‰ã€‚é™¤è¿™äº›æ“ä½œä¹‹å¤–ï¼Œå½“æœåŠ¡ç©ºé—²æ—¶ï¼Œå¦‚æžœå½“å‰å­—å…¸ä¹Ÿéœ€è¦è¿›è¡Œrehshæ“ä½œï¼Œåˆ™ä¼šè°ƒç”¨incrementallyRehashå‡½æ•°è¿›è¡Œæ‰¹é‡rehashæ“ä½œï¼ˆæ¯æ¬¡å¯¹100ä¸ªèŠ‚ç‚¹è¿›è¡Œrehashæ“ä½œï¼Œå…±æ‰§è¡Œ1æ¯«ç§’ï¼‰ã€‚åœ¨ç»åŽ†Næ¬¡rehashæ“ä½œåŽï¼Œæ•´ä¸ªht[0]çš„æ•°æ®éƒ½ä¼šè¿ç§»åˆ°ht[1]ä¸­ï¼Œè¿™æ ·åšçš„å¥½å¤„å°±æŠŠæ˜¯æœ¬åº”é›†ä¸­å¤„ç†çš„æ—¶é—´åˆ†æ•£åˆ°äº†ä¸Šç™¾ä¸‡ã€åƒä¸‡ã€äº¿æ¬¡æ“ä½œä¸­ï¼Œæ‰€ä»¥å…¶è€—æ—¶å¯å¿½ç•¥ä¸è®¡ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* This function performs just a step of rehashing, and only if hashing has
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * not been paused for our hash table. When we have iterators in the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * middle of a rehashing we can&amp;#39;t mess with the two hash tables otherwise
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * some elements can be missed or duplicated.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * This function is called by common lookup or update operations in the
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * dictionary so that the hash table automatically migrates from H1 to H2
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * while it is actively used. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">_dictRehashStep&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">pauserehash&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#75af00">dictRehash&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="åˆ é™¤-1">åˆ é™¤&lt;/h3>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">static&lt;/span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">dictGenericDelete&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">const&lt;/span> &lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">nofree&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">uint64_t&lt;/span> &lt;span style="color:#111">h&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">idx&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">he&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">prevHe&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">table&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* dict is empty */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">dictSize&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">==&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#75af00">dictIsRehashing&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#75af00">_dictRehashStep&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">h&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">dictHashKey&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">table&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">table&lt;/span> &lt;span style="color:#f92672">&amp;lt;=&lt;/span> &lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">table&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">idx&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">h&lt;/span> &lt;span style="color:#f92672">&amp;amp;&lt;/span> &lt;span style="color:#75af00">DICTHT_SIZE_MASK&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">table&lt;/span>&lt;span style="color:#111">]);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">he&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">table&lt;/span>&lt;span style="color:#111">][&lt;/span>&lt;span style="color:#111">idx&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">prevHe&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// æŸ¥æ‰¾
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">while&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">he&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#f92672">==&lt;/span>&lt;span style="color:#111">he&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">key&lt;/span> &lt;span style="color:#f92672">||&lt;/span> &lt;span style="color:#75af00">dictCompareKeys&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">he&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">key&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* Unlink the element from the list */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">prevHe&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">prevHe&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">next&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">he&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">next&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">else&lt;/span> &lt;span style="color:#75715e">// åœ¨bucketé¡¶éƒ¨,ç›´æŽ¥ç•¥è¿‡
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">table&lt;/span>&lt;span style="color:#111">][&lt;/span>&lt;span style="color:#111">idx&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">he&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">next&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#111">nofree&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">dictFreeUnlinkedEntry&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">he&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">table&lt;/span>&lt;span style="color:#111">]&lt;/span>&lt;span style="color:#f92672">--&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">he&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">prevHe&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">he&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">he&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">he&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">next&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">if&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">!&lt;/span>&lt;span style="color:#75af00">dictIsRehashing&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#00a8c8">break&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">/* not found */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h3 id="éåŽ†">éåŽ†&lt;/h3>
&lt;p>éåŽ†Redisæ•´ä¸ªæ•°æ®åº“ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼šå…¨éåŽ†ï¼ˆä¾‹å¦‚keyså‘½ä»¤ï¼‰ã€é—´æ–­éåŽ†ï¼ˆhscanå‘½ä»¤ï¼‰:&lt;/p>
&lt;ul>
&lt;li>å…¨éåŽ†: ä¸€æ¬¡å‘½ä»¤æ‰§è¡Œå°±éåŽ†å®Œæ•´ä¸ªæ•°æ®åº“ã€‚&lt;/li>
&lt;li>é—´æ–­éåŽ†: æ¯æ¬¡å‘½ä»¤æ‰§è¡Œåªå–éƒ¨åˆ†æ•°æ®ï¼Œåˆ†å¤šæ¬¡éåŽ†ã€‚&lt;/li>
&lt;/ul>
&lt;p>è¿­ä»£å™¨â€”â€”å¯åœ¨å®¹å™¨ï¼ˆå®¹å™¨å¯ä¸ºå­—å…¸ã€é“¾è¡¨ç­‰æ•°æ®ç»“æž„ï¼‰ä¸Šéè®¿çš„æŽ¥å£ï¼Œè®¾è®¡äººå‘˜æ— é¡»å…³å¿ƒå®¹å™¨çš„å†…å®¹ï¼Œè°ƒç”¨è¿­ä»£å™¨å›ºå®šçš„æŽ¥å£å°±å¯éåŽ†æ•°æ®ï¼Œåœ¨å¾ˆå¤šé«˜çº§è¯­è¨€ä¸­éƒ½æœ‰å®žçŽ°ã€‚&lt;/p>
&lt;p>å­—å…¸è¿­ä»£å™¨ä¸»è¦ç”¨äºŽè¿­ä»£å­—å…¸è¿™ä¸ªæ•°æ®ç»“æž„ä¸­çš„æ•°æ®ï¼Œæ—¢ç„¶æ˜¯è¿­ä»£å­—å…¸ä¸­çš„æ•°æ®ï¼Œå¿…ç„¶ä¼šå‡ºçŽ°ä¸€ä¸ªé—®é¢˜ï¼Œè¿­ä»£è¿‡ç¨‹ä¸­ï¼Œå¦‚æžœå‘ç”Ÿäº†æ•°æ®å¢žåˆ ï¼Œåˆ™å¯èƒ½å¯¼è‡´å­—å…¸è§¦å‘rehashæ“ä½œï¼Œæˆ–è¿­ä»£å¼€å§‹æ—¶å­—å…¸æ­£åœ¨è¿›è¡Œrehashæ“ä½œï¼Œä»Žè€Œå¯¼è‡´ä¸€æ¡æ•°æ®å¯èƒ½å¤šæ¬¡éåŽ†åˆ°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">typedef&lt;/span> &lt;span style="color:#00a8c8">struct&lt;/span> &lt;span style="color:#111">dictIterator&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">index&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#75715e">// è¿­ä»£hashä¸­çš„ç´¢å¼•å€¼
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#75715e">// safe ä¸º1è¡¨ç¤ºæ˜¯å®‰å…¨è¿­ä»£å™¨ï¼Œå¯ä»¥åœ¨add,findç­‰rehashåœºæ™¯ä¸­ä½¿ç”¨
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">table&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">safe&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">// entry å½“å‰è¯»å–èŠ‚ç‚¹ï¼ŒnextEntry entry èŠ‚ç‚¹çš„nextå­—æ®µ
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">entry&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">nextEntry&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* unsafe iterator fingerprint for misuse detection. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">fingerprint&lt;/span>&lt;span style="color:#111">;&lt;/span>&lt;span style="color:#75715e">// å­—å…¸æŒ‡çº¹ï¼Œå­—å…¸å‘ç”Ÿæ”¹å˜éšä¹‹æ”¹å˜
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span>&lt;span style="color:#111">}&lt;/span> &lt;span style="color:#111">dictIterator&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>fingerprintå­—æ®µæ˜¯ä¸€ä¸ª64ä½çš„æ•´æ•°ï¼Œè¡¨ç¤ºåœ¨ç»™å®šæ—¶é—´å†…å­—å…¸çš„çŠ¶æ€ã€‚åœ¨è¿™é‡Œç§°å…¶ä¸ºå­—å…¸çš„æŒ‡çº¹ï¼Œå› ä¸ºè¯¥å­—æ®µçš„å€¼ä¸ºå­—å…¸ï¼ˆdictç»“æž„ä½“ï¼‰ä¸­æ‰€æœ‰å­—æ®µå€¼ç»„åˆåœ¨ä¸€èµ·ç”Ÿæˆçš„Hashå€¼ï¼Œæ‰€ä»¥å½“å­—å…¸ä¸­æ•°æ®å‘ç”Ÿä»»ä½•å˜åŒ–æ—¶ï¼Œå…¶å€¼éƒ½ä¼šä¸åŒï¼Œç”Ÿæˆç®—æ³•å¯å‚è§æºç dict.cæ–‡ä»¶ä¸­çš„dictFingerprintå‡½æ•°ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">/* A fingerprint is a 64 bit number that represents the state of the dictionary
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * at a given time, it&amp;#39;s just a few dict properties xored together.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * When an unsafe iterator is initialized, we get the dict fingerprint, and check
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * the fingerprint again when the iterator is released.
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * If the two fingerprints are different it means that the user of the iterator
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * performed forbidden operations against the dictionary while iterating. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#75af00">dictFingerprint&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">unsigned&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#00a8c8">long&lt;/span> &lt;span style="color:#111">integers&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">6&lt;/span>&lt;span style="color:#111">],&lt;/span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">int&lt;/span> &lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">integers&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">long&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">integers&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">integers&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">integers&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">3&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">long&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_table&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">integers&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">4&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_size_exp&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">integers&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">5&lt;/span>&lt;span style="color:#111">]&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ht_used&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* We hash N integers by summing every successive integer with the integer
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * hashing of the previous sum. Basically:
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * Result = hash(hash(hash(int1)+int2)+int3) ...
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * This way the same set of integers in a different order will (likely) hash
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e"> * to a different number. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">for&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">j&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">j&lt;/span> &lt;span style="color:#f92672">&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">6&lt;/span>&lt;span style="color:#111">;&lt;/span> &lt;span style="color:#111">j&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">+=&lt;/span> &lt;span style="color:#111">integers&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">];&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75715e">/* For the hashing step we use Tomas Wang&amp;#39;s 64 bit integer hash. */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">~&lt;/span>&lt;span style="color:#111">hash&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">21&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">// hash = (hash &amp;lt;&amp;lt; 21) - hash - 1;
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">^&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">24&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">3&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">8&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">// hash * 265
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">^&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">14&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">2&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">4&lt;/span>&lt;span style="color:#111">);&lt;/span> &lt;span style="color:#75715e">// hash * 21
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#75715e">&lt;/span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">^&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">&amp;gt;&amp;gt;&lt;/span> &lt;span style="color:#ae81ff">28&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">+&lt;/span> &lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">hash&lt;/span> &lt;span style="color:#f92672">&amp;lt;&amp;lt;&lt;/span> &lt;span style="color:#ae81ff">31&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">hash&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>æ ¹æ®è¿­ä»£å™¨ç»“æž„ä¸­çš„safeå­—æ®µï¼Œå°†è¿­ä»£å™¨åˆ†ä¸ºæ™®é€šè¿­ä»£å™¨å’Œå®‰å…¨è¿­ä»£å™¨:&lt;/p>
&lt;ul>
&lt;li>æ™®é€šè¿­ä»£å™¨: åªéåŽ†æ•°æ®&lt;/li>
&lt;li>å®‰å…¨è¿­ä»£å™¨: éåŽ†çš„åŒæ—¶åˆ é™¤æ•°æ®&lt;/li>
&lt;/ul>
&lt;h4 id="æ™®é€šè¿­ä»£å™¨">æ™®é€šè¿­ä»£å™¨&lt;/h4>
&lt;p>æ™®é€šè¿­ä»£å™¨è¿­ä»£å­—å…¸ä¸­æ•°æ®æ—¶ï¼Œä¼šå¯¹è¿­ä»£å™¨ä¸­fingerprintå­—æ®µçš„å€¼ä½œä¸¥æ ¼çš„æ ¡éªŒï¼Œæ¥ä¿è¯è¿­ä»£è¿‡ç¨‹ä¸­å­—å…¸ç»“æž„ä¸å‘ç”Ÿä»»ä½•å˜åŒ–ï¼Œç¡®ä¿è¯»å–å‡ºçš„æ•°æ®ä¸å‡ºçŽ°é‡å¤&lt;/p>
&lt;p>å½“Redisæ‰§è¡Œéƒ¨åˆ†å‘½ä»¤æ—¶ä¼šä½¿ç”¨æ™®é€šè¿­ä»£å™¨è¿­ä»£å­—å…¸æ•°æ®ï¼Œä¾‹å¦‚sortå‘½ä»¤ã€‚sortå‘½ä»¤ä¸»è¦ä½œç”¨æ˜¯å¯¹ç»™å®šåˆ—è¡¨ã€é›†åˆã€æœ‰åºé›†åˆçš„å…ƒç´ è¿›è¡ŒæŽ’åºï¼Œå¦‚æžœç»™å®šçš„æ˜¯æœ‰åºé›†åˆï¼Œå…¶æˆå‘˜åå­˜å‚¨ç”¨çš„æ˜¯å­—å…¸ï¼Œåˆ†å€¼å­˜å‚¨ç”¨çš„æ˜¯è·³è·ƒè¡¨ï¼Œåˆ™æ‰§è¡Œsortå‘½ä»¤è¯»å–æ•°æ®çš„æ—¶å€™ä¼šç”¨åˆ°è¿­ä»£å™¨æ¥éåŽ†æ•´ä¸ªå­—å…¸ã€‚&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">set&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">((&lt;/span>&lt;span style="color:#111">zset&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#111">sortval&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">ptr&lt;/span>&lt;span style="color:#111">)&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">dict&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dictIterator&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">di&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dictEntry&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">setele&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">sds&lt;/span> &lt;span style="color:#111">sdsele&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">di&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">dictGetIterator&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">set&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">while&lt;/span>&lt;span style="color:#111">((&lt;/span>&lt;span style="color:#111">setele&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">dictNext&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">di&lt;/span>&lt;span style="color:#111">))&lt;/span> &lt;span style="color:#f92672">!=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">)&lt;/span> &lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">sdsele&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">dictGetKey&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">setele&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">vector&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">obj&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">createStringObject&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sdsele&lt;/span>&lt;span style="color:#111">,&lt;/span>&lt;span style="color:#75af00">sdslen&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">sdsele&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">vector&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">u&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">score&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">vector&lt;/span>&lt;span style="color:#111">[&lt;/span>&lt;span style="color:#111">j&lt;/span>&lt;span style="color:#111">].&lt;/span>&lt;span style="color:#111">u&lt;/span>&lt;span style="color:#111">.&lt;/span>&lt;span style="color:#111">cmpobj&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">j&lt;/span>&lt;span style="color:#f92672">++&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">dictReleaseIterator&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">di&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;ol>
&lt;li>
&lt;p>è°ƒç”¨dictGetIteratorå‡½æ•°åˆå§‹åŒ–ä¸€ä¸ªæ™®é€šè¿­ä»£å™¨ï¼Œæ­¤æ—¶ä¼šæŠŠiter-&amp;gt;safeå€¼ç½®ä¸º0ï¼Œè¡¨ç¤ºåˆå§‹åŒ–çš„è¿­ä»£å™¨ä¸ºæ™®é€šè¿­ä»£å™¨&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-c" data-lang="c">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#00a8c8">void&lt;/span> &lt;span style="color:#75af00">dictInitIterator&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dictIterator&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">iter&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">iter&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">d&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">iter&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">table&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">iter&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">index&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#f92672">-&lt;/span>&lt;span style="color:#ae81ff">1&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">iter&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">safe&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#ae81ff">0&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">iter&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">entry&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">iter&lt;/span>&lt;span style="color:#f92672">-&amp;gt;&lt;/span>&lt;span style="color:#111">nextEntry&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#111">NULL&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">dictIterator&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#75af00">dictGetIterator&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">dict&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#111">dictIterator&lt;/span> &lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">iter&lt;/span> &lt;span style="color:#f92672">=&lt;/span> &lt;span style="color:#75af00">zmalloc&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#00a8c8">sizeof&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#f92672">*&lt;/span>&lt;span style="color:#111">iter&lt;/span>&lt;span style="color:#111">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#75af00">dictInitIterator&lt;/span>&lt;span style="color:#111">(&lt;/span>&lt;span style="color:#111">iter&lt;/span>&lt;span style="color:#111">,&lt;/span> &lt;span style="color:#111">d&lt;/span>&lt;span style="color:#111">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#00a8c8">return&lt;/span> &lt;span style="color:#111">iter&lt;/span>&lt;span style="color:#111">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#111">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;/li>
&lt;li>
&lt;p>å¾ªçŽ¯è°ƒç”¨dictNextå‡½æ•°ä¾æ¬¡éåŽ†å­—å…¸ä¸­Hashè¡¨çš„èŠ‚ç‚¹ï¼Œé¦–æ¬¡éåŽ†æ—¶ä¼šé€šè¿‡dictFingerprintå‡½æ•°æ‹¿åˆ°å½“å‰å­—å…¸çš„æŒ‡çº¹å€¼ã€‚&lt;/p>
&lt;/li>
&lt;li>&lt;/li>
&lt;/ol>
&lt;h4 id="å®‰å…¨è¿­ä»£å™¨">å®‰å…¨è¿­ä»£å™¨&lt;/h4>
&lt;h2 id="heading">&lt;/h2></description></item><item><title/><link>https://chi-kai.github.io/post/cmu115-445/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://chi-kai.github.io/post/cmu115-445/</guid><description>&lt;h1 id="p0">p0&lt;/h1>
&lt;h2 id="æ•´ä½“æ€è·¯">æ•´ä½“æ€è·¯&lt;/h2>
&lt;h2 id="ä¸€äº›è¾¹ç•Œæ¡ä»¶">ä¸€äº›è¾¹ç•Œæ¡ä»¶&lt;/h2>
&lt;h2 id="size_t-ä½ç§»">size_t ä½ç§»&lt;/h2>
&lt;h2 id="auto-çš„ä¸ç¡®å®šæ€§">auto çš„ä¸ç¡®å®šæ€§&lt;/h2>
&lt;h2 id="gdb-debug">gdb debug&lt;/h2>
&lt;p>![[Pasted image 20241015100838.png]]&lt;/p></description></item></channel></rss>